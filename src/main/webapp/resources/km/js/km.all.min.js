km.js.utils={isEmpty:function(b){return b==null||b==""||typeof(b)=="undefined"},random:function(b){return Math.floor((Math.random()*b)+1)},isMobile:function(){return window.matchMedia("only screen and (min-device-width : 320px) and (max-device-width : 480px)").matches},getItemLink:function(c){var d=c.substring(0,3);switch(d){case"002":return"km/type/"+c;case"003":return"km/field/"+c;case"006":return"km/profile/"+c;case"009":return"km/actions/"+c;case"00a":return"km/views/"+c;case"00b":return"km/classes/"+c;case"00e":return"km/uniquechecks/"+c;case"00f":return"km/layouts/"+c;case"014":return"km/webresources/"+c;case"015":return"km/viewresources/"+c;default:return null}},customizableObjectDetails:function(b){km.js.db.query("select id from "+b.typeName,(function(a){return function(j,i,g){var h=km.js.objectdetails.create({mode:"edit",jsti:g,target:a.target,layout:a.layout,type:{name:a.typeName},record:{},customizable:true,customization:{context:"environment"}});h.render({})}})(b))},renderProfile:function(){var b=$("<div></div>").addClass("km-profile-img");b.css("background","url("+km.js.config.imagePath+"/mountains.jpg)");$(".km-profile-box > .km-profile-pic").append(b);$(".km-profile-box > .km-profile-name").text(km.js.config.authData.user.userName)},cloneArr:function(d){var f=[];for(var e=0;e<d.length;e++){f.push($.extend({},d[e]))}return f},bind:function(g,h,f,e){if(!(g instanceof jQuery)){throw"km.js.utils.bind source should be a jQuery object"}if(!(h instanceof jQuery)){throw"km.js.utils.bind dest should be a jQuery object"}g.keyup((function(a,c,b){return function(){if(a.hasClass("km-bind-manually-edited")){return}var d=c;if($(this).val()!=""){d=$(this).val()}a.text(d);if(typeof(b)==="function"){a.val(b(d))}else{a.val(d)}}})(h,f,e));h.keyup(function(){h.addClass("km-bind-manually-edited")})},capitalize:function(b){return b?b.charAt(0).toUpperCase()+b.slice(1):b},uncapitalize:function(b){return b?b.charAt(0).toLowerCase()+b.slice(1):b},getTypeFromQuery:function(d,c){$.get(km.js.config.contextPath+"/km/typefromquery",{query:d},(function(a){return function(b){a(b.data.type,b.data.isValidQuery)}})(c),"json")},addPropertyNamesToJSRC:function(q,n){var o=[];for(var m=0;m<q.length;m++){var p=q[m];for(var l in p){var i=n.fields[l];if(!i){throw"Field with KID "+l+" not found in JSTI on record "+JSON.stringify(p)}var r=p[l];if($.isArray(r)){r=this.addPropertyNamesToJSRC(r,n)}else{if(this.isObject(r)){var k=[];k.push(r);r=this.addPropertyNamesToJSRC(k,n)[0]}}p[i.apiName]=r}o.push(p)}return o},padLeft:function(c,h,g){if(!c){c=""}if(c.length===h){return c}for(var f=0;f<(h-c.length);f++){c=g+c}return c},isObject:function(b){return b!==null&&typeof b==="object"},propVal:function(e,d){if(e==null){return null}else{if(d.indexOf(".")>=0){var f=d.split(".");return this.propVal(e[f[0]],d.substring(d.indexOf(".")+1))}else{return km.js.utils.isEmpty(e)?null:e[d]}}},coalesce:function(c,d){return c?c:d},getScriptInclude:function(b){return'<script type="text/javascript" src="'+km.js.config.contextPath+"/"+b+'"><\/script>'},getCssInclude:function(b){return'<link href="'+km.js.config.contextPath+"/"+b+'" rel="stylesheet" type="text/css" />'},normalizeId:function(b){return b?b.replace(/\./g,"-"):b},parseDate:function(q,v){if(!v){v="GMT"}var p=q.split(" ");var n=p[0];var t=p[1];var z=n.split("-");var s=parseInt(z[0]);var u=parseInt(z[1])-1;var r=parseInt(z[2]);var y=0;var x=0;var w=0;if(t){var o=t.split(":");var y=parseInt(o[0]);var x=parseInt(o[1]);var w=parseInt(o[2])}return new Date(s,u,r,y,x,w)},forEachProp:function(e,f){for(var d in e){if(e.hasOwnProperty(property)){f(d,e[d])}}},nl2br:function(b){return b!=null?b.replace(/(?:\r\n|\r|\n)/g,"<br />"):null},setPropVal:function(i,h,g){if(h.indexOf(".")==-1){i[h]=g}else{var j=h.split(".");var f=i[j[0]];if(!f){f={}}this.setPropVal(f,h.substring(h.indexOf(".")+1),g);i[j[0]]=f}},lastProperty:function(c){if(c==null||c.indexOf(".")<0){return c}var d=c.split(/\./);return d[d.length-1]},insert:function(d,e,f){e.splice(d,0,f)},remove:function(c,d){d.splice(c,1)},openURL:function(b){location.href=b},formatDate:function(e,f){var d=function(a){return a.toString().length<2?"0"+a:a};return e.getFullYear()+"-"+d(e.getMonth()+1)+"-"+d(e.getDate())},size:function(f){var d=0;for(var e in f){if(f.hasOwnProperty(e)){d++}}return d},populateIdsOnProperties:function(h,g,f){if(!g){throw"Cannot populate IDs on table display options because the passed base type is null"}for(var i=0;i<h.length;i++){var j=h[i];if(j.id){continue}if(!j.name){throw"Neither property name nor its ID specified in table display options"}j.id=km.js.utils.nestedPropertyToPir(j.name,g,f);if(!j.id){throw"Could not resolve property ID for property name "+j.name+" on type "+g.qualifiedName+" (type ID "+g.id+")"}}},nestedPropertyToPir:function(o,n,p){var m=o.split(".");var l=n.qualifiedName;var j=p.pirs[l+"."+m[0]];if(m.length===1){return j}else{var k=p.fields[j];var r=k.dataType.id;var q=null;if(r===km.js.datatypes.object_reference.id){q=p.types[k.dataType.typeId]}else{if(r===km.js.datatypes.inverse_collection.id){q=p.types[k.dataType.inverseTypeId]}else{if(r===km.js.datatypes.association.id){q=p.types[k.dataType.associatedTypeId]}else{throw"Field "+k.name+" is not an object reference, collection or association, but is used with nested properties"}}}if(!q){throw"New base type not retrieved"}return j+"."+this.nestedPropertyToPir(o.substring(o.indexOf(".")+1),q,p)}},isSimpleRestriction:function(b){return b.operator.toLowerCase()!=="or"&&b.operator.toLowerCase()!=="and"&&b.operator.toLowerCase()!=="not"},getTypeFromJSTI:function(d,c){if(d.baseTypeId){type=c.types[d.baseTypeId];if(type==null){throw"Type with ID "+d.baseTypeId+" not found"}}else{if(d.baseTypeName){type=this.getTypeFromJSTIByName(d.baseTypeName,c);if(type==null){throw"Type with name "+d.baseTypeName+" not found"}}else{throw"Neither base type name nor ID specified in JCR"}}return type},getTypeFromJSTIByName:function(f,g){for(var h in g.types){var e=g.types[h];if(e.qualifiedName===f){return e}}return null},openMenuItem:function(d){var c=$("div#content td.left-menu a").filter((function(a){return function(){return $(this).text()==a}})(d)).closest("li").addClass("km-menu-highlighted");c.parent().closest("li").find("ul").show()},openCurrentMenuItem:function(){var e=window.location.href.indexOf(km.js.config.contextPath)+km.js.config.contextPath.length;var f=window.location.href.substring(e);var d=$("div#content div#left-menu a[href$='"+f+"']").closest("li").addClass("km-menu-highlighted");d.parent().closest("li").find("ul").show()},forEachRestriction:function(f,j){var i=[];if($.isArray(f)){i=[].concat(f)}else{i.push(f)}for(var h=0;h<i.length;h++){var g=i[h];j(g);if(g.operator.toLowerCase()==="or"||g.operator.toLowerCase()==="and"||g.operator.toLowerCase()==="not"){this.forEachRestriction(g.args,j)}}},adjustIframeSize:function(o,p,i,k,j){var l=document.getElementById(o);var m=l.contentWindow.document.body.scrollHeight+30;var n=l.contentWindow.document.body.scrollWidth+30;if(i&&m>i){m=i}if(p&&m<p){m=p}if(j&&n>j){n=j}if(k&&n<k){n=k}l.height=(m)+"px";l.width=(n)+"px";console.log("Adjusting size: "+m+" / "+n)},customTypes:function(){var f=[];for(var d in km.js.config.types){var e=km.js.config.types[d];if(e.isBasic===false){f.push(e)}}return f},userLookup:function(e){var f={baseTypeName:"kommet.basic.User",properties:[{name:"id"},{name:"userName"}]};var g={display:{properties:[{name:"userName",label:km.js.config.i18n["user.username"],linkStyle:true}],idProperty:{name:"id"}},title:km.js.config.i18n["tasks.users"],tableSearchOptions:{properties:[{name:"userName",operator:"ilike"}]}};var h=km.js.ref.create({selectedRecordDisplayField:{name:"userName"},jcr:f,availableItemsDialogOptions:{},availableItemsOptions:g,inputName:e.inputName,inputId:e.inputId,selectedRecordId:e.recordId,visibleInput:e.visibleInput,afterSelect:e.afterSelect,mode:e.mode,editable:e.editable});h.render(e.target);return h},isInteger:function(b){return parseInt(b,10)},dateToGMT:function(c){if(c){if(km.js.utils.isInteger(c)){c=new Date(c)}var d=new Date(c.getTime());d.setHours(c.getHours()-1*km.js.config.authData.timeZoneOffset);return d}else{return null}},dateTimePicker:function(f){var e=$("<input></input>").datetimepicker({dateFormat:"yy-mm-dd",addSliderAccess:true,showHour:!f.dateOnly,showMinute:!f.dateOnly,showTime:!f.dateOnly,sliderAccessArgs:{touchonly:false},onSelect:(function(a){return function(b){$(this).removeClass("km-output");if(typeof(a)==="function"){a(b)}}})(f.onSelect)});e.addClass("km-input");e.datepicker("setDate",f.value);if(!f.mode){f.mode="edit"}if(f.mode==="view"){e.addClass("km-output")}e.click(function(){$(this).removeClass("km-output")});e.blur(function(){$(this).addClass("km-output")});if(f.target instanceof jQuery){f.target.empty().append(e)}else{if(typeof(f.target)==="function"){f.target(e)}}var d={input:e,enable:function(){this.input.removeClass("km-output")}};return d},userGroupLookup:function(e){var f={baseTypeName:"kommet.basic.UserGroup",properties:[{name:"id"},{name:"name"}]};var g={display:{properties:[{name:"name",label:km.js.config.i18n["usergroups.groupname"],linkStyle:true}],idProperty:{name:"id"}},title:km.js.config.i18n["usergroups.list.title"],tableSearchOptions:{properties:[{name:"name",operator:"ilike"}]}};var h=km.js.ref.create({selectedRecordDisplayField:{name:"name"},jcr:f,availableItemsDialogOptions:{},availableItemsOptions:g,inputName:e.inputName,inputId:e.inputId,selectedRecordId:e.recordId,visibleInput:e.visibleInput,mode:e.mode,afterSelect:e.afterSelect,editable:e.editable});h.render(e.target);return h}};
km.js.data={associate:function(i,j,l,k,g){var h=function(a,b){return function(c){if(c.success===true){if(km.js.utils.isEmpty(c.id)){throw"Association successful, but ID of linking record not returned"}if(typeof(a)==="function"){a(c.id)}}else{if(typeof(b)==="function"){b(c)}}}};$.post(km.js.config.sysContextPath+"/rest/associate",{relationFieldId:i,parentId:j,childId:l},h(k,g),"json")},unassociate:function(j,f,h,g){var i=function(a){return function(b){if(typeof(a)==="function"){a(b.id)}}};$.post(km.js.config.sysContextPath+"/rest/unassociate",{relationFieldId:j,parentId:f,childId:h},i(g),"json")}};
km.js.datatypes={number:{id:0},text:{id:1},bool:{id:2},datetime:{id:3},rid:{id:4},email:{id:5},object_reference:{id:6},enumeration:{id:7},inverse_collection:{id:8},association:{id:10},formula:{id:11},date:{id:12},autonumber:{id:14}};
km.js.jsti={forTypes:function(h,e,g){var f={};if($.isArray(h)){f.typePrefixes=typePrefix.join(",")}if($.isArray(e)){f.typeNames=e.join(",")}$.post(km.js.config.sysContextPath+"/rest/jsti",f,g,"json")},get:function(j,h){var i={fields:{},types:{},fieldInfo:function(b){var a=this.fields[b];return km.js.utils.isEmpty(a)?null:a},typeInfo:function(b){var a=this.types[b];return km.js.utils.isEmpty(a)?null:a}};if(km.js.utils.isEmpty(h)){h=[]}if(km.js.utils.isEmpty(j)){j=[]}for(var f=0;f<h.length;f++){var g=km.js.utils.lastProperty(h[f]);i.types[g]={}}return i},fieldData:function(d,f){var e=f.indexOf(".")>-1?f.substring(f.indexOf(".")+1):f;return d.fields[e]}};
if(typeof(km.js.scope)==="undefined"){km.js.scope={dialogs:{},refs:{},rels:{},resizeEvent:{listeners:[],listen:function(b){if(typeof(b)!=="function"){throw"Cannot register listener as it is not a function: "+b}this.listeners.push(b)},notify:function(){for(var d=0;d<this.listeners.length;d++){var c=this.listeners[d];if(typeof(c)==="function"){c(window)}}}}}};
km.js.ui={boolButton:function(g){var h=typeof(g.onSetTrue)==="function"&&typeof(g.onSetFalse)==="function";if(!h){if(!(g.target instanceof jQuery)){throw"Target of a boolButton call has to be a jQuery object"}if(!g.recordId){throw"Record ID not defined in boolButton call"}if(!g.field){throw"Field not defined in boolButton call"}if(!g.type){throw"Type not defined in boolButton call"}}var f=g.value;var e=function(b){console.log("Initializing boolButton with options: "+JSON.stringify(b));var a=$('<i class="fa km-bool"></i>').addClass(b.value?"fa-check km-bool-checked":"fa-close km-bool-unchecked").addClass("km-bool-button-icon");b.target.find("i.km-bool").remove();b.target.prepend(a);if(!b.refreshMode){b.target.click((function(c){return function(){console.log("Button clicked");var m=$(this).find("i.km-bool");var n=!m.hasClass("km-bool-checked");var o=(function(j,k){return function(){console.log("Record updated");j.value=n;j.refreshMode=true;e(j)}})(c,m);if(n&&typeof(c.onSetTrue)==="function"){c.onSetTrue(d,c,o)}else{if(!n&&typeof(c.onSetFalse)==="function"){c.onSetFalse(d,c,o)}else{var d={id:c.recordId};d[c.field]=n;console.log("Updating record");km.js.db.update(d,o,null)}}}})(b))}};if(f!==true&&f!==false){if(h){throw"Initial value not set in boolButton called with manual callbacks"}console.log("Fetching initial value");km.js.db.query("select "+g.field+" from "+g.type+" where id = '"+g.recordId+"' limit 1",(function(a,b){return function(d,k,c){console.log("Initial value: "+JSON.stringify(d));d=km.js.utils.addPropertyNamesToJSRC(d,c);if(!d.length){throw"Record '"+b.recordId+"' of type "+b.type+" not found in km.js.ui.boolButton function"}b.value=d[0][b.field];a(b)}})(e,g))}else{e(g)}},buttonWait:function(f){if(f.isRestore==null){f.isRestore=true}if(!(f.button instanceof jQuery)){throw"Button passed to km.ui.buttonWait method is not a jQuery object"}var g=$('<div class="km-spinner"></div>');for(var e=0;e<=5;e++){g.append($("<div></div>").addClass("km-spinner-"+e))}var h=f.button.text()?f.button.text():f.button.val();f.button.empty().append(g).append($("<div></div>").text(f.text?f.text:"").addClass("km-waitbtn-text"));return{options:f,text:h,isRestore:f.isRestore,startTime:(new Date()).getTime()}},buttonWaitStop:function(f){var d=function(){var a=f.options.button;if(typeof(a.val)==="function"){a.empty().val(f.text)}if(typeof(a.text)==="function"){a.empty().text(f.text)}};if(f.isRestore){var e=(new Date()).getTime();if((e-f.startTime)>1000){d()}else{setTimeout(d,1000)}}},header:function(h,f,g){var e=$('<div class="km-ui-header km-title">'+h+"</div>");if(f){e.addClass(f)}if(g){e.attr("style",g)}return e},ripple:function(b){if(!b){b=$(document.body)}b.click(function(d){var a=$("<div></div>").addClass("km-ripple");a.css("top",(d.pageY)+"px").css("left",(d.pageX)+"px");a.css("background-color","#ccc");$(document.body).append(a);a.animate({opacity:0.3,width:"+=40px",height:"+=40px",left:"-=20px",top:"-=20px"},300,function(){$(this).hide()})})},appendMenuImages:function(){if(!$(".km-menu").hasClass("has-menu-icons")){$(".km-menu").addClass("has-menu-icons");$(".km-menu > ul > li > a").each(function(){var b=$("<img></img>").attr("src",km.js.config.imagePath+"/menuarrow.png");$(this).prepend($("<span></span>").append(b).addClass("km-menu-icon"))})}},tooltip:function(d){var f=$("<img></img>").attr("src",km.js.config.imagePath+"/tooltip.png").addClass("km-tooltip-icon");f.click((function(a){return function(j){var b=$("<div></div>").css("position","relative").text(a.text);var k=$("<div></div>").addClass("km-tooltip-text").append(b);var c="tooltip-"+Math.floor(Math.random()*(10000000));k.attr("id",c);$("div.km-tooltip-text").remove();$(document).find("body").append(k);k.css("top",j.pageY-k.outerHeight()/2).css("left",j.pageX+20);$(document).find("body").click(function(){$("div.km-tooltip-text").remove()});j.stopPropagation()}})(d));var e=$("<span></span>").append(f).addClass("km-tooltip-wrapper");if(d.afterTarget instanceof jQuery){d.afterTarget.after(e)}},formatApiName:function(b){if(!b){return}b=km.js.utils.capitalize(b);b=b.replace(/\s/g,"_");return b},formatFieldName:function(b){if(!b){return}b=km.js.utils.uncapitalize(b);b=b.replace(/\s/g,"_");return b},autoFormatName:function(c){if(!(c.target instanceof jQuery)){throw"Target of the autoformatApiName function must be a jQuery object"}var d=function(){var g=$(this).val();if(!g){return}var h="";var a="";if(g.indexOf(".")>=0){h=g.substring(0,g.lastIndexOf("."));a=g.substring(g.lastIndexOf(".")+1,g.length)}else{a=g}var b=(h?h.toLowerCase()+".":"")+km.js.ui.formatApiName(a);if(b!==g){$(this).val(b);$(this).addClass("km-auto-format-highlight")}else{$(this).removeClass("km-auto-format-highlight")}};c.target.focusout(d);if(c.onKeyUp){c.target.keyup(d)}},autoFormatFieldName:function(c){if(!(c.target instanceof jQuery)){throw"Target of the autoformatApiName function must be a jQuery object"}var d=function(){var b=$(this).val();if(!b){return}var a=km.js.ui.formatFieldName(b);if(a!==b){$(this).val(a);$(this).addClass("km-auto-format-highlight")}else{$(this).removeClass("km-auto-format-highlight")}};c.target.focusout(d);if(c.onKeyUp){c.target.keyup(d)}},editable:function(g){var f={};var h=$.extend({},f,g);var e=$("<input></input>").attr("type","text");if(h.inputName){e.attr("name",h.inputName)}e.keyup(function(a){if(a.keyCode==13){$(this).focusout()}});if(h.inputId){e.attr("id",h.inputId)}if(h.cssClass){e.addClass(h.cssClass)}if(!(h.target instanceof jQuery)){throw"Target should be a jQuery object"}e.focusout((function(a,b){return function(){if(typeof(b)==="function"){b($(this).val())}if($(this).val()===""){$(this).val("<empty>")}a.text($(this).val());$(this).hide();a.show()}})(h.target,h.onAccept));h.target.click((function(b,a){return function(){if(typeof(a)==="function"){a()}b.insertAfter($(this));$(this).hide();b.val($(this).text());b.show();b.select()}})(e,h.onActivate))},confirm:function(b){if(!(b.target instanceof jQuery)){throw"Target must be a jQuery object"}b.target.click((function(a){return function(){if(!a.target.is(":visible")){return}a.target.hide();var h=$('<div class="km-ui-confirm"><span class="km-ui-confirm-q">'+(a.question?a.question:km.js.config.i18n["msg.delete.warning"])+"</span></div>");var f=$('<a href="javascript:;">'+(a.yesLabel?a.yesLabel:km.js.config.i18n["btn.yes"])+"</a>");f.click(a.callback);var g=$('<a href="javascript:;">'+(a.noLabel?a.noLabel:km.js.config.i18n["btn.no"])+"</a>");g.click(function(){$(this).closest(".km-ui-confirm").remove();a.target.show()});h.append(f).append(g);a.target.after(h)}})(b))},error:function(h,e,f,g){return this.message(h,e,"error",f,g)},info:function(h,e,f,g){return this.message(h,e,"info",f,g)},message:function(o,m,v,q,t){var r="msg-tag";var n='<img src="'+km.js.config.imagePath+"/";if(v==="error"){r+=" action-errors";n+="erricon.png"}else{if(v==="info"){r+=" action-msgs";n+="infoicon.png"}}n+='" />';if(q!=null){r+=" "+q}var u="";if(o instanceof Array){u="<ul>";for(i=0;i<o.length;i++){u+="<li>"+o[i]+"</li>"}u+="</ul>"}else{u="<ul><li>"+o+"</li></ul>"}var w=$("<tr></tr>").append($("<td></td>").append($(n))).append($("<td></td>").html(u));var s=$("<table></table>").append($("<tbody></tbody>").append(w));var p=$('<div class="'+r+'" style="'+t+'"></div>').append(s);if(typeof(m)==="function"){m(p)}else{if(m instanceof jQuery){m.empty().append(p).show()}}},applyTabs:function(f){if(!(f instanceof jQuery)){throw"Argument of function km.ui.applyTabs must be a jQuery object, instead got "+typeof(f)}var d=function(b,a){a.find("div.km-tabs-panels > div.km-tabs-panel").removeClass("km-tabs-panel-active").hide();a.find("div.km-tabs-panels > div.km-tabs-panel-"+b).addClass("km-tabs-panel-active").show();a.find("ul.km-tabs-head > li.km-tabs-head-active").removeClass("km-tabs-head-active");a.find("ul.km-tabs-head > li.km-tabs-head-"+b).addClass("km-tabs-head-active");location.hash="km.tab."+b};f.find("ul.km-tabs-head > li").click((function(b,a){return function(){a($(this).index(),b)}})(f,d));var e=0;if(location.hash&&location.hash.indexOf("#km.tab.")===0){e=parseInt(location.hash.substring("#km.tab.".length))}d(e,f)},statusbar:{timer:null,stdCssClass:null,container:null,render:function(l,m,j){if(this.timer){clearTimeout(this.timer)}var n=null;if($("div."+this.cssClass).length===0){barWrapper=$("<div></div>").addClass("km-status-bar").addClass(j);n=$("<div></div>").addClass("content").appendTo(barWrapper);n.append(km.js.ui.closeBtn(function(){barWrapper.remove()}));$(document.body).append(barWrapper)}else{n=$("div."+this.cssClass+" div.content");n.find("ul.km-status-msgs").remove()}this.container=barWrapper;var k=$("<ul></ul>").addClass("km-status-msgs");if(!$.isArray(l)){var p=[];p.push(l)}else{p=l}for(var o=0;o<p.length;o++){var q=$("<li></li>").text(p[o]);k.append(q)}n.append(k);if(m){this.timer=setTimeout(function(){km.js.ui.statusbar.hide()},m)}},show:function(f,d){var e="km-status-bar-std km-status-bar-std-info";this.render(f,d,e)},err:function(c,d){this.render(c,d,"km-status-bar-std km-status-bar-std-err")},hide:function(){$(".km-status-bar").remove()}},closeBtn:function(c){var d=$("<img>").attr("src",km.js.config.imagePath+"/ex.png").addClass("km-close");d.click(function(){c()});return d},bool:function(b){b.each(function(){val=$(this).text();if(val){val=val.trim()}var a=$("<img></img>").attr("src",km.js.config.imagePath+"/"+(val=="true"?"check.gif":"uncheck.png"));$(this).empty().append(a)})},typeLookup:function(h){if(!h.types){h.types=km.js.utils.customTypes()}var g=km.js.datasource.create({type:"json",data:h.types});var j={properties:[{name:"qualifiedName"},{name:"id"},{name:"label"}]};if(""===h.selectedRecordId){selectedRecordId=null}var k={options:{id:"type-lookup-search"},display:{properties:[{name:"label",label:"Label",linkStyle:true},{name:"qualifiedName",label:"API Name",linkStyle:true}],idProperty:{name:"id"},defaultProperty:{name:"label"}},title:"Types"};var f=km.js.ref.create({datasource:g,selectedRecordDisplayField:{name:"label"},jcr:j,availableItemsDialogOptions:{afterClose:h.dialogAfterClose},availableItemsOptions:k,inputName:h.inputName,selectedRecordId:h.selectedRecordId,afterSelect:h.afterSelect,visibleInput:h.visibleInput});f.render(h.target);return f},dialog:{create:function(h){var e={size:{width:Math.floor(window.document.body.clientWidth*0.7),height:Math.floor(window.document.body.clientHeight*0.8),maxWidth:Math.floor(window.document.body.clientWidth*0.7),maxHeight:Math.floor(window.document.body.clientHeight*0.8)}};var f=$.extend(true,{},e,h);if(!f.id){f.id="km-dialog-"+km.js.utils.random(1000000)}if(f.size.fitToContent===true){f.size.width=f.size.height=null}var g={id:f.id,imagePath:km.js.config.imagePath+"/",options:f,addOpenDialog:function(a){km.js.scope.dialogs[km.js.utils.normalizeId(a.id)]=a},removeOpenDialog:function(a){delete km.js.scope.dialogs[km.js.utils.normalizeId(a)]},show:function(t){var b='<div class="km-dialog-overlay';if(!km.js.utils.isEmpty(this.options.cssClass)){b+=" "+this.options.cssClass}if(km.js.utils.isMobile()){b+=" km-dialog-mobile"}b+='" id="'+this.id+'">';b+='<div class="km-dialog"';var z="";if(!km.js.utils.isMobile()){if(f.size.width){z+="width: "+f.size.width}if(f.size.height){z+=";height: "+f.size.height}}else{z+="height: "+$(window).height()+"px"}b+='style="'+z+'">';b+='<div class="topbar">';if(!km.js.utils.isEmpty(f.title)){b+=f.title}b+='<img src="'+this.imagePath+'ex.png" class="close-btn"></div>';b+='<div class="km-dialog-content"';if(!km.js.utils.isEmpty(f.style)){b+=' style="'+f.style+'"'}b+=">";b+="</div></div></div>";var x=$(b);if(km.js.utils.isMobile()){x.find(".km-dialog-content").css("height",$(window).height()+"px")}var A=function(j){return function(){j.close()}};x.find(".close-btn").click(A(this)).mouseover(function(){$(this).attr("src",km.js.config.imagePath+"/exh.png")}).mouseout(function(){$(this).attr("src",km.js.config.imagePath+"/ex.png")});x.click(A(this));x.find(".km-dialog").click(function(j){j.stopPropagation()});if(document.getElementById(this.id)!=null){this.self().replaceWith(x)}else{$("body").append(x)}if(!km.js.utils.isEmpty(f.url)){x.find(".km-dialog-content").append('<iframe src="'+f.url+'" style="height: '+f.size.height+'"></iframe>')}else{if(f.iframe){var a=$("<html></html>");var d=$("<head></head>");if(f.iframe.addDefaultStyles===true){d.append($(km.js.utils.getCssInclude("resources/km/css/km.all.min.css")));d.append($(km.js.utils.getCssInclude("resources/layout.css")));d.append($(km.js.utils.getCssInclude("resources/tag-styles.css")));d.append($(km.js.utils.getCssInclude("resources/header.css")));d.append($(km.js.utils.getCssInclude("resources/themes/std/styles.css")));d.append($(km.js.utils.getScriptInclude("resources/km/js/km.core.js")));d.append($(km.js.utils.getScriptInclude("js/km.config.js")));d.append($(km.js.utils.getScriptInclude("resources/km/js/km.all.min.js")));d.append($(km.js.utils.getScriptInclude("resources/km/js/km.ui.js")))}if(window.kommet&&$.isArray(window.kommet.styles)){for(var v=0;v<window.kommet.styles.length;v++){d.append($('<link href="'+window.kommet.styles[v]+'" rel="stylesheet" type="text/css" />'))}}a.append(d);var u=$("<body></body>");if(f.iframe.bodyCssClass){u.addClass(f.iframe.bodyCssClass)}if(f.iframe.bodyCssStyle){u.attr("style",f.iframe.bodyCssStyle)}a.append(u.append(t));var s=this.id+"-iframe";var w=$("<iframe></iframe>").attr("id",s);if(f.iframe.cssClass){w.addClass(f.iframe.cssClass)}w.hide();x.find(".km-dialog-content").empty().append(w);var c=$("<img></img>").attr("src",km.js.config.imagePath+"/ellipsis.gif");x.find(".km-dialog-content").append(c);var y=x.find(".km-dialog-content > iframe").contents().find("body");y.addClass("km-font-scale").append(a);if(f.iframe.cssBodyClass){y.addClass(f.iframe.cssBodyClass)}x.find(".km-dialog-content > iframe").contents().find("body").replaceWith(y);w.ready((function(l,j,k){return function(){j.hide();k.show();l.adjustSize();km.js.scope.resizeEvent.listen((function(){return function(m){console.log("Adjusting iframe to changed content");l.adjustSize()}})())}})(this,c,w))}else{x.find(".km-dialog-content").append(t)}}if(typeof(this.options.beforeShow)==="function"){this.options.beforeShow(this)}$("body").css("overflow","hidden");$("html").css("overflow","hidden");this.addOpenDialog(this);return this},adjustSize:function(){var c=null,a=null;var r=30;var s=this.options.size.width;var t=this.options.size.height;var b=false;if(this.options.size.fitToContent===true){if(this.self().find("iframe").size()>0){b=true;var p=this.self().find("iframe");var u=p.attr("id");c=p.contents().find("body").height()+20;a=p.contents().find("body").width()+100;p.css("width",a+"px");p.css("height",c+"px");t=c;s=a}}s+=(2*r)+100;t+=(2*r)+40;if(this.options.size.maxHeight&&t>this.options.size.maxHeight){t=this.options.size.maxHeight}if(this.options.size.minHeight&&t<this.options.size.minHeight){t=this.options.size.minHeight}if(this.options.size.maxWidth&&s>this.options.size.maxWidth){s=this.options.size.maxWidth}if(this.options.size.minWidth&&s<this.options.size.minWidth){s=this.options.size.minWidth}console.log("Allow body scale: "+this.options.iframe.allowAdjustBodyWidth);if(b&&this.options.iframe.allowAdjustBodyWidth){p.contents().find("body").css("width",Math.floor(s*0.9))}var d=this.self().find(".km-dialog");if(!km.js.utils.isMobile()){console.log("not mobile");d.css("width",s+"px");d.css("height",t+"px");var q=d.find(".km-dialog-content");q.css("width",s+"px");q.css("height",t+"px")}else{console.log("mobile");d.css("width","100%");d.css("height",$(window).height())}this.self().find(".km-dialog-content").css("padding",r+"px")},self:function(){return $("div[id='"+this.id+"']")},close:function(){this.self().remove();$("body").css("overflow","initial");$("html").css("overflow","auto");if(typeof(this.options.afterClose)==="function"){this.options.afterClose()}this.removeOpenDialog(this.id)},hide:function(){this.self().hide();$("body").css("overflow","auto");$("html").css("overflow","auto");this.removeOpenDialog(this.id)},content:function(a){this.self().find(".km-dialog-content").html(a)},fullscreen:function(){this.self().find(".km-dialog").css("width","100%").css("height","100vh").addClass("km-dialog-fullscreen");return this}};return g},closeAllDialogs:function(){for(var b in km.js.scope.dialogs){km.js.scope.dialogs[b].close()}}}};
km.js.notifier={get:function(){var b={waits:{},onComplete:null,isComplete:false,wait:function(a){this.waits[a]=false;this.isComplete=false},reach:function(d){this.waits[d]=true;var a=true;for(wait in this.waits){if(this.waits[wait]!==true){a=false;break}}if(a===true){this.isComplete=true;this.onComplete(this)}}};return b}};
km.js.datasource={create:function(h){var e={contextPath:km.js.config.contextPath,sysContextPath:km.js.config.sysContextPath};var f=$.extend({},e,h);var g={type:f.type,data:f.data,jsti:f.jsti,jcr:null,contextPath:f.contextPath,sysContextPath:f.sysContextPath,dataLength:km.js.utils.isEmpty(f.data)?null:f.data.length,getDefaultCompare:function(a,b){return function(c,k){var d=km.js.utils.propVal(c,a);var l=km.js.utils.propVal(k,a);if(d<l){return b?1:-1}if(d>l){return b?-1:1}return 0}},query:function(d,l,k){var a=null;var b=null;if(d&&typeof(d)==="object"){a=d}else{b=d}if(this.type==="collection"){if(a){this.populateJCRIds(a,this.jsti)}return this.queryLocalCollection(a,l)}else{if(this.type==="database"){var c=function(i,j){return function(p,r,q){if(a){j.populateJCRIds(a,q)}i(p,r,q)}};return this.queryDatabase(a?a:b,c(l,this),k)}else{if(this.type==="json"){return this.queryJSONCollection(a,l)}else{console.error("Unsupported data source type "+this.type)}}}},queryDatabase:function(a,c,d){var l=null;var m=null;var n=null;if(typeof(a)==="object"){l=a;this.jcr=l;n={jcr:JSON.stringify(l),mode:"datasource"}}else{m=a;this.jcr=null;n={query:m,mode:"datasource"}}if(typeof(this.contextPath)==="undefined"){throw"Context path not set"}var b=function(k,j,i){return function(p){k.jsti=p.jsrc.jsti;k.dataLength=p.recordCount;if(typeof(j)==="function"){j(p.jsrc.records,p.recordCount,p.jsrc.jsti)}}};$.post(this.sysContextPath+"/rest/jsds/query",n,b(this,c),"json").fail(d)},queryJSONCollection:function(d,a){this.jcr=d;this.dataLength=this.data.length;var b=this.filterData();var c=b.length;b=this.sortItems(b);b=this.pageItems(b,this.jcr.limit,this.jcr.offset);if(typeof(a)==="function"){a(b,c,this.jsti)}return b},queryLocalCollection:function(C,I){this.jcr=C;this.dataLength=this.data.length;var i=this.filterData();var M=[];if(C.groupings!=null&&C.groupings.length>0){var F={};var H=C.groupings[0].property_id;for(var a=0;a<i.length;a++){var k=i[a];var B=km.js.utils.propVal(k,H);if(km.js.utils.isEmpty(B)){B=""}if($.inArray(B,M)<0){M.push(B)}var K=null;if(!km.js.utils.isEmpty(F[B])){K=F[B]}else{K={group_value:B,items:[],aggr_results:{}}}K.items.push(k);F[B]=K}var J=[];for(var c=0;c<M.length;c++){var D=M[c];var j=F[D];km.js.utils.setPropVal(j,H,D);for(var a=0;a<C.properties.length;a++){if(C.properties[a].id!=H){j[C.properties[a].id]=j.items.length}}J.push(j)}for(var a=0;a<J.length;a++){var j=J[a];for(var b=0;b<j.items.length;b++){var k=j.items[b];for(var c=0;c<C.properties.length;c++){var L=C.properties[c];if(km.js.utils.isEmpty(j.aggr_results[L.id])){j.aggr_results[L.id]={sum:0,count:0,min:null,max:null,avg:null}}var d=j.aggr_results[L.id];if(L.id!=H){var N=L.aggr;var G=L.id;if(N==="avg"){var B=km.js.utils.propVal(k,G);d.sum+=(B!=null?B:0);d.count=j.items.length}else{if(N==="sum"){var B=km.js.utils.propVal(k,G);d.sum+=(B!=null?B:0)}else{if(N==="count"){d.count=j.items.length}else{if(N==="min"){var B=km.js.utils.propVal(k,G);if(d.min==null||B<d.min){d.min=B}}else{if(N==="max"){var B=km.js.utils.propVal(k,G);if(d.max==null||B>d.max){d.max=B}}}}}}}d.avg=(d.sum/d.count).toFixed(2)}}for(var c=0;c<C.properties.length;c++){var N=C.properties[c].aggr;if(!km.js.utils.isEmpty(N)){j[C.properties[c].id]=j.aggr_results[C.properties[c].id][N]}}}i=J}var E=i.length;i=this.sortItems(i);i=this.pageItems(i,this.jcr.limit,this.jcr.offset);if(typeof(I)==="function"){I(i,E,this.jsti)}return i},filterData:function(){var c=[];if(km.js.utils.isEmpty(this.jcr)){return[].concat(this.data)}if(this.jcr.restrictions!=null&&this.jcr.restrictions.length>0){for(var k=0;k<this.data.length;k++){var a=this.data[k];var b=true;for(var i=0;i<this.jcr.restrictions.length&&b;i++){var d=this.jcr.restrictions[i];if(!this.isMeetCriteria(d,a)){b=false}}if(b){c.push(a)}}}else{c=[].concat(this.data)}return c},pageItems:function(b,c,d){var j=km.js.utils.isEmpty(d)?0:d;var a=km.js.utils.isEmpty(c)?(b.length-j):c;return b.splice(j,a)},sortItems:function(a){if(km.js.utils.isEmpty(this.jcr.orderings)||this.jcr.orderings.length==0){return a}sortProperty=this.jcr.orderings[0].property_id;sortOrder=this.jcr.orderings[0].direction;return a.sort(this.getDefaultCompare(sortProperty,sortOrder==="desc"))},populateJCRIds:function(a,c){var o=km.js.utils.getTypeFromJSTI(a,c);var i=o.qualifiedName;if(!i){throw"Type qualified name not found in JSTI. Type ID is "+a.baseTypeId}if(a.properties){for(var n=0;n<a.properties.length;n++){var p=a.properties[n];if(!p.id){p.id=km.js.utils.nestedPropertyToPir(p.name,o,c)}}}if(a.groupings){for(var n=0;n<a.groupings.length;n++){var d=a.grouping[n];if(!d.property_id){d.property_id=nestedPropertyToPir(d.property_name,o,c)}}}if(a.orderings){for(var n=0;n<a.orderings.length;n++){var b=a.orderings[n];if(!b.property_id){b.property_id=nestedPropertyToPir(b.property_name,o,c)}}}if(a.restrictions){km.js.utils.forEachRestriction(a.restrictions,(function(k,j){return function(m){if(km.js.utils.isSimpleRestriction(m)&&!m.property_id){var l=km.js.utils.getTypeFromJSTI(j,k);m.property_id=km.js.utils.nestedPropertyToPir(m.property_name,l,k)}}})(c,a))}},isMeetCriteria:function(d,i){if(d.operator.toLowerCase()==="eq"){return km.js.utils.propVal(i,d.property_id)===d.args[0]}else{if(d.operator.toLowerCase()==="ne"){return km.js.utils.propVal(i,d.property_id)!==d.args[0]}else{if(d.operator.toLowerCase()==="gt"){return km.js.utils.propVal(i,d.property_id)>d.args[0]}else{if(d.operator.toLowerCase()==="ge"){return km.js.utils.propVal(i,d.property_id)>=d.args[0]}else{if(d.operator.toLowerCase()==="lt"){return km.js.utils.propVal(i,d.property_id)<d.args[0]}else{if(d.operator.toLowerCase()==="le"){return km.js.utils.propVal(i,d.property_id)<=d.args[0]}else{if(d.operator.toLowerCase()==="ilike"){var l=km.js.utils.propVal(i,d.property_id);if(km.js.utils.isEmpty(l)){return false}else{var b=new RegExp(d.args[0].replace(/%/g,".*"),"gi");return(l+"").toLowerCase().match(b)!==null}}else{if(d.operator.toLowerCase()==="not"){if(d.args===null||d.args.length===0){throw"Empty argument list for a NOT restriction"}else{if(d.args.length>1){throw"More than one argument not allowed in a NOT restriction"}}var a=d.args[0];if(typeof a==="object"&&a!==null){return !this.isMeetCriteria(a,i)}else{throw"Argument of a NOT restriction is not an object. Its value is "+a}}else{if(d.operator.toLowerCase()==="or"||d.operator.toLowerCase()==="and"){if(d.args===null||d.args.length===0){throw"Empty argument list for a "+d.operator+" restriction"}if(d.operator.toLowerCase()==="and"){for(var c=0;c<d.args.length;c++){var a=d.args[c];if(typeof a==="object"&&a!==null){if(!this.isMeetCriteria(a,i)){return false}}else{throw"Argument of an AND restriction is not an object. Its value is "+a}}return true}else{if(d.operator.toLowerCase()==="or"){for(var c=0;c<d.args.length;c++){var a=d.args[c];if(typeof a==="object"&&a!==null){if(this.isMeetCriteria(a,i)){return true}}else{throw"Argument of an AND restriction is not an object. Its value is "+a}}return false}}}else{console.log("Criteria not supported: "+d.operator);return false}}}}}}}}}}};return g}};
km.js.buttonpanel={create:function(c){var d={buttons:[],id:c.id,cssClass:c.cssClass,options:c,addButton:function(a){this.buttons.push(a)},render:function(j){var a=$('<div class="km-btn-panel" id="'+this.id+'"></div>');if(this.cssClass){a.addClass(this.cssClass)}if(c.title){var i=$("<div></div>").text(c.title.text);if(c.title.cssClass){i.addClass(c.title.cssClass)}a.append(i)}var b=$("<div></div>").addClass("km-btn-panel-buttons");for(var h=0;h<this.buttons.length;h++){b.append(this.getButtonCode(this.buttons[h]))}a.append(b);if(typeof(j)==="function"){j(a)}else{j.html(a)}return a},getButtonCode:function(f){var b='<a href="'+(f.url?f.url:"javascript:;")+'" ';b+='class="sbtn">'+f.label+"</a>";var a=$(b);if(f.id){a.attr("id",f.id)}if(typeof(f.onClick)==="function"){a.click(f.onClick)}return a}};return d}};
km.js.table={create:function(h,l,n,i){var j={cssClass:"km-table-std",wrapperCssClass:null,contextPath:km.js.config.contextPath,dragRowCount:10,pageSize:20,afterRender:null,afterRemoveColumn:null,exportFormats:[],buttonPanel:null,pagination:{active:false,currentPage:0,pageCount:null}};var k=$.extend({},j,i);if(!n.idProperty){n.idProperty={name:"id"}}if(k.title){if(k.title.placement==="buttons-left"){if(k.buttonPanel){k.buttonPanel.title=k.title}}}var m={datasource:null,jcr:null,title:k.title,data:null,generatedCode:null,display:null,settings:null,activeDragColumnIndex:null,sortPropertyId:null,sortOrder:null,unpagedDataCount:null,id:k.id,buttonPanel:k.buttonPanel,baseType:null,pagination:k.pagination,render:function(b,c){var d=function(e,f){return function(g,s,r){var t=e.datasource.type==="json";if(!r&&!t){throw"JSTI not passed to datasource.query callback"}if(!t){e.baseType=km.js.utils.getTypeFromJSTI(f,r);e.populateIdsOnTableOptions(r,e.baseType)}e.getCode(g,s);e.rerenderFooter();e.initHeaderFilters();e.draggableColumns();e.updateHeaders();e.updateButtonPanel();if(typeof(c)==="function"){c(e.generatedCode,e)}else{c.html(e.generatedCode)}if(typeof(e.settings.afterRender)==="function"){e.settings.afterRender(e)}if(km.js.scope.resizeEvent){km.js.scope.resizeEvent.notify()}e.data=[].concat(g);e.unpagedDataCount=s}};var a=km.js.utils.isEmpty(b)?this.jcr:b;if(km.js.utils.isEmpty(a)){console.error("JCR is empty")}this.datasource.query(a,d(this,a))},rerenderRows:function(a,c,b){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call rerenderRows when no table code has been generated"}this.generatedCode.find("div.kmjstb").html(this.renderRows(a,c));if(b&&typeof(b.onComplete)==="function"){b.onComplete(this)}},populateIdsOnTableOptions:function(a,b){if(!this.display){return}if(this.display.properties&&this.display.properties.length>0){km.js.utils.populateIdsOnProperties(this.display.properties,b,a)}if(this.display.idProperty){if(!this.display.idProperty.id){if(this.display.idProperty.name){this.display.idProperty.id=km.js.utils.nestedPropertyToPir(this.display.idProperty.name,b,a)}else{throw"Neither ID property name nor its ID defined in table options"}}}else{throw"ID property not defined in km.js.table options"}},updateButtonPanel:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call updateHeaders when no table code has been generated"}if(!this.buttonPanel||!this.buttonPanel.buttons||this.buttonPanel.buttons.length===0){return}if(typeof(this.buttonPanel.render)!=="function"){throw"Button panel defined on rm.table does not have function render(). It may not have been created using rm.buttonpanel.create()"}this.buttonPanel.render(this.generatedCode.find(".km-btn-panel-container"))},updateHeaders:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call updateHeaders when no table code has been generated"}if(!km.js.utils.isEmpty(l.groupings)){for(var a=0;a<l.groupings.length;a++){var c=l.groupings[a].property_id;this.generatedCode.find("#"+this.settings.id+"-group-btn-"+c.replace(/\./g,"-")).attr("src",this.imagePath+"linkh.png")}}for(var a=0;a<l.properties.length;a++){var e=l.properties[a];var f=this.generatedCode.find("#"+this.settings.id+" .kmjsth select#aggr-"+e.id.replace(/\./g,"-"));var p=null;if(this.datasource.type!=="json"){p=this.datasource.jsti.fields[km.js.utils.lastProperty(e.id)].dataType.id}else{p=km.js.datatypes.text.id}var b=this.aggrFunctionsForDataType(p);var g="";for(var d=0;d<b.length;d++){g+='<option value="'+b[d].name+'">'+b[d].label+"</option>"}f.html(g);if(!km.js.utils.isEmpty(e.aggr)){f.val(e.aggr).show()}}},container:function(){return $("#km-table-container-"+this.settings.id)},getCode:function(b,f){var d=$('<div id="km-table-container-'+this.settings.id+'"></div>').addClass("km-table-container");if(this.title&&this.title.placement==="top"){var a=$("<div></div>").text(this.title.text).addClass("km-record-table-title");if(this.title.cssClass){a.addClass(this.title.cssClass)}d.append(a)}d.append($('<div class="km-btn-panel-container"></div>'));var c=$('<div id="km-table-wrapper-'+this.settings.id+'" class="km-table-wrapper"></div>');if(this.settings.wrapperCssClass){c.addClass(this.settings.wrapperCssClass)}d.append(c);var e=$('<div class="kmjstable '+this.settings.cssClass+'" id="'+this.settings.id+'"></div>');e.append(this.renderHeaders());e.append($('<div class="kmjstb"></div>'));d.append(e);d.append($('<div class="kmjstf"></div>'));this.generatedCode=d;this.generatedCode.find(".kmjstb").html(this.renderRows(b,f));return this.generatedCode},rerenderFooter:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call rerenderFooter when no table code has been generated"}this.generatedCode.find(".kmjstf").replaceWith(this.renderFooter())},renderFooter:function(){var f=$('<div class="kmjstf"></div>');var D=$('<div class="kmjstr"></div>');var x=this.pagination.pageCount>15?15:this.pagination.pageCount;if(this.pagination.active){var B=$('<div id="pagination-'+this.settings.id+'" class="km-pagination"></div>');B.append($('<a href="javascript:;" class="km-first km-page-no"></a>').html("&lt;&lt;"));B.append($('<a href="javascript:;" class="km-prev km-page-no"></a>').html("&lt;"));var b=$('<div class="km-page-no-no-ellipsis"></div>');for(var d=0;d<x;d++){b.append($('<a href="javascript:;" class="km-page-no km-page-'+d+'">'+(d+1)+"</a>"))}B.append(b);if(this.pagination.pageCount>x){var y=$('<div class="km-page-no-ellipsis"></div>');for(var d=x;d<(this.pagination.pageCount-1);d++){y.append($('<a href="javascript:;" class="km-page-no km-page-'+d+'">'+(d+1)+"</a>"))}B.append(y)}var z=$('<div class="km-page-no-no-ellipsis">');if(this.pagination.pageCount>x){z.append($('<a href="javascript:;" class="km-page-no km-page-'+(this.pagination.pageCount-1)+'">'+this.pagination.pageCount+"</a>"))}B.append(z);B.append($('<a href="javascript:;" class="km-next km-page-no"></a>').html("&gt;"))}D.append(B);var C=false;var e=false;if(!km.js.utils.isEmpty(this.settings.exportFormats)&&this.settings.exportFormats.length>0){var A=$('<div class="kmjstr"></div>');var g=$('<div class="km-export-btns"></div>');for(var d=0;d<this.settings.exportFormats.length;d++){if(this.settings.exportFormats[d]==="csv"){C=true;g.append($('<input type="button" class="sbtn km-export-csv" id="'+this.id+'-csv" value="CSV">'));g.append($('<form id="'+this.settings.id+'-csv-form" method="post" style="display:none"><input type="hidden" name="jcr"></form>'))}else{if(this.settings.exportFormats[d]==="xlsx"){e=true;g.append($('<input type="button" class="sbtn km-export-xlsx" id="'+this.id+'-xlsx" value="Excel">'));g.append($('<form id="'+this.settings.id+'-xlsx-form" method="post" style="display:none"><input type="hidden" name="jcr"></form>'))}else{throw"Unsupported export format "+this.options.exportFormats[d]}}}A.append(g);D.append(g)}f.append(D);var c=function(o){return function(){o.prevPage()}};var a=function(o){return function(){o.nextPage()}};var w=function(o,p){return function(){o.goToPage(p)}};if(C===true){f.find(".km-export-csv").click((function(o){return function(){o.exportToCsv()}})(this))}if(e===true){f.find(".km-export-xlsx").click((function(o){return function(){o.exportToXlsx()}})(this))}f.find(".km-prev").click(c(this));f.find(".km-next").click(a(this));f.find(".km-first").click(w(this,0));f.find(".km-last").click(w(this,this.pagination.pageCount-1));for(var d=0;d<x;d++){f.find(".km-page-"+d).click(w(this,d))}if(this.pagination.pageCount>x){f.find(".km-page-"+(this.pagination.pageCount-1)).click(w(this,(this.pagination.pageCount-1)))}return f},renderHeaders:function(){var a='<div class="kmjsth">';a+='<div class="kmjstr">';for(var b=0;b<this.display.properties.length;b++){a+='<div class="kmjstd th-'+this.display.properties[b].id.replace(/\./g,"-")+'">'+this.display.properties[b].label+"</div>"}a+="</div></div>";return $(a)},aggrFunctionsForDataType:function(b){var a=[{name:"count",label:"zliczanie"}];if(b===0){a.push({name:"sum",label:"suma"});a.push({name:"avg",label:"srednia"});a.push({name:"min",label:"minimum"});a.push({name:"max",label:"maksimum"})}return a},defaultRestrictionOperatorForType:function(a){if(a===km.js.datatypes.bool.id||a===km.js.datatypes.number.id){return"eq"}else{return"ilike"}},waitModeOn:function(){$("#"+this.settings.id+" > .kmjstb").css({filter:"alpha(opacity=40)",zoom:"1",opacity:"0.4"})},waitModeOff:function(){$("#"+this.settings.id+" > .kmjstb").css({filter:"alpha(opacity=100)",zoom:"1",opacity:"1.0"})},renderRows:function(B,c){if(!B){return""}if(this.pagination.active){this.pagination.pageCount=Math.ceil(c/this.pagination.pageSize)}var e=function(q,o,p){return q.replace(/{(.*?)}/g,function(s,r){if(r==="id"){return o}else{return km.js.utils.propVal(p,r)}})};var F=[];var g=false;if(!this.datasource.type==="database"){if(this.datasource.jsti){B=km.js.utils.addPropertyNamesToJSRC(B,this.datasource.jsti);g=true}else{throw"JSTI not defined on database datasource"}}var A=false;for(var d=0;d<this.display.properties.length;d++){var I=this.display.properties[d];if(I.url&&/{(.*?)}/.test(I.url)&&!g){if(this.datasource.type==="database"&&this.datasource.jsti){B=km.js.utils.addPropertyNamesToJSRC(B,this.datasource.jsti);g=true}else{console.warn("Requested initializing properties on record set, but it was impossible due to missing JSTI")}}}if(B.length){for(var d=0;d<B.length;d++){var G=B[d];var D='<div class="kmjstr"';var a=null;if(!km.js.utils.isEmpty(this.display.idProperty.id)){a=G[this.display.idProperty.id];if(!a){throw"ID property "+this.display.idProperty.id+" not retrieved in query"}D+=' id="'+a+'"'}D+="></div>";var b=$(D);for(var f=0;f<this.display.properties.length;f++){var I=this.display.properties[f];var C=I.id?km.js.utils.propVal(G,I.id):G;if(typeof(I.format)==="function"){C=I.format(C,G)}if(C==null){C=""}cellCode='<div class="kmjstd kmjstd-'+I.id.replace(/\./g,"-")+"";if(I.linkStyle===true){cellCode+=" kmjstda"}cellCode+='"></div>';var K=$(cellCode);var E=$("<div></div>").addClass("km-prop-mobile-label").text(I.label);K.append(E);var J=null;if(!km.js.utils.isEmpty(I.url)){J=$('<a href="'+e(I.url,G[this.display.idProperty.id],G)+'">'+C+"</a>")}else{if(C instanceof jQuery){J=C}else{J=C}}K.append(J);if(I.content&&typeof(I.content)==="function"){I.content(G,a,K)}b.append(K)}F.push(b)}}else{var H=$("<div></div>").addClass("kmjstr km-table-no-results");var K=$("<div></div>").addClass("kmjstd").text(km.js.config.i18n["msg.noresults"]);H.append(K);for(var f=1;f<this.display.properties.length;f++){H.append($("<div></div>").addClass("kmjstd"))}F.push(H)}for(var d=0;d<this.display.properties.length;d++){var I=this.display.properties[d];if(typeof(I.onClick)==="function"){var L=function(o){return function(){var p=$(this).closest(".kmjstr").attr("id");o(p)}};for(var f=0;f<F.length;f++){F[f].find(".kmjstd-"+I.id.replace(/\./g,"-")).click(L(I.onClick))}}}return F},goToPage:function(a){this.pagination.currentPage=a;this.jcr.offset=this.pagination.pageSize*a;this.update()},prevPage:function(){if(this.pagination.currentPage>0){this.goToPage(this.pagination.currentPage-1)}},nextPage:function(){if(this.pagination.currentPage<(this.pagination.pageCount-1)){this.goToPage(this.pagination.currentPage+1)}},update:function(a){var b=[].concat(this.data);var c=function(e,d){return function(g,f){e.rerenderRows(g,f);e.rerenderFooter();e.updatePaginationDisplay();e.data=[].concat(g);e.unpagedDataCount=f;if(typeof(d)==="function"){d(e)}}};if(!km.js.utils.isEmpty(l)){this.datasource.query(l,c(this,a))}else{(c(this))(b,this.unpagedDataCount)}},updatePaginationDisplay:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call updatePaginationDisplay when no table code has been generated"}this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-no").removeClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-"+this.pagination.currentPage).addClass("km-page-no-hl");if(this.pagination.currentPage==0){this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-0").addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-prev").addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-first").addClass("km-page-no-hl")}if(this.pagination.currentPage==(this.pagination.pageCount-1)){this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-"+this.pagination.currentPage).addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-next").addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-last").addClass("km-page-no-hl")}},setPageSize:function(a){this.pagination.pageSize=a;this.jcr.offset=this.pagination.pageSize*pageIndex;this.update();this.rerenderFooter()},moveColumn:function(c,b){if(c===b){return}$("#"+this.settings.id+" .kmjstr").each(function(){var d=$(this).children().eq(c);var e=$(this).children().eq(b);if(b>c){e.after(d)}else{e.before(d)}});var a=this.display.properties[c];km.js.utils.remove(c,this.display.properties);km.js.utils.insert(b,this.display.properties,a)},draggableColumns:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call draggableColumns when no table code has been generated"}var a=function(b){for(var c=0;c<b.display.properties.length;c++){var e=b.display.properties[c];if(e.draggable!==true){continue}var d=e.id.replace(/\./g,"-");var f=b.generatedCode.find(".kmjsth > .kmjstr > .th-"+d);f.draggable({helper:"clone",start:function(s,g){var u=$(this).index();b.activeDragColumnIndex=u;var v=$('<div id="drag-col-'+b.settings.id+'"></div>');var t=0;b.generatedCode.find(".kmjstr .kmjstd:nth-child("+(u+1)+")").each(function(){if(t<b.settings.dragRowCount){v.append($(this).clone());t++}else{return false}});$(g.helper).html(v);$(g.helper).css("border","1px dotted #666");$(g.helper).css("background-color","#eee").css("color","#555").css("opacity","0.9")},cursor:"move",stop:function(){var g=$("#drag-col-"+b.settings.id);g.remove()}})}b.generatedCode.find(".kmjsth > .kmjstr > .kmjstd").droppable({drop:function(g,p){if($(p.draggable).hasClass("kmjstd")){b.moveColumn(b.activeDragColumnIndex,$(this).index());b.activeDragColumnIndex=null}},tolerance:"pointer"})};return a(this)},exportToXlsx:function(){var d=this;$("#"+d.settings.id+"-xlsx-form").attr("action",km.js.config.sysContextPath+"/rest/jsds/query?format=xlsx&exportFileName="+(d.settings.exportFileName?d.settings.exportFileName:""));var b=$.extend({},d.jcr);b.offset=null;b.limit=null;b.properties=[];for(var e=0;e<d.display.properties.length;e++){var c=null;for(var a=0;e<d.jcr.properties.length;a++){if(d.jcr.properties[a].id===d.display.properties[e].id){c=d.jcr.properties[a];break}}if(c){b.properties.push(c)}}$("#"+d.settings.id+"-xlsx-form > input[name='jcr']").val(JSON.stringify(b));$("#"+d.settings.id+"-xlsx-form").submit()},exportToCsv:function(){var d=this;$("#"+d.settings.id+"-csv-form").attr("action",km.js.config.sysContextPath+"/rest/jsds/query?format=csv&exportFileName="+(d.settings.exportFileName?d.settings.exportFileName:""));var e=$.extend({},d.jcr);e.offset=null;e.limit=null;e.properties=[];for(var a=0;a<d.display.properties.length;a++){var c=null;for(var b=0;b<d.jcr.properties.length;b++){if(d.jcr.properties[b].id===d.display.properties[a].id){c=d.jcr.properties[b];break}}if(c){e.properties.push(c)}}$("#"+d.settings.id+"-csv-form > input[name='jcr']").val(JSON.stringify(e));$("#"+d.settings.id+"-csv-form").submit()},sort:function(d){var b=d.replace(/\./,"-");var a=this.container().find(".th-"+b);this.waitModeOn();var e=this.sortOrder==="asc"?"desc":"asc";a.closest(".kmjsth").find(".kmjstd .sort-btn").attr("src",this.imagePath+"sort.png");a.find(".sort-btn").attr("src",this.imagePath+"sort"+e+".png");this.sortOrder=e;this.jcr.orderings=[{property_id:d,direction:e}];var c=function(f){return function(g,p){f.rerenderRows(g,p,{onComplete:function(o){o.waitModeOff()}});f.data=[].concat(g);f.unpagedDataCount=p}};this.datasource.query(l,c(this))},initHeaderFilters:function(){var a=function(c){if(km.js.utils.isEmpty(c.generatedCode)){throw"Cannot call initHeaderFilters when no table code has been generated"}for(var g=0;g<c.display.properties.length;g++){var t=c.display.properties[g];var d=t.id.replace(/\./g,"-");var e=null;if(c.datasource.type==="database"){e=c.datasource.jsti.fields[km.js.utils.lastProperty(t.id)].dataType.id;if(!e&&e!==0){throw"Data type not retrieved for property "+JSON.stringify(t)}}var r=c.generatedCode.find(".kmjsth > .kmjstr > .th-"+d);var f=t.label;var s=t.id;var b='<span class="km-th-label">'+f+"</span>";if(t.filterable===true){b+='<div class="filter-val"></div>'}b+='<div class="km-label-btns">';if(t.groupable===true){b+='<div class="km-header-btn"><img class="group-btn" id="'+c.settings.id+"-group-btn-"+d+'" src="'+c.imagePath+'link.png"></div>'}if(t.filterable===true){b+='<div class="km-header-btn"><img class="filter-btn" id="'+c.settings.id+"-filter-btn-"+d+'" src="'+c.imagePath+'filter.png"></div>'}if(t.sortable===true){if(c.datasource.type==="database"&&e===km.js.datatypes.formula.id){console.warn("Sorting by formula field "+t.id+" skipped");t.sortable=false}else{b+='<div class="km-header-btn"><img class="sort-btn" id="'+c.settings.id+"-sort-btn-"+d+'" src="'+c.imagePath+'sort.png"></div>'}}if(t.removable===true){b+='<div class="km-header-btn"><img class="del-btn" id="'+c.settings.id+"-del-btn-"+d+'" src="'+c.imagePath+'exb.png"></div>'}b+='<select class="aggr-select" id="aggr-'+d+'">';b+='<option value="count">zliczanie</option>';b+='<option value="sum">suma</option>';b+='<option value="avg">srednia</option>';b+='<option value="min">minimum</option>';b+='<option value="max">maksimum</option>';b+="</select>";b+="</div>";if(t.filterable===true){b+='<div><input class="km-js-th-input th-input-'+d+'" type="text" placeholder="filtr"></div>'}r.html(b);if(t.filterable===true){r.find("img.filter-btn").each(function(){$(this).click(function(){var o=$(this).closest(".kmjstd").find("input.km-js-th-input");if(o.is(":visible")){o.hide()}else{$(this).closest(".kmjstr").find(".kmjstd input.km-js-th-input").hide();$(this).closest(".kmjstd").find(".filter-val").hide();o.show()}})})}if(t.sortable===true){r.find(".km-th-label").click((function(o,p){return function(){o.sort(p.id)}})(c,t));r.find("img.sort-btn").each(function(){$(this).click(function(){c.waitModeOn();var q=$(this).attr("id").substring((c.settings.id+"-sort-btn-").length);q=q.replace(/\-/g,".");var p=c.sortOrder==="asc"?"desc":"asc";$(this).closest(".kmjsth").find(".kmjstd .sort-btn").attr("src",c.imagePath+"sort.png");$(this).attr("src",c.imagePath+"sort"+p+".png");c.sortOrder=p;c.jcr.orderings=[{property_id:q,direction:p}];var o=function(v){return function(x,u){v.rerenderRows(x,u,{onComplete:function(w){w.waitModeOff()}});v.data=[].concat(x);v.unpagedDataCount=u}};c.datasource.query(c.jcr,o(c))})})}if(t.removable===true){r.find("img.del-btn").each(function(){$(this).click(function(){var o=$(this).attr("id").substring((c.settings.id+"-del-btn-").length);var p=c.isGrouped(c.datasource.jcr,o);o=o.replace(/\-/g,".");c.removeColumn(o,true);if(p){c.update()}})})}r.find(".aggr-select").each(function(){$(this).change(function(){var o=$(this).attr("id").substring("aggr-".length);c.setAggr(l,o,$("#aggr-"+o).val());c.update()})});if(t.groupable===true){r.find(".group-btn").each(function(){$(this).click(function(){var o=$(this).attr("id").substring($(this).attr("id").indexOf("-group-btn")+"-group-btn".length+1);o=o.replace(/\-/g,".");if(c.isGrouped(l,o)){$(this).attr("src",c.imagePath+"link.png");c.setGrouping(c.jcr,null);var p=$(this).closest(".kmjstr");p.find("select.aggr-select").hide()}else{var p=$(this).closest(".kmjstr");p.find("img.group-btn").attr("src",c.imagePath+"link.png");$(this).attr("src",c.imagePath+"linkh.png");c.setGrouping(c.jcr,o);p.find("select.aggr-select").show();p.find("select#aggr-"+o).hide()}c.update()})})}if(t.filterable===true){r.find("input.km-js-th-input").each(function(){$(this).focusout(function(){$(this).hide()});$(this).keyup(function(o){var p=$(this).attr("class").split(/\s+/);var v=null;for(var q=0;q<p.length;q++){if(p[q].indexOf("th-input-")==0){v=p[q].substring("th-input-".length)}}v=v.replace(/\-/g,".");if(km.js.utils.isEmpty($(this).val())){c.removeRestrictions(c.jcr,v);$(this).closest(".kmjstd").find(".filter-btn").attr("src",c.imagePath+"filter.png")}else{c.addRestriction(c.jcr,v,$(this).val());c.goToPage(0);$(this).closest(".kmjstd").find(".filter-btn").attr("src",c.imagePath+"filterh.png")}c.update()})})}}};return a(this)},setAggr:function(c,b,e){for(var a=0;a<c.properties.length;a++){var d=c.properties[a];if(d.id==b){d.aggr=e;return}}},isGrouped:function(c,b){if(c.groupings==null||c.groupings.length==0){return false}for(var a=0;a<c.groupings.length;a++){if(c.groupings[a].property_id==b){return true}}return false},setGrouping:function(c,b){c.groupings=[];if(b!=null){c.groupings.push({property_id:b});for(var a=0;a<c.properties.length;a++){var d=c.properties[a];var e=d.aggr;d.aggr=d.id===b?null:(km.js.utils.isEmpty(e)?"count":e)}}else{for(var a=0;a<c.properties.length;a++){c.properties[a].aggr=null}}},removeRestrictions:function(c,b){var d=[];for(var a=0;a<c.restrictions.length;a++){if(c.restrictions[a].property_id!=b){d.push(c.restrictions[a])}}c.restrictions=d},parseRestriction:function(d){var c={operator:null,args:[]};if(km.js.utils.isEmpty(d)){return c}d=d.trim();var a=d.split(/\s+/);if(a.length==1){c.args.push(d);return c}getRestrictionName=function(e){if(e==">"){return"gt"}else{if(e==">="){return"ge"}else{if(e=="<"){return"lt"}else{if(e=="<="){return"le"}else{if(e=="="){return"eq"}else{return null}}}}}};var b=getRestrictionName(a[0]);if(b!=null){c.operator=b;c.args.push(d.substring(a[0].length))}else{c.args.push(d)}return c},removeColumn:function(e,c){this.removeColumnFromView(e);if(!c){return}for(var d=0;d<this.display.properties.length;d++){if(this.display.properties[d].id===e){this.display.properties.splice(d,1);break}}var b=this.jcr.groupings;var f=false;if(!km.js.utils.isEmpty(b)){for(var d=0;d<b.length;d++){if(b[d].property_id===e){b.splice(d,1);f=true;break}}}var a=this.jcr.properties;for(var d=0;d<a.length;d++){if(a[d].id===e){a.splice(d,1);break}else{if(f){a[d].aggr=null;console.log("rem for "+a[d].id)}}}if(typeof(this.settings.afterRemoveColumn)==="function"){this.settings.afterRemoveColumn(e)}},everyCell:function(d,a){var e=d.replace(/\./g,"-");var c=$("#"+this.settings.id+" .th-"+e);var f=c.index();if(f<0){return}var b=function(p,g){$("#"+p.settings.id+" .kmjstr").each(function(){g($(this).children().eq(f))})};b(this,a)},removeColumnFromView:function(a){this.everyCell(a,function(b){b.remove()})},hideColumn:function(a){this.everyCell(a,function(b){b.fadeOut(400)})},showColumn:function(a){this.everyCell(a,function(b){b.fadeIn(400)})},setButtonPanel:function(a){this.buttonPanel=a;this.buttonPanel.options.title=this.title},addRestriction:function(a,v,g){var d=null;var e=false;if(!km.js.utils.isEmpty(a.restrictions)){for(var c=0;c<a.restrictions.length;c++){if(a.restrictions[c].property_id==v){d=a.restrictions[c];e=true}}}else{a.restrictions=[]}if(d==null){d={property_id:v}}var b=this.parseRestriction(g);var t=b.operator;var f=km.js.jsti.fieldData(this.settings.jsti,km.js.utils.lastProperty(v));if(km.js.utils.isEmpty(f)){throw"JSTI does not contain information about field "+v}if(t==null){t=this.defaultRestrictionOperatorForType(f.dataType.id);if(t.toLowerCase()==="like"||t.toLowerCase()==="ilike"){var s=[];for(var c=0;c<b.args.length;c++){s.push("%"+b.args[c]+"%")}}b.args=s;console.log("Using default operator "+t+" for dt "+f.dataType.id)}d.operator=t;d.args=b.args;if(f.dataType.id===km.js.datatypes.number.id){var u=[];for(var c=0;c<d.args.length;c++){u.push(parseFloat(d.args[c]))}d.args=u}else{if(f.dataType.id===km.js.datatypes.bool.id){var u=[];for(var c=0;c<d.args.length;c++){u.push(d.args[c]==="true")}d.args=u}}if(!e){a.restrictions.push(d)}}};m.datasource=h;m.jcr=l;m.data=h.data;m.display=n;m.settings=k;m.pagination.pageSize=km.js.utils.isEmpty(i.pageSize)?m.pagination.pageSize:i.pageSize;if(m.settings.paginationActive===true||m.settings.paginationActive===false){m.pagination.active=m.settings.paginationActive}if(m.datasource.type==="json"){m=this.adjustJSONDatasource(m)}if(m.pagination.active===true){m.jcr.offset=0;m.jcr.limit=m.pagination.pageSize}m.imagePath=m.settings.contextPath+"/resources/images/";return m},adjustJSONDatasource:function(i){var l=[];for(var g=0;g<i.jcr.properties.length;g++){var j=i.jcr.properties[g];j.id=j.name;l.push(j)}i.jcr.properties=l;var k=[];for(var g=0;g<i.display.properties.length;g++){var j=i.display.properties[g];j.id=j.name;k.push(j)}i.display.properties=k;if(i.jcr.groupings){var h=[];for(var g=0;g<i.jcr.groupings.length;g++){var j=i.jcr.groupings[g];j.id=j.name;h.push(j)}i.jcr.groupings=h}if(i.selectedRecordDisplayField){i.selectedRecordDisplayField.id=i.selectedRecordDisplayField.name}if(i.display.idProperty){i.display.idProperty.id=i.display.idProperty.name}if(!i.display.defaultProperty||!i.display.defaultProperty.name){throw'Option display.defaultProperty.name needs to be specified when using datasource of type "json"'}return i}};
km.js.itemlist={create:function(d){var f={addBtnImage:"attachment.png",contextPath:km.js.config.contextPath};var e={getSelectedValues:d.getSelectedValues,options:$.extend({},f,d),items:[],jsti:{},imagePath:null,render:function(a){var b='<div id="'+this.options.id+'-container">'+this.getInnerCode()+"</div>";var c=$(b);if(typeof(a)==="function"){a(c,this)}else{throw"Callback not specified while calling itemlist.render()"}},getInnerCode:function(){var l='<div class="rmcp apc"><ul>';if(this.options.addBtn===true){l+='<li class="rmcpi rmcpadd">';if(!km.js.utils.isEmpty(this.options.addBtnImage)){l+='<img src="'+this.imagePath+this.options.addBtnImage+'">'}l+="</li>"}for(var i=0;i<this.items.length;i++){l+=this.getItemCode(this.items[i])}l+="</ul></div>";var b=$(l);if(typeof(this.options.onItemClick)==="function"){var a=function(g){return function(){var h=$(this).closest("li").attr("id").substring(g.options.id.length+"-i-".length);for(var j=0;j<g.items.length;j++){if(g.items[j][g.options.idField]===h){g.options.onItemClick(g.items[j])}}}};b.find("li.kmcpi > div.kmcptxt").click(a(this))}if(this.options.removeBtn===true){var c=function(g){return function(){var h=$(this).closest("li").attr("id").substring(g.options.id.length+"-i-".length);$(this).closest("li").remove();if(typeof(g.options.afterItemDelete)==="function"){for(var j=0;j<g.items.length;j++){if(g.items[j][g.options.idField]===h){g.options.afterItemDelete(g.items[j],h)}}}}};b.find("li.kmcpi img.del").click(c(this))}if(this.options.addBtn===true&&typeof(this.options.addBtnClick)==="function"){var k=function(g){return function(){g.options.addBtnClick(g)}};b.find("li.kmcpadd").click(k(this))}return b},getItemCode:function(a){var b='<li class="rmcpi" id="'+this.options.id+"-i-"+a[this.options.idField]+'"><div class="rmcptxt">';for(var c=0;c<this.options.properties.length;c++){b+=("<span>"+a[this.options.properties[c].id]+"</span>")}b+="</div>";if(this.options.removeBtn===true){b+='<img src="'+this.imagePath+'ex.png" class="del">'}b+="</li>";return b},update:function(b){var a=function(h,c){return function(g){h.items=g.records;h.jsti=g.jsti;$("#"+h.options.id+"-container").html(h.getInnerCode());if(typeof(c)==="function"){c(h)}}};this.items=this.getSelectedValues(a(this,b))}};e.imagePath=e.options.contextPath+"/resources/images/";return e}};
km.js.tablesearch={create:function(g){var h={columns:2,searchLabel:"Search"};var e=$.extend({},h,g);var f={table:e.table,columns:e.columns,cssClass:e.cssClass,properties:e.properties,searchPropertyValues:{},searchLabel:e.searchLabel,jsti:e.jsti,originalRestrictionCount:null,render:function(b){if(!this.properties||this.properties.length==0){throw"No properties specified in the table search panel"}if(!this.table){throw"No table associated with the table search panel"}if(!this.table.jcr){throw"Table object associated with the search panel has no JCR"}if(!this.table.datasource){throw"Data source not set on the associated table"}if(!this.jsti){throw"JSTI not set on table search"}var w=$("<div></div>").addClass("km-table-search").attr("id","table-search-"+this.table.id);if(this.cssClass){w.addClass(this.cssClass)}var a=$("<div></div>").addClass("km-table-search-table");var u=this.table.baseType;if(!u){if(!this.jsti){throw"Base type on table not set and it cannot be retrieved because JSTI on table search is not set"}else{u=this.jsti.types[this.table.jcr.baseTypeId]}}km.js.utils.populateIdsOnProperties(this.properties,u,this.jsti);var x=null;for(var i=0;i<this.properties.length;i++){if(i%this.columns==0){a.append(x);x=$("<div></div>").addClass("km-table-search-row")}var z=this.properties[i];var s=this.jsti.fields[km.js.utils.lastProperty(z.id)];var c=z.label?z.label:s.label;x.append($('<div class="km-table-search-cell km-table-search-label">'+c+"</div>"));var t=$("<div></div>").addClass("km-table-search-cell");t.append(this.getSearchInput(z,s.dataType));x.append(t)}var v=this.properties.length%this.columns;if(v!==0){for(var i=0;i<v;i++){x.append($('<div class="km-table-search-cell km-table-search-label"></div>'));var t=$("<div></div>").addClass("km-table-search-cell");x.append(t)}}a.append(x);var y=this.table.buttonPanel;if(!y){y=km.js.buttonpanel.create({id:this.table.id+"-btn-panel"})}var d={label:this.searchLabel,onClick:(function(j){return function(){j.search()}})(this)};y.addButton(d);this.table.setButtonPanel(y);w.append(a);w.keypress((function(j){return function(k){if(k.keyCode==13){j.search();return false}}})(this));if(typeof(b)==="function"){b(w)}else{this.table.container().prepend(w)}return w},search:function(){var d=this.table.jcr;if(!d){throw"Associated table has null JCR"}if(this.table.jcr.restrictions){for(var b=0;b<this.table.jcr.restrictions.length;b++){if(this.table.jcr.restrictions[b].table_search_restriction===true){km.js.utils.remove(b,this.table.jcr.restrictions)}}}for(var b=0;b<this.properties.length;b++){var l=this.properties[b];var c=this.searchPropertyValues[l.id];if(c){var a=c;if(l.operator==="ilike"||l.operator==="like"){a="%"+a+"%"}var i={property_id:l.id,operator:l.operator,args:[a],table_search_restriction:true};if(!this.table.jcr.restrictions){this.table.jcr.restrictions=[]}this.table.jcr.restrictions.push(i)}}this.table.goToPage(0);this.table.update()},getSearchInput:function(a,b){var c=$("<input></input>");c.keydown((function(j,d){return function(){j[d]=$(this).val()}})(this.searchPropertyValues,a.id));if(!b){throw"Data type for property"+a.id+" not found in JSTI"}if(b.id===km.js.datatypes.number.id||b.id===km.js.datatypes.text.id||b.id===km.js.datatypes.enumeration.id||b.id===km.js.datatypes.autonumber.id){c.attr("type","text").attr("id","search-"+a.id.replace(/\./,"-"));return c}else{if(b.id===km.js.datatypes.bool.id){c.attr("type","checkbox").attr("id","search-"+a.id.replace(/\./,"-"));return c}else{if(b.id===km.js.datatypes.rid.id){c.attr("type","text").attr("id","search-"+a.id.replace(/\./,"-"));return c}else{throw"Unsupported data type ID "+b.id+" while rendering input field"}}}}};return f}};
km.js.rel={create:function(x){var t={removeBtn:true,addBtn:true};var i=$.extend({},t,x);var w=i.jsti.fields[i.fieldId];var r=null;var p=null;var q=i.jsti.types[i.typeId];if(w.dataType.id===km.js.datatypes.inverse_collection.id){if(km.js.utils.isEmpty(w.dataType.inverseTypeId)){throw"Inverse type ID not specifed"}r=i.jsti.types[w.dataType.inverseTypeId]}else{if(w.dataType.id===km.js.datatypes.association.id){if(km.js.utils.isEmpty(w.dataType.associatedTypeId)){throw"Associated type ID not specifed"}r=i.jsti.types[w.dataType.associatedTypeId]}}if(!r){throw"Associated type not defined for relation field "+JSON.stringify(w)}var u=[];for(var v=0;v<i.selectedItemProperties.length;v++){u.push({id:w.id+"."+i.selectedItemProperties[v].id})}p=function(c){var d=km.js.datasource.create({type:"database"});var a={baseTypeId:i.typeId,properties:u,restrictions:[{property_id:q.idFieldId,operator:"eq",args:[i.recordId]}]};var b=function(e){return function(f){f.records=f.length>0?f[0][w.id]:[];e(f)}};d.query(a,b(c))};u.push({id:w.id+"."+r.idFieldId});if(km.js.utils.isEmpty(i.availableItemsOptions)){i.availableItemsOptions={}}if(km.js.utils.isEmpty(i.availableItemsOptions.properties)){var s=i.jsti.fields[r.defaultFieldId];if(km.js.utils.isEmpty(s)){throw"Default field with ID "+r.defaultFieldId+" not found"}i.availableItemsOptions.properties=[{id:s.id,label:s.label}]}var n=i.getAssignableItems;if(typeof(n)!=="function"){n=function(a){var b=km.js.datasource.create({type:"database"});var d={baseTypeId:r.id,properties:[]};d.properties.push({id:r.idFieldId});for(var c=0;c<i.availableItemsOptions.properties.length;c++){d.properties.push({id:i.availableItemsOptions.properties[c].id})}b.query(d,a)}}var o={baseType:q,relationField:w,associatedType:r,id:i.id,itemList:null,getSelectedValues:p,availableItemsDialog:null,availableItemsOptions:{properties:null,title:null,tableSearchOptions:null},options:i,update:function(){var a=function(b){return function(c){$("#"+b.id).replaceWith(c)}};this.render(a(this))},render:function(a){var b=function(f){return function(g){var h=function(){return function(l,j,k){console.log("Fetched assignable data");f.openSelectDialog(l,k)}};n(h(this))}};var c=function(f){return function(h,g){console.log("Deleting "+g);km.js.data.unassociate(f.relationField.id,f.options.recordId,g)}};var d={id:"item-list-"+this.id,properties:i.selectedItemProperties,idField:r.idFieldId,onItemClick:function(f){km.js.utils.openURL(km.js.config.contextPath+"/"+f[r.idFieldId])},afterItemDelete:c(this),removeBtn:i.removeBtn,addBtn:i.addBtn,addBtnClick:b(this),getSelectedValues:p};var e=function(f){return function(g){this.itemList=km.js.itemlist.create(d);this.itemList.render((function(h){return function(j,k){itemListElem=j;if(typeof(h)==="function"){h(j)}k.update()}})(f))}};this.getSelectedValues(e(a))},openSelectDialog:function(c,b){var e={id:"av-dialog-"+this.id,width:"800px",height:"500px",cssClass:"km-rel-av-dialog",iframe:{addDefaultStyles:true,cssClass:"km-std-iframe",cssBodyClass:"km-std-iframe-body",allowAdjustBodyWidth:true}};if(this.availableItemsDialog==null){this.availableItemsDialog=km.js.ui.dialog.create(e)}var d=function(g,f){return function(j,h){var k=$('<div style="margin: 0 auto;"></div>');if(i.availableItemsOptions.title){k.append(km.js.ui.header(i.availableItemsOptions.title,null,"margin-bottom: 20px"))}k.append(j);g.show(k)}};var a=this.getAvailableItemTable(c,b,d(this.availableItemsDialog,this.title))},getAvailableItemTable:function(f,j,b){var d=km.js.datasource.create({type:"collection",data:f,jsti:j});if(km.js.utils.isEmpty(i.availableItemsOptions.properties)){throw"Properties for available items not defined"}var h={baseTypeId:this.associatedType.id,properties:[].concat(this.options.availableItemsOptions.properties)};h.properties.push({id:this.associatedType.idFieldId});var c={properties:[],idProperty:{id:this.associatedType.idFieldId}};for(var e=0;e<this.options.availableItemsOptions.properties.length;e++){c.properties.push({id:this.options.availableItemsOptions.properties[e].id,label:this.options.availableItemsOptions.properties[e].label,sortable:this.options.availableItemsOptions.properties[e].sortable,linkStyle:true,onClick:(function(y){return function(B){y.onItemSelect(B)}})(this)})}var l=km.js.table.create(d,h,c,{id:"available-items-"+this.id,jsti:j,pageSize:10,paginationActive:true,cssClass:"km-table-std km-rel-av-items",wrapperCssClass:"km-rel-av-items-wrapper",buttonPanel:this.options.availableItemsOptions.buttonPanel});var m=null;if(!km.js.utils.isEmpty(i.availableItemsOptions.tableSearchOptions)){var a={properties:[{id:this.associatedType.defaultFieldId,operator:"ilike"}],cssClass:"km-table-search-std"};var z={table:l,jsti:j};var k=$.extend({},a,i.availableItemsOptions.tableSearchOptions,z);m=km.js.tablesearch.create(k)}var g=function(y,B){return function(A,D){if(y){A=y.render().add(A)}B(A,D)}};l.render(null,g(m,b))},onItemSelect:function(b){this.availableItemsDialog.hide();var c=function(d){return function(e){d.update()}};var a=function(d){km.js.ui.statusbar.err(d.message?d.message:d.messages,10000)};km.js.data.associate(this.relationField.id,this.options.recordId,b,c(this),a)}};km.js.scope.rels[km.js.utils.normalizeId(o.id)]=o;return o}};
km.js.tabs={create:function(e){var f={originalContentHandling:"hide",cssClass:"km-tabs-std"};var e=$.extend({},f,e);var d={id:e.id,tabs:e.tabs,cssClass:e.cssClass,originalContentHandling:e.originalContentHandling,afterRender:e.afterRender,renderCount:0,render:function(a){this.renderCount++;var p=$('<ul class="km-tabs-head"></ul>');var b=$('<div class="km-tabs-panels"></div>');for(var n=0;n<this.tabs.length;n++){var o=this.tabs[n];var i=$('<li class="km-tabs-head-'+n+'">'+o.label+"</li>");i.click((function(h,g){return function(){h.open(g)}})(this,n));p.append(i);var r=$('<div class="km-tabs-panel km-tabs-panel-'+n+'"></div>');if(!(o.content instanceof jQuery)){throw"Tab content for tab "+n+" ("+o.label+") is not a jQuery object, its type is "+typeof(o.content)}if(o.content){r.html(o.content.clone());if(this.originalContentHandling==="remove"){o.content.remove()}else{o.content.hide()}}else{throw"Content not defined for tab with ID "+n+" and label "+o.label}b.append(r)}var c='<div class="km-tabs-container';if(this.cssClass){c+=" "+d.cssClass}c+='" id="'+this.id+'"></div>';var q=$(c);q.append($("<div></div>").append(p).addClass("km-tab-names-container"));q.append(b);if(typeof(a)==="function"){a(q)}else{a.html(q)}this.callAfterRender()},container:function(){return $("#"+this.id)},openActiveTab:function(){var a=0;if(location.hash&&location.hash.indexOf("#rm.tab.")===0){a=parseInt(location.hash.substring("#rm.tab.".length))}this.open(a)},open:function(a){if(typeof(this.tabs[a].beforeOpen)==="function"){this.tabs[a].beforeOpen()}this.container().find("div.km-tabs-panels > div.km-tabs-panel-active").removeClass("km-tabs-panel-active").hide();this.container().find("div.km-tabs-panels > div.km-tabs-panel-"+a).addClass("km-tabs-panel-active").show();this.container().find("ul.km-tabs-head > li.km-tabs-head-active").removeClass("km-tabs-head-active");this.container().find("ul.km-tabs-head > li.km-tabs-head-"+a).addClass("km-tabs-head-active");location.hash="rm.tab."+a},appendAfterRender:function(a){if(!this.afterRender){this.afterRender=a}else{if($.isArray(this.afterRender)){this.afterRender.push(a)}}this.callAfterRender(this.afterRender)},callAfterRender:function(){if(this.renderCount<1){return}if(typeof(this.afterRender)==="function"){this.afterRender(this)}else{if($.isArray(this.afterRender)){for(var b=0;b<this.afterRender.length;b++){var a=this.afterRender[b];if(typeof(a)==="function"){a(this)}else{throw"After render callback is not a function"}}}}}};return d}};
km.js.comments={create:function(c){var d={cssClass:"km-cmt-std",addLabel:km.js.config.i18n["comments.save"],deleteLabel:km.js.config.i18n["comments.delete"],respondLabel:km.js.config.i18n["comments.reply"],responsesLabel:km.js.config.i18n["comments.replies"],responseTitleLabel:km.js.config.i18n["comments.response.title"],noAnswersLabel:km.js.config.i18n["comments.no.replies"],title:km.js.config.i18n["comments.list.title"],commentTypePrefix:"00l",sortMode:"desc",maxResponseIndentLevel:4,maxResponseAddLevel:null,addComments:false};c=$.extend({},d,c);if(!c.id){throw"No ID passed in configuration options to the comments object"}return{id:c.id,comments:c.comments,recordId:c.recordId,title:c.title,cssClass:c.cssClass,addLabel:c.addLabel,deleteLabel:c.deleteLabel,respondLabel:c.respondLabel,responsesLabel:c.responsesLabel,responseTitleLabel:c.responseTitleLabel,noAnswersLabel:c.noAnswersLabel,recentInvocationParams:{},commentTypePrefix:c.commentTypePrefix,maxResponseIndentLevel:c.maxResponseIndentLevel,maxResponseAddLevel:c.maxResponseAddLevel,addComments:c.addComments,options:c,sortMode:c.sortMode,render:function(b){this.recentInvocationParams.renderArg=b;var f=function(h,e){return function(u){var i=u.data;var r=$('<div id="'+h.id+'" class="km-cmt '+h.cssClass+'"></div>');r.append('<div class="km-cmt-title km-title">'+h.title+"</div>");if(h.recordId&&h.addComments===true){var t=$('<div class="km-cmt-new"></div>');t.append('<div class="km-cmt-add-error"></div>');t.append('<textarea id="newcomment"></textarea>');var s=$('<a href="javascript:;" class="sbtn">'+h.addLabel+"</a>");s.click((function(j){return function(){var k=$(this).closest(".km-cmt-new").find("textarea#newcomment").first().val();var m=j.container().find("textarea#newcomment");m.prop("disabled",true);var l={content:k,recordId:j.recordId};$.post(km.js.config.sysContextPath+"/comments/save",l,(function(n,o){return function(p){if(p.success===true){n.refresh()}else{o.prop("disabled",false);km.js.ui.error(p.message,n.container().find(".km-cmt-new .km-cmt-add-error"),null)}}})(h,m),"json")}})(h));t.append(s);r.append(t)}var v=function(){var k=$('<ul class="km-cmt-list-btns"></ul>');var j=$('<li><img class="km-cmt-sort-'+h.sortMode+'" src="'+km.js.config.imagePath+"/sort"+h.sortMode+'.png" /></li>');j.find("img").click((function(l){return function(){if($(this).hasClass("km-cmt-sort-desc")){l.sort("asc")}else{l.sort("desc")}}})(h));k.append(j);return k};r.append(v());var q=$('<div class="km-cmt-list"></div>');for(var g=0;g<i.length;g++){q.append(h.commentCode(i[g],0,h.options))}r.append(q);if(typeof(e)==="function"){e(r)}else{if(e instanceof jQuery){e.empty().append(r)}else{throw"Unsupported type "+typeof(e)+" of parameter target in call to km.js.comments.render()"}}}};if(this.comments&&this.recordId){throw"Both comments list and record ID cannot be set"}if(this.recordId){var a={sort:this.sortMode,subcommentLevels:-1,additionalFields:this.options.queriedFields};$.get(km.js.config.sysContextPath+"/rest/recordcomments/"+this.recordId,a,f(this,b),"json")}else{(f(this,b))({comments:this.comments})}return this},refresh:function(){this.render(this.recentInvocationParams.renderArg)},container:function(){return $("#"+this.id)},commentCode:function(r,x,a){if(!r.id){throw"Comment has no ID"}if(!r.content){throw"Comment has no text"}var w=$('<div class="km-cmt-item km-cmt-item-'+r.id+'"></div>');var b=$('<div class="km-cmt-box"></div>');var s=$('<div class="km-cmt-head"></div>');var t=r.createdBy?r.createdBy.userName:"";s.append($('<span class="km-cmt-author">'+t+"</span>"));s.append($('<span class="km-cmt-date">'+r.createdDate+"</span>"));b.append(s);var q=$('<div class="km-cmt-content"></div>').text(km.js.utils.nl2br(r.content));b.append(q);var p=$('<div class="km-cmt-btns"></div>');if(r.canDelete===true){p.append($('<a class="km-cmt-del btn" href="javascript:;">'+this.deleteLabel+"</a>"))}if(this.addComments===true){p.append($('<a class="km-cmt-resp btn" href="javascript:;">'+this.respondLabel+"</a>"))}var v=r.comments?r.comments.length:0;p.append($('<a class="km-cmt-show-replies" href="javascript:;">'+this.responsesLabel+" ("+v+")</a>"));if(typeof(a.buttonsPostprocessor)==="function"){a.buttonsPostprocessor(r,p,a)}b.append(p);w.append(b);w.append(this.answerList(r,x,a));w.find("a.km-cmt-show-replies").click((function(e){return function(){$(this).closest(".km-cmt-item").find(".km-cmt-answer-list-"+e).toggle()}})(r.id));if(r.canDelete===true){w.find("a.km-cmt-del").each((function(e,f){return function(){var g=function(){e.container().find("textarea#newcomment").attr("disabled","disabled");$.post(km.js.config.sysContextPath+"/comments/delete",{commentId:f},function(h){e.refresh()},"json")};km.js.ui.confirm({callback:g,question:km.js.config.i18n["comments.delete.warning"],target:$(this)})}})(this,r.id))}if(this.addComments===true){w.find("a.km-cmt-resp").click((function(e,f){return function(){$(this).closest(".km-cmt-item").find(".km-cmt-resp-form-"+f).toggle();$(this).closest(".km-cmt-item").find(".km-cmt-resp-form-"+f+" > textarea").attr("id","km-cmt-resp-text-"+f)}})(this,r.id));if(!this.maxResponseAddLevel||x<=this.maxResponseAddLevel){var u=$('<div class="km-cmt-resp-form km-cmt-resp-form-'+r.id+'"><div class="km-cmt-resp-title">'+this.responseTitleLabel+"</div><textarea></textarea></div>");if(x<=this.maxResponseIndentLevel){u.css("padding-left","5%")}var o=$('<a href="javascript:;" class="sbtn">'+this.addLabel+"</a>");o.click((function(e){return function(){var i=$(this).closest(".km-cmt-resp-form").find("textarea");var g=i.first().val();i.attr("disabled","disabled");$(this).attr("disabled","disabled");var f=i.attr("id").substring("km-cmt-resp-text-".length);var h={content:g,parentId:f,recordId:e.recordId};$.post(km.js.config.sysContextPath+"/comments/save",h,"json").done(function(j){console.log("S: "+JSON.stringify(j));e.refresh()}).fail(function(j){console.log("E: "+JSON.stringify(j));e.refresh()})}})(this));u.append(o);w.append(u)}}return w},sort:function(a){if(a!=="asc"&&a!=="desc"){throw'Unsupported sort direction "'+direction+'"'}this.sortMode=a;this.refresh()},answerList:function(i,j,h){var a=$('<div class="km-cmt-answer-list km-cmt-answer-list-'+i.id+'"></div>');if(j<=this.maxResponseIndentLevel){a.css("padding-left","5%")}if(i.comments&&i.comments.length>0){for(var b=0;b<i.comments.length;b++){a.append(this.commentCode(i.comments[b],j+1,h))}}else{a.append('<div class="km-cmt-no-replies">'+this.noAnswersLabel+"</div>")}return a}}}};
km.js.ref={create:function(e){var d=function(a){if(!a.datasource){a.datasource=km.js.datasource.create({type:"database"})}if(!a.id){a.id="km-ref-"+km.js.utils.random(1000000)}if(a.datasource.type==="json"){if(a.availableItemsOptions&&a.availableItemsOptions.display&&a.availableItemsOptions.display.idProperty&&!a.availableItemsOptions.display.idProperty.id){a.availableItemsOptions.display.idProperty.id=a.availableItemsOptions.display.idProperty.name}}return a};e=d(e);var f={recentRenderParams:null,inputName:e.inputName,inputId:e.inputId,visibleInput:e.visibleInput,selectedRecordId:e.selectedRecordId,selectedRecordDisplayName:e.selectedRecordDisplayName,selectedRecordDisplayField:e.selectedRecordDisplayField,availableItemsOptions:e.availableItemsOptions,datasource:e.datasource,jcr:e.jcr,dialog:null,id:e.id,dialogOptions:e.availableItemsDialogOptions,afterSelect:e.afterSelect,afterClear:e.afterClear,mode:e.mode?e.mode:"edit",editable:e.editable,render:function(a){if(this.selectedRecordId&&!this.selectedRecordDisplayName){if(!this.selectedRecordDisplayField){throw"Display field not defined. Specify option selectedRecordDisplayField in configuration of the rm.ref component."}else{if(!this.selectedRecordDisplayField.id&&!this.selectedRecordDisplayField.name){throw"Neither selectedRecordDisplayField ID nor its name specified"}}var m={baseTypeId:this.jcr.baseTypeId,baseTypeName:this.jcr.baseTypeName,properties:[{id:this.selectedRecordDisplayField.id,name:this.selectedRecordDisplayField.name}],restrictions:[{operator:"eq",property_id:this.availableItemsOptions.display.idProperty.id,property_name:this.availableItemsOptions.display.idProperty.name,args:[this.selectedRecordId]}]};this.datasource.query(m,(function(g){return function(h,k,i){if(!g.selectedRecordDisplayField.id){if(g.datasource.type!=="json"){var j=km.js.utils.getTypeFromJSTI(g.jcr,i);if(!j){throw"Base type not retrieved"}g.selectedRecordDisplayField.id=km.js.utils.nestedPropertyToPir(g.selectedRecordDisplayField.name,j,i);if(!g.selectedRecordDisplayField.id){throw"Could not get ID for select record display field with name '"+g.selectedRecordDisplayField.name+"' on type "+j.qualifiedName}}else{if(!g.availableItemsOptions.display.defaultProperty.name){throw'Option display.defaultProperty.name name not defined on km.js.table using datasource of type "json"'}g.selectedRecordDisplayField.id=g.availableItemsOptions.display.defaultProperty.name}}if(h.length===0){throw"Selected record with ID "+g.selectedRecordId+" not found"}else{g.setDisplayValue(h[0][g.selectedRecordDisplayField.id])}}})(this))}this.recentRenderParams=a;if(!this.id){throw"Object reference ID is not defined"}if(!this.dialog){var c={size:{fitToContent:true},iframe:{addDefaultStyles:true,cssClass:"km-std-iframe",cssBodyClass:"km-std-iframe-body",allowAdjustBodyWidth:true},id:this.id+"-items-dialog",style:"background-color: #fff"};var n=$.extend({},c,this.dialogOptions);this.dialog=km.js.ui.dialog.create(n)}var o=$('<div class="km-lookup" id="km-lookup-'+this.id+'"></div>');if(!this.inputName){throw"Reference input name must not be empty. Specify inputName option in lookup configuration"}if(this.mode==="view"){o.addClass("km-readonly-lookup");if(this.editable===true){o.click((function(g){return function(h){g.makeEditable()}})(this))}}var b=$('<input type="hidden" class="km-lookup-val" name="'+this.inputName+'"></input>');if(this.selectedRecordId){b.val(this.selectedRecordId)}if(this.inputId){b.attr("id",this.inputId)}o.append(b);var l=$('<input class="km-lookup-display-name" type="text" readonly="true"></input>');if(this.visibleInput&&this.visibleInput.cssClass){l.addClass(this.visibleInput.cssClass)}l.click((function(g){return function(){if(g.isEditable()){console.log("Opening available items");g.openAvailableItems()}}})(this));o.append(l);if(this.mode==="view"&&this.editable===true){l.blur((function(g){return function(){g.makeIneditable()}})(this))}var p=$('<img class="km-lookup-del" src="'+km.js.config.imagePath+'/ex.png">');p.click((function(g){return function(){g.clear()}})(this));o.append(p);if(a){if(typeof(a)==="function"){a(o,this)}else{if(a instanceof jQuery){console.log("Target "+a.size()+", target desc: "+a+" ("+JSON.stringify(a)+")");a.replaceWith(o)}else{throw"Unsupported argument type "+typeof(a)+" while calling ref.render()"}}if(this.selectedRecordDisplayName){this.setDisplayValue(this.selectedRecordDisplayName)}}return o},isEditable:function(){return !this.container().hasClass("km-readonly-lookup")},makeEditable:function(){this.container().removeClass("km-readonly-lookup")},makeIneditable:function(){this.container().addClass("km-readonly-lookup")},clear:function(){this.setDisplayValue(null);this.container().find("input.km-lookup-val").val(null);if(typeof(this.afterClear)==="function"){this.afterClear(this.selectedRecordId)}this.selectedRecordId=null},refresh:function(){this.render(this.recentRenderParams)},openAvailableItems:function(){var c={id:this.id+"-ait",options:{pageSize:10,paginationActive:true}};var a={};for(var m=0;m<this.availableItemsOptions.display.properties.length;m++){var i=this.availableItemsOptions.display.properties[m];i.onClick=(function(g){return function(h){g.select(h)}})(this)}var l=$.extend({},c,this.availableItemsOptions,a);var n=km.js.table.create(this.datasource,this.jcr,l.display,l.options);var b=function(g){return function(x,z){var v=null;var y=z.datasource.type==="json";if(!z.datasource.jsti&&!y){throw"JSTI not available on datasource related to available items table"}var w=null;if(!y){w=km.js.utils.getTypeFromJSTI(g.jcr,z.datasource.jsti);if(!w){throw"Type information not found in JSTI for type KID "+g.jcr.baseTypeId}}if(!km.js.utils.isEmpty(g.availableItemsOptions.tableSearchOptions)){console.log("Adding table search for type "+JSON.stringify(w));var A={properties:[{id:w.defaultFieldId,operator:"ilike"}],cssClass:"km-table-search-std"};var k={table:z,jsti:z.datasource.jsti};var B=$.extend({},A,g.availableItemsOptions.tableSearchOptions,k);if(!y){km.js.utils.populateIdsOnProperties(B.properties,w,z.datasource.jsti)}v=km.js.tablesearch.create(B)}var h=$("<div></div>");var j=g.availableItemsOptions.title?g.availableItemsOptions.title:w.pluralLabel;h.append(km.js.ui.header(j,null,"margin-bottom: 20px"));if(v){x=v.render().add(x)}h.append(x);g.dialog.show(h)}};n.render(null,b(this))},container:function(){var a=$("div[id='km-lookup-"+this.id+"']");if(a.length>1){throw"Ambiguous container, found "+a.length+" such elements instead of one"}return a},select:function(a){this.dialog.hide();this.selectedRecordId=a;this.selectedRecordDisplayName=null;if(this.mode==="view"&&this.editable===true){this.container().addClass("km-readonly-lookup")}if(typeof(this.recentRenderParams)==="function"){this.render(this.recentRenderParams);if(typeof(this.afterSelect)==="function"){this.afterSelect(this.selectedRecordId)}}else{if(this.recentRenderParams instanceof jQuery){this.render(this.container());if(typeof(this.afterSelect)==="function"){this.afterSelect(this.selectedRecordId)}}else{throw"Unsupported recent invocation param type: "+typeof(this.recentRenderParams)}}},setDisplayValue:function(a){this.container().find("input.km-lookup-display-name").val(a);this.selectedRecordDisplayName=a}};km.js.scope.refs[km.js.utils.normalizeId(f.id)]=f;return f}};
km.js.validation={init:function(b){if(!b){b=$(document)}else{if(!(b instanceof jQuery)){throw"Target of validation.init must be a jQuery object"}}b.find("input[km-validate=number]").each((function(a){return function(){$(this).change(function(d){a.validateNumber($(this),d)});$(this).blur(function(d){a.validateNumber($(this),d)})}})(this))},isValidNumber:function(b){return(new RegExp(km.js.config.localeNumberFormat)).test(b)},validateNumber:function(e,d){var f=e.val();if(f&&!this.isValidNumber(e.val())){e.addClass(this.errorClass);e.focus()}else{e.removeClass(this.errorClass)}},errorClass:"km-validate-err"};
km.js.fileupload={create:function(g){var h={id:"file-upload",parentDialog:null};var f=$.extend({},h,g);var e=km.js.ui.dialog.create({id:f.id,size:{width:"800px",height:"600px"},url:km.js.config.sysContextPath+"/files/new?"+(f.parentDialog?"parentDialog="+f.parentDialog:"")+(f.recordId?"&recordId="+f.recordId:""),afterClose:f.afterClose});return e}};
km.js.userlookup={create:function(k){var l={id:"user-lookup"};var g=$.extend({},l,k);var h={baseTypeName:"kommet.basic.User",properties:[{name:"userName"},{name:"id"}]};var j={options:{id:"user-search"},display:{properties:[{name:"userName",label:"User Name",linkStyle:true}],idProperty:{name:"id"}},title:"Users",tableSearchOptions:{properties:[{name:"userName",operator:"ilike"}]}};var i=km.js.ref.create({selectedRecordDisplayField:{name:"userName"},jcr:h,availableItemsDialogOptions:{},availableItemsOptions:j,inputName:g.inputName,inputId:g.inputId,visibleInput:g.visibleInput,selectedRecordId:g.selectedRecordId});return i}};
km.js.devitems={create:function(h){var e={items:null,group:"package",checkboxes:false,checkboxCallback:null};var g=$.extend({},e,h);var f={options:g,container:null,render:function(k,W){var aa=W?$.extend({},this.options,W):this.options;this.container=$("<div></div>").addClass("km-dev-items-container");this.container.append(this.getBtnPanel(aa));if(!aa.items){throw"Item collection has not been provided"}if(aa.group==="type"){var O=$("<ul></ul>").addClass("km-devitems-tree");var P=aa.types;var ac=0;if(P&&$.isArray(P)){var b=$("<ul></ul>");var I={};for(var L=0;L<P.length;L++){var Y=P[L];var c=Y.qualifiedName.split(".");var U=aa.selectedItemIds&&km.js.utils.isObject(aa.selectedItemIds[Y.id]);if(U||aa.ignoreSelection){ac++}I=this.addItemToTree(I,c,c,Y.id,U);for(var a=0;a<Y.fields.length;a++){var Q=Y.fields[a];if(Q.isSystem){continue}var K=aa.selectedItemIds&&aa.selectedItemIds[Q.id];if(K||aa.ignoreSelection){ac++}var S=(Y.qualifiedName+"._"+Q.apiName).split(".");I=this.addItemToTree(I,S,S,Q.id,K,{field:Q})}}b=this.appendItemTree(b,I,this,1,aa,false);var M=$("<a></a>").text("Types and fields ("+ac+")").addClass("km-devitems-type");M.click(function(){$(this).closest("div.km-devitems-typegroup-name").siblings("ul").children("li").toggle()});var i=$("<div></div>").addClass("km-devitems-typegroup-name");var R=$("<span></span>").addClass("km-devitems-typegroup-icon").append($("<i></i>").addClass("fa fa-folder km-devitem-icon"));i.append(R).append(M);var d=$("<li></li>").append(i).append(b);O.append(d)}for(typeId in aa.items){var ab=km.js.config.componentTypes[typeId];if(!ab){throw"Component type with ID "+typeId+" not found"}var b=$("<ul></ul>");var T=aa.items[typeId];if(T){if($.isArray(T)){var I={};for(var L=0;L<T.length;L++){var J=T[L];var Z=[];var V=null;for(var N in J){if(N.indexOf("003")!==0){continue}var Q=aa.jsti.fields[N];if(Q.apiName==="id"){V=J[N]}else{var X=J[N];Z.push(X)}}var c=Z.join(".").split(".");var U=aa.selectedItemIds&&aa.selectedItemIds[V];I=this.addItemToTree(I,c,c,V,U)}b=this.appendItemTree(b,I,this,1,aa,false)}else{throw"Items for component type ID "+typeId+" are not represented in an array"}}var ad=ab.name.toLowerCase().replace(/\_/g," ");var M=$("<a></a>").text(ad+" ("+T.length+")").addClass("km-devitems-type");M.click(function(){$(this).closest("div.km-devitems-typegroup-name").siblings("ul").children("li").toggle()});var i=$("<div></div>").addClass("km-devitems-typegroup-name");var R=$("<span></span>").addClass("km-devitems-typegroup-icon").append($("<i></i>").addClass("fa fa-folder km-devitem-icon"));i.append(R).append(M);var d=$("<li></li>").append(i).append(b);O.append(d)}this.container.append(O)}else{if(aa.group==="package"){throw"Grouping by package not supported"}else{throw"Unsupported dev item grouping '"+aa.group+"'"}}this.container.append(O);if(typeof(k)==="function"){k(this.container,this)}else{if(k instanceof jQuery){k.empty().append(this.container)}}this.collapse()},collapse:function(){this.container.find("li.km-devitems-enditem-li").hide();this.container.find("li.km-devitems-package-li").hide()},addItemToTree:function(m,a,c,d,n,l){if(a.length>1){var b=m[a[0]];if(!b){m[a[0]]={};b=m[a[0]]}a.splice(0,1);b=this.addItemToTree(b,a,c,d,n,l)}else{if(m[a[0]]){throw"The same item "+a[0]+" added twice"}m[a[0]]={name:a[0],qualifiedName:c.join("."),id:d,isSelected:n,options:l}}return m},appendItemTree:function(C,A,F,N,D,M){for(var H in A){var d=A[H];if(M&&!km.js.utils.isObject(d)){continue}var I=M?H.substring(1):H;var E=$("<li></li>");var z=$("<span></span>").text(I).addClass("km-devitems-item-name");var G=$("<div></div>").css("padding-left",(2*N)+"em");var L=$("<a></a>").append(z);if(d.id){L.addClass("km-devitems-enditem");E.addClass("km-devitems-enditem-li").attr("id","km-devitems-enditem-li-"+d.id);E.append($("<input></input>").val(d.qualifiedName).attr("name","qualifiedName").attr("type","hidden"));if(typeof(F.options.itemClick)==="function"){L.click((function(i,j){return function(){i(j)}}(F.options.itemClick,d)))}if(D.checkboxes===true){var B=$("<input></input>").attr("type","checkbox").attr("id","record_"+d.id);if(d.isSelected){B.attr("checked","checked")}if(typeof(D.onCheck)==="function"){B.click((function(i){return function(){D.onCheck(i)}})(d))}G.append($("<div></div>").addClass("km-devitems-checkbox-wrapper").append(B))}if(typeof(D.onClick)==="function"){L.click((function(i,j){return function(){D.onClick(i);j.toggleClass("km-devitems-selected")}})(d,E))}var J=$("<div></div>").addClass("km-devitems-icon-wrapper");var K=$("<i></i>").addClass("fa fa-file km-devitem-icon");J.append(K);G.append(J);G.append(L);if(M){var c=d.options.field;if(!c){throw"Field definition not set"}var a=$("<div></div>").addClass("km-field-info");a.text("("+c.datatype.name+")");G.append(a)}E.append(G);if(d.isSelected){E.addClass("km-devitems-selected")}else{if(D.unselectedItemCssClass){E.addClass(D.unselectedItemCssClass)}}if(d.id.indexOf("002")===0){E.addClass("km-devitems-type-li");L.click((function(){return function(){$(this).closest(".km-devitems-type-li").children("ul").children("li").toggle()}}()));var b=$("<ul></ul>");this.appendItemTree(b,d,F,N+1,D,true);E.append(b)}}else{L.addClass("km-devitems-package");E.addClass("km-devitems-package-li");E.append(L);L.click((function(){return function(){$(this).closest(".km-devitems-package-li").children("ul").children("li").toggle()}}()));var y=$("<i></i>").addClass("fa fa-list km-devitem-icon");y.click((function(){return function(){$(this).closest(".km-devitems-package-li").children("ul").children("li").toggle()}}()));G.append($("<div></div>").addClass("km-devitems-icon-wrapper").append(y));G.append(L);E.append(G);var b=$("<ul></ul>");this.appendItemTree(b,d,F,N+1,D,false);E.append(b)}C.append(E)}return C},getBtnPanel:function(a){var b=$("<div></div>").addClass("km-devitems-btns");return b}};return f}};
km.js.calendar={create:function(c){var d={range:"week",daysPerRow:7,cssClass:"km-cal-std",hourStart:7,hourEnd:18,eventUrl:"events/{id}",hours:true,formatDate:function(a){return a!==null?this.stdDateFormat(a,"-"):""}};c=$.extend({},d,c);return{range:c.range,startDate:c.startDate,endDate:c.endDate,hourStart:c.hourStart,hourEnd:c.hourEnd,hours:c.hours,formatDate:c.formatDate,daysPerRow:c.daysPerRow,cssClass:c.cssClass,defaultEventDuration:3600000,eventUrl:c.eventUrl,id:c.id?c.id:"cal-"+(Math.floor(Math.random()*1000)+1),addEvents:function(a){for(var b=0;b<a.length;b++){this.addEvent(a[b])}},showRange:function(h,b){if(h<this.startDate){h=this.startDate}if(b>this.endDate){b=this.endDate}this.container().find(".km-cal-day").hide();for(var a=new Date(h);a<=b;a.setDate(a.getDate()+1)){var g=this.stdDateFormat(a,"");this.container().find(".km-cal-day-"+g).show()}},addEvent:function(z){var t=this.hourStart;var x=z.duration?z.duration:this.defaultEventDuration;var r=new Date(z.startDate);var a=new Date(z.startDate+x);if(r.getHours()<this.hourStart){if(a.getHours()<this.hourStart){console.log("Ignoring event "+z.name);return}}else{t=r.getHours()}var b=$('<div class="km-cal-event"></div>');b.append('<div class="km-cal-event-inner"><a class="km-cal-event-link" href="'+this.eventUrl.replace(/{id}/g,z.id)+'">'+z.name+"</a></div>");var B=this.stdDateFormat(r,"")+t;var v=this.container().find("div.km-cal-hour-"+B+" > div.km-cal-event-content").first();var u=this.container().find("div.km-cal-hour-"+this.stdDateFormat(r,"")+(a.getHours()+(a.getMinutes()>0?1:0))+" > div.km-cal-event-content").first();var A=u.position().top;var q=null;if(a.getHours()>r.getHours()){q=this.container().find("div.km-cal-hour-"+(this.stdDateFormat(r,"")+(a.getHours()-1))+" > div.km-cal-event-content").first()}else{q=v}var y=q.position().top;console.log("Event: "+z.name+", MIN: "+a.getMinutes());console.log("NEXT: "+A+", BUT: "+y);var s=v.position().top;var w=a.getMinutes()>0?(y+(a.getMinutes()*(A-y))/60):A;b.css("height",w-s);v.append(b)},container:function(){return $("#"+this.id)},render:function(l){var j='<div class="km-cal-container '+this.cssClass+'" id="'+this.id+'">';var a=$('<div class="km-cal-days"></div>');var k=0;for(var b=new Date(c.startDate);b<=c.endDate;b.setDate(b.getDate()+1)){if(k%this.daysPerRow===0){a.append('<div class="km-cal-day-row"></div>')}a.append(this.renderDay(b));k++;if(k%this.daysPerRow===0){a.append("</div>")}}j+="</div>";var i=$(j);i.append(a);if(typeof(l)==="function"){l(i)}else{l.append(i)}},stdDateFormat:function(f,a){var b=function(h){var e=h+"";return e.length==1?"0"+e:e};return f.getFullYear()+a+b(f.getMonth()+1)+a+b(f.getDate())},renderDay:function(f){var a=this.stdDateFormat(f,"");var b=$('<div class="km-cal-day km-cal-day-'+a+'"></div>');b.append('<div class="km-cal-date-label">'+this.formatDate(f)+"</div>");if(this.hours===true){b.append(this.renderHours(f))}return b},renderHours:function(b){var a='<div class="km-cal-hours">';for(var f=this.hourStart;f<=this.hourEnd;f++){a+='<div class="km-cal-hour km-cal-hour-'+this.stdDateFormat(b,"")+f+'"><div class="km-cal-hour-num">';a+=f+".00";a+='</div><div class="km-cal-event-content"></div></div>'}a+="</div>";return $(a)},}}};
km.js.rightpanel={create:function(e){var f={recentItems:{show:true,count:5},notifications:{show:true,count:5},icon:null};var g=$.extend({},f,e);var h={options:g,container:null,render:function(a){this.container=$("<div></div>").addClass("km-rp-container");this.container.append(this.userInfo());if(typeof(a)==="function"){a(this.container,this)}else{if(a instanceof jQuery){a.empty().append(this.container)}}this.initNotifications(this.container);this.initTasks(this.container);this.initEvents(this.container)},initNotifications:function(b){var a=km.js.datasource.create({type:"database"});var c={baseTypeName:"kommet.basic.Notification",properties:[{name:"id"},{name:"text"},{name:"title"},{name:"viewedDate"},],restrictions:[{property_name:"assignee.id",operator:"eq",args:[km.js.config.authData.user.id]},{property_name:"viewedDate",operator:"isnull",args:[]}]};a.query(c,(function(l,d,k){return function(D,B,A){D=km.js.utils.addPropertyNamesToJSRC(D,A);var i=$("<div></div>").addClass("km-rp-list-wrapper");var J=$("<ul></ul>").addClass("km-rp-list");var H=$("<div></div>").addClass("km-rp-list-title").text(km.js.config.i18n["notif.notification.title"]+" ("+D.length+")");i.append(H);var y=0;if(D.length>0){for(var z=0;z<D.length;z++){var C=D[z];var G=$("<li></li>");var H=$("<div></div>").addClass("km-rp-list-item-title").text(C.title);var I=$("<img></img>").attr("src",km.js.config.imagePath+"/ex.png").addClass("km-rp-list-close");I.click((function(m,n){return function(){console.log("Deleting notification "+m);$.post(km.js.config.contextPath+"/km/notifications/setviewed",{id:m},function(o){if(o.status==="success"){G.remove()}else{km.js.ui.statusbar.show("Could not set notification as viewed",10000)}},"json")}})(C.id,G));H.append(I);var F=$("<div></div>").addClass("km-rp-list-item-text").text(C.text);G.append(H).append(F);if(!C.viewedDate){y++;G.addClass("km-unread")}G.click((function(m){return function(){var n={id:m,viewedDate:(new Date()).getTime()};km.js.db.update(n,(function(o){return function(){o.removeClass("km-unread");o.fadeOut(500)}})($(this)))}})(C.id));J.append(G)}var j=$("<div></div>").append(J).addClass("km-rp-item-wrapper");if(D.length>5){j.addClass("km-rp-scroll")}i.append(j);if(y&&(d instanceof jQuery)){var E=$("<div></div>").addClass("km-alert-numbers");E.text(y);E.click((function(m){return function(){m()}})(k));d.append(E)}}else{i.append($("<div></div>").addClass("km-rp-list-noitems").text(km.js.config.i18n["rightpanel.list.noitems"]))}l.append(i)}})(b,this.options.icon,this.options.openCallback))},initTasks:function(b){var a=km.js.datasource.create({type:"database"});var c={baseTypeName:"kommet.basic.Task",properties:[{name:"id"},{name:"content"},{name:"title"}],restrictions:[{property_name:"assignedUser.id",operator:"eq",args:[km.js.config.authData.user.id]}]};a.query(c,(function(d){return function(i,x,B){i=km.js.utils.addPropertyNamesToJSRC(i,B);var z=$("<div></div>").addClass("km-rp-list-wrapper");var y=$("<ul></ul>").addClass("km-rp-list");var C=$("<div></div>").addClass("km-rp-list-title km-rp-list-title-clickable").text(km.js.config.i18n["rightpanel.tasks.title"]+" ("+i.length+")");C.click(function(){km.js.utils.openURL(km.js.config.contextPath+"/km/tasks/userlist")});z.append(C);if(i.length>0){for(var A=0;A<i.length;A++){var D=i[A];var w=$("<li></li>").addClass("km-rp-list-item-link");var C=$("<div></div>").addClass("km-rp-list-item-title").text(D.title);w.click((function(k,j){return function(){km.js.utils.openURL(km.js.config.contextPath+"/km/tasks/userlist?id="+k)}})(D.id,w));var v=$("<div></div>").addClass("km-rp-list-item-text").text(D.content);w.append(C).append(v);y.append(w)}var u=$("<div></div>").append(y).addClass("km-rp-item-wrapper");if(i.length>5){u.addClass("km-rp-scroll")}z.append(u)}else{z.append($("<div></div>").addClass("km-rp-list-noitems").text(km.js.config.i18n["rightpanel.list.noitems"]))}d.append(z)}})(b))},initEvents:function(c){var b=new Date();b.setHours(0);b.setMinutes(0);b.setSeconds(0);var a=new Date(b);a.setDate(a.getDate()+6);a.setHours(23);a.setMinutes(59);a.setSeconds(59);$.get(km.js.config.contextPath+"/km/rest/events",{startDate:b.getTime(),endDate:a.getTime(),userId:km.js.config.authData.user.id},(function(d){return function(z){var B=z.data.events;var w=$("<div></div>").addClass("km-rp-list-wrapper");var v=$("<ul></ul>").addClass("km-rp-list");var u=$("<div></div>").addClass("km-rp-list-title").text(km.js.config.i18n["rightpanel.events.title"]+" ("+B.length+")");w.append(u);if(B.length>0){for(var y=0;y<B.length;y++){var A=B[y];var t=$("<li></li>").addClass("km-rp-list-item-link");var u=$("<div></div>").addClass("km-rp-list-item-title").text(A.name);t.click((function(k,j){return function(){km.js.utils.openURL(km.js.config.contextPath+"/km/events/"+k)}})(A.id,t));var i=$("<div></div>").addClass("km-rp-list-item-text").text(A.description?A.description.substring(0,40):"");t.append(u).append(i);v.append(t)}var x=$("<div></div>").append(v).addClass("km-rp-item-wrapper");if(records.length>5){x.addClass("km-rp-scroll")}w.append(x)}else{w.append($("<div></div>").addClass("km-rp-list-noitems").text(km.js.config.i18n["rightpanel.list.noitems"]))}d.append(w)}})(c))},userInfo:function(){var a=$("<div></div>").addClass("km-rp-username-wrapper");a.append($("<div></div>").addClass("km-rp-username-title").text(km.js.config.i18n["rightpanel.loggedin.as"]));a.append($("<div></div>").addClass("km-rp-username").text(km.js.config.authData.user.userName));return a}};return h}};
km.js.ide={getJavaHints:function(k,i,l,g,h,j){$.post(km.js.config.contextPath+"/km/livejavahints",{code:k,varName:i,methodName:l,line:g,position:h},(function(a){return function(b){var c=[];for(var d=0;d<b.data.methods.length;d++){var e=b.data.methods[d].name;c.push({text:(l?"":".")+e+"()",displayText:e})}a(c)}})(j),"json")},getControllerTemplate:function(b){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"controller",templateFileName:"kommet.example.MyController"},function(d){if(d.success===true){var a={name:"MyController",content:d.data.source,mode:"text/x-java",type:"class",fileData:d.data.fileData};console.log("Calling callback");b(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getClassTemplate:function(b){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"class",templateFileName:"kommet.example.MyClass"},function(d){if(d.success===true){var a={name:"MyClass",content:d.data.source,mode:"text/x-java",type:"class",fileData:d.data.fileData};b(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getTriggerTemplate:function(c,d){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"trigger",templateFileName:"kommet.example.SampleTrigger",typeName:d?d.type:null},function(b){if(b.success===true){var a={name:"SampleTrigger",content:b.data.source,mode:"text/x-java",type:"class",fileData:b.data.fileData};c(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getBusinessActionTemplate:function(b){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"businessAction",templateFileName:"kommet.example.MyBusinessAction"},function(d){if(d.success===true){var a={name:"MyBusinessAction",content:d.data.source,mode:"text/x-java",type:"class",fileData:d.data.fileData};b(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getViewTemplate:function(b){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"view",templateFileName:"kommet.views.MyView"},function(d){if(d.success===true){var a={name:"MyView",content:d.data.source,mode:"xml",type:"view"};b(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getLayoutTemplate:function(b){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"layout",templateFileName:"kommet.views.MyLayout"},function(d){if(d.success===true){var a={name:"MyLayout",content:d.data.source,mode:"xml",type:"layout"};b(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")}};
km.js.db={query:function(h,g,f){var e=km.js.datasource.create({type:"database"});e.query(h,g,f)},update:function(h,j,i,g){var l=h.id;delete h.id;var k={id:l,record:JSON.stringify(h),};if(g){if(g.typeName){k.typeName=g.typeName}}$.post(km.js.config.contextPath+"/km/rest/record/save",k,function(a){if(typeof(j)==="function"){j(a.success,a)}},"json").fail(function(a){if(typeof(i)==="function"){i(JSON.parse(a.responseText))}})},deleteRecord:function(e,d,f){$.post(km.js.config.contextPath+"/km/rest/record/delete",{id:e},function(a){if(typeof(d)==="function"){d(a.success,a)}},"json").fail(function(a){if(typeof(f)==="function"){f(JSON.parse(a.responseText))}})}};
km.js.rest={call:function(d,c){if(d.indexOf("/")==0){d=d.substring(1)}$.get(km.js.config.contextPath+"/"+d,c,"json")}};
km.js.relatedlist={create:function(j){var i=km.js.datasource.create({type:"database"});if(!j.jcr){throw"[km.js.relatedlist] jcr is null"}if(!j.target){throw"[km.js.relatedlist] target not defined"}var m={idProperty:{name:"id"}};var h={id:"relatedlist"};var n=$.extend({},m,j.displayOptions);var l=$.extend({},h,j.tableOptions);var k=km.js.table.create(i,j.jcr,n,l);k.render(j.target)}};
km.js.objectdetails={create:function(d){var e={delayCallbacks:false,layout:null,customizable:false};var f={options:$.extend({},e,d),afterRenderCallbacks:[],renderStage:"not-started",renderedForm:null,updatedRecord:null,render:function(N){this.renderStage="started";this.afterRenderCallbacks=[];var P=$.extend({},this.options,N);this.actualOptions=P;var G=$("<div></div>").addClass("km-rd-table km-grid-section km-grid-group");if(P.customizable){if(!d.customization){throw"Customization context not defined"}G.addClass("km-rd-table-customizable")}var i=P.jsti;if(!i){throw"JSTI not provided to rm.objectdetails"}var O=P.record;if(!O){throw"Record not passed to rm.objectdetails"}this.updatedRecord=$.extend({},O);var D=P.mode;var Q=P.fieldsPerRow;if(!Q){Q=2}if(!D){throw"Form mode (edit/view) not defined"}var M=null;var J=0;if(!P.fields&&!P.layout){throw"Neither fields for display nor layout are specified"}if(P.fields&&P.layout){throw"Both fields and layout cannot be set in options of rm.objectdetails"}if(P.fields){P.layout=this.getDefaultLayout(P,Q)}for(var a=0;a<P.layout.sections.length;a++){var K=P.layout.sections[a];var k=$("<div></div>").addClass("km-rd-body km-property-section km-grid-col km-grid-span-2-of-2");if(K.title){var I=$('<div class="km-rd-row km-section-title"><div class="km-rd-cell">'+K.title+"</div></div>");k.append(I)}if(!K.rows){throw"Layout section does not contain any rows"}var F=0;for(;F<K.rows.length;F++){var M=K.rows[F];var T=$("<div></div>").addClass("km-rd-row km-grid-section km-grid-group");for(var c=0;c<M.fields.length;c++){var S=M.fields[c];if(S.isPlaceholder){T.append(this.placeholder(a,F,c,P.customizable,P));J++;continue}var E=null;if(S.isGeneric===true){var L=km.js.utils.propVal(O,S.name);if(!L&&S.value){L=S.value}var E=this.propertyCell(S,S.name,L,D,null)}else{var j=S.id;var b=null;var H=null;if(!j){if(!P.type){throw"Type not specified in options"}if(!S.name){throw"Neither field name nor ID specified: "+JSON.stringify(S)}H=S.name;b=this.getFieldFromJSTI(P.type,S.name,i)}else{b=i.fields[S.id]}if(!b){throw"Field "+JSON.stringify(S)+" not found in JSTI"}if(b.apiName&&!b.name){b.name=b.apiName}var L=O[b.id];if(S.label){b.label=S.label}var E=this.propertyCell(b,H,L,D,i)}if(!E){continue}if(P.customizable){E.draggable({helper:function(){return $(this).clone().addClass("km-rd-prop-drag-helper")},start:(function(g,m,n,l,h){return function(o,p){g.draggedProperty={field:m,sectionIndex:n,rowIndex:l,fieldIndex:h}}})(this,S,a,F,c),stop:(function(g){return function(h,l){g.draggedProperty=null}})(this)})}T.append(E);J++}while((J%Q)!==0){T.append(this.placeholder(a,F,c,P.customizable,P));J++}if(typeof(M.render)==="function"){T.empty().append(M.render(M,T,G))}k.append(T)}var T=$("<div></div>").addClass("km-rd-row km-grid-section km-grid-group");J=0;while(J<Q){T.append(this.placeholder(a,F,J,P.customizable,P));J++}k.append(T);T=null;if(P.customizable){k.draggable({helper:function(){return $(this).clone().addClass("km-rd-prop-drag-helper")},start:(function(h,g){return function(m,l){h.draggedSection={sectionIndex:g}}})(this,a),stop:(function(g){return function(h,l){g.draggedSection=null}})(this)});k.droppable({drop:(function(h,g,l){return function(){if(!h.draggedSection){return}var n=P.layout;var m=n.sections[g];n.sections[g]=n.sections[h.draggedSection.sectionIndex];n.sections[h.draggedSection.sectionIndex]=m;h.draggedSection=null;console.log("Repainting layout: "+JSON.stringify(n));h.render(h.actualOptions);if(!l.customization){throw"Customization context not defined"}h.saveCustomization(l.type.name,l.customization.context,l.customization.contextValue,n)}})(this,a,P)})}G.append(k)}this.renderedForm=G;var R=G;if(P.customization){R=$("<div></div>").append(this.customizationPanel(P)).append(G)}if(typeof(P.target)==="function"){P.target(R,this)}else{if(P.target instanceof jQuery){P.target.empty().append(R)}}this.renderStage="finished";this.callAfterRenderCallbacks()},customizationPanel:function(a){var c=this.getTypeFromJSTI(a.type,a.jsti);if(!c){throw"Type not found while rendering customization panel"}var m=$("<div></div>");var o=$("<div></div>").addClass("km-field-list");for(var p in a.jsti.fields){var b=a.jsti.fields[p];if(b.typeId!==c.id){continue}var n=$("<div></div>").addClass("km-cust-field");var l=$("<div></div>").text(b.label);n.append(l);var p=$("<div></div>").text(b.name);n.append(p);n.draggable({helper:function(){return $(this).clone().css("display","block").addClass("km-field-drag-helper")},start:(function(h,g){return function(i,j){h.draggedProperty={field:g,sectionIndex:null,rowIndex:null,fieldIndex:null,isNew:true}}})(this,b),stop:(function(g){return function(i,h){g.draggedProperty=null}})(this)});o.append(n)}m.append(o);return m},placeholder:function(c,r,p,m,n){var a=$("<div></div>").addClass("km-rd-property km-grid-col km-grid-span-1-of-2");var b=$("<div></div>").addClass("label km-rd-cell");var o=$("<div></div>").addClass("value km-rd-cell");if(m){b.append($("<div>new field</div>").addClass("km-drop-label-filler"));var q=$('<input type="text"></input>').attr("disabled",true);o.append($("<div></div>").append(q).addClass("km-drop-val-filler"));a.droppable({drop:(function(k,j,i,g,h){return function(){if(!k.draggedProperty.field){throw"Dropped null field"}console.log("Dropped "+JSON.stringify(k.draggedProperty));var l=n.layout;var v=l.sections[j];if(i>=v.rows.length){v.rows.push({fields:[]})}var w=v.rows[i];if(g>=w.fields.length){for(var x=w.fields.length;x<g;x++){w.fields.push({isPlaceholder:true})}}w.fields.push(k.draggedProperty.field);if(k.draggedProperty.isNew!==true){l.sections[k.draggedProperty.sectionIndex].rows[k.draggedProperty.rowIndex].fields[k.draggedProperty.fieldIndex]={isPlaceholder:true}}k.draggedProperty=null;console.log("Repainting layout: "+JSON.stringify(l));k.render(k.actualOptions);if(!h.customization){throw"Customization context not defined"}k.saveCustomization(h.type.name,h.customization.context,h.customization.contextValue,l)}})(this,c,r,p,n)})}return a.append(b).append(o)},saveCustomization:function(h,c,a,b){$.post(km.js.config.contextPath+"/km/objectdetails/customize",{typeName:h,context:c,contextValue:a,layout:JSON.stringify(b)},function(g){})},propertyDrop:function(){var a=$("<div></div>").addClass("km-rd-property km-prop-drop");var b=$("<div></div>").addClass("label km-rd-cell km-drop-cell").text("a");a.append(b);return a},getDefaultLayout:function(a,n){var o={sections:[]};var b={title:null,rows:[]};var p=null;var m=0;for(var c=0;c<a.fields.length;c++){if(!p){p={fields:[]}}var i=a.fields[c];p.fields.push(i);m++;if((m%n)===0){b.rows.push(p);p=null}}if(p){b.rows.push(p)}o.sections.push(b);return o},callAfterRenderCallbacks:function(){for(var a=0;a<this.afterRenderCallbacks.length;a++){this.afterRenderCallbacks[a]()}},addAfterRenderCallback:function(a){if(this.renderStage==="finished"&&!this.options.delayCallbacks){a()}else{this.afterRenderCallbacks.push(a)}},getTypeFromJSTI:function(j,a){if(!j.id&&!j.name){throw"Neither type name nor ID set: "+JSON.stringify(j)}var i=null;for(var b in a.types){var c=a.types[b];if((j.id&&j.id===c.id)||(j.name&&j.name===c.qualifiedName)){return c}}return null},getFieldFromJSTI:function(b,c,s){var n=this.getTypeFromJSTI(b,s);if(!n){throw"Type not found: "+JSON.stringify(b)}var a=c.indexOf(".")>=0;var r=[];if(a){r=c.split(".");c=r[0]}for(var p in s.fields){var o=s.fields[p];if(o.apiName===c&&o.typeId===n.id){if(!a){return o}else{if(o.dataType.id!==km.js.datatypes.object_reference.id){throw"Expected nested field "+c+" to be a type reference, but its data type is "+o.dataType.id}if(!o.dataType.typeId){throw"Referenced type ID not set on field "+c+" in JSTI"}r.shift();var t=r.join(".");var q=s.types[o.dataType.typeId];if(!q){throw"Nested type "+o.dataType.typeId+" not found in JSTI"}return this.getFieldFromJSTI(q,t,s)}}}return null},propertyCell:function(r,o,q,n,p){var a=$("<div></div>").addClass("km-rd-property km-grid-col km-grid-span-1-of-2");var c=$("<div></div>").addClass("label km-rd-cell").text(r.label);var m=this.renderField(r,o,q,n,p);if(!m){return null}var b=$("<div></div>").addClass("value km-rd-cell").append(m);a.append(c).append(b);return a},showErrors:function(a){var h=function(j,g){j.addClass("km-field-err-style")};for(var c=0;c<a.length;c++){var b=a[c];h(this.renderedForm.find(".km-field-"+b.fieldId),b.message)}},renderField:function(u,D,y,B,a){var i=function(g){g.addClass("km-output");g.attr("disabled","true").attr("readonly","true");return g};var c=u.dataType;if(c.id===km.js.datatypes.text.id||c.id===km.js.datatypes.email.id||c.id===km.js.datatypes.number.id||(c.id===km.js.datatypes.enumeration.id&&B==="view")){var w=$("<input></input>").val(y).attr("type","text");w.addClass("km-field-"+u.id);if(u.placeholder){w.attr("placeholder",u.placeholder)}w.change((function(h,g){return function(){h.updatedRecord[g.id]=$(this).val();km.js.utils.setPropVal(h.updatedRecord,D,$(this).val())}})(this,u));if(B==="view"){w=i(w)}return w}else{if(c.id===km.js.datatypes.date.id||c.id===km.js.datatypes.datetime.id){var w=$("<input></input>").val(y).attr("type","text");w.addClass("km-field-"+u.id);w.datepicker({dateFormat:"yy-mm-dd"});w.change((function(h,g){return function(){h.updatedRecord[g.id]=$(this).val();km.js.utils.setPropVal(h.updatedRecord,D,$(this).val())}})(this,u));if(B==="view"){w=i(w)}return w}else{if(c.id===km.js.datatypes.object_reference.id){var v="item-"+km.js.utils.random(1000000);var w=$("<input></input>").val(y).attr("type","text").attr("km-hash",v);w.addClass("km-field-"+u.id);var t=a.types[c.typeId];if(!t){throw"Referenced type with ID "+c.typeId+" for field "+u.apiName+" not found"}var b=a.fields[t.defaultFieldId];var C={baseTypeName:t.qualifiedName,properties:[{name:"id"},{name:b.apiName}]};var A={display:{properties:[{name:b.apiName,label:b.label,linkStyle:true}],idProperty:{name:"id"}}};var x=km.js.ref.create({selectedRecordDisplayField:{name:b.apiName},jcr:C,availableItemsDialogOptions:{},availableItemsOptions:A,inputName:u.apiName,mode:B,selectedRecordId:y?y[t.idFieldId]:null,afterSelect:(function(g,j,h){return function(l){var k={};k[h]=l;g.updatedRecord[j.id]=k;km.js.utils.setPropVal(g.updatedRecord,D,k)}})(this,u,t.idFieldId)});x.render((function(g){return function(h){g.addAfterRenderCallback(function(){$("input[km-hash='"+v+"']").replaceWith(h)})}})(this));return w}else{if(c.id===km.js.datatypes.bool.id){var w=null;if(this.actualOptions.boolDisplay==="dropdown"){var w=$("<select></select>");w.addClass("km-field-"+u.id);w.append($("<option></option>").text("Yes").attr("value","true"));w.append($("<option></option>").text("No").attr("value","false"));w.val(y===true?"Yes":"No");w.change((function(h,g){return function(){h.updatedRecord[g.id]=($(this).val()==="true");km.js.utils.setPropVal(h.updatedRecord,D,$(this).val()==="true")}})(this,u))}else{var w=$("<input></input>").attr("value","true").attr("type","checkbox");w.addClass("km-field-"+u.id);if(y===true){w.attr("checked",true)}w.change((function(h,g){return function(){h.updatedRecord[g.id]=$(this).is(":checked");km.js.utils.setPropVal(h.updatedRecord,D,$(this).is(":checked"))}})(this,u))}if(B==="view"){w=i(w)}return w}else{if(c.id===km.js.datatypes.enumeration.id&&B==="edit"){var w=$("<select></select>");w.addClass("km-field-"+u.id);for(var z=0;z<c.enumValues.length;z++){w.append($("<option></option>").text(c.enumValues[z]).attr("value",c.enumValues[z]))}w.val(y);w.change((function(h,g){return function(){h.updatedRecord[g.id]=$(this).val();km.js.utils.setPropVal(h.updatedRecord,D,$(this).val())}})(this,u));return w}else{if(c.id===km.js.datatypes.inverse_collection.id||c.id===km.js.datatypes.association.id||c.id===km.js.datatypes.rid.id||c.id===km.js.datatypes.formula.id){return null}else{throw"Unsupported field data type "+JSON.stringify(c)}}}}}}return null},};return f},renderRecord:function(b){km.js.db.query(b.query,(function(a){return function(k,j,h){var l=k.length?k[0]:{};var i=km.js.objectdetails.create({mode:a.mode?a.mode:"edit",jsti:h,target:function(e){a.target.empty();var c=$("<div></div>");if(a.title){var d=$("<div></div>").addClass("km-title").text(a.title);c.append(d)}if(a.buttonPanel){a.buttonPanel.render(function(f){c.append(f)})}c.append(e);a.target.append(c)},layout:a.layout,type:{name:a.typeName},record:l,customizable:false});i.render({})}})(b))}};
km.js.tasks={renderStage:"not-started",afterRenderCallbacks:[],options:null,show:function(f){this.renderStage="started";this.afterRenderCallbacks=[];var d={query:"select id, title, priority, status, content, dueDate, assignedUser.id, assignedUser.userName, assignedGroup.id, assignedGroup.name from Task",fields:[{name:"id"},{name:"title"},{name:"content"},{name:"dueDate"},{name:"priority"},{name:"assignedUser"},{name:"assignedGroup"}],mode:"view",title:km.js.config.i18n["tasks.list.title"],display:"boxes",dalFilters:{orderBy:"dueDate asc",dateCondition:null,ownerCondition:null},btnFilters:{dueDate:"all",owner:"all",orderBy:"dueDate asc"},taskId:null,recordId:null,isEmbedded:false,contentInRow:false};this.options=$.extend({},d,f);var e=this.buildQuery(this.options);this.options.taskId=null;km.js.db.query(e,(function(b,a){return function(x,w,c){var i=[{name:"userName"},{name:"id"},{name:"profile"},{name:"isActive"},{name:"createdDate"},{name:"locale"}];var y=$("<div></div>").addClass("km-tasks");if(a.isEmbedded){y.addClass("km-tasks-embedded")}if(!a.contentInRow){y.addClass("km-tasks-no-content")}var B=$("<div></div>");y.append(b.header(a,B));x=km.js.utils.addPropertyNamesToJSRC(x,c);y.append(B);var v=function(g){var h=new Date(g.getTime());h.setHours(0,0,0,0);return h};var F=function(g,h){if(!g||!h){return false}return v(g).getTime()===v(h).getTime()};var C=null;if(x.length){var z=$("<div></div>").addClass("km-task-list-items");for(var G=0;G<x.length;G++){var A=x[G];var H=A.dueDate?km.js.utils.parseDate(A.dueDate):null;if((G===0||(!F(C,H)&&C))){var D=$("<div></div>").addClass("km-tasks-dayheader");if(H){D.text(km.js.config.i18n["dayofweek."+H.getDay()]+", "+H.getDate()+" "+km.js.config.i18n["month.decl."+(H.getMonth()+1)])}else{D.text(km.js.config.i18n["tasks.noduedate.header"])}z.append(D)}if(a.display==="objectdetails"){z.append(b.renderTaskAsObjectDetails(A,a,c,b))}else{if(a.display==="boxes"){z.append(b.renderTaskAsBox(A,a,c,b))}else{throw"Unsupported display mode '"+a.display+"' for task list"}}C=H}y.append(z)}else{var E=$("<div></div>").text(km.js.config.i18n["tasks.notaskstodisplay"]).addClass("km-no-tasks-msg");y.append(E)}if(a.target instanceof jQuery){a.target.empty().append(y)}else{if(typeof(a.target)==="function"){a.target(y)}}y.find(".km-task").hide().fadeIn(500);this.renderStage="finished";for(var G=0;G<b.afterRenderCallbacks.length;G++){b.afterRenderCallbacks[G]()}}})(this,this.options))},buildQuery:function(f){var h=f.query;var g=[];if(f.recordId){g.push("recordId = '"+f.recordId+"'")}if(f.dalFilters||f.taskId){if(f.dalFilters.dateCondition){g.push(f.dalFilters.dateCondition)}if(f.dalFilters.ownerCondition){g.push(f.dalFilters.ownerCondition)}if(g.length||f.taskId){var e=[];if(g.length){e.push(g.join(" AND "))}if(f.taskId){e.push("id = '"+f.taskId+"'")}h+=" WHERE "+e.join(" OR ")}if(f.dalFilters.orderBy){h+=" ORDER BY "+f.dalFilters.orderBy}}return h},getTaskForm:function(){var M=$("<div></div>").addClass("km-newtask-form");var E=$("<div></div>").addClass("km-title").text(km.js.config.i18n["tasks.newtask.title"]);M.append(E);M.append($("<div></div>").attr("id","km-task-err-wrapper").hide());var B=$("<input></input>").attr("type","hidden");M.append(B);var x=$("<input></input>").attr("type","text").attr("id","new-task-title").addClass("km-input");x.attr("placeholder",km.js.config.i18n["tasks.form.title.placeholder"]);M.append(x);var A=$("<textarea></textarea>").attr("id","new-task-content").addClass("km-input");A.attr("placeholder",km.js.config.i18n["tasks.form.content.placeholder"]);M.append($("<div></div>").append(A).addClass("km-task-content-wrapper"));var L=$("<div></div>").addClass("km-newtask-options");var w=$("<div></div>");var i=$("<div></div>").addClass("km-task-option-wrapper");i.append($("<div></div>").text(km.js.config.i18n["tasks.duedate"]).addClass("label"));var N=$("<input></input>").attr("id","due-date").datetimepicker({dateFormat:"yy-mm-dd",addSliderAccess:true,sliderAccessArgs:{touchonly:false}}).addClass("km-input");i.append($("<div></div>").append(N));L.append(w.append(i));var D=$("<div></div>");var F=$("<div></div>").addClass("km-task-option-wrapper");F.append($("<div></div>").text(km.js.config.i18n["tasks.priority"]).addClass("label"));var z=$("<select></select>").attr("id","priority").addClass("km-input");for(var y=0;y<5;y++){var J=$("<option></option>").attr("value",y).text(km.js.config.i18n["tasks.priority."+y]);z.append(J)}z.val(3);F.append($("<div></div>").append(z));D.append(F);L.append(D);var I=$("<div></div>");var v=$("<div></div>").addClass("km-task-option-wrapper");v.append($("<div></div>").text(km.js.config.i18n["tasks.assigneduser"]).addClass("label"));var H=$("<div></div>").attr("id","assigned-user-container");v.append($("<div></div>").append(H));I.append(v);L.append(I);M.append(L);var G=$("<div></div>").addClass("km-newtask-form-btns");var C=$("<a></a>").attr("href","javascript:;").addClass("sbtn").text(km.js.config.i18n["btn.save"]);C.click((function(d,f,e,a,b,c){return function(){var g=$(this);$(this).text(km.js.config.i18n["btn.saving"]);var h={title:e.val(),content:a.val(),dueDate:b.val()?(new Date(b.val())).getTime():null,priority:c.val(),assignedUserId:$(".km-task-assigned-user").val(),recordId:d.options.recordId};$.post(km.js.config.contextPath+"/km/tasklist/save",h,(function(j){return function(k){$(".km-task-err-wrapper").fadeOut(400);g.text(km.js.config.i18n["btn.save"]);if(k.success){km.js.ui.statusbar.show(km.js.config.i18n["tasks.successfully.created"],5000);d.show(d.options);km.js.ui.dialog.closeAllDialogs()}else{km.js.ui.error(k.messages,$(".km-task-err-wrapper"));$(".km-task-err-wrapper").fadeIn(400)}}})(f),"json")}})(this,M,x,A,N,z));G.append(C);var K=$("<a></a>").attr("href","javascript:;").addClass("sbtn").text(km.js.config.i18n["btn.cancel"]);K.click((function(a){return function(){km.js.ui.dialog.closeAllDialogs()}})(M));G.append(K);M.append(G);km.js.utils.userLookup({target:function(a){M.find("#assigned-user-container").empty().append(a)},inputId:"km-task-assigned-user",inputName:"km-task-assigned-user",visibleInput:{cssClass:"km-input"}});return M},header:function(Y,aa){var ac=$("<div></div>").addClass("km-tasks-header");var ag=$("<div></div>").addClass("km-tasks-titlebar");var G=$("<div></div>").text(Y.title).addClass("km-tasklist-title");ag.append(G);var O=$("<div></div>").addClass("km-tasklist-icons");var W=$("<img></img>").attr("src",km.js.config.imagePath+"/newicon.png");W.click((function(a){return function(){km.js.ui.dialog.create({id:"task-dialog",size:{width:"75%",height:"600px"}}).show(a.getTaskForm())}})(this,aa));O.append(W);ag.append(O);ac.append(ag);var ae=function(c,a,d,e,b){return function(){c.options.dalFilters[a]=d;c.options.btnFilters[e]=b;c.show(c.options)}};var ai=$("<div></div>").addClass("km-btn-group");var S=$("<a></a>").text(km.js.config.i18n["tasks.btn.mytasks"]);S.click(ae(this,"ownerCondition","assignedUser.id = '"+km.js.config.authData.user.id+"'","owner","me"));if(Y.btnFilters.owner==="me"){S.addClass("km-active")}ai.append(S);var ak=$("<a></a>").text(km.js.config.i18n["tasks.btn.mygroup"]);ak.click(ae(this,"ownerCondition","assignedGroup.id IN (select parentGroup.id from UserGroupAssignment where childUser.id = '"+km.js.config.authData.user.id+"')","owner","mygroup"));if(Y.btnFilters.owner==="mygroup"){ak.addClass("km-active")}ai.append(ak);var J=$("<a></a>").text(km.js.config.i18n["tasks.btn.alltasks"]);if(Y.btnFilters.owner==="all"){J.addClass("km-active")}J.click(ae(this,"ownerCondition",null,"owner","all"));ai.append(J);ai.find("a").click(function(){$(this).closest("div.km-btn-group").find("a").removeClass("km-active");$(this).addClass("km-active")});var Q=$("<div></div>").addClass("km-tasks-btns-wrapper");Q.append($("<div></div>").text(km.js.config.i18n["tasks.btn.assignedto"]).addClass("km-task-btns-title"));Q.append(ai);ac.append(Q);var K=$("<div></div>").addClass("km-btn-group");var I=$("<a></a>").text(km.js.config.i18n["tasks.btn.duetoday"]);var M=new Date();M.setHours(0,0,0,0);var U=new Date();U.setHours(23,59,59,999);var P=new Date();P.setDate(P.getDate()+7);P.setHours(23,59,59,999);var ab=new Date();ab.setDate(ab.getDate()+3);ab.setHours(23,59,59,999);I.click(ae(this,"dateCondition","dueDate >= "+M.getTime()+" and dueDate <= "+U.getTime(),"dueDate","today"));if(Y.btnFilters.dueDate==="today"){I.addClass("km-active")}K.append(I);var V=$("<a></a>").text(km.js.config.i18n["tasks.btn.threedays"]);V.click(ae(this,"dateCondition","dueDate >= "+M.getTime()+" and dueDate <= "+ab.getTime(),"dueDate","3days"));if(Y.btnFilters.dueDate==="3days"){V.addClass("km-active")}K.append(V);var N=$("<a></a>").text(km.js.config.i18n["tasks.btn.duethisweek"]);N.click(ae(this,"dateCondition","dueDate >= "+M.getTime()+" and dueDate <= "+P.getTime(),"dueDate","week"));if(Y.btnFilters.dueDate==="week"){N.addClass("km-active")}K.append(N);var Z=$("<a></a>").text(km.js.config.i18n["tasks.btn.duepast"]);Z.click(ae(this,"dateCondition","dueDate < "+(new Date()).getTime(),"dueDate","past"));if(Y.btnFilters.dueDate==="past"){Z.addClass("km-active")}K.append(Z);var ah=$("<a></a>").text(km.js.config.i18n["tasks.btn.dueall"]);ah.click(ae(this,"dateCondition",null,"dueDate","all"));if(Y.btnFilters.dueDate==="all"){ah.addClass("km-active")}K.append(ah);var H=$("<img></img>").attr("src",km.js.config.imagePath+"/calendar-white.png");var R=$("<div></div>").addClass("cal-wrapper");var aj=km.js.utils.dateTimePicker({target:R,value:this.options.btnFilters.dueDate instanceof Date?this.options.btnFilters.dueDate:null,dateOnly:true,mode:"edit",onSelect:(function(a){return function(d){var c=new Date(d);var e=new Date(c);e.setHours(0,0,0,0);var b=new Date(c);b.setHours(23,59,59,0);ae(a,"dateCondition","dueDate <= "+b.getTime()+" and dueDate >= "+e.getTime(),"dueDate",c)()}})(this)});var X=$("<div></div>").append(R).append($("<span></span>").append(H)).addClass("btn cal-btn");if(Y.btnFilters.dueDate instanceof Date){X.addClass("km-active")}K.append(X);K.find("a").click(function(){$(this).closest("div.km-btn-group").find("a").removeClass("km-active");$(this).addClass("km-active")});var al=$("<div></div>").addClass("km-tasks-btns-wrapper");al.append($("<div></div>").text(km.js.config.i18n["tasks.btn.duetitle"]).addClass("km-task-btns-title"));al.append(K);ac.append(al);var ad=$("<div></div>").addClass("km-btn-group");var af=$("<a></a>").text(km.js.config.i18n["tasks.btn.sortby.duedate.asc"]);af.click(ae(this,"orderBy","dueDate asc","orderBy","dueDate asc"));if(Y.btnFilters.orderBy==="dueDate asc"){af.addClass("km-active")}ad.append(af);var T=$("<a></a>").text(km.js.config.i18n["tasks.btn.sortby.duedate.desc"]);T.click(ae(this,"orderBy","dueDate desc","orderBy","dueDate desc"));if(Y.btnFilters.orderBy==="dueDate desc"){T.addClass("km-active")}ad.append(T);var L=$("<div></div>").addClass("km-tasks-btns-wrapper");L.append($("<div></div>").text(km.js.config.i18n["tasks.btn.sortby.title"]).addClass("km-task-btns-title"));L.append(ad);ac.append(L);return ac},addAfterRenderCallback:function(b){if(this.renderStage==="finished"){b()}else{this.afterRenderCallbacks.push(b)}},renderTaskAsBox:function(X,ah,Y,ar){var R=$("<div></div>").addClass("km-task").addClass("km-task-display-row");R.attr("id","km-task-"+X.id);var al=$("<div></div>").addClass("km-task-tc");var Z=function(a){km.js.ui.statusbar.err(a.message?a.message:a.messages)};var ao=function(b){var a=$("<img></img>").attr("src",km.js.config.imagePath+"/check.gif").css("position","absolute").css("right","5em").css("top","2em");b.css("position","relative");b.append(a);a.hide().fadeIn(700);setTimeout((function(){return function(){a.fadeOut(700)}})(a),3000)};var aa=function(a,c,d){var e=$("<img></img>").attr("src",km.js.config.imagePath+"/trashicon.png").addClass("task-icon");var b=$("<div></div>").addClass("km-task-delete-wrapper");b.append(e);c.append(b);km.js.ui.confirm({target:e,callback:(function(g,f){return function(){km.js.db.deleteRecord(g,(function(h){return function(){h.fadeOut(400)}})(f))}})(d,a)})};var ac=function(a,b){if(!a){km.js.ui.statusbar.err(b.message?b.message:b.messages)}else{}};var Q=function(a,b,c){a.blur((function(e,d){return function(){var f={id:e};f[d]=$(this).val()?$(this).val():null;km.js.db.update(f,ac,Z)}})(X.id,b))};var i=function(b,a,c){b.addClass("km-task-display-form");b.removeClass("km-status-resolved-row");b.removeClass("km-task-display-row");km.js.ui.dialog.create({id:"existing-task-dialog",size:{width:"75%",height:"600px"},afterClose:(function(d){return function(){d.show(d.options)}})(c)}).show(b)};var af=$("<div></div>").addClass("km-task-status-wrapper");var aw=$("<img></img>").attr("src",km.js.config.imagePath+"/"+(X.status==="Resolved"?"check.gif":"greycheck.png"));aw.addClass("task-icon");if(X.status==="Resolved"){aw.addClass("km-status-resolved");R.addClass("km-status-resolved-row")}af.append(aw);aw.click((function(a,b){return function(){var c=null;if($(this).hasClass("km-status-resolved")){$(this).removeClass("km-status-resolved");b.removeClass("km-status-resolved-row");$(this).attr("src",km.js.config.imagePath+"/greycheck.png");c="Open"}else{$(this).addClass("km-status-resolved");b.addClass("km-status-resolved-row");$(this).attr("src",km.js.config.imagePath+"/check.gif");c="Resolved"}var d={id:a};d.status=c;km.js.db.update(d,ac,Z)}})(X.id,R));al.append(af);var ap=$("<div></div>").addClass("km-task-title");var am=$("<input></input>").attr("type","text").val(X.title).addClass("km-task-edit");Q(am,"title",X.id);var ab=X.content?X.content:"";var aA=$("<textarea></textarea>").val(ab).addClass("km-task-edit");if(km.js.utils.isMobile()){am.focus((function(b,a,c){return function(){i(b,a,c)}})(R,aA,this))}ap.append(am);var aj=$("<div></div>").addClass("km-task-content-wrapper").append(aA);Q(aA,"content",X.id);al.append(ap).append(aj);var S=$("<div></div>").addClass("km-task-assignee-wrapper");var ad=$("<div></div>").addClass("km-task-option-wrapper");var aD=$("<img></img>").attr("src",km.js.config.imagePath+"/personicon.png").addClass("task-icon");var ax=$("<span></span>").append(aD).addClass("task-icon-wrapper");ad.append(ax);var an="ua-"+km.js.utils.random(1000000);var aC=$("<div></div>").attr("id",an);var ay=$("<div></div>").text(X.assignedUser?X.assignedUser.userName:"");ad.append($("<div></div>").append(aC).append(ay));S.append(ad);var T=function(b,d,c,a){c.hide();km.js.utils.userLookup({target:((function(e){return function(f){$("#"+e).empty().append(f)}})(a)),inputName:"km-task-assignee",visibleInput:{cssClass:"km-input"},mode:"view",editable:true,recordId:d,afterSelect:function(e){var f={id:b};f.assignedUser=e?{id:e}:null;km.js.db.update(f,null,Z)}})};this.addAfterRenderCallback(function(){var a=T(X.id,X.assignedUser?X.assignedUser.id:null,ay,an);ay.click(a);ax.click(a)});al.append(S);var U=$("<div></div>").addClass("km-tasks-priority-cell");var ak=$("<div></div>").addClass("km-task-option-wrapper");var aE=$("<img></img>").attr("src",km.js.config.imagePath+"/impicon.png").addClass("task-icon");var V=$("<span></span>").append(aE).addClass("task-icon-wrapper");ak.append(V);var aB=$("<select></select>").attr("id","priority").addClass("km-task-edit");for(var ae=0;ae<5;ae++){var au=$("<option></option>").attr("value",ae).text(km.js.config.i18n["tasks.priority."+ae]);aB.append(au)}aB.val(X.priority);Q(aB,"priority",X.id);ak.append($("<div></div>").append(aB));U.append(ak);al.append(U);var ai=$("<div></div>").addClass("km-task-duedate-wrapper");var at=$("<div></div>").addClass("km-task-option-wrapper");var aq=$("<img></img>").attr("src",km.js.config.imagePath+"/alarmclock.png").addClass("task-icon");var W=$("<span></span>").append(aq).addClass("task-icon-wrapper");at.append(W);var ag=$("<span></span>").text(X.dueDate?X.dueDate:"");Q(ag,"dueDate",X.id);var az=km.js.utils.dateTimePicker({target:ag,value:X.dueDate,mode:"view",onSelect:(function(a){return function(b){var c={id:a,dueDate:b?(new Date(b)).getTime():null};km.js.db.update(c,ac,Z)}})(X.id)});W.click((function(a){return function(){a.enable()}})(az));at.append(ag);ai.append(at);al.append(ai);var av=$("<img></img>").attr("src",km.js.config.imagePath+"/uncollapse.png").addClass("km-task-open-icon task-icon");av.click((function(b,a,d,c){return function(){if(b.hasClass("km-task-display-form")){b.removeClass("km-task-display-form");b.addClass("km-status-resolved-row");b.addClass("km-task-display-row");km.js.ui.dialog.closeAllDialogs()}else{c(b,a,d)}}})(R,aA,this,i));al.append($("<div></div>").append(av).addClass("km-task-open-wrapper"));R.append(al);aa(R,al,X.id);return R},renderTaskAsObjectDetails:function(l,k,m,j){var n="hash-"+km.js.utils.random(10);var h=$("<div></div>").addClass("ibox").attr("km-hash",n);var i=km.js.objectdetails.create({mode:k.mode,jsti:m,delayCallbacks:true,target:(function(a,b){var c=function(d,e){j.addAfterRenderCallback(function(){$("div[km-hash='"+a+"']").empty().append(d);e.callAfterRenderCallbacks()})};return c})(n,j),fields:k.fields,fieldsPerRow:2,type:{name:"kommet.basic.Task"}});i.render({record:l});return h}};
km.js.filelookup={show:function(f){var d={chooseSystemFiles:true,uploadedFileName:"uploadedFile",immediate:false};var e=$.extend({},d,f);km.js.db.query("select id, name from File where id = '"+(e.fileId?e.fileId:"00h0000000000")+"'",(function(a){return function(z,v,s){z=km.js.utils.addPropertyNamesToJSRC(z,s);var u=$("<img></img>").attr("src",km.js.config.imagePath+"/attachicon.png");var b=$("<div></div>").addClass("km-file-icon").append(u);var B=$("<div></div>").append(b).addClass("km-file-lookup");var A="km-file-"+km.js.utils.random(1000000);if(a.inputName){var x=$("<input></input>").attr("type","hidden").val(a.fileId).attr("name",a.inputName);B.append(x)}var r=$("<input></input>").attr("type","file").attr("name",a.uploadedFileName).hide();var c=km.js.filelookup.getFileForm(r,A);B.append(c);if(z.length){var t=z[0];var w=$("<div></div>").text(t.name).addClass("km-filename");B.append(w);var y=$("<img></img>").attr("src",km.js.config.imagePath+"/ex.png");y.click((function(g,h){return function(){g.val(null);h.empty();$(this).remove()}})(x,w));B.append($("<div></div>").append(y).addClass("km-remove"))}u.click((function(h,g,i,h){return function(){var j=km.js.ui.dialog.create({id:"km-fileupload-"+km.js.utils.random(1000000),size:{width:"800px",height:"600px"},afterClose:null});j.show(km.js.filelookup.getFileDialog(g,i,B,h,j))}})(a,r,c,a));a.target.empty().append(B)}})(e))},getFileForm:function(f,e){var d=$("<form></form>").attr("enctype","multipart/form-data").attr("method","post");d.append($("<input></input>").attr("type","hidden").attr("name","fileName"));d.append($("<input></input>").attr("type","hidden").attr("name","revisionId"));d.append($("<input></input>").attr("type","hidden").attr("name","nativeUpload").val("true"));d.append($("<input></input>").attr("type","hidden").attr("name","fileParam").val(e));d.append(f);d.css("display","none");return d},getFileDialog:function(y,w,o,p,q){var s=$("<div></div>").addClass("km-file-upload-wrapper");var t=$("<div></div>").addClass("km-file-drag");t.append($("<div></div>").text(km.js.config.i18n["files.drag.file"]));var x=$("<a></a>").addClass("sbtn").attr("href","javascript:;").text(km.js.config.i18n["files.browse"]);x.click((function(a){return function(){a.click()}})(y));t.append($("<div></div>").append(x).addClass("km-file-browse"));if(p.chooseSystemFiles){var u=$("<a></a>").addClass("sbtn").attr("href","javascript:;").text(km.js.config.i18n["files.choose.existing"]);u.click((function(a,b){return function(){km.js.filelookup.fileList(a,b,p)}})(s,q,p));t.append($("<div></div>").append(u).addClass("km-file-choose"))}var A=$("<div></div>").addClass("km-file-panel").hide();var r=$("<input></input>").attr("type","text").attr("id","filename").addClass("km-input");var v=function(a,b,e,c,d){if(a.success){b.hide();var f=$("<div></div>").text(km.js.config.i18n["files.upload.complete"]).addClass("km-upload-success");e.empty().append(f);c.close();if(typeof(d.afterSave)==="function"){if(!a.fileId||!a.fileRevisionId){throw"File ID or file revision ID not returned after file upload"}d.afterSave(a.fileId,a.fileRevisionId,a.fileName,d)}}else{var g=km.js.config.i18n["files.upload.failed"];if(a.messages&&a.messages.length){g+=": "+a.messages[0]}var f=$("<div></div>").text(g).addClass("km-upload-failed");e.empty().append(f)}};var z=(function(e,d,c,b,a){return function(){if(b.isDropUpload){if(b.dropCallbacks){for(var h=0;h<b.dropCallbacks.length;h++){console.log("Processing upload");b.dropCallbacks[h]()}}}else{var f="km-iframe-"+km.js.utils.random(1000000);var g=$('<iframe style="display: none" />').attr("id",f).attr("name",f);$("body").append(g);c.find("input[name=fileName]").val(d.val());c.attr("target",f);c.attr("action",km.js.config.contextPath+"/km/files/nativeupload");c.submit();var i=km.js.ui.buttonWait({button:$(this),text:"Saving"});g.load((function(j,l,k){return function(){km.js.ui.buttonWaitStop(j);iframeContents=$(this)[0].contentWindow.document.body.innerHTML;var m=JSON.parse(iframeContents);v(m,t,l,a,k)}})(i,A,b))}}})(y,r,w,p,q);if(typeof(t.dropzone)==="function"){t.dropzone({url:km.js.config.contextPath+"/km/files/nativeupload",createImageThumbnails:false,paramName:p.uploadedFileName,success:(function(a,c,b){return function(e,f){var d=JSON.parse(f);v(d,t,c,a,b)}})(q,A,p),previewTemplate:'<div class="dz-details">\n<div class="dz-size"><span data-dz-size></span></div>\n    <div class="dz-filename"><span data-dz-name></span></div>',accept:(function(c,a,b){return function(e,f){var d=e.name.split("\\").pop().split("/").pop();c.find("#filename").val(d);c.show();a.isDropUpload=true;if(!a.dropCallbacks){a.dropCallbacks=[]}a.dropCallbacks.push(f);if(a.immediate){b()}}})(A,p,z)})}s.append(t);A.append(r);var B=$("<a></a>").attr("href","javascript:;").text(km.js.config.i18n["btn.save"]).addClass("sbtn");B.click(z);A.append(B);s.append(A);y.on("change",(function(c,a,b){return function(){console.log("File: "+$(this).val());var d=$(this).val().split("\\").pop().split("/").pop();c.find("#filename").val(d);c.show();if(b.immediate){a()}}})(A,z,p));return s},fileList:function(i,k,l){var j=km.js.datasource.create({type:"database"});var m={baseTypeName:"kommet.basic.File",properties:[{name:"id"},{name:"createdDate"},{name:"name"}]};var p={properties:[{name:"name",label:"File name",linkStyle:true,onClick:(function(a,b){return function(c){if(typeof(b.afterSave)==="function"){b.afterSave(c,null,null,b)}a.close()}})(k,l)},{name:"createdDate",label:"Created date",linkStyle:true}],idProperty:{name:"id"}};var n={id:"km-files",pagination:{active:true,pageSize:15}};var o=km.js.table.create(j,m,p,n);o.render(m,i)}};
km.js.grid={create:function(d){var c={options:d,show:function(a){if(a){this.options.target=a}if(!this.options.fields){throw"Fields not set in grid"}if(!this.options.records){throw"Records not passed to grid"}var b=this.getGridCode(this.options,this.options.records);if(this.options.target instanceof jQuery){this.options.target.empty().append(b)}else{if(typeof(this.options.target)==="function"){this.options.target(b)}else{throw"Unsupported target data type while rendering grid"}}},getGridCode:function(j,k){var b=$("<div></div>").addClass("km-grid");b.append(this.getHeader(j));var l=0;for(var i=0;i<k.length;i++){var a=k[i];b.append(this.getRow(j,a,++l))}if(j.emptyRowCount){for(var i=0;i<j.emptyRowCount;i++){b.append(this.getEmptyRow(j,++l))}}return b},getHeader:function(b){var i=$("<div></div>").addClass("km-grid-row km-grid-header");this.columnCount=0;for(var a=0;a<b.fields.length;a++){var j=b.fields[a];if(!j.dataType){throw"Field data type not set for field "+j.name}if(!this.isValidDataTypeForGrid(j.dataType,j)){continue}this.columnCount++;var h=this.getHeaderCell(j,b);i.append(h)}if(b.emptyColumnCount){for(var a=0;a<b.emptyColumnCount;a++){this.columnCount++;var h=this.getEmptyHeaderCell(b);i.append(h)}}return i},isValidDataTypeForGrid:function(b,a){if(a.name==="accessType"){return false}if(km.js.datatypes.text.id===b.id){return true}if(km.js.datatypes.number.id===b.id){return true}if(km.js.datatypes.enumeration.id===b.id){return true}if(km.js.datatypes.email.id===b.id){return true}return false},getEmptyRow:function(j,b){var l=$("<div></div>").addClass("km-grid-row").attr("km-record-id","null").attr("km-row-no",b);for(var k=0;k<j.fields.length;k++){var i=j.fields[k];if(!i.dataType){throw"Field data type not set for field "+i.name}if(!this.isValidDataTypeForGrid(i.dataType,i)){continue}var a=this.getEmptyCell(j,i,null);a.attr("km-record-id","null");l.append(a)}if(j.emptyColumnCount){for(var k=0;k<j.emptyColumnCount;k++){var a=this.getEmptyCell(j,null,null);a.attr("km-record-id","null");l.append(a)}}return l},getRow:function(m,k,b){var a=$("<div></div>").addClass("km-grid-row").attr("km-record-id",k.id).attr("km-row-no",b);for(var i=0;i<m.fields.length;i++){var n=m.fields[i];if(!n.dataType){throw"Field data type not set for field "+n.name}if(!this.isValidDataTypeForGrid(n.dataType,n)){continue}var l=this.getCell(k,n,m);l.attr("km-record-id",k.id);a.append(l)}if(m.emptyColumnCount){for(var i=0;i<m.emptyColumnCount;i++){var l=this.getEmptyCell(m,null,k.id);l.attr("km-record-id",k.id);a.append(l)}}return a},getCell:function(j,l,b){var a=$("<div></div>").addClass("km-grid-cell");var i=j[l.name];var k=$("<input></input>").attr("type","text").val(i).addClass("km-grid-input");k.blur((function(g,e,f){return function(){var h={id:g.id};h[e]=f.val();km.js.db.update(h,null,null)}})(j,l.name,k));a.append(k);return a},getEmptyCell:function(a,i,j){var h=$("<div></div>").addClass("km-grid-cell").attr("km-record-id",j);var b=$("<input></input>").attr("type","text").addClass("km-grid-input");if(i){b.blur((function(f,e,l,g){if(!g.typeName){throw"Type name not defined in km.js.grid - cannot insert new record"}return function(){var k={id:f};var n={typeName:g.typeName};k[e]=l.val();km.js.db.update(k,null,null,n)}})(j,i.name,b,a))}h.append(b);return h},getHeaderCell:function(l,b){var a=$("<div></div>").addClass("km-grid-cell km-grid-header-cell").attr("km-field",l.id);var j=l.label?l.label:l.name;var i=j;var k=$("<input></input>").attr("type","text").val(i).addClass("km-grid-input");a.append(k);return a},getEmptyHeaderCell:function(a){var f=$("<div></div>").addClass("km-grid-cell km-grid-header-cell").attr("km-field","null");var b=$("<input></input>").attr("type","text").addClass("km-grid-input");b.blur((function(i,j,e){return function(){if(!i.val()){return}if(j.attr("km-field")!=="null"){return}if(!e.typeName){throw"Type name not defined in km.js.grid - cannot create new field"}var n=function(k){return k.replace(/\w\S*/g,function(l){return l.charAt(0).toUpperCase()+l.substr(1).toLowerCase()})};var h=n(i.val());var m=h.replace(/\s+/g,"");m=m.charAt(0).toLowerCase()+m.substr(1).toLowerCase();var g={type:e.typeName,apiName:m,label:h};$.post(km.js.config.contextPath+"/km/rest/field/create",g,(function(k){return function(l){if(l.success){k.attr("km-field",l.data.fieldId)}}})(j),"json")}})(b,f,a));f.append(b);return f}};return c}};
km.js.cookies={create:function(g,f,j){var i="";if(j){var h=new Date();h.setTime(h.getTime()+(j*24*60*60*1000));i="; expires="+h.toUTCString()}document.cookie=g+"="+f+i+"; path=/"},read:function(h){var c=h+"=";var i=document.cookie.split(";");for(var g=0;g<i.length;g++){var j=i[g];while(j.charAt(0)==" "){j=j.substring(1,j.length)}if(j.indexOf(c)==0){return j.substring(c.length,j.length)}}return null},erase:function(b){create(b,"",-1)}};
km.js.marketplace={cachedData:null,render:function(f){this.cachedData={availableLibs:[],installedLibs:[],notifier:km.js.notifier.get()};var e={allowInstall:true,detailsLink:"rm/lib/marketplaceimport?id="};options=$.extend({},e,f);this.cachedData.notifier.wait("availableLibs");if(options.allowInstall){this.cachedData.notifier.wait("installedLibs")}this.cachedData.notifier.onComplete=(function(a){return function(){var C=a.availableLibs;var G=$("<div></div>").addClass("km-mrkt");for(var w=0;w<C.length;w++){var i=C[w];var B=$("<div></div>").addClass("km-lib");B.click((function(g){return function(){location.href=km.js.config.contextPath+"/"+g.detailsLink+i.id}})(options));var E=$("<img></img>").attr("src","https://kommet.io/km/download/"+i.logo.id).addClass("km-lib-logo");B.append(E);var b=$("<div></div>").addClass("km-lib-label").text(i.label);var H=$("<div></div>").addClass("km-lib-name").text(i.name);if(i.background){b.css("background",i.background);H.css("background",i.background)}B.append(b);B.append(H);var F=$("<div></div>").addClass("km-lib-desc").text(i.description);B.append(F);var A=$("<div></div>").addClass("km-lib-btns");if(options.allowInstall){var D=function(g,h){for(var j=0;j<h.length;j++){if(h[j].name===g.name&&h[j].version===g.version){console.log(JSON.stringify(h[j]));if(h[j].isEnabled===true){return"installed"}else{return"installed/disabled"}}}return"not installed"};var v=$("<i></i>").addClass("fa fa-download");var x=D(i,a.installedLibs);if(x==="installed"){var y=$("<a></a>").addClass("sbtn sbtn-inactive").append(v).append("Installed").attr("href","javascript:;");A.append(y)}else{if(x==="installed/disabled"){var y=$("<a></a>").addClass("sbtn sbtn-inactive").append(v).append("Downloaded").attr("href","javascript:;");A.append(y)}else{var y=$("<a></a>").addClass("sbtn").append(v).append("Install").attr("href",km.js.config.contextPath+"/"+options.detailsLink+i.id);A.append(y)}}}var c=$("<i></i>").addClass("fa fa-commenting-o");var z=$("<a></a>").addClass("sbtn").append(c).append("Details").attr("href",km.js.config.contextPath+"/"+options.detailsLink+i.id);A.append(z);B.append(A);G.append(B)}options.target.empty().append(G)}})(this.cachedData);if(options.allowInstall){km.js.db.query("select id, name, source, version, isEnabled from Library where source = 'External (library repository)'",(function(a){return function(c,h,b){lib=km.js.utils.addPropertyNamesToJSRC(c,b);a.installedLibs=c;a.notifier.reach("installedLibs")}})(this.cachedData))}var d={limit:options.limit,keyword:options.keyword};$.get("https://kommet.io/rest/marketplace/libs",d,(function(b,a){return function(c){a.availableLibs=c;a.notifier.reach("availableLibs")}})(options,this.cachedData))}};
