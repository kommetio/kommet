km.js.utils={isEmpty:function(b){return b==null||b==""||typeof(b)=="undefined"},random:function(b){return Math.floor((Math.random()*b)+1)},isMobile:function(){return window.matchMedia("only screen and (min-device-width : 320px) and (max-device-width : 480px)").matches},getItemLink:function(c){var d=c.substring(0,3);switch(d){case"002":return"km/type/"+c;case"003":return"km/field/"+c;case"006":return"km/profile/"+c;case"009":return"km/actions/"+c;case"00a":return"km/views/"+c;case"00b":return"km/classes/"+c;case"00e":return"km/uniquechecks/"+c;case"00f":return"km/layouts/"+c;case"014":return"km/webresources/"+c;case"015":return"km/viewresources/"+c;default:return null}},customizableObjectDetails:function(b){km.js.db.query("select id from "+b.typeName,(function(a){return function(j,i,g){var h=km.js.objectdetails.create({mode:"edit",jsti:g,target:a.target,layout:a.layout,type:{name:a.typeName},record:{},customizable:true,customization:{context:"environment"}});h.render({})}})(b))},renderProfile:function(){var b=$("<div></div>").addClass("km-profile-img");b.css("background","url("+km.js.config.imagePath+"/mountains.jpg)");$(".km-profile-box > .km-profile-pic").append(b);$(".km-profile-box > .km-profile-name").text(km.js.config.authData.user.userName)},cloneArr:function(e){var d=[];for(var f=0;f<e.length;f++){d.push($.extend({},e[f]))}return d},bind:function(e,f,h,g){if(!(e instanceof jQuery)){throw"km.js.utils.bind source should be a jQuery object"}if(!(f instanceof jQuery)){throw"km.js.utils.bind dest should be a jQuery object"}e.keyup((function(c,b,a){return function(){if(c.hasClass("km-bind-manually-edited")){return}var d=b;if($(this).val()!=""){d=$(this).val()}c.text(d);if(typeof(a)==="function"){c.val(a(d))}else{c.val(d)}}})(f,h,g));f.keyup(function(){f.addClass("km-bind-manually-edited")})},capitalize:function(b){return b?b.charAt(0).toUpperCase()+b.slice(1):b},uncapitalize:function(b){return b?b.charAt(0).toLowerCase()+b.slice(1):b},getTypeFromQuery:function(d,c){$.get(km.js.config.contextPath+"/km/typefromquery",{query:d},(function(a){return function(b){a(b.data.type,b.data.isValidQuery)}})(c),"json")},addPropertyNamesToJSRC:function(q,n){var o=[];for(var m=0;m<q.length;m++){var p=q[m];for(var l in p){var i=n.fields[l];if(!i){throw"Field with KID "+l+" not found in JSTI on record "+JSON.stringify(p)}var r=p[l];if($.isArray(r)){r=this.addPropertyNamesToJSRC(r,n)}else{if(this.isObject(r)){var k=[];k.push(r);r=this.addPropertyNamesToJSRC(k,n)[0]}}p[i.apiName]=r}o.push(p)}return o},padLeft:function(g,f,c){if(!g){g=""}if(g.length===f){return g}for(var h=0;h<(f-g.length);h++){g=c+g}return g},isObject:function(b){return b!==null&&typeof b==="object"},propVal:function(f,e){if(f==null){return null}else{if(e.indexOf(".")>=0){var d=e.split(".");return this.propVal(f[d[0]],e.substring(e.indexOf(".")+1))}else{return km.js.utils.isEmpty(f)?null:f[e]}}},coalesce:function(c,d){return c?c:d},getScriptInclude:function(b){return'<script type="text/javascript" src="'+km.js.config.contextPath+"/"+b+'"><\/script>'},getCssInclude:function(b){return'<link href="'+km.js.config.contextPath+"/"+b+'" rel="stylesheet" type="text/css" />'},normalizeId:function(b){return b?b.replace(/\./g,"-"):b},parseDate:function(p,u){if(!u){u="GMT"}var o=p.split(" ");var z=o[0];var s=o[1];var y=z.split("-");var r=parseInt(y[0]);var t=parseInt(y[1])-1;var q=parseInt(y[2]);var x=0;var w=0;var v=0;if(s){var n=s.split(":");var x=parseInt(n[0]);var w=parseInt(n[1]);var v=parseInt(n[2])}return new Date(r,t,q,x,w,v)},forEachProp:function(f,d){for(var e in f){if(f.hasOwnProperty(property)){d(e,f[e])}}},nl2br:function(b){return b!=null?b.replace(/(?:\r\n|\r|\n)/g,"<br />"):null},setPropVal:function(g,f,j){if(f.indexOf(".")==-1){g[f]=j}else{var h=f.split(".");var i=g[h[0]];if(!i){i={}}this.setPropVal(i,f.substring(f.indexOf(".")+1),j);g[h[0]]=i}},lastProperty:function(c){if(c==null||c.indexOf(".")<0){return c}var d=c.split(/\./);return d[d.length-1]},insert:function(e,f,d){f.splice(e,0,d)},remove:function(c,d){d.splice(c,1)},openURL:function(b){location.href=b},formatDate:function(f,d){var e=function(a){return a.toString().length<2?"0"+a:a};return f.getFullYear()+"-"+e(f.getMonth()+1)+"-"+e(f.getDate())},size:function(d){var e=0;for(var f in d){if(d.hasOwnProperty(f)){e++}}return e},populateIdsOnProperties:function(f,j,i){if(!j){throw"Cannot populate IDs on table display options because the passed base type is null"}for(var g=0;g<f.length;g++){var h=f[g];if(h.id){continue}if(!h.name){throw"Neither property name nor its ID specified in table display options"}h.id=km.js.utils.nestedPropertyToPir(h.name,j,i);if(!h.id){throw"Could not resolve property ID for property name "+h.name+" on type "+j.qualifiedName+" (type ID "+j.id+")"}}},nestedPropertyToPir:function(o,n,p){var m=o.split(".");var l=n.qualifiedName;var j=p.pirs[l+"."+m[0]];if(m.length===1){return j}else{var k=p.fields[j];var r=k.dataType.id;var q=null;if(r===km.js.datatypes.object_reference.id){q=p.types[k.dataType.typeId]}else{if(r===km.js.datatypes.inverse_collection.id){q=p.types[k.dataType.inverseTypeId]}else{if(r===km.js.datatypes.association.id){q=p.types[k.dataType.associatedTypeId]}else{throw"Field "+k.name+" is not an object reference, collection or association, but is used with nested properties"}}}if(!q){throw"New base type not retrieved"}return j+"."+this.nestedPropertyToPir(o.substring(o.indexOf(".")+1),q,p)}},isSimpleRestriction:function(b){return b.operator.toLowerCase()!=="or"&&b.operator.toLowerCase()!=="and"&&b.operator.toLowerCase()!=="not"},getTypeFromJSTI:function(d,c){if(d.baseTypeId){type=c.types[d.baseTypeId];if(type==null){throw"Type with ID "+d.baseTypeId+" not found"}}else{if(d.baseTypeName){type=this.getTypeFromJSTIByName(d.baseTypeName,c);if(type==null){throw"Type with name "+d.baseTypeName+" not found"}}else{throw"Neither base type name nor ID specified in JCR"}}return type},getTypeFromJSTIByName:function(h,e){for(var f in e.types){var g=e.types[f];if(g.qualifiedName===h){return g}}return null},openMenuItem:function(d){var c=$("div#content td.left-menu a").filter((function(a){return function(){return $(this).text()==a}})(d)).closest("li").addClass("km-menu-highlighted");c.parent().closest("li").find("ul").show()},openCurrentMenuItem:function(){var f=window.location.href.indexOf(km.js.config.contextPath)+km.js.config.contextPath.length;var d=window.location.href.substring(f);var e=$("div#content div#left-menu a[href$='"+d+"']").closest("li").addClass("km-menu-highlighted");e.parent().closest("li").find("ul").show()},forEachRestriction:function(i,h){var g=[];if($.isArray(i)){g=[].concat(i)}else{g.push(i)}for(var f=0;f<g.length;f++){var j=g[f];h(j);if(j.operator.toLowerCase()==="or"||j.operator.toLowerCase()==="and"||j.operator.toLowerCase()==="not"){this.forEachRestriction(j.args,h)}}},adjustIframeSize:function(l,m,n,p,o){var i=document.getElementById(l);var j=i.contentWindow.document.body.scrollHeight+30;var k=i.contentWindow.document.body.scrollWidth+30;if(n&&j>n){j=n}if(m&&j<m){j=m}if(o&&k>o){k=o}if(p&&k<p){k=p}i.height=(j)+"px";i.width=(k)+"px";console.log("Adjusting size: "+j+" / "+k)},customTypes:function(){var d=[];for(var e in km.js.config.types){var f=km.js.config.types[e];if(f.isBasic===false){d.push(f)}}return d},userLookup:function(g){var h={baseTypeName:"kommet.basic.User",properties:[{name:"id"},{name:"userName"}]};var e={display:{properties:[{name:"userName",label:km.js.config.i18n["user.username"],linkStyle:true}],idProperty:{name:"id"}},title:km.js.config.i18n["tasks.users"],tableSearchOptions:{properties:[{name:"userName",operator:"ilike"}]}};var f=km.js.ref.create({selectedRecordDisplayField:{name:"userName"},jcr:h,availableItemsDialogOptions:{},availableItemsOptions:e,inputName:g.inputName,inputId:g.inputId,selectedRecordId:g.recordId,visibleInput:g.visibleInput,afterSelect:g.afterSelect,mode:g.mode,editable:g.editable});f.render(g.target);return f},isInteger:function(b){return parseInt(b,10)},dateToGMT:function(c){if(c){if(km.js.utils.isInteger(c)){c=new Date(c)}var d=new Date(c.getTime());d.setHours(c.getHours()-1*km.js.config.authData.timeZoneOffset);return d}else{return null}},dateTimePicker:function(d){var f=$("<input></input>").datetimepicker({dateFormat:"yy-mm-dd",addSliderAccess:true,showHour:!d.dateOnly,showMinute:!d.dateOnly,showTime:!d.dateOnly,sliderAccessArgs:{touchonly:false},onSelect:(function(a){return function(b){$(this).removeClass("km-output");if(typeof(a)==="function"){a(b)}}})(d.onSelect)});f.addClass("km-input");f.datepicker("setDate",d.value);if(!d.mode){d.mode="edit"}if(d.mode==="view"){f.addClass("km-output")}f.click(function(){$(this).removeClass("km-output")});f.blur(function(){$(this).addClass("km-output")});if(d.target instanceof jQuery){d.target.empty().append(f)}else{if(typeof(d.target)==="function"){d.target(f)}}var e={input:f,enable:function(){this.input.removeClass("km-output")}};return e},userGroupLookup:function(g){var h={baseTypeName:"kommet.basic.UserGroup",properties:[{name:"id"},{name:"name"}]};var e={display:{properties:[{name:"name",label:km.js.config.i18n["usergroups.groupname"],linkStyle:true}],idProperty:{name:"id"}},title:km.js.config.i18n["usergroups.list.title"],tableSearchOptions:{properties:[{name:"name",operator:"ilike"}]}};var f=km.js.ref.create({selectedRecordDisplayField:{name:"name"},jcr:h,availableItemsDialogOptions:{},availableItemsOptions:e,inputName:g.inputName,inputId:g.inputId,selectedRecordId:g.recordId,visibleInput:g.visibleInput,mode:g.mode,afterSelect:g.afterSelect,editable:g.editable});f.render(g.target);return f}};
km.js.data={associate:function(g,h,j,i,k){var l=function(a,b){return function(c){if(c.success===true){if(km.js.utils.isEmpty(c.id)){throw"Association successful, but ID of linking record not returned"}if(typeof(a)==="function"){a(c.id)}}else{if(typeof(b)==="function"){b(c)}}}};$.post(km.js.config.sysContextPath+"/rest/associate",{relationFieldId:g,parentId:h,childId:j},l(i,k),"json")},unassociate:function(h,i,f,j){var g=function(a){return function(b){if(typeof(a)==="function"){a(b.id)}}};$.post(km.js.config.sysContextPath+"/rest/unassociate",{relationFieldId:h,parentId:i,childId:f},g(j),"json")}};
km.js.datatypes={number:{id:0},text:{id:1},bool:{id:2},datetime:{id:3},rid:{id:4},email:{id:5},object_reference:{id:6},enumeration:{id:7},inverse_collection:{id:8},association:{id:10},formula:{id:11},date:{id:12},autonumber:{id:14}};
km.js.jsti={forTypes:function(f,g,e){var h={};if($.isArray(f)){h.typePrefixes=typePrefix.join(",")}if($.isArray(g)){h.typeNames=g.join(",")}$.post(km.js.config.sysContextPath+"/rest/jsti",h,e,"json")},get:function(h,f){var g={fields:{},types:{},fieldInfo:function(b){var a=this.fields[b];return km.js.utils.isEmpty(a)?null:a},typeInfo:function(b){var a=this.types[b];return km.js.utils.isEmpty(a)?null:a}};if(km.js.utils.isEmpty(f)){f=[]}if(km.js.utils.isEmpty(h)){h=[]}for(var i=0;i<f.length;i++){var j=km.js.utils.lastProperty(f[i]);g.types[j]={}}return g},fieldData:function(e,d){var f=d.indexOf(".")>-1?d.substring(d.indexOf(".")+1):d;return e.fields[f]}};
if(typeof(km.js.scope)==="undefined"){km.js.scope={dialogs:{},refs:{},rels:{},resizeEvent:{listeners:[],listen:function(b){if(typeof(b)!=="function"){throw"Cannot register listener as it is not a function: "+b}this.listeners.push(b)},notify:function(){for(var d=0;d<this.listeners.length;d++){var c=this.listeners[d];if(typeof(c)==="function"){c(window)}}}}}};
km.js.ui={boolButton:function(e){var f=typeof(e.onSetTrue)==="function"&&typeof(e.onSetFalse)==="function";if(!f){if(!(e.target instanceof jQuery)){throw"Target of a boolButton call has to be a jQuery object"}if(!e.recordId){throw"Record ID not defined in boolButton call"}if(!e.field){throw"Field not defined in boolButton call"}if(!e.type){throw"Type not defined in boolButton call"}}var h=e.value;var g=function(b){console.log("Initializing boolButton with options: "+JSON.stringify(b));var a=$('<i class="fa km-bool"></i>').addClass(b.value?"fa-check km-bool-checked":"fa-close km-bool-unchecked").addClass("km-bool-button-icon");b.target.find("i.km-bool").remove();b.target.prepend(a);if(!b.refreshMode){b.target.click((function(c){return function(){console.log("Button clicked");var o=$(this).find("i.km-bool");var d=!o.hasClass("km-bool-checked");var m=(function(k,j){return function(){console.log("Record updated");k.value=d;k.refreshMode=true;g(k)}})(c,o);if(d&&typeof(c.onSetTrue)==="function"){c.onSetTrue(n,c,m)}else{if(!d&&typeof(c.onSetFalse)==="function"){c.onSetFalse(n,c,m)}else{var n={id:c.recordId};n[c.field]=d;console.log("Updating record");km.js.db.update(n,m,null)}}}})(b))}};if(h!==true&&h!==false){if(f){throw"Initial value not set in boolButton called with manual callbacks"}console.log("Fetching initial value");km.js.db.query("select "+e.field+" from "+e.type+" where id = '"+e.recordId+"' limit 1",(function(a,b){return function(d,k,c){console.log("Initial value: "+JSON.stringify(d));d=km.js.utils.addPropertyNamesToJSRC(d,c);if(!d.length){throw"Record '"+b.recordId+"' of type "+b.type+" not found in km.js.ui.boolButton function"}b.value=d[0][b.field];a(b)}})(g,e))}else{g(e)}},buttonWait:function(h){if(h.isRestore==null){h.isRestore=true}if(!(h.button instanceof jQuery)){throw"Button passed to km.ui.buttonWait method is not a jQuery object"}var e=$('<div class="km-spinner"></div>');for(var g=0;g<=5;g++){e.append($("<div></div>").addClass("km-spinner-"+g))}var f=h.button.text()?h.button.text():h.button.val();h.button.empty().append(e).append($("<div></div>").text(h.text?h.text:"").addClass("km-waitbtn-text"));return{options:h,text:f,isRestore:h.isRestore,startTime:(new Date()).getTime()}},buttonWaitStop:function(d){var e=function(){var a=d.options.button;if(typeof(a.val)==="function"){a.empty().val(d.text)}if(typeof(a.text)==="function"){a.empty().text(d.text)}};if(d.isRestore){var f=(new Date()).getTime();if((f-d.startTime)>1000){e()}else{setTimeout(e,1000)}}},header:function(f,h,e){var g=$('<div class="km-ui-header km-title">'+f+"</div>");if(h){g.addClass(h)}if(e){g.attr("style",e)}return g},ripple:function(b){if(!b){b=$(document.body)}b.click(function(d){var a=$("<div></div>").addClass("km-ripple");a.css("top",(d.pageY)+"px").css("left",(d.pageX)+"px");a.css("background-color","#ccc");$(document.body).append(a);a.animate({opacity:0.3,width:"+=40px",height:"+=40px",left:"-=20px",top:"-=20px"},300,function(){$(this).hide()})})},appendMenuImages:function(){if(!$(".km-menu").hasClass("has-menu-icons")){$(".km-menu").addClass("has-menu-icons");$(".km-menu > ul > li > a").each(function(){var b=$("<img></img>").attr("src",km.js.config.imagePath+"/menuarrow.png");$(this).prepend($("<span></span>").append(b).addClass("km-menu-icon"))})}},tooltip:function(e){var d=$("<img></img>").attr("src",km.js.config.imagePath+"/tooltip.png").addClass("km-tooltip-icon");d.click((function(a){return function(c){var k=$("<div></div>").css("position","relative").text(a.text);var j=$("<div></div>").addClass("km-tooltip-text").append(k);var b="tooltip-"+Math.floor(Math.random()*(10000000));j.attr("id",b);$("div.km-tooltip-text").remove();$(document).find("body").append(j);j.css("top",c.pageY-j.outerHeight()/2).css("left",c.pageX+20);$(document).find("body").click(function(){$("div.km-tooltip-text").remove()});c.stopPropagation()}})(e));var f=$("<span></span>").append(d).addClass("km-tooltip-wrapper");if(e.afterTarget instanceof jQuery){e.afterTarget.after(f)}},formatApiName:function(b){if(!b){return}b=km.js.utils.capitalize(b);b=b.replace(/\s/g,"_");return b},formatFieldName:function(b){if(!b){return}b=km.js.utils.uncapitalize(b);b=b.replace(/\s/g,"_");return b},autoFormatName:function(c){if(!(c.target instanceof jQuery)){throw"Target of the autoformatApiName function must be a jQuery object"}var d=function(){var a=$(this).val();if(!a){return}var b="";var g="";if(a.indexOf(".")>=0){b=a.substring(0,a.lastIndexOf("."));g=a.substring(a.lastIndexOf(".")+1,a.length)}else{g=a}var h=(b?b.toLowerCase()+".":"")+km.js.ui.formatApiName(g);if(h!==a){$(this).val(h);$(this).addClass("km-auto-format-highlight")}else{$(this).removeClass("km-auto-format-highlight")}};c.target.focusout(d);if(c.onKeyUp){c.target.keyup(d)}},autoFormatFieldName:function(c){if(!(c.target instanceof jQuery)){throw"Target of the autoformatApiName function must be a jQuery object"}var d=function(){var b=$(this).val();if(!b){return}var a=km.js.ui.formatFieldName(b);if(a!==b){$(this).val(a);$(this).addClass("km-auto-format-highlight")}else{$(this).removeClass("km-auto-format-highlight")}};c.target.focusout(d);if(c.onKeyUp){c.target.keyup(d)}},editable:function(e){var h={};var f=$.extend({},h,e);var g=$("<input></input>").attr("type","text");if(f.inputName){g.attr("name",f.inputName)}g.keyup(function(a){if(a.keyCode==13){$(this).focusout()}});if(f.inputId){g.attr("id",f.inputId)}if(f.cssClass){g.addClass(f.cssClass)}if(!(f.target instanceof jQuery)){throw"Target should be a jQuery object"}g.focusout((function(a,b){return function(){if(typeof(b)==="function"){b($(this).val())}if($(this).val()===""){$(this).val("<empty>")}a.text($(this).val());$(this).hide();a.show()}})(f.target,f.onAccept));f.target.click((function(b,a){return function(){if(typeof(a)==="function"){a()}b.insertAfter($(this));$(this).hide();b.val($(this).text());b.show();b.select()}})(g,f.onActivate))},confirm:function(b){if(!(b.target instanceof jQuery)){throw"Target must be a jQuery object"}b.target.click((function(a){return function(){if(!a.target.is(":visible")){return}a.target.hide();var h=$('<div class="km-ui-confirm"><span class="km-ui-confirm-q">'+(a.question?a.question:km.js.config.i18n["msg.delete.warning"])+"</span></div>");var f=$('<a href="javascript:;">'+(a.yesLabel?a.yesLabel:km.js.config.i18n["btn.yes"])+"</a>");f.click(a.callback);var g=$('<a href="javascript:;">'+(a.noLabel?a.noLabel:km.js.config.i18n["btn.no"])+"</a>");g.click(function(){$(this).closest(".km-ui-confirm").remove();a.target.show()});h.append(f).append(g);a.target.after(h)}})(b))},error:function(f,g,h,e){return this.message(f,g,"error",h,e)},info:function(f,g,h,e){return this.message(f,g,"info",h,e)},message:function(n,w,u,p,s){var q="msg-tag";var m='<img src="'+km.js.config.imagePath+"/";if(u==="error"){q+=" action-errors";m+="erricon.png"}else{if(u==="info"){q+=" action-msgs";m+="infoicon.png"}}m+='" />';if(p!=null){q+=" "+p}var t="";if(n instanceof Array){t="<ul>";for(i=0;i<n.length;i++){t+="<li>"+n[i]+"</li>"}t+="</ul>"}else{t="<ul><li>"+n+"</li></ul>"}var v=$("<tr></tr>").append($("<td></td>").append($(m))).append($("<td></td>").html(t));var r=$("<table></table>").append($("<tbody></tbody>").append(v));var o=$('<div class="'+q+'" style="'+s+'"></div>').append(r);if(typeof(w)==="function"){w(o)}else{if(w instanceof jQuery){w.empty().append(o).show()}}},applyTabs:function(d){if(!(d instanceof jQuery)){throw"Argument of function km.ui.applyTabs must be a jQuery object, instead got "+typeof(d)}var e=function(b,a){a.find("div.km-tabs-panels > div.km-tabs-panel").removeClass("km-tabs-panel-active").hide();a.find("div.km-tabs-panels > div.km-tabs-panel-"+b).addClass("km-tabs-panel-active").show();a.find("ul.km-tabs-head > li.km-tabs-head-active").removeClass("km-tabs-head-active");a.find("ul.km-tabs-head > li.km-tabs-head-"+b).addClass("km-tabs-head-active");location.hash="km.tab."+b};d.find("ul.km-tabs-head > li").click((function(b,a){return function(){a($(this).index(),b)}})(d,e));var f=0;if(location.hash&&location.hash.indexOf("#km.tab.")===0){f=parseInt(location.hash.substring("#km.tab.".length))}e(f,d)},statusbar:{timer:null,stdCssClass:null,container:null,render:function(j,k,p){if(this.timer){clearTimeout(this.timer)}var l=null;if($("div."+this.cssClass).length===0){barWrapper=$("<div></div>").addClass("km-status-bar").addClass(p);l=$("<div></div>").addClass("content").appendTo(barWrapper);l.append(km.js.ui.closeBtn(function(){barWrapper.remove()}));$(document.body).append(barWrapper)}else{l=$("div."+this.cssClass+" div.content");l.find("ul.km-status-msgs").remove()}this.container=barWrapper;var q=$("<ul></ul>").addClass("km-status-msgs");if(!$.isArray(j)){var n=[];n.push(j)}else{n=j}for(var m=0;m<n.length;m++){var o=$("<li></li>").text(n[m]);q.append(o)}l.append(q);if(k){this.timer=setTimeout(function(){km.js.ui.statusbar.hide()},k)}},show:function(d,e){var f="km-status-bar-std km-status-bar-std-info";this.render(d,e,f)},err:function(c,d){this.render(c,d,"km-status-bar-std km-status-bar-std-err")},hide:function(){$(".km-status-bar").remove()}},closeBtn:function(c){var d=$("<img>").attr("src",km.js.config.imagePath+"/ex.png").addClass("km-close");d.click(function(){c()});return d},bool:function(b){b.each(function(){val=$(this).text();if(val){val=val.trim()}var a=$("<img></img>").attr("src",km.js.config.imagePath+"/"+(val=="true"?"check.gif":"uncheck.png"));$(this).empty().append(a)})},typeLookup:function(f){if(!f.types){f.types=km.js.utils.customTypes()}var k=km.js.datasource.create({type:"json",data:f.types});var g={properties:[{name:"qualifiedName"},{name:"id"},{name:"label"}]};if(""===f.selectedRecordId){selectedRecordId=null}var h={options:{id:"type-lookup-search"},display:{properties:[{name:"label",label:"Label",linkStyle:true},{name:"qualifiedName",label:"API Name",linkStyle:true}],idProperty:{name:"id"},defaultProperty:{name:"label"}},title:"Types"};var j=km.js.ref.create({datasource:k,selectedRecordDisplayField:{name:"label"},jcr:g,availableItemsDialogOptions:{afterClose:f.dialogAfterClose},availableItemsOptions:h,inputName:f.inputName,selectedRecordId:f.selectedRecordId,afterSelect:f.afterSelect,visibleInput:f.visibleInput});j.render(f.target);return j},dialog:{create:function(f){var g={size:{width:Math.floor(window.document.body.clientWidth*0.7),height:Math.floor(window.document.body.clientHeight*0.8),maxWidth:Math.floor(window.document.body.clientWidth*0.7),maxHeight:Math.floor(window.document.body.clientHeight*0.8)}};var h=$.extend(true,{},g,f);if(!h.id){h.id="km-dialog-"+km.js.utils.random(1000000)}if(h.size.fitToContent===true){h.size.width=h.size.height=null}var e={id:h.id,imagePath:km.js.config.imagePath+"/",options:h,addOpenDialog:function(a){km.js.scope.dialogs[km.js.utils.normalizeId(a.id)]=a},removeOpenDialog:function(a){delete km.js.scope.dialogs[km.js.utils.normalizeId(a)]},show:function(x){var t='<div class="km-dialog-overlay';if(!km.js.utils.isEmpty(this.options.cssClass)){t+=" "+this.options.cssClass}if(km.js.utils.isMobile()){t+=" km-dialog-mobile"}t+='" id="'+this.id+'">';t+='<div class="km-dialog"';var d="";if(!km.js.utils.isMobile()){if(h.size.width){d+="width: "+h.size.width}if(h.size.height){d+=";height: "+h.size.height}}else{d+="height: "+$(window).height()+"px"}t+='style="'+d+'">';t+='<div class="topbar">';if(!km.js.utils.isEmpty(h.title)){t+=h.title}t+='<img src="'+this.imagePath+'ex.png" class="close-btn"></div>';t+='<div class="km-dialog-content"';if(!km.js.utils.isEmpty(h.style)){t+=' style="'+h.style+'"'}t+=">";t+="</div></div></div>";var z=$(t);if(km.js.utils.isMobile()){z.find(".km-dialog-content").css("height",$(window).height()+"px")}var A=function(j){return function(){j.close()}};z.find(".close-btn").click(A(this)).mouseover(function(){$(this).attr("src",km.js.config.imagePath+"/exh.png")}).mouseout(function(){$(this).attr("src",km.js.config.imagePath+"/ex.png")});z.click(A(this));z.find(".km-dialog").click(function(j){j.stopPropagation()});if(document.getElementById(this.id)!=null){this.self().replaceWith(z)}else{$("body").append(z)}if(!km.js.utils.isEmpty(h.url)){z.find(".km-dialog-content").append('<iframe src="'+h.url+'" style="height: '+h.size.height+'"></iframe>')}else{if(h.iframe){var s=$("<html></html>");var v=$("<head></head>");if(h.iframe.addDefaultStyles===true){v.append($(km.js.utils.getCssInclude("resources/km/css/km.all.min.css")));v.append($(km.js.utils.getCssInclude("resources/layout.css")));v.append($(km.js.utils.getCssInclude("resources/tag-styles.css")));v.append($(km.js.utils.getCssInclude("resources/header.css")));v.append($(km.js.utils.getCssInclude("resources/themes/std/styles.css")));v.append($(km.js.utils.getScriptInclude("resources/km/js/km.core.js")));v.append($(km.js.utils.getScriptInclude("js/km.config.js")));v.append($(km.js.utils.getScriptInclude("resources/km/js/km.all.min.js")));v.append($(km.js.utils.getScriptInclude("resources/km/js/km.ui.js")))}if(window.kommet&&$.isArray(window.kommet.styles)){for(var b=0;b<window.kommet.styles.length;b++){v.append($('<link href="'+window.kommet.styles[b]+'" rel="stylesheet" type="text/css" />'))}}s.append(v);var a=$("<body></body>");if(h.iframe.bodyCssClass){a.addClass(h.iframe.bodyCssClass)}if(h.iframe.bodyCssStyle){a.attr("style",h.iframe.bodyCssStyle)}s.append(a.append(x));var w=this.id+"-iframe";var y=$("<iframe></iframe>").attr("id",w);if(h.iframe.cssClass){y.addClass(h.iframe.cssClass)}y.hide();z.find(".km-dialog-content").empty().append(y);var u=$("<img></img>").attr("src",km.js.config.imagePath+"/ellipsis.gif");z.find(".km-dialog-content").append(u);var c=z.find(".km-dialog-content > iframe").contents().find("body");c.addClass("km-font-scale").append(s);if(h.iframe.cssBodyClass){c.addClass(h.iframe.cssBodyClass)}z.find(".km-dialog-content > iframe").contents().find("body").replaceWith(c);y.ready((function(l,j,k){return function(){j.hide();k.show();l.adjustSize();km.js.scope.resizeEvent.listen((function(){return function(m){console.log("Adjusting iframe to changed content");l.adjustSize()}})())}})(this,u,y))}else{z.find(".km-dialog-content").append(x)}}if(typeof(this.options.beforeShow)==="function"){this.options.beforeShow(this)}$("body").css("overflow","hidden");$("html").css("overflow","hidden");this.addOpenDialog(this);return this},adjustSize:function(){var u=null,s=null;var d=30;var p=this.options.size.width;var q=this.options.size.height;var t=false;if(this.options.size.fitToContent===true){if(this.self().find("iframe").size()>0){t=true;var b=this.self().find("iframe");var r=b.attr("id");u=b.contents().find("body").height()+20;s=b.contents().find("body").width()+100;b.css("width",s+"px");b.css("height",u+"px");q=u;p=s}}p+=(2*d)+100;q+=(2*d)+40;if(this.options.size.maxHeight&&q>this.options.size.maxHeight){q=this.options.size.maxHeight}if(this.options.size.minHeight&&q<this.options.size.minHeight){q=this.options.size.minHeight}if(this.options.size.maxWidth&&p>this.options.size.maxWidth){p=this.options.size.maxWidth}if(this.options.size.minWidth&&p<this.options.size.minWidth){p=this.options.size.minWidth}console.log("Allow body scale: "+this.options.iframe.allowAdjustBodyWidth);if(t&&this.options.iframe.allowAdjustBodyWidth){b.contents().find("body").css("width",Math.floor(p*0.9))}var a=this.self().find(".km-dialog");if(!km.js.utils.isMobile()){console.log("not mobile");a.css("width",p+"px");a.css("height",q+"px");var c=a.find(".km-dialog-content");c.css("width",p+"px");c.css("height",q+"px")}else{console.log("mobile");a.css("width","100%");a.css("height",$(window).height())}this.self().find(".km-dialog-content").css("padding",d+"px")},self:function(){return $("div[id='"+this.id+"']")},close:function(){this.self().remove();$("body").css("overflow","initial");$("html").css("overflow","auto");if(typeof(this.options.afterClose)==="function"){this.options.afterClose()}this.removeOpenDialog(this.id)},hide:function(){this.self().hide();$("body").css("overflow","auto");$("html").css("overflow","auto");this.removeOpenDialog(this.id)},content:function(a){this.self().find(".km-dialog-content").html(a)},fullscreen:function(){this.self().find(".km-dialog").css("width","100%").css("height","100vh").addClass("km-dialog-fullscreen");return this}};return e},closeAllDialogs:function(){for(var b in km.js.scope.dialogs){km.js.scope.dialogs[b].close()}}}};
km.js.notifier={get:function(){var b={waits:{},onComplete:null,isComplete:false,wait:function(a){this.waits[a]=false;this.isComplete=false},reach:function(d){this.waits[d]=true;var a=true;for(wait in this.waits){if(this.waits[wait]!==true){a=false;break}}if(a===true){this.isComplete=true;this.onComplete(this)}}};return b}};
km.js.datasource={create:function(f){var g={contextPath:km.js.config.contextPath,sysContextPath:km.js.config.sysContextPath};var h=$.extend({},g,f);var e={type:h.type,data:h.data,jsti:h.jsti,jcr:null,contextPath:h.contextPath,sysContextPath:h.sysContextPath,dataLength:km.js.utils.isEmpty(h.data)?null:h.data.length,getDefaultCompare:function(a,b){return function(c,k){var d=km.js.utils.propVal(c,a);var l=km.js.utils.propVal(k,a);if(d<l){return b?1:-1}if(d>l){return b?-1:1}return 0}},query:function(l,b,a){var c=null;var d=null;if(l&&typeof(l)==="object"){c=l}else{d=l}if(this.type==="collection"){if(c){this.populateJCRIds(c,this.jsti)}return this.queryLocalCollection(c,b)}else{if(this.type==="database"){var k=function(i,j){return function(r,q,p){if(c){j.populateJCRIds(c,p)}i(r,q,p)}};return this.queryDatabase(c?c:d,k(b,this),a)}else{if(this.type==="json"){return this.queryJSONCollection(c,b)}else{console.error("Unsupported data source type "+this.type)}}}},queryDatabase:function(c,d,a){var l=null;var m=null;var b=null;if(typeof(c)==="object"){l=c;this.jcr=l;b={jcr:JSON.stringify(l),mode:"datasource"}}else{m=c;this.jcr=null;b={query:m,mode:"datasource"}}if(typeof(this.contextPath)==="undefined"){throw"Context path not set"}var n=function(i,k,j){return function(p){i.jsti=p.jsrc.jsti;i.dataLength=p.recordCount;if(typeof(k)==="function"){k(p.jsrc.records,p.recordCount,p.jsrc.jsti)}}};$.post(this.sysContextPath+"/rest/jsds/query",b,n(this,d),"json").fail(a)},queryJSONCollection:function(b,c){this.jcr=b;this.dataLength=this.data.length;var d=this.filterData();var a=d.length;d=this.sortItems(d);d=this.pageItems(d,this.jcr.limit,this.jcr.offset);if(typeof(c)==="function"){c(d,a,this.jsti)}return d},queryLocalCollection:function(k,I){this.jcr=k;this.dataLength=this.data.length;var c=this.filterData();var M=[];if(k.groupings!=null&&k.groupings.length>0){var F={};var H=k.groupings[0].property_id;for(var D=0;D<c.length;D++){var i=c[D];var j=km.js.utils.propVal(i,H);if(km.js.utils.isEmpty(j)){j=""}if($.inArray(j,M)<0){M.push(j)}var K=null;if(!km.js.utils.isEmpty(F[j])){K=F[j]}else{K={group_value:j,items:[],aggr_results:{}}}K.items.push(i);F[j]=K}var J=[];for(var a=0;a<M.length;a++){var B=M[a];var d=F[B];km.js.utils.setPropVal(d,H,B);for(var D=0;D<k.properties.length;D++){if(k.properties[D].id!=H){d[k.properties[D].id]=d.items.length}}J.push(d)}for(var D=0;D<J.length;D++){var d=J[D];for(var E=0;E<d.items.length;E++){var i=d.items[E];for(var a=0;a<k.properties.length;a++){var L=k.properties[a];if(km.js.utils.isEmpty(d.aggr_results[L.id])){d.aggr_results[L.id]={sum:0,count:0,min:null,max:null,avg:null}}var b=d.aggr_results[L.id];if(L.id!=H){var N=L.aggr;var G=L.id;if(N==="avg"){var j=km.js.utils.propVal(i,G);b.sum+=(j!=null?j:0);b.count=d.items.length}else{if(N==="sum"){var j=km.js.utils.propVal(i,G);b.sum+=(j!=null?j:0)}else{if(N==="count"){b.count=d.items.length}else{if(N==="min"){var j=km.js.utils.propVal(i,G);if(b.min==null||j<b.min){b.min=j}}else{if(N==="max"){var j=km.js.utils.propVal(i,G);if(b.max==null||j>b.max){b.max=j}}}}}}}b.avg=(b.sum/b.count).toFixed(2)}}for(var a=0;a<k.properties.length;a++){var N=k.properties[a].aggr;if(!km.js.utils.isEmpty(N)){d[k.properties[a].id]=d.aggr_results[k.properties[a].id][N]}}}c=J}var C=c.length;c=this.sortItems(c);c=this.pageItems(c,this.jcr.limit,this.jcr.offset);if(typeof(I)==="function"){I(c,C,this.jsti)}return c},filterData:function(){var i=[];if(km.js.utils.isEmpty(this.jcr)){return[].concat(this.data)}if(this.jcr.restrictions!=null&&this.jcr.restrictions.length>0){for(var b=0;b<this.data.length;b++){var c=this.data[b];var d=true;for(var a=0;a<this.jcr.restrictions.length&&d;a++){var k=this.jcr.restrictions[a];if(!this.isMeetCriteria(k,c)){d=false}}if(d){i.push(c)}}}else{i=[].concat(this.data)}return i},pageItems:function(d,j,a){var b=km.js.utils.isEmpty(a)?0:a;var c=km.js.utils.isEmpty(j)?(d.length-b):j;return d.splice(b,c)},sortItems:function(a){if(km.js.utils.isEmpty(this.jcr.orderings)||this.jcr.orderings.length==0){return a}sortProperty=this.jcr.orderings[0].property_id;sortOrder=this.jcr.orderings[0].direction;return a.sort(this.getDefaultCompare(sortProperty,sortOrder==="desc"))},populateJCRIds:function(c,o){var a=km.js.utils.getTypeFromJSTI(c,o);var n=a.qualifiedName;if(!n){throw"Type qualified name not found in JSTI. Type ID is "+c.baseTypeId}if(c.properties){for(var b=0;b<c.properties.length;b++){var i=c.properties[b];if(!i.id){i.id=km.js.utils.nestedPropertyToPir(i.name,a,o)}}}if(c.groupings){for(var b=0;b<c.groupings.length;b++){var d=c.grouping[b];if(!d.property_id){d.property_id=nestedPropertyToPir(d.property_name,a,o)}}}if(c.orderings){for(var b=0;b<c.orderings.length;b++){var p=c.orderings[b];if(!p.property_id){p.property_id=nestedPropertyToPir(p.property_name,a,o)}}}if(c.restrictions){km.js.utils.forEachRestriction(c.restrictions,(function(j,k){return function(m){if(km.js.utils.isSimpleRestriction(m)&&!m.property_id){var l=km.js.utils.getTypeFromJSTI(k,j);m.property_id=km.js.utils.nestedPropertyToPir(m.property_name,l,j)}}})(o,c))}},isMeetCriteria:function(l,a){if(l.operator.toLowerCase()==="eq"){return km.js.utils.propVal(a,l.property_id)===l.args[0]}else{if(l.operator.toLowerCase()==="ne"){return km.js.utils.propVal(a,l.property_id)!==l.args[0]}else{if(l.operator.toLowerCase()==="gt"){return km.js.utils.propVal(a,l.property_id)>l.args[0]}else{if(l.operator.toLowerCase()==="ge"){return km.js.utils.propVal(a,l.property_id)>=l.args[0]}else{if(l.operator.toLowerCase()==="lt"){return km.js.utils.propVal(a,l.property_id)<l.args[0]}else{if(l.operator.toLowerCase()==="le"){return km.js.utils.propVal(a,l.property_id)<=l.args[0]}else{if(l.operator.toLowerCase()==="ilike"){var b=km.js.utils.propVal(a,l.property_id);if(km.js.utils.isEmpty(b)){return false}else{var d=new RegExp(l.args[0].replace(/%/g,".*"),"gi");return(b+"").toLowerCase().match(d)!==null}}else{if(l.operator.toLowerCase()==="not"){if(l.args===null||l.args.length===0){throw"Empty argument list for a NOT restriction"}else{if(l.args.length>1){throw"More than one argument not allowed in a NOT restriction"}}var c=l.args[0];if(typeof c==="object"&&c!==null){return !this.isMeetCriteria(c,a)}else{throw"Argument of a NOT restriction is not an object. Its value is "+c}}else{if(l.operator.toLowerCase()==="or"||l.operator.toLowerCase()==="and"){if(l.args===null||l.args.length===0){throw"Empty argument list for a "+l.operator+" restriction"}if(l.operator.toLowerCase()==="and"){for(var i=0;i<l.args.length;i++){var c=l.args[i];if(typeof c==="object"&&c!==null){if(!this.isMeetCriteria(c,a)){return false}}else{throw"Argument of an AND restriction is not an object. Its value is "+c}}return true}else{if(l.operator.toLowerCase()==="or"){for(var i=0;i<l.args.length;i++){var c=l.args[i];if(typeof c==="object"&&c!==null){if(this.isMeetCriteria(c,a)){return true}}else{throw"Argument of an AND restriction is not an object. Its value is "+c}}return false}}}else{console.log("Criteria not supported: "+l.operator);return false}}}}}}}}}}};return e}};
km.js.buttonpanel={create:function(c){var d={buttons:[],id:c.id,cssClass:c.cssClass,options:c,addButton:function(a){this.buttons.push(a)},render:function(b){var h=$('<div class="km-btn-panel" id="'+this.id+'"></div>');if(this.cssClass){h.addClass(this.cssClass)}if(c.title){var a=$("<div></div>").text(c.title.text);if(c.title.cssClass){a.addClass(c.title.cssClass)}h.append(a)}var i=$("<div></div>").addClass("km-btn-panel-buttons");for(var j=0;j<this.buttons.length;j++){i.append(this.getButtonCode(this.buttons[j]))}h.append(i);if(typeof(b)==="function"){b(h)}else{b.html(h)}return h},getButtonCode:function(b){var a='<a href="'+(b.url?b.url:"javascript:;")+'" ';a+='class="sbtn">'+b.label+"</a>";var f=$(a);if(b.id){f.attr("id",b.id)}if(typeof(b.onClick)==="function"){f.click(b.onClick)}return f}};return d}};
km.js.table={create:function(m,j,l,n){var h={cssClass:"km-table-std",wrapperCssClass:null,contextPath:km.js.config.contextPath,dragRowCount:10,pageSize:20,afterRender:null,afterRemoveColumn:null,exportFormats:[],buttonPanel:null,pagination:{active:false,currentPage:0,pageCount:null}};var i=$.extend({},h,n);if(!l.idProperty){l.idProperty={name:"id"}}if(i.title){if(i.title.placement==="buttons-left"){if(i.buttonPanel){i.buttonPanel.title=i.title}}}var k={datasource:null,jcr:null,title:i.title,data:null,generatedCode:null,display:null,settings:null,activeDragColumnIndex:null,sortPropertyId:null,sortOrder:null,unpagedDataCount:null,id:i.id,buttonPanel:i.buttonPanel,baseType:null,pagination:i.pagination,render:function(d,a){var b=function(e,f){return function(g,s,r){var t=e.datasource.type==="json";if(!r&&!t){throw"JSTI not passed to datasource.query callback"}if(!t){e.baseType=km.js.utils.getTypeFromJSTI(f,r);e.populateIdsOnTableOptions(r,e.baseType)}e.getCode(g,s);e.rerenderFooter();e.initHeaderFilters();e.draggableColumns();e.updateHeaders();e.updateButtonPanel();if(typeof(a)==="function"){a(e.generatedCode,e)}else{a.html(e.generatedCode)}if(typeof(e.settings.afterRender)==="function"){e.settings.afterRender(e)}if(km.js.scope.resizeEvent){km.js.scope.resizeEvent.notify()}e.data=[].concat(g);e.unpagedDataCount=s}};var c=km.js.utils.isEmpty(d)?this.jcr:d;if(km.js.utils.isEmpty(c)){console.error("JCR is empty")}this.datasource.query(c,b(this,c))},rerenderRows:function(c,b,a){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call rerenderRows when no table code has been generated"}this.generatedCode.find("div.kmjstb").html(this.renderRows(c,b));if(a&&typeof(a.onComplete)==="function"){a.onComplete(this)}},populateIdsOnTableOptions:function(a,b){if(!this.display){return}if(this.display.properties&&this.display.properties.length>0){km.js.utils.populateIdsOnProperties(this.display.properties,b,a)}if(this.display.idProperty){if(!this.display.idProperty.id){if(this.display.idProperty.name){this.display.idProperty.id=km.js.utils.nestedPropertyToPir(this.display.idProperty.name,b,a)}else{throw"Neither ID property name nor its ID defined in table options"}}}else{throw"ID property not defined in km.js.table options"}},updateButtonPanel:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call updateHeaders when no table code has been generated"}if(!this.buttonPanel||!this.buttonPanel.buttons||this.buttonPanel.buttons.length===0){return}if(typeof(this.buttonPanel.render)!=="function"){throw"Button panel defined on rm.table does not have function render(). It may not have been created using rm.buttonpanel.create()"}this.buttonPanel.render(this.generatedCode.find(".km-btn-panel-container"))},updateHeaders:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call updateHeaders when no table code has been generated"}if(!km.js.utils.isEmpty(j.groupings)){for(var e=0;e<j.groupings.length;e++){var f=j.groupings[e].property_id;this.generatedCode.find("#"+this.settings.id+"-group-btn-"+f.replace(/\./g,"-")).attr("src",this.imagePath+"linkh.png")}}for(var e=0;e<j.properties.length;e++){var a=j.properties[e];var b=this.generatedCode.find("#"+this.settings.id+" .kmjsth select#aggr-"+a.id.replace(/\./g,"-"));var d=null;if(this.datasource.type!=="json"){d=this.datasource.jsti.fields[km.js.utils.lastProperty(a.id)].dataType.id}else{d=km.js.datatypes.text.id}var p=this.aggrFunctionsForDataType(d);var c="";for(var g=0;g<p.length;g++){c+='<option value="'+p[g].name+'">'+p[g].label+"</option>"}b.html(c);if(!km.js.utils.isEmpty(a.aggr)){b.val(a.aggr).show()}}},container:function(){return $("#km-table-container-"+this.settings.id)},getCode:function(d,b){var f=$('<div id="km-table-container-'+this.settings.id+'"></div>').addClass("km-table-container");if(this.title&&this.title.placement==="top"){var c=$("<div></div>").text(this.title.text).addClass("km-record-table-title");if(this.title.cssClass){c.addClass(this.title.cssClass)}f.append(c)}f.append($('<div class="km-btn-panel-container"></div>'));var e=$('<div id="km-table-wrapper-'+this.settings.id+'" class="km-table-wrapper"></div>');if(this.settings.wrapperCssClass){e.addClass(this.settings.wrapperCssClass)}f.append(e);var a=$('<div class="kmjstable '+this.settings.cssClass+'" id="'+this.settings.id+'"></div>');a.append(this.renderHeaders());a.append($('<div class="kmjstb"></div>'));f.append(a);f.append($('<div class="kmjstf"></div>'));this.generatedCode=f;this.generatedCode.find(".kmjstb").html(this.renderRows(d,b));return this.generatedCode},rerenderFooter:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call rerenderFooter when no table code has been generated"}this.generatedCode.find(".kmjstf").replaceWith(this.renderFooter())},renderFooter:function(){var f=$('<div class="kmjstf"></div>');var b=$('<div class="kmjstr"></div>');var B=this.pagination.pageCount>15?15:this.pagination.pageCount;if(this.pagination.active){var x=$('<div id="pagination-'+this.settings.id+'" class="km-pagination"></div>');x.append($('<a href="javascript:;" class="km-first km-page-no"></a>').html("&lt;&lt;"));x.append($('<a href="javascript:;" class="km-prev km-page-no"></a>').html("&lt;"));var z=$('<div class="km-page-no-no-ellipsis"></div>');for(var d=0;d<B;d++){z.append($('<a href="javascript:;" class="km-page-no km-page-'+d+'">'+(d+1)+"</a>"))}x.append(z);if(this.pagination.pageCount>B){var C=$('<div class="km-page-no-ellipsis"></div>');for(var d=B;d<(this.pagination.pageCount-1);d++){C.append($('<a href="javascript:;" class="km-page-no km-page-'+d+'">'+(d+1)+"</a>"))}x.append(C)}var D=$('<div class="km-page-no-no-ellipsis">');if(this.pagination.pageCount>B){D.append($('<a href="javascript:;" class="km-page-no km-page-'+(this.pagination.pageCount-1)+'">'+this.pagination.pageCount+"</a>"))}x.append(D);x.append($('<a href="javascript:;" class="km-next km-page-no"></a>').html("&gt;"))}b.append(x);var a=false;var e=false;if(!km.js.utils.isEmpty(this.settings.exportFormats)&&this.settings.exportFormats.length>0){var w=$('<div class="kmjstr"></div>');var g=$('<div class="km-export-btns"></div>');for(var d=0;d<this.settings.exportFormats.length;d++){if(this.settings.exportFormats[d]==="csv"){a=true;g.append($('<input type="button" class="sbtn km-export-csv" id="'+this.id+'-csv" value="CSV">'));g.append($('<form id="'+this.settings.id+'-csv-form" method="post" style="display:none"><input type="hidden" name="jcr"></form>'))}else{if(this.settings.exportFormats[d]==="xlsx"){e=true;g.append($('<input type="button" class="sbtn km-export-xlsx" id="'+this.id+'-xlsx" value="Excel">'));g.append($('<form id="'+this.settings.id+'-xlsx-form" method="post" style="display:none"><input type="hidden" name="jcr"></form>'))}else{throw"Unsupported export format "+this.options.exportFormats[d]}}}w.append(g);b.append(g)}f.append(b);var c=function(o){return function(){o.prevPage()}};var y=function(o){return function(){o.nextPage()}};var A=function(o,p){return function(){o.goToPage(p)}};if(a===true){f.find(".km-export-csv").click((function(o){return function(){o.exportToCsv()}})(this))}if(e===true){f.find(".km-export-xlsx").click((function(o){return function(){o.exportToXlsx()}})(this))}f.find(".km-prev").click(c(this));f.find(".km-next").click(y(this));f.find(".km-first").click(A(this,0));f.find(".km-last").click(A(this,this.pagination.pageCount-1));for(var d=0;d<B;d++){f.find(".km-page-"+d).click(A(this,d))}if(this.pagination.pageCount>B){f.find(".km-page-"+(this.pagination.pageCount-1)).click(A(this,(this.pagination.pageCount-1)))}return f},renderHeaders:function(){var a='<div class="kmjsth">';a+='<div class="kmjstr">';for(var b=0;b<this.display.properties.length;b++){a+='<div class="kmjstd th-'+this.display.properties[b].id.replace(/\./g,"-")+'">'+this.display.properties[b].label+"</div>"}a+="</div></div>";return $(a)},aggrFunctionsForDataType:function(b){var a=[{name:"count",label:"zliczanie"}];if(b===0){a.push({name:"sum",label:"suma"});a.push({name:"avg",label:"srednia"});a.push({name:"min",label:"minimum"});a.push({name:"max",label:"maksimum"})}return a},defaultRestrictionOperatorForType:function(a){if(a===km.js.datatypes.bool.id||a===km.js.datatypes.number.id){return"eq"}else{return"ilike"}},waitModeOn:function(){$("#"+this.settings.id+" > .kmjstb").css({filter:"alpha(opacity=40)",zoom:"1",opacity:"0.4"})},waitModeOff:function(){$("#"+this.settings.id+" > .kmjstb").css({filter:"alpha(opacity=100)",zoom:"1",opacity:"1.0"})},renderRows:function(B,c){if(!B){return""}if(this.pagination.active){this.pagination.pageCount=Math.ceil(c/this.pagination.pageSize)}var e=function(p,q,o){return p.replace(/{(.*?)}/g,function(s,r){if(r==="id"){return q}else{return km.js.utils.propVal(o,r)}})};var F=[];var g=false;if(!this.datasource.type==="database"){if(this.datasource.jsti){B=km.js.utils.addPropertyNamesToJSRC(B,this.datasource.jsti);g=true}else{throw"JSTI not defined on database datasource"}}var A=false;for(var d=0;d<this.display.properties.length;d++){var I=this.display.properties[d];if(I.url&&/{(.*?)}/.test(I.url)&&!g){if(this.datasource.type==="database"&&this.datasource.jsti){B=km.js.utils.addPropertyNamesToJSRC(B,this.datasource.jsti);g=true}else{console.warn("Requested initializing properties on record set, but it was impossible due to missing JSTI")}}}if(B.length){for(var d=0;d<B.length;d++){var G=B[d];var D='<div class="kmjstr"';var a=null;if(!km.js.utils.isEmpty(this.display.idProperty.id)){a=G[this.display.idProperty.id];if(!a){throw"ID property "+this.display.idProperty.id+" not retrieved in query"}D+=' id="'+a+'"'}D+="></div>";var b=$(D);for(var f=0;f<this.display.properties.length;f++){var I=this.display.properties[f];var C=I.id?km.js.utils.propVal(G,I.id):G;if(typeof(I.format)==="function"){C=I.format(C,G)}if(C==null){C=""}cellCode='<div class="kmjstd kmjstd-'+I.id.replace(/\./g,"-")+"";if(I.linkStyle===true){cellCode+=" kmjstda"}cellCode+='"></div>';var K=$(cellCode);var E=$("<div></div>").addClass("km-prop-mobile-label").text(I.label);K.append(E);var J=null;if(!km.js.utils.isEmpty(I.url)){J=$('<a href="'+e(I.url,G[this.display.idProperty.id],G)+'">'+C+"</a>")}else{if(C instanceof jQuery){J=C}else{J=C}}K.append(J);if(I.content&&typeof(I.content)==="function"){I.content(G,a,K)}b.append(K)}F.push(b)}}else{var H=$("<div></div>").addClass("kmjstr km-table-no-results");var K=$("<div></div>").addClass("kmjstd").text(km.js.config.i18n["msg.noresults"]);H.append(K);for(var f=1;f<this.display.properties.length;f++){H.append($("<div></div>").addClass("kmjstd"))}F.push(H)}for(var d=0;d<this.display.properties.length;d++){var I=this.display.properties[d];if(typeof(I.onClick)==="function"){var L=function(o){return function(){var p=$(this).closest(".kmjstr").attr("id");o(p)}};for(var f=0;f<F.length;f++){F[f].find(".kmjstd-"+I.id.replace(/\./g,"-")).click(L(I.onClick))}}}return F},goToPage:function(a){this.pagination.currentPage=a;this.jcr.offset=this.pagination.pageSize*a;this.update()},prevPage:function(){if(this.pagination.currentPage>0){this.goToPage(this.pagination.currentPage-1)}},nextPage:function(){if(this.pagination.currentPage<(this.pagination.pageCount-1)){this.goToPage(this.pagination.currentPage+1)}},update:function(c){var a=[].concat(this.data);var b=function(e,d){return function(f,g){e.rerenderRows(f,g);e.rerenderFooter();e.updatePaginationDisplay();e.data=[].concat(f);e.unpagedDataCount=g;if(typeof(d)==="function"){d(e)}}};if(!km.js.utils.isEmpty(j)){this.datasource.query(j,b(this,c))}else{(b(this))(a,this.unpagedDataCount)}},updatePaginationDisplay:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call updatePaginationDisplay when no table code has been generated"}this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-no").removeClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-"+this.pagination.currentPage).addClass("km-page-no-hl");if(this.pagination.currentPage==0){this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-0").addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-prev").addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-first").addClass("km-page-no-hl")}if(this.pagination.currentPage==(this.pagination.pageCount-1)){this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-"+this.pagination.currentPage).addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-next").addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-last").addClass("km-page-no-hl")}},setPageSize:function(a){this.pagination.pageSize=a;this.jcr.offset=this.pagination.pageSize*pageIndex;this.update();this.rerenderFooter()},moveColumn:function(b,a){if(b===a){return}$("#"+this.settings.id+" .kmjstr").each(function(){var d=$(this).children().eq(b);var e=$(this).children().eq(a);if(a>b){e.after(d)}else{e.before(d)}});var c=this.display.properties[b];km.js.utils.remove(b,this.display.properties);km.js.utils.insert(a,this.display.properties,c)},draggableColumns:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call draggableColumns when no table code has been generated"}var a=function(c){for(var d=0;d<c.display.properties.length;d++){var f=c.display.properties[d];if(f.draggable!==true){continue}var e=f.id.replace(/\./g,"-");var b=c.generatedCode.find(".kmjsth > .kmjstr > .th-"+e);b.draggable({helper:"clone",start:function(s,g){var u=$(this).index();c.activeDragColumnIndex=u;var v=$('<div id="drag-col-'+c.settings.id+'"></div>');var t=0;c.generatedCode.find(".kmjstr .kmjstd:nth-child("+(u+1)+")").each(function(){if(t<c.settings.dragRowCount){v.append($(this).clone());t++}else{return false}});$(g.helper).html(v);$(g.helper).css("border","1px dotted #666");$(g.helper).css("background-color","#eee").css("color","#555").css("opacity","0.9")},cursor:"move",stop:function(){var g=$("#drag-col-"+c.settings.id);g.remove()}})}c.generatedCode.find(".kmjsth > .kmjstr > .kmjstd").droppable({drop:function(p,g){if($(g.draggable).hasClass("kmjstd")){c.moveColumn(c.activeDragColumnIndex,$(this).index());c.activeDragColumnIndex=null}},tolerance:"pointer"})};return a(this)},exportToXlsx:function(){var a=this;$("#"+a.settings.id+"-xlsx-form").attr("action",km.js.config.sysContextPath+"/rest/jsds/query?format=xlsx&exportFileName="+(a.settings.exportFileName?a.settings.exportFileName:""));var d=$.extend({},a.jcr);d.offset=null;d.limit=null;d.properties=[];for(var b=0;b<a.display.properties.length;b++){var e=null;for(var c=0;b<a.jcr.properties.length;c++){if(a.jcr.properties[c].id===a.display.properties[b].id){e=a.jcr.properties[c];break}}if(e){d.properties.push(e)}}$("#"+a.settings.id+"-xlsx-form > input[name='jcr']").val(JSON.stringify(d));$("#"+a.settings.id+"-xlsx-form").submit()},exportToCsv:function(){var a=this;$("#"+a.settings.id+"-csv-form").attr("action",km.js.config.sysContextPath+"/rest/jsds/query?format=csv&exportFileName="+(a.settings.exportFileName?a.settings.exportFileName:""));var b=$.extend({},a.jcr);b.offset=null;b.limit=null;b.properties=[];for(var c=0;c<a.display.properties.length;c++){var e=null;for(var d=0;d<a.jcr.properties.length;d++){if(a.jcr.properties[d].id===a.display.properties[c].id){e=a.jcr.properties[d];break}}if(e){b.properties.push(e)}}$("#"+a.settings.id+"-csv-form > input[name='jcr']").val(JSON.stringify(b));$("#"+a.settings.id+"-csv-form").submit()},sort:function(a){var d=a.replace(/\./,"-");var c=this.container().find(".th-"+d);this.waitModeOn();var b=this.sortOrder==="asc"?"desc":"asc";c.closest(".kmjsth").find(".kmjstd .sort-btn").attr("src",this.imagePath+"sort.png");c.find(".sort-btn").attr("src",this.imagePath+"sort"+b+".png");this.sortOrder=b;this.jcr.orderings=[{property_id:a,direction:b}];var e=function(f){return function(p,g){f.rerenderRows(p,g,{onComplete:function(o){o.waitModeOff()}});f.data=[].concat(p);f.unpagedDataCount=g}};this.datasource.query(j,e(this))},initHeaderFilters:function(){var a=function(d){if(km.js.utils.isEmpty(d.generatedCode)){throw"Cannot call initHeaderFilters when no table code has been generated"}for(var r=0;r<d.display.properties.length;r++){var b=d.display.properties[r];var e=b.id.replace(/\./g,"-");var f=null;if(d.datasource.type==="database"){f=d.datasource.jsti.fields[km.js.utils.lastProperty(b.id)].dataType.id;if(!f&&f!==0){throw"Data type not retrieved for property "+JSON.stringify(b)}}var s=d.generatedCode.find(".kmjsth > .kmjstr > .th-"+e);var g=b.label;var t=b.id;var c='<span class="km-th-label">'+g+"</span>";if(b.filterable===true){c+='<div class="filter-val"></div>'}c+='<div class="km-label-btns">';if(b.groupable===true){c+='<div class="km-header-btn"><img class="group-btn" id="'+d.settings.id+"-group-btn-"+e+'" src="'+d.imagePath+'link.png"></div>'}if(b.filterable===true){c+='<div class="km-header-btn"><img class="filter-btn" id="'+d.settings.id+"-filter-btn-"+e+'" src="'+d.imagePath+'filter.png"></div>'}if(b.sortable===true){if(d.datasource.type==="database"&&f===km.js.datatypes.formula.id){console.warn("Sorting by formula field "+b.id+" skipped");b.sortable=false}else{c+='<div class="km-header-btn"><img class="sort-btn" id="'+d.settings.id+"-sort-btn-"+e+'" src="'+d.imagePath+'sort.png"></div>'}}if(b.removable===true){c+='<div class="km-header-btn"><img class="del-btn" id="'+d.settings.id+"-del-btn-"+e+'" src="'+d.imagePath+'exb.png"></div>'}c+='<select class="aggr-select" id="aggr-'+e+'">';c+='<option value="count">zliczanie</option>';c+='<option value="sum">suma</option>';c+='<option value="avg">srednia</option>';c+='<option value="min">minimum</option>';c+='<option value="max">maksimum</option>';c+="</select>";c+="</div>";if(b.filterable===true){c+='<div><input class="km-js-th-input th-input-'+e+'" type="text" placeholder="filtr"></div>'}s.html(c);if(b.filterable===true){s.find("img.filter-btn").each(function(){$(this).click(function(){var o=$(this).closest(".kmjstd").find("input.km-js-th-input");if(o.is(":visible")){o.hide()}else{$(this).closest(".kmjstr").find(".kmjstd input.km-js-th-input").hide();$(this).closest(".kmjstd").find(".filter-val").hide();o.show()}})})}if(b.sortable===true){s.find(".km-th-label").click((function(o,p){return function(){o.sort(p.id)}})(d,b));s.find("img.sort-btn").each(function(){$(this).click(function(){d.waitModeOn();var q=$(this).attr("id").substring((d.settings.id+"-sort-btn-").length);q=q.replace(/\-/g,".");var p=d.sortOrder==="asc"?"desc":"asc";$(this).closest(".kmjsth").find(".kmjstd .sort-btn").attr("src",d.imagePath+"sort.png");$(this).attr("src",d.imagePath+"sort"+p+".png");d.sortOrder=p;d.jcr.orderings=[{property_id:q,direction:p}];var o=function(v){return function(x,u){v.rerenderRows(x,u,{onComplete:function(w){w.waitModeOff()}});v.data=[].concat(x);v.unpagedDataCount=u}};d.datasource.query(d.jcr,o(d))})})}if(b.removable===true){s.find("img.del-btn").each(function(){$(this).click(function(){var o=$(this).attr("id").substring((d.settings.id+"-del-btn-").length);var p=d.isGrouped(d.datasource.jcr,o);o=o.replace(/\-/g,".");d.removeColumn(o,true);if(p){d.update()}})})}s.find(".aggr-select").each(function(){$(this).change(function(){var o=$(this).attr("id").substring("aggr-".length);d.setAggr(j,o,$("#aggr-"+o).val());d.update()})});if(b.groupable===true){s.find(".group-btn").each(function(){$(this).click(function(){var o=$(this).attr("id").substring($(this).attr("id").indexOf("-group-btn")+"-group-btn".length+1);o=o.replace(/\-/g,".");if(d.isGrouped(j,o)){$(this).attr("src",d.imagePath+"link.png");d.setGrouping(d.jcr,null);var p=$(this).closest(".kmjstr");p.find("select.aggr-select").hide()}else{var p=$(this).closest(".kmjstr");p.find("img.group-btn").attr("src",d.imagePath+"link.png");$(this).attr("src",d.imagePath+"linkh.png");d.setGrouping(d.jcr,o);p.find("select.aggr-select").show();p.find("select#aggr-"+o).hide()}d.update()})})}if(b.filterable===true){s.find("input.km-js-th-input").each(function(){$(this).focusout(function(){$(this).hide()});$(this).keyup(function(o){var p=$(this).attr("class").split(/\s+/);var v=null;for(var q=0;q<p.length;q++){if(p[q].indexOf("th-input-")==0){v=p[q].substring("th-input-".length)}}v=v.replace(/\-/g,".");if(km.js.utils.isEmpty($(this).val())){d.removeRestrictions(d.jcr,v);$(this).closest(".kmjstd").find(".filter-btn").attr("src",d.imagePath+"filter.png")}else{d.addRestriction(d.jcr,v,$(this).val());d.goToPage(0);$(this).closest(".kmjstd").find(".filter-btn").attr("src",d.imagePath+"filterh.png")}d.update()})})}}};return a(this)},setAggr:function(e,d,b){for(var c=0;c<e.properties.length;c++){var a=e.properties[c];if(a.id==d){a.aggr=b;return}}},isGrouped:function(b,a){if(b.groupings==null||b.groupings.length==0){return false}for(var c=0;c<b.groupings.length;c++){if(b.groupings[c].property_id==a){return true}}return false},setGrouping:function(e,d){e.groupings=[];if(d!=null){e.groupings.push({property_id:d});for(var c=0;c<e.properties.length;c++){var a=e.properties[c];var b=a.aggr;a.aggr=a.id===d?null:(km.js.utils.isEmpty(b)?"count":b)}}else{for(var c=0;c<e.properties.length;c++){e.properties[c].aggr=null}}},removeRestrictions:function(a,d){var b=[];for(var c=0;c<a.restrictions.length;c++){if(a.restrictions[c].property_id!=d){b.push(a.restrictions[c])}}a.restrictions=b},parseRestriction:function(b){var a={operator:null,args:[]};if(km.js.utils.isEmpty(b)){return a}b=b.trim();var c=b.split(/\s+/);if(c.length==1){a.args.push(b);return a}getRestrictionName=function(e){if(e==">"){return"gt"}else{if(e==">="){return"ge"}else{if(e=="<"){return"lt"}else{if(e=="<="){return"le"}else{if(e=="="){return"eq"}else{return null}}}}}};var d=getRestrictionName(c[0]);if(d!=null){a.operator=d;a.args.push(b.substring(c[0].length))}else{a.args.push(b)}return a},removeColumn:function(a,e){this.removeColumnFromView(a);if(!e){return}for(var f=0;f<this.display.properties.length;f++){if(this.display.properties[f].id===a){this.display.properties.splice(f,1);break}}var d=this.jcr.groupings;var b=false;if(!km.js.utils.isEmpty(d)){for(var f=0;f<d.length;f++){if(d[f].property_id===a){d.splice(f,1);b=true;break}}}var c=this.jcr.properties;for(var f=0;f<c.length;f++){if(c[f].id===a){c.splice(f,1);break}else{if(b){c[f].aggr=null;console.log("rem for "+c[f].id)}}}if(typeof(this.settings.afterRemoveColumn)==="function"){this.settings.afterRemoveColumn(a)}},everyCell:function(f,c){var a=f.replace(/\./g,"-");var e=$("#"+this.settings.id+" .th-"+a);var b=e.index();if(b<0){return}var d=function(g,p){$("#"+g.settings.id+" .kmjstr").each(function(){p($(this).children().eq(b))})};d(this,c)},removeColumnFromView:function(a){this.everyCell(a,function(b){b.remove()})},hideColumn:function(a){this.everyCell(a,function(b){b.fadeOut(400)})},showColumn:function(a){this.everyCell(a,function(b){b.fadeIn(400)})},setButtonPanel:function(a){this.buttonPanel=a;this.buttonPanel.options.title=this.title},addRestriction:function(t,s,d){var a=null;var b=false;if(!km.js.utils.isEmpty(t.restrictions)){for(var v=0;v<t.restrictions.length;v++){if(t.restrictions[v].property_id==s){a=t.restrictions[v];b=true}}}else{t.restrictions=[]}if(a==null){a={property_id:s}}var u=this.parseRestriction(d);var f=u.operator;var c=km.js.jsti.fieldData(this.settings.jsti,km.js.utils.lastProperty(s));if(km.js.utils.isEmpty(c)){throw"JSTI does not contain information about field "+s}if(f==null){f=this.defaultRestrictionOperatorForType(c.dataType.id);if(f.toLowerCase()==="like"||f.toLowerCase()==="ilike"){var e=[];for(var v=0;v<u.args.length;v++){e.push("%"+u.args[v]+"%")}}u.args=e;console.log("Using default operator "+f+" for dt "+c.dataType.id)}a.operator=f;a.args=u.args;if(c.dataType.id===km.js.datatypes.number.id){var g=[];for(var v=0;v<a.args.length;v++){g.push(parseFloat(a.args[v]))}a.args=g}else{if(c.dataType.id===km.js.datatypes.bool.id){var g=[];for(var v=0;v<a.args.length;v++){g.push(a.args[v]==="true")}a.args=g}}if(!b){t.restrictions.push(a)}}};k.datasource=m;k.jcr=j;k.data=m.data;k.display=l;k.settings=i;k.pagination.pageSize=km.js.utils.isEmpty(n.pageSize)?k.pagination.pageSize:n.pageSize;if(k.settings.paginationActive===true||k.settings.paginationActive===false){k.pagination.active=k.settings.paginationActive}if(k.datasource.type==="json"){k=this.adjustJSONDatasource(k)}if(k.pagination.active===true){k.jcr.offset=0;k.jcr.limit=k.pagination.pageSize}k.imagePath=k.settings.contextPath+"/resources/images/";return k},adjustJSONDatasource:function(g){var j=[];for(var k=0;k<g.jcr.properties.length;k++){var h=g.jcr.properties[k];h.id=h.name;j.push(h)}g.jcr.properties=j;var i=[];for(var k=0;k<g.display.properties.length;k++){var h=g.display.properties[k];h.id=h.name;i.push(h)}g.display.properties=i;if(g.jcr.groupings){var l=[];for(var k=0;k<g.jcr.groupings.length;k++){var h=g.jcr.groupings[k];h.id=h.name;l.push(h)}g.jcr.groupings=l}if(g.selectedRecordDisplayField){g.selectedRecordDisplayField.id=g.selectedRecordDisplayField.name}if(g.display.idProperty){g.display.idProperty.id=g.display.idProperty.name}if(!g.display.defaultProperty||!g.display.defaultProperty.name){throw'Option display.defaultProperty.name needs to be specified when using datasource of type "json"'}return g}};
km.js.itemlist={create:function(e){var d={addBtnImage:"attachment.png",contextPath:km.js.config.contextPath};var f={getSelectedValues:e.getSelectedValues,options:$.extend({},d,e),items:[],jsti:{},imagePath:null,render:function(c){var a='<div id="'+this.options.id+'-container">'+this.getInnerCode()+"</div>";var b=$(a);if(typeof(c)==="function"){c(b,this)}else{throw"Callback not specified while calling itemlist.render()"}},getInnerCode:function(){var b='<div class="rmcp apc"><ul>';if(this.options.addBtn===true){b+='<li class="rmcpi rmcpadd">';if(!km.js.utils.isEmpty(this.options.addBtnImage)){b+='<img src="'+this.imagePath+this.options.addBtnImage+'">'}b+="</li>"}for(var l=0;l<this.items.length;l++){b+=this.getItemCode(this.items[l])}b+="</ul></div>";var i=$(b);if(typeof(this.options.onItemClick)==="function"){var c=function(g){return function(){var h=$(this).closest("li").attr("id").substring(g.options.id.length+"-i-".length);for(var j=0;j<g.items.length;j++){if(g.items[j][g.options.idField]===h){g.options.onItemClick(g.items[j])}}}};i.find("li.kmcpi > div.kmcptxt").click(c(this))}if(this.options.removeBtn===true){var k=function(g){return function(){var h=$(this).closest("li").attr("id").substring(g.options.id.length+"-i-".length);$(this).closest("li").remove();if(typeof(g.options.afterItemDelete)==="function"){for(var j=0;j<g.items.length;j++){if(g.items[j][g.options.idField]===h){g.options.afterItemDelete(g.items[j],h)}}}}};i.find("li.kmcpi img.del").click(k(this))}if(this.options.addBtn===true&&typeof(this.options.addBtnClick)==="function"){var a=function(g){return function(){g.options.addBtnClick(g)}};i.find("li.kmcpadd").click(a(this))}return i},getItemCode:function(c){var a='<li class="rmcpi" id="'+this.options.id+"-i-"+c[this.options.idField]+'"><div class="rmcptxt">';for(var b=0;b<this.options.properties.length;b++){a+=("<span>"+c[this.options.properties[b].id]+"</span>")}a+="</div>";if(this.options.removeBtn===true){a+='<img src="'+this.imagePath+'ex.png" class="del">'}a+="</li>";return a},update:function(b){var a=function(h,c){return function(g){h.items=g.records;h.jsti=g.jsti;$("#"+h.options.id+"-container").html(h.getInnerCode());if(typeof(c)==="function"){c(h)}}};this.items=this.getSelectedValues(a(this,b))}};f.imagePath=f.options.contextPath+"/resources/images/";return f}};
km.js.tablesearch={create:function(e){var f={columns:2,searchLabel:"Search"};var g=$.extend({},f,e);var h={table:g.table,columns:g.columns,cssClass:g.cssClass,properties:g.properties,searchPropertyValues:{},searchLabel:g.searchLabel,jsti:g.jsti,originalRestrictionCount:null,render:function(a){if(!this.properties||this.properties.length==0){throw"No properties specified in the table search panel"}if(!this.table){throw"No table associated with the table search panel"}if(!this.table.jcr){throw"Table object associated with the search panel has no JCR"}if(!this.table.datasource){throw"Data source not set on the associated table"}if(!this.jsti){throw"JSTI not set on table search"}var z=$("<div></div>").addClass("km-table-search").attr("id","table-search-"+this.table.id);if(this.cssClass){z.addClass(this.cssClass)}var d=$("<div></div>").addClass("km-table-search-table");var c=this.table.baseType;if(!c){if(!this.jsti){throw"Base type on table not set and it cannot be retrieved because JSTI on table search is not set"}else{c=this.jsti.types[this.table.jcr.baseTypeId]}}km.js.utils.populateIdsOnProperties(this.properties,c,this.jsti);var s=null;for(var w=0;w<this.properties.length;w++){if(w%this.columns==0){d.append(s);s=$("<div></div>").addClass("km-table-search-row")}var i=this.properties[w];var b=this.jsti.fields[km.js.utils.lastProperty(i.id)];var t=i.label?i.label:b.label;s.append($('<div class="km-table-search-cell km-table-search-label">'+t+"</div>"));var x=$("<div></div>").addClass("km-table-search-cell");x.append(this.getSearchInput(i,b.dataType));s.append(x)}var y=this.properties.length%this.columns;if(y!==0){for(var w=0;w<y;w++){s.append($('<div class="km-table-search-cell km-table-search-label"></div>'));var x=$("<div></div>").addClass("km-table-search-cell");s.append(x)}}d.append(s);var u=this.table.buttonPanel;if(!u){u=km.js.buttonpanel.create({id:this.table.id+"-btn-panel"})}var v={label:this.searchLabel,onClick:(function(j){return function(){j.search()}})(this)};u.addButton(v);this.table.setButtonPanel(u);z.append(d);z.keypress((function(j){return function(k){if(k.keyCode==13){j.search();return false}}})(this));if(typeof(a)==="function"){a(z)}else{this.table.container().prepend(z)}return z},search:function(){var l=this.table.jcr;if(!l){throw"Associated table has null JCR"}if(this.table.jcr.restrictions){for(var d=0;d<this.table.jcr.restrictions.length;d++){if(this.table.jcr.restrictions[d].table_search_restriction===true){km.js.utils.remove(d,this.table.jcr.restrictions)}}}for(var d=0;d<this.properties.length;d++){var b=this.properties[d];var i=this.searchPropertyValues[b.id];if(i){var c=i;if(b.operator==="ilike"||b.operator==="like"){c="%"+c+"%"}var a={property_id:b.id,operator:b.operator,args:[c],table_search_restriction:true};if(!this.table.jcr.restrictions){this.table.jcr.restrictions=[]}this.table.jcr.restrictions.push(a)}}this.table.goToPage(0);this.table.update()},getSearchInput:function(c,a){var b=$("<input></input>");b.keydown((function(j,d){return function(){j[d]=$(this).val()}})(this.searchPropertyValues,c.id));if(!a){throw"Data type for property"+c.id+" not found in JSTI"}if(a.id===km.js.datatypes.number.id||a.id===km.js.datatypes.text.id||a.id===km.js.datatypes.enumeration.id||a.id===km.js.datatypes.autonumber.id){b.attr("type","text").attr("id","search-"+c.id.replace(/\./,"-"));return b}else{if(a.id===km.js.datatypes.bool.id){b.attr("type","checkbox").attr("id","search-"+c.id.replace(/\./,"-"));return b}else{if(a.id===km.js.datatypes.rid.id){b.attr("type","text").attr("id","search-"+c.id.replace(/\./,"-"));return b}else{throw"Unsupported data type ID "+a.id+" while rendering input field"}}}}};return h}};
km.js.rel={create:function(r){var n={removeBtn:true,addBtn:true};var s=$.extend({},n,r);var q=s.jsti.fields[s.fieldId];var x=null;var v=null;var w=s.jsti.types[s.typeId];if(q.dataType.id===km.js.datatypes.inverse_collection.id){if(km.js.utils.isEmpty(q.dataType.inverseTypeId)){throw"Inverse type ID not specifed"}x=s.jsti.types[q.dataType.inverseTypeId]}else{if(q.dataType.id===km.js.datatypes.association.id){if(km.js.utils.isEmpty(q.dataType.associatedTypeId)){throw"Associated type ID not specifed"}x=s.jsti.types[q.dataType.associatedTypeId]}}if(!x){throw"Associated type not defined for relation field "+JSON.stringify(q)}var o=[];for(var p=0;p<s.selectedItemProperties.length;p++){o.push({id:q.id+"."+s.selectedItemProperties[p].id})}v=function(b){var c=km.js.datasource.create({type:"database"});var d={baseTypeId:s.typeId,properties:o,restrictions:[{property_id:w.idFieldId,operator:"eq",args:[s.recordId]}]};var a=function(e){return function(f){f.records=f.length>0?f[0][q.id]:[];e(f)}};c.query(d,a(b))};o.push({id:q.id+"."+x.idFieldId});if(km.js.utils.isEmpty(s.availableItemsOptions)){s.availableItemsOptions={}}if(km.js.utils.isEmpty(s.availableItemsOptions.properties)){var i=s.jsti.fields[x.defaultFieldId];if(km.js.utils.isEmpty(i)){throw"Default field with ID "+x.defaultFieldId+" not found"}s.availableItemsOptions.properties=[{id:i.id,label:i.label}]}var t=s.getAssignableItems;if(typeof(t)!=="function"){t=function(d){var a=km.js.datasource.create({type:"database"});var c={baseTypeId:x.id,properties:[]};c.properties.push({id:x.idFieldId});for(var b=0;b<s.availableItemsOptions.properties.length;b++){c.properties.push({id:s.availableItemsOptions.properties[b].id})}a.query(c,d)}}var u={baseType:w,relationField:q,associatedType:x,id:s.id,itemList:null,getSelectedValues:v,availableItemsDialog:null,availableItemsOptions:{properties:null,title:null,tableSearchOptions:null},options:s,update:function(){var a=function(b){return function(c){$("#"+b.id).replaceWith(c)}};this.render(a(this))},render:function(b){var c=function(f){return function(g){var h=function(){return function(l,j,k){console.log("Fetched assignable data");f.openSelectDialog(l,k)}};t(h(this))}};var d=function(f){return function(h,g){console.log("Deleting "+g);km.js.data.unassociate(f.relationField.id,f.options.recordId,g)}};var e={id:"item-list-"+this.id,properties:s.selectedItemProperties,idField:x.idFieldId,onItemClick:function(f){km.js.utils.openURL(km.js.config.contextPath+"/"+f[x.idFieldId])},afterItemDelete:d(this),removeBtn:s.removeBtn,addBtn:s.addBtn,addBtnClick:c(this),getSelectedValues:v};var a=function(f){return function(g){this.itemList=km.js.itemlist.create(e);this.itemList.render((function(h){return function(j,k){itemListElem=j;if(typeof(h)==="function"){h(j)}k.update()}})(f))}};this.getSelectedValues(a(b))},openSelectDialog:function(d,c){var a={id:"av-dialog-"+this.id,width:"800px",height:"500px",cssClass:"km-rel-av-dialog",iframe:{addDefaultStyles:true,cssClass:"km-std-iframe",cssBodyClass:"km-std-iframe-body",allowAdjustBodyWidth:true}};if(this.availableItemsDialog==null){this.availableItemsDialog=km.js.ui.dialog.create(a)}var e=function(g,f){return function(j,h){var k=$('<div style="margin: 0 auto;"></div>');if(s.availableItemsOptions.title){k.append(km.js.ui.header(s.availableItemsOptions.title,null,"margin-bottom: 20px"))}k.append(j);g.show(k)}};var b=this.getAvailableItemTable(d,c,e(this.availableItemsDialog,this.title))},getAvailableItemTable:function(j,k,h){var c=km.js.datasource.create({type:"collection",data:j,jsti:k});if(km.js.utils.isEmpty(s.availableItemsOptions.properties)){throw"Properties for available items not defined"}var b={baseTypeId:this.associatedType.id,properties:[].concat(this.options.availableItemsOptions.properties)};b.properties.push({id:this.associatedType.idFieldId});var z={properties:[],idProperty:{id:this.associatedType.idFieldId}};for(var f=0;f<this.options.availableItemsOptions.properties.length;f++){z.properties.push({id:this.options.availableItemsOptions.properties[f].id,label:this.options.availableItemsOptions.properties[f].label,sortable:this.options.availableItemsOptions.properties[f].sortable,linkStyle:true,onClick:(function(y){return function(B){y.onItemSelect(B)}})(this)})}var l=km.js.table.create(c,b,z,{id:"available-items-"+this.id,jsti:k,pageSize:10,paginationActive:true,cssClass:"km-table-std km-rel-av-items",wrapperCssClass:"km-rel-av-items-wrapper",buttonPanel:this.options.availableItemsOptions.buttonPanel});var d=null;if(!km.js.utils.isEmpty(s.availableItemsOptions.tableSearchOptions)){var g={properties:[{id:this.associatedType.defaultFieldId,operator:"ilike"}],cssClass:"km-table-search-std"};var e={table:l,jsti:k};var m=$.extend({},g,s.availableItemsOptions.tableSearchOptions,e);d=km.js.tablesearch.create(m)}var a=function(y,B){return function(D,A){if(y){D=y.render().add(D)}B(D,A)}};l.render(null,a(d,h))},onItemSelect:function(c){this.availableItemsDialog.hide();var a=function(d){return function(e){d.update()}};var b=function(d){km.js.ui.statusbar.err(d.message?d.message:d.messages,10000)};km.js.data.associate(this.relationField.id,this.options.recordId,c,a(this),b)}};km.js.scope.rels[km.js.utils.normalizeId(u.id)]=u;return u}};
km.js.tabs={create:function(f){var d={originalContentHandling:"hide",cssClass:"km-tabs-std"};var f=$.extend({},d,f);var e={id:f.id,tabs:f.tabs,cssClass:f.cssClass,originalContentHandling:f.originalContentHandling,afterRender:f.afterRender,renderCount:0,render:function(a){this.renderCount++;var p=$('<ul class="km-tabs-head"></ul>');var b=$('<div class="km-tabs-panels"></div>');for(var n=0;n<this.tabs.length;n++){var o=this.tabs[n];var i=$('<li class="km-tabs-head-'+n+'">'+o.label+"</li>");i.click((function(g,h){return function(){g.open(h)}})(this,n));p.append(i);var r=$('<div class="km-tabs-panel km-tabs-panel-'+n+'"></div>');if(!(o.content instanceof jQuery)){throw"Tab content for tab "+n+" ("+o.label+") is not a jQuery object, its type is "+typeof(o.content)}if(o.content){r.html(o.content.clone());if(this.originalContentHandling==="remove"){o.content.remove()}else{o.content.hide()}}else{throw"Content not defined for tab with ID "+n+" and label "+o.label}b.append(r)}var c='<div class="km-tabs-container';if(this.cssClass){c+=" "+e.cssClass}c+='" id="'+this.id+'"></div>';var q=$(c);q.append($("<div></div>").append(p).addClass("km-tab-names-container"));q.append(b);if(typeof(a)==="function"){a(q)}else{a.html(q)}this.callAfterRender()},container:function(){return $("#"+this.id)},openActiveTab:function(){var a=0;if(location.hash&&location.hash.indexOf("#rm.tab.")===0){a=parseInt(location.hash.substring("#rm.tab.".length))}this.open(a)},open:function(a){if(typeof(this.tabs[a].beforeOpen)==="function"){this.tabs[a].beforeOpen()}this.container().find("div.km-tabs-panels > div.km-tabs-panel-active").removeClass("km-tabs-panel-active").hide();this.container().find("div.km-tabs-panels > div.km-tabs-panel-"+a).addClass("km-tabs-panel-active").show();this.container().find("ul.km-tabs-head > li.km-tabs-head-active").removeClass("km-tabs-head-active");this.container().find("ul.km-tabs-head > li.km-tabs-head-"+a).addClass("km-tabs-head-active");location.hash="rm.tab."+a},appendAfterRender:function(a){if(!this.afterRender){this.afterRender=a}else{if($.isArray(this.afterRender)){this.afterRender.push(a)}}this.callAfterRender(this.afterRender)},callAfterRender:function(){if(this.renderCount<1){return}if(typeof(this.afterRender)==="function"){this.afterRender(this)}else{if($.isArray(this.afterRender)){for(var b=0;b<this.afterRender.length;b++){var a=this.afterRender[b];if(typeof(a)==="function"){a(this)}else{throw"After render callback is not a function"}}}}}};return e}};
km.js.comments={create:function(c){var d={cssClass:"km-cmt-std",addLabel:km.js.config.i18n["comments.save"],deleteLabel:km.js.config.i18n["comments.delete"],respondLabel:km.js.config.i18n["comments.reply"],responsesLabel:km.js.config.i18n["comments.replies"],responseTitleLabel:km.js.config.i18n["comments.response.title"],noAnswersLabel:km.js.config.i18n["comments.no.replies"],title:km.js.config.i18n["comments.list.title"],commentTypePrefix:"00l",sortMode:"desc",maxResponseIndentLevel:4,maxResponseAddLevel:null,addComments:false};c=$.extend({},d,c);if(!c.id){throw"No ID passed in configuration options to the comments object"}return{id:c.id,comments:c.comments,recordId:c.recordId,title:c.title,cssClass:c.cssClass,addLabel:c.addLabel,deleteLabel:c.deleteLabel,respondLabel:c.respondLabel,responsesLabel:c.responsesLabel,responseTitleLabel:c.responseTitleLabel,noAnswersLabel:c.noAnswersLabel,recentInvocationParams:{},commentTypePrefix:c.commentTypePrefix,maxResponseIndentLevel:c.maxResponseIndentLevel,maxResponseAddLevel:c.maxResponseAddLevel,addComments:c.addComments,options:c,sortMode:c.sortMode,render:function(a){this.recentInvocationParams.renderArg=a;var b=function(h,e){return function(r){var i=r.data;var u=$('<div id="'+h.id+'" class="km-cmt '+h.cssClass+'"></div>');u.append('<div class="km-cmt-title km-title">'+h.title+"</div>");if(h.recordId&&h.addComments===true){var q=$('<div class="km-cmt-new"></div>');q.append('<div class="km-cmt-add-error"></div>');q.append('<textarea id="newcomment"></textarea>');var v=$('<a href="javascript:;" class="sbtn">'+h.addLabel+"</a>");v.click((function(j){return function(){var k=$(this).closest(".km-cmt-new").find("textarea#newcomment").first().val();var m=j.container().find("textarea#newcomment");m.prop("disabled",true);var l={content:k,recordId:j.recordId};$.post(km.js.config.sysContextPath+"/comments/save",l,(function(n,o){return function(p){if(p.success===true){n.refresh()}else{o.prop("disabled",false);km.js.ui.error(p.message,n.container().find(".km-cmt-new .km-cmt-add-error"),null)}}})(h,m),"json")}})(h));q.append(v);u.append(q)}var g=function(){var j=$('<ul class="km-cmt-list-btns"></ul>');var k=$('<li><img class="km-cmt-sort-'+h.sortMode+'" src="'+km.js.config.imagePath+"/sort"+h.sortMode+'.png" /></li>');k.find("img").click((function(l){return function(){if($(this).hasClass("km-cmt-sort-desc")){l.sort("asc")}else{l.sort("desc")}}})(h));j.append(k);return j};u.append(g());var t=$('<div class="km-cmt-list"></div>');for(var s=0;s<i.length;s++){t.append(h.commentCode(i[s],0,h.options))}u.append(t);if(typeof(e)==="function"){e(u)}else{if(e instanceof jQuery){e.empty().append(u)}else{throw"Unsupported type "+typeof(e)+" of parameter target in call to km.js.comments.render()"}}}};if(this.comments&&this.recordId){throw"Both comments list and record ID cannot be set"}if(this.recordId){var f={sort:this.sortMode,subcommentLevels:-1,additionalFields:this.options.queriedFields};$.get(km.js.config.sysContextPath+"/rest/recordcomments/"+this.recordId,f,b(this,a),"json")}else{(b(this,a))({comments:this.comments})}return this},refresh:function(){this.render(this.recentInvocationParams.renderArg)},container:function(){return $("#"+this.id)},commentCode:function(x,r,s){if(!x.id){throw"Comment has no ID"}if(!x.content){throw"Comment has no text"}var q=$('<div class="km-cmt-item km-cmt-item-'+x.id+'"></div>');var t=$('<div class="km-cmt-box"></div>');var a=$('<div class="km-cmt-head"></div>');var b=x.createdBy?x.createdBy.userName:"";a.append($('<span class="km-cmt-author">'+b+"</span>"));a.append($('<span class="km-cmt-date">'+x.createdDate+"</span>"));t.append(a);var w=$('<div class="km-cmt-content"></div>').text(km.js.utils.nl2br(x.content));t.append(w);var v=$('<div class="km-cmt-btns"></div>');if(x.canDelete===true){v.append($('<a class="km-cmt-del btn" href="javascript:;">'+this.deleteLabel+"</a>"))}if(this.addComments===true){v.append($('<a class="km-cmt-resp btn" href="javascript:;">'+this.respondLabel+"</a>"))}var p=x.comments?x.comments.length:0;v.append($('<a class="km-cmt-show-replies" href="javascript:;">'+this.responsesLabel+" ("+p+")</a>"));if(typeof(s.buttonsPostprocessor)==="function"){s.buttonsPostprocessor(x,v,s)}t.append(v);q.append(t);q.append(this.answerList(x,r,s));q.find("a.km-cmt-show-replies").click((function(e){return function(){$(this).closest(".km-cmt-item").find(".km-cmt-answer-list-"+e).toggle()}})(x.id));if(x.canDelete===true){q.find("a.km-cmt-del").each((function(e,f){return function(){var g=function(){e.container().find("textarea#newcomment").attr("disabled","disabled");$.post(km.js.config.sysContextPath+"/comments/delete",{commentId:f},function(h){e.refresh()},"json")};km.js.ui.confirm({callback:g,question:km.js.config.i18n["comments.delete.warning"],target:$(this)})}})(this,x.id))}if(this.addComments===true){q.find("a.km-cmt-resp").click((function(e,f){return function(){$(this).closest(".km-cmt-item").find(".km-cmt-resp-form-"+f).toggle();$(this).closest(".km-cmt-item").find(".km-cmt-resp-form-"+f+" > textarea").attr("id","km-cmt-resp-text-"+f)}})(this,x.id));if(!this.maxResponseAddLevel||r<=this.maxResponseAddLevel){var o=$('<div class="km-cmt-resp-form km-cmt-resp-form-'+x.id+'"><div class="km-cmt-resp-title">'+this.responseTitleLabel+"</div><textarea></textarea></div>");if(r<=this.maxResponseIndentLevel){o.css("padding-left","5%")}var u=$('<a href="javascript:;" class="sbtn">'+this.addLabel+"</a>");u.click((function(e){return function(){var i=$(this).closest(".km-cmt-resp-form").find("textarea");var g=i.first().val();i.attr("disabled","disabled");$(this).attr("disabled","disabled");var f=i.attr("id").substring("km-cmt-resp-text-".length);var h={content:g,parentId:f,recordId:e.recordId};$.post(km.js.config.sysContextPath+"/comments/save",h,"json").done(function(j){console.log("S: "+JSON.stringify(j));e.refresh()}).fail(function(j){console.log("E: "+JSON.stringify(j));e.refresh()})}})(this));o.append(u);q.append(o)}}return q},sort:function(a){if(a!=="asc"&&a!=="desc"){throw'Unsupported sort direction "'+direction+'"'}this.sortMode=a;this.refresh()},answerList:function(a,b,j){var h=$('<div class="km-cmt-answer-list km-cmt-answer-list-'+a.id+'"></div>');if(b<=this.maxResponseIndentLevel){h.css("padding-left","5%")}if(a.comments&&a.comments.length>0){for(var i=0;i<a.comments.length;i++){h.append(this.commentCode(a.comments[i],b+1,j))}}else{h.append('<div class="km-cmt-no-replies">'+this.noAnswersLabel+"</div>")}return h}}}};
km.js.ref={create:function(f){var e=function(a){if(!a.datasource){a.datasource=km.js.datasource.create({type:"database"})}if(!a.id){a.id="km-ref-"+km.js.utils.random(1000000)}if(a.datasource.type==="json"){if(a.availableItemsOptions&&a.availableItemsOptions.display&&a.availableItemsOptions.display.idProperty&&!a.availableItemsOptions.display.idProperty.id){a.availableItemsOptions.display.idProperty.id=a.availableItemsOptions.display.idProperty.name}}return a};f=e(f);var d={recentRenderParams:null,inputName:f.inputName,inputId:f.inputId,visibleInput:f.visibleInput,selectedRecordId:f.selectedRecordId,selectedRecordDisplayName:f.selectedRecordDisplayName,selectedRecordDisplayField:f.selectedRecordDisplayField,availableItemsOptions:f.availableItemsOptions,datasource:f.datasource,jcr:f.jcr,dialog:null,id:f.id,dialogOptions:f.availableItemsDialogOptions,afterSelect:f.afterSelect,afterClear:f.afterClear,mode:f.mode?f.mode:"edit",editable:f.editable,render:function(m){if(this.selectedRecordId&&!this.selectedRecordDisplayName){if(!this.selectedRecordDisplayField){throw"Display field not defined. Specify option selectedRecordDisplayField in configuration of the rm.ref component."}else{if(!this.selectedRecordDisplayField.id&&!this.selectedRecordDisplayField.name){throw"Neither selectedRecordDisplayField ID nor its name specified"}}var o={baseTypeId:this.jcr.baseTypeId,baseTypeName:this.jcr.baseTypeName,properties:[{id:this.selectedRecordDisplayField.id,name:this.selectedRecordDisplayField.name}],restrictions:[{operator:"eq",property_id:this.availableItemsOptions.display.idProperty.id,property_name:this.availableItemsOptions.display.idProperty.name,args:[this.selectedRecordId]}]};this.datasource.query(o,(function(g){return function(i,h,j){if(!g.selectedRecordDisplayField.id){if(g.datasource.type!=="json"){var k=km.js.utils.getTypeFromJSTI(g.jcr,j);if(!k){throw"Base type not retrieved"}g.selectedRecordDisplayField.id=km.js.utils.nestedPropertyToPir(g.selectedRecordDisplayField.name,k,j);if(!g.selectedRecordDisplayField.id){throw"Could not get ID for select record display field with name '"+g.selectedRecordDisplayField.name+"' on type "+k.qualifiedName}}else{if(!g.availableItemsOptions.display.defaultProperty.name){throw'Option display.defaultProperty.name name not defined on km.js.table using datasource of type "json"'}g.selectedRecordDisplayField.id=g.availableItemsOptions.display.defaultProperty.name}}if(i.length===0){throw"Selected record with ID "+g.selectedRecordId+" not found"}else{g.setDisplayValue(i[0][g.selectedRecordDisplayField.id])}}})(this))}this.recentRenderParams=m;if(!this.id){throw"Object reference ID is not defined"}if(!this.dialog){var a={size:{fitToContent:true},iframe:{addDefaultStyles:true,cssClass:"km-std-iframe",cssBodyClass:"km-std-iframe-body",allowAdjustBodyWidth:true},id:this.id+"-items-dialog",style:"background-color: #fff"};var b=$.extend({},a,this.dialogOptions);this.dialog=km.js.ui.dialog.create(b)}var c=$('<div class="km-lookup" id="km-lookup-'+this.id+'"></div>');if(!this.inputName){throw"Reference input name must not be empty. Specify inputName option in lookup configuration"}if(this.mode==="view"){c.addClass("km-readonly-lookup");if(this.editable===true){c.click((function(g){return function(h){g.makeEditable()}})(this))}}var p=$('<input type="hidden" class="km-lookup-val" name="'+this.inputName+'"></input>');if(this.selectedRecordId){p.val(this.selectedRecordId)}if(this.inputId){p.attr("id",this.inputId)}c.append(p);var n=$('<input class="km-lookup-display-name" type="text" readonly="true"></input>');if(this.visibleInput&&this.visibleInput.cssClass){n.addClass(this.visibleInput.cssClass)}n.click((function(g){return function(){if(g.isEditable()){console.log("Opening available items");g.openAvailableItems()}}})(this));c.append(n);if(this.mode==="view"&&this.editable===true){n.blur((function(g){return function(){g.makeIneditable()}})(this))}var l=$('<img class="km-lookup-del" src="'+km.js.config.imagePath+'/ex.png">');l.click((function(g){return function(){g.clear()}})(this));c.append(l);if(m){if(typeof(m)==="function"){m(c,this)}else{if(m instanceof jQuery){console.log("Target "+m.size()+", target desc: "+m+" ("+JSON.stringify(m)+")");m.replaceWith(c)}else{throw"Unsupported argument type "+typeof(m)+" while calling ref.render()"}}if(this.selectedRecordDisplayName){this.setDisplayValue(this.selectedRecordDisplayName)}}return c},isEditable:function(){return !this.container().hasClass("km-readonly-lookup")},makeEditable:function(){this.container().removeClass("km-readonly-lookup")},makeIneditable:function(){this.container().addClass("km-readonly-lookup")},clear:function(){this.setDisplayValue(null);this.container().find("input.km-lookup-val").val(null);if(typeof(this.afterClear)==="function"){this.afterClear(this.selectedRecordId)}this.selectedRecordId=null},refresh:function(){this.render(this.recentRenderParams)},openAvailableItems:function(){var i={id:this.id+"-ait",options:{pageSize:10,paginationActive:true}};var c={};for(var m=0;m<this.availableItemsOptions.display.properties.length;m++){var a=this.availableItemsOptions.display.properties[m];a.onClick=(function(g){return function(h){g.select(h)}})(this)}var l=$.extend({},i,this.availableItemsOptions,c);var b=km.js.table.create(this.datasource,this.jcr,l.display,l.options);var n=function(g){return function(k,v){var j=null;var A=v.datasource.type==="json";if(!v.datasource.jsti&&!A){throw"JSTI not available on datasource related to available items table"}var y=null;if(!A){y=km.js.utils.getTypeFromJSTI(g.jcr,v.datasource.jsti);if(!y){throw"Type information not found in JSTI for type KID "+g.jcr.baseTypeId}}if(!km.js.utils.isEmpty(g.availableItemsOptions.tableSearchOptions)){console.log("Adding table search for type "+JSON.stringify(y));var h={properties:[{id:y.defaultFieldId,operator:"ilike"}],cssClass:"km-table-search-std"};var B={table:v,jsti:v.datasource.jsti};var w=$.extend({},h,g.availableItemsOptions.tableSearchOptions,B);if(!A){km.js.utils.populateIdsOnProperties(w.properties,y,v.datasource.jsti)}j=km.js.tablesearch.create(w)}var x=$("<div></div>");var z=g.availableItemsOptions.title?g.availableItemsOptions.title:y.pluralLabel;x.append(km.js.ui.header(z,null,"margin-bottom: 20px"));if(j){k=j.render().add(k)}x.append(k);g.dialog.show(x)}};b.render(null,n(this))},container:function(){var a=$("div[id='km-lookup-"+this.id+"']");if(a.length>1){throw"Ambiguous container, found "+a.length+" such elements instead of one"}return a},select:function(a){this.dialog.hide();this.selectedRecordId=a;this.selectedRecordDisplayName=null;if(this.mode==="view"&&this.editable===true){this.container().addClass("km-readonly-lookup")}if(typeof(this.recentRenderParams)==="function"){this.render(this.recentRenderParams);if(typeof(this.afterSelect)==="function"){this.afterSelect(this.selectedRecordId)}}else{if(this.recentRenderParams instanceof jQuery){this.render(this.container());if(typeof(this.afterSelect)==="function"){this.afterSelect(this.selectedRecordId)}}else{throw"Unsupported recent invocation param type: "+typeof(this.recentRenderParams)}}},setDisplayValue:function(a){this.container().find("input.km-lookup-display-name").val(a);this.selectedRecordDisplayName=a}};km.js.scope.refs[km.js.utils.normalizeId(d.id)]=d;return d}};
km.js.validation={init:function(b){if(!b){b=$(document)}else{if(!(b instanceof jQuery)){throw"Target of validation.init must be a jQuery object"}}b.find("input[km-validate=number]").each((function(a){return function(){$(this).change(function(d){a.validateNumber($(this),d)});$(this).blur(function(d){a.validateNumber($(this),d)})}})(this))},isValidNumber:function(b){return(new RegExp(km.js.config.localeNumberFormat)).test(b)},validateNumber:function(f,e){var d=f.val();if(d&&!this.isValidNumber(f.val())){f.addClass(this.errorClass);f.focus()}else{f.removeClass(this.errorClass)}},errorClass:"km-validate-err"};
km.js.fileupload={create:function(e){var f={id:"file-upload",parentDialog:null};var h=$.extend({},f,e);var g=km.js.ui.dialog.create({id:h.id,size:{width:"800px",height:"600px"},url:km.js.config.sysContextPath+"/files/new?"+(h.parentDialog?"parentDialog="+h.parentDialog:"")+(h.recordId?"&recordId="+h.recordId:""),afterClose:h.afterClose});return g}};
km.js.userlookup={create:function(i){var j={id:"user-lookup"};var k=$.extend({},j,i);var l={baseTypeName:"kommet.basic.User",properties:[{name:"userName"},{name:"id"}]};var h={options:{id:"user-search"},display:{properties:[{name:"userName",label:"User Name",linkStyle:true}],idProperty:{name:"id"}},title:"Users",tableSearchOptions:{properties:[{name:"userName",operator:"ilike"}]}};var g=km.js.ref.create({selectedRecordDisplayField:{name:"userName"},jcr:l,availableItemsDialogOptions:{},availableItemsOptions:h,inputName:k.inputName,inputId:k.inputId,visibleInput:k.visibleInput,selectedRecordId:k.selectedRecordId});return g}};
km.js.devitems={create:function(f){var g={items:null,group:"package",checkboxes:false,checkboxCallback:null};var e=$.extend({},g,f);var h={options:e,container:null,render:function(c,b){var I=b?$.extend({},this.options,b):this.options;this.container=$("<div></div>").addClass("km-dev-items-container");this.container.append(this.getBtnPanel(I));if(!I.items){throw"Item collection has not been provided"}if(I.group==="type"){var K=$("<ul></ul>").addClass("km-devitems-tree");var U=I.types;var k=0;if(U&&$.isArray(U)){var L=$("<ul></ul>");var Y={};for(var S=0;S<U.length;S++){var J=U[S];var i=J.qualifiedName.split(".");var Q=I.selectedItemIds&&km.js.utils.isObject(I.selectedItemIds[J.id]);if(Q||I.ignoreSelection){k++}Y=this.addItemToTree(Y,i,i,J.id,Q);for(var aa=0;aa<J.fields.length;aa++){var O=J.fields[aa];if(O.isSystem){continue}var W=I.selectedItemIds&&I.selectedItemIds[O.id];if(W||I.ignoreSelection){k++}var ac=(J.qualifiedName+"._"+O.apiName).split(".");Y=this.addItemToTree(Y,ac,ac,O.id,W,{field:O})}}L=this.appendItemTree(L,Y,this,1,I,false);var M=$("<a></a>").text("Types and fields ("+k+")").addClass("km-devitems-type");M.click(function(){$(this).closest("div.km-devitems-typegroup-name").siblings("ul").children("li").toggle()});var V=$("<div></div>").addClass("km-devitems-typegroup-name");var a=$("<span></span>").addClass("km-devitems-typegroup-icon").append($("<i></i>").addClass("fa fa-folder km-devitem-icon"));V.append(a).append(M);var X=$("<li></li>").append(V).append(L);K.append(X)}for(typeId in I.items){var P=km.js.config.componentTypes[typeId];if(!P){throw"Component type with ID "+typeId+" not found"}var L=$("<ul></ul>");var d=I.items[typeId];if(d){if($.isArray(d)){var Y={};for(var S=0;S<d.length;S++){var ab=d[S];var ad=[];var Z=null;for(var N in ab){if(N.indexOf("003")!==0){continue}var O=I.jsti.fields[N];if(O.apiName==="id"){Z=ab[N]}else{var T=ab[N];ad.push(T)}}var i=ad.join(".").split(".");var Q=I.selectedItemIds&&I.selectedItemIds[Z];Y=this.addItemToTree(Y,i,i,Z,Q)}L=this.appendItemTree(L,Y,this,1,I,false)}else{throw"Items for component type ID "+typeId+" are not represented in an array"}}var R=P.name.toLowerCase().replace(/\_/g," ");var M=$("<a></a>").text(R+" ("+d.length+")").addClass("km-devitems-type");M.click(function(){$(this).closest("div.km-devitems-typegroup-name").siblings("ul").children("li").toggle()});var V=$("<div></div>").addClass("km-devitems-typegroup-name");var a=$("<span></span>").addClass("km-devitems-typegroup-icon").append($("<i></i>").addClass("fa fa-folder km-devitem-icon"));V.append(a).append(M);var X=$("<li></li>").append(V).append(L);K.append(X)}this.container.append(K)}else{if(I.group==="package"){throw"Grouping by package not supported"}else{throw"Unsupported dev item grouping '"+I.group+"'"}}this.container.append(K);if(typeof(c)==="function"){c(this.container,this)}else{if(c instanceof jQuery){c.empty().append(this.container)}}this.collapse()},collapse:function(){this.container.find("li.km-devitems-enditem-li").hide();this.container.find("li.km-devitems-package-li").hide()},addItemToTree:function(m,c,d,a,b,l){if(c.length>1){var n=m[c[0]];if(!n){m[c[0]]={};n=m[c[0]]}c.splice(0,1);n=this.addItemToTree(n,c,d,a,b,l)}else{if(m[c[0]]){throw"The same item "+c[0]+" added twice"}m[c[0]]={name:c[0],qualifiedName:d.join("."),id:a,isSelected:b,options:l}}return m},appendItemTree:function(D,B,I,N,G,M){for(var J in B){var d=B[J];if(M&&!km.js.utils.isObject(d)){continue}var y=M?J.substring(1):J;var F=$("<li></li>");var C=$("<span></span>").text(y).addClass("km-devitems-item-name");var H=$("<div></div>").css("padding-left",(2*N)+"em");var L=$("<a></a>").append(C);if(d.id){L.addClass("km-devitems-enditem");F.addClass("km-devitems-enditem-li").attr("id","km-devitems-enditem-li-"+d.id);F.append($("<input></input>").val(d.qualifiedName).attr("name","qualifiedName").attr("type","hidden"));if(typeof(I.options.itemClick)==="function"){L.click((function(i,j){return function(){i(j)}}(I.options.itemClick,d)))}if(G.checkboxes===true){var E=$("<input></input>").attr("type","checkbox").attr("id","record_"+d.id);if(d.isSelected){E.attr("checked","checked")}if(typeof(G.onCheck)==="function"){E.click((function(i){return function(){G.onCheck(i)}})(d))}H.append($("<div></div>").addClass("km-devitems-checkbox-wrapper").append(E))}if(typeof(G.onClick)==="function"){L.click((function(i,j){return function(){G.onClick(i);j.toggleClass("km-devitems-selected")}})(d,F))}var z=$("<div></div>").addClass("km-devitems-icon-wrapper");var K=$("<i></i>").addClass("fa fa-file km-devitem-icon");z.append(K);H.append(z);H.append(L);if(M){var c=d.options.field;if(!c){throw"Field definition not set"}var a=$("<div></div>").addClass("km-field-info");a.text("("+c.datatype.name+")");H.append(a)}F.append(H);if(d.isSelected){F.addClass("km-devitems-selected")}else{if(G.unselectedItemCssClass){F.addClass(G.unselectedItemCssClass)}}if(d.id.indexOf("002")===0){F.addClass("km-devitems-type-li");L.click((function(){return function(){$(this).closest(".km-devitems-type-li").children("ul").children("li").toggle()}}()));var b=$("<ul></ul>");this.appendItemTree(b,d,I,N+1,G,true);F.append(b)}}else{L.addClass("km-devitems-package");F.addClass("km-devitems-package-li");F.append(L);L.click((function(){return function(){$(this).closest(".km-devitems-package-li").children("ul").children("li").toggle()}}()));var A=$("<i></i>").addClass("fa fa-list km-devitem-icon");A.click((function(){return function(){$(this).closest(".km-devitems-package-li").children("ul").children("li").toggle()}}()));H.append($("<div></div>").addClass("km-devitems-icon-wrapper").append(A));H.append(L);F.append(H);var b=$("<ul></ul>");this.appendItemTree(b,d,I,N+1,G,false);F.append(b)}D.append(F)}return D},getBtnPanel:function(a){var b=$("<div></div>").addClass("km-devitems-btns");return b}};return h}};
km.js.calendar={create:function(c){var d={range:"week",daysPerRow:7,cssClass:"km-cal-std",hourStart:7,hourEnd:18,eventUrl:"events/{id}",hours:true,formatDate:function(a){return a!==null?this.stdDateFormat(a,"-"):""}};c=$.extend({},d,c);return{range:c.range,startDate:c.startDate,endDate:c.endDate,hourStart:c.hourStart,hourEnd:c.hourEnd,hours:c.hours,formatDate:c.formatDate,daysPerRow:c.daysPerRow,cssClass:c.cssClass,defaultEventDuration:3600000,eventUrl:c.eventUrl,id:c.id?c.id:"cal-"+(Math.floor(Math.random()*1000)+1),addEvents:function(a){for(var b=0;b<a.length;b++){this.addEvent(a[b])}},showRange:function(b,h){if(b<this.startDate){b=this.startDate}if(h>this.endDate){h=this.endDate}this.container().find(".km-cal-day").hide();for(var g=new Date(b);g<=h;g.setDate(g.getDate()+1)){var a=this.stdDateFormat(g,"");this.container().find(".km-cal-day-"+a).show()}},addEvent:function(v){var B=this.hourStart;var r=v.duration?v.duration:this.defaultEventDuration;var t=new Date(v.startDate);var y=new Date(v.startDate+r);if(t.getHours()<this.hourStart){if(y.getHours()<this.hourStart){console.log("Ignoring event "+v.name);return}}else{B=t.getHours()}var z=$('<div class="km-cal-event"></div>');z.append('<div class="km-cal-event-inner"><a class="km-cal-event-link" href="'+this.eventUrl.replace(/{id}/g,v.id)+'">'+v.name+"</a></div>");var b=this.stdDateFormat(t,"")+B;var x=this.container().find("div.km-cal-hour-"+b+" > div.km-cal-event-content").first();var w=this.container().find("div.km-cal-hour-"+this.stdDateFormat(t,"")+(y.getHours()+(y.getMinutes()>0?1:0))+" > div.km-cal-event-content").first();var a=w.position().top;var s=null;if(y.getHours()>t.getHours()){s=this.container().find("div.km-cal-hour-"+(this.stdDateFormat(t,"")+(y.getHours()-1))+" > div.km-cal-event-content").first()}else{s=x}var u=s.position().top;console.log("Event: "+v.name+", MIN: "+y.getMinutes());console.log("NEXT: "+a+", BUT: "+u);var A=x.position().top;var q=y.getMinutes()>0?(u+(y.getMinutes()*(a-u))/60):a;z.css("height",q-A);x.append(z)},container:function(){return $("#"+this.id)},render:function(b){var l='<div class="km-cal-container '+this.cssClass+'" id="'+this.id+'">';var i=$('<div class="km-cal-days"></div>');var a=0;for(var j=new Date(c.startDate);j<=c.endDate;j.setDate(j.getDate()+1)){if(a%this.daysPerRow===0){i.append('<div class="km-cal-day-row"></div>')}i.append(this.renderDay(j));a++;if(a%this.daysPerRow===0){i.append("</div>")}}l+="</div>";var k=$(l);k.append(i);if(typeof(b)==="function"){b(k)}else{b.append(k)}},stdDateFormat:function(b,f){var a=function(h){var e=h+"";return e.length==1?"0"+e:e};return b.getFullYear()+f+a(b.getMonth()+1)+f+a(b.getDate())},renderDay:function(b){var f=this.stdDateFormat(b,"");var a=$('<div class="km-cal-day km-cal-day-'+f+'"></div>');a.append('<div class="km-cal-date-label">'+this.formatDate(b)+"</div>");if(this.hours===true){a.append(this.renderHours(b))}return a},renderHours:function(a){var f='<div class="km-cal-hours">';for(var b=this.hourStart;b<=this.hourEnd;b++){f+='<div class="km-cal-hour km-cal-hour-'+this.stdDateFormat(a,"")+b+'"><div class="km-cal-hour-num">';f+=b+".00";f+='</div><div class="km-cal-event-content"></div></div>'}f+="</div>";return $(f)},}}};
km.js.rightpanel={create:function(g){var h={recentItems:{show:true,count:5},notifications:{show:true,count:5},icon:null};var e=$.extend({},h,g);var f={options:e,container:null,render:function(a){this.container=$("<div></div>").addClass("km-rp-container");this.container.append(this.userInfo());if(typeof(a)==="function"){a(this.container,this)}else{if(a instanceof jQuery){a.empty().append(this.container)}}this.initNotifications(this.container);this.initTasks(this.container);this.initEvents(this.container)},initNotifications:function(a){var c=km.js.datasource.create({type:"database"});var b={baseTypeName:"kommet.basic.Notification",properties:[{name:"id"},{name:"text"},{name:"title"},{name:"viewedDate"},],restrictions:[{property_name:"assignee.id",operator:"eq",args:[km.js.config.authData.user.id]},{property_name:"viewedDate",operator:"isnull",args:[]}]};c.query(b,(function(l,d,k){return function(D,B,A){D=km.js.utils.addPropertyNamesToJSRC(D,A);var y=$("<div></div>").addClass("km-rp-list-wrapper");var J=$("<ul></ul>").addClass("km-rp-list");var H=$("<div></div>").addClass("km-rp-list-title").text(km.js.config.i18n["notif.notification.title"]+" ("+D.length+")");y.append(H);var i=0;if(D.length>0){for(var j=0;j<D.length;j++){var C=D[j];var G=$("<li></li>");var H=$("<div></div>").addClass("km-rp-list-item-title").text(C.title);var I=$("<img></img>").attr("src",km.js.config.imagePath+"/ex.png").addClass("km-rp-list-close");I.click((function(n,m){return function(){console.log("Deleting notification "+n);$.post(km.js.config.contextPath+"/km/notifications/setviewed",{id:n},function(o){if(o.status==="success"){G.remove()}else{km.js.ui.statusbar.show("Could not set notification as viewed",10000)}},"json")}})(C.id,G));H.append(I);var F=$("<div></div>").addClass("km-rp-list-item-text").text(C.text);G.append(H).append(F);if(!C.viewedDate){i++;G.addClass("km-unread")}G.click((function(m){return function(){var n={id:m,viewedDate:(new Date()).getTime()};km.js.db.update(n,(function(o){return function(){o.removeClass("km-unread");o.fadeOut(500)}})($(this)))}})(C.id));J.append(G)}var z=$("<div></div>").append(J).addClass("km-rp-item-wrapper");if(D.length>5){z.addClass("km-rp-scroll")}y.append(z);if(i&&(d instanceof jQuery)){var E=$("<div></div>").addClass("km-alert-numbers");E.text(i);E.click((function(m){return function(){m()}})(k));d.append(E)}}else{y.append($("<div></div>").addClass("km-rp-list-noitems").text(km.js.config.i18n["rightpanel.list.noitems"]))}l.append(y)}})(a,this.options.icon,this.options.openCallback))},initTasks:function(a){var c=km.js.datasource.create({type:"database"});var b={baseTypeName:"kommet.basic.Task",properties:[{name:"id"},{name:"content"},{name:"title"}],restrictions:[{property_name:"assignedUser.id",operator:"eq",args:[km.js.config.authData.user.id]}]};c.query(b,(function(d){return function(u,C,w){u=km.js.utils.addPropertyNamesToJSRC(u,w);var i=$("<div></div>").addClass("km-rp-list-wrapper");var D=$("<ul></ul>").addClass("km-rp-list");var y=$("<div></div>").addClass("km-rp-list-title km-rp-list-title-clickable").text(km.js.config.i18n["rightpanel.tasks.title"]+" ("+u.length+")");y.click(function(){km.js.utils.openURL(km.js.config.contextPath+"/km/tasks/userlist")});i.append(y);if(u.length>0){for(var v=0;v<u.length;v++){var z=u[v];var x=$("<li></li>").addClass("km-rp-list-item-link");var y=$("<div></div>").addClass("km-rp-list-item-title").text(z.title);x.click((function(k,j){return function(){km.js.utils.openURL(km.js.config.contextPath+"/km/tasks/userlist?id="+k)}})(z.id,x));var B=$("<div></div>").addClass("km-rp-list-item-text").text(z.content);x.append(y).append(B);D.append(x)}var A=$("<div></div>").append(D).addClass("km-rp-item-wrapper");if(u.length>5){A.addClass("km-rp-scroll")}i.append(A)}else{i.append($("<div></div>").addClass("km-rp-list-noitems").text(km.js.config.i18n["rightpanel.list.noitems"]))}d.append(i)}})(a))},initEvents:function(b){var a=new Date();a.setHours(0);a.setMinutes(0);a.setSeconds(0);var c=new Date(a);c.setDate(c.getDate()+6);c.setHours(23);c.setMinutes(59);c.setSeconds(59);$.get(km.js.config.contextPath+"/km/rest/events",{startDate:a.getTime(),endDate:c.getTime(),userId:km.js.config.authData.user.id},(function(d){return function(A){var t=A.data.events;var u=$("<div></div>").addClass("km-rp-list-wrapper");var x=$("<ul></ul>").addClass("km-rp-list");var i=$("<div></div>").addClass("km-rp-list-title").text(km.js.config.i18n["rightpanel.events.title"]+" ("+t.length+")");u.append(i);if(t.length>0){for(var w=0;w<t.length;w++){var B=t[w];var v=$("<li></li>").addClass("km-rp-list-item-link");var i=$("<div></div>").addClass("km-rp-list-item-title").text(B.name);v.click((function(k,j){return function(){km.js.utils.openURL(km.js.config.contextPath+"/km/events/"+k)}})(B.id,v));var y=$("<div></div>").addClass("km-rp-list-item-text").text(B.description?B.description.substring(0,40):"");v.append(i).append(y);x.append(v)}var z=$("<div></div>").append(x).addClass("km-rp-item-wrapper");if(records.length>5){z.addClass("km-rp-scroll")}u.append(z)}else{u.append($("<div></div>").addClass("km-rp-list-noitems").text(km.js.config.i18n["rightpanel.list.noitems"]))}d.append(u)}})(b))},userInfo:function(){var a=$("<div></div>").addClass("km-rp-username-wrapper");a.append($("<div></div>").addClass("km-rp-username-title").text(km.js.config.i18n["rightpanel.loggedin.as"]));a.append($("<div></div>").addClass("km-rp-username").text(km.js.config.authData.user.userName));return a}};return f}};
km.js.ide={getJavaHints:function(i,g,j,k,l,h){$.post(km.js.config.contextPath+"/km/livejavahints",{code:i,varName:g,methodName:j,line:k,position:l},(function(a){return function(e){var b=[];for(var c=0;c<e.data.methods.length;c++){var d=e.data.methods[c].name;b.push({text:(j?"":".")+d+"()",displayText:d})}a(b)}})(h),"json")},getControllerTemplate:function(b){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"controller",templateFileName:"kommet.example.MyController"},function(d){if(d.success===true){var a={name:"MyController",content:d.data.source,mode:"text/x-java",type:"class",fileData:d.data.fileData};console.log("Calling callback");b(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getClassTemplate:function(b){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"class",templateFileName:"kommet.example.MyClass"},function(d){if(d.success===true){var a={name:"MyClass",content:d.data.source,mode:"text/x-java",type:"class",fileData:d.data.fileData};b(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getTriggerTemplate:function(c,d){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"trigger",templateFileName:"kommet.example.SampleTrigger",typeName:d?d.type:null},function(b){if(b.success===true){var a={name:"SampleTrigger",content:b.data.source,mode:"text/x-java",type:"class",fileData:b.data.fileData};c(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getBusinessActionTemplate:function(b){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"businessAction",templateFileName:"kommet.example.MyBusinessAction"},function(d){if(d.success===true){var a={name:"MyBusinessAction",content:d.data.source,mode:"text/x-java",type:"class",fileData:d.data.fileData};b(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getViewTemplate:function(b){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"view",templateFileName:"kommet.views.MyView"},function(d){if(d.success===true){var a={name:"MyView",content:d.data.source,mode:"xml",type:"view"};b(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getLayoutTemplate:function(b){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"layout",templateFileName:"kommet.views.MyLayout"},function(d){if(d.success===true){var a={name:"MyLayout",content:d.data.source,mode:"xml",type:"layout"};b(a)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")}};
km.js.db={query:function(f,e,h){var g=km.js.datasource.create({type:"database"});g.query(f,e,h)},update:function(l,h,g,k){var j=l.id;delete l.id;var i={id:j,record:JSON.stringify(l),};if(k){if(k.typeName){i.typeName=k.typeName}}$.post(km.js.config.contextPath+"/km/rest/record/save",i,function(a){if(typeof(h)==="function"){h(a.success,a)}},"json").fail(function(a){if(typeof(g)==="function"){g(JSON.parse(a.responseText))}})},deleteRecord:function(f,e,d){$.post(km.js.config.contextPath+"/km/rest/record/delete",{id:f},function(a){if(typeof(e)==="function"){e(a.success,a)}},"json").fail(function(a){if(typeof(d)==="function"){d(JSON.parse(a.responseText))}})}};
km.js.rest={call:function(d,c){if(d.indexOf("/")==0){d=d.substring(1)}$.get(km.js.config.contextPath+"/"+d,c,"json")}};
km.js.relatedlist={create:function(h){var n=km.js.datasource.create({type:"database"});if(!h.jcr){throw"[km.js.relatedlist] jcr is null"}if(!h.target){throw"[km.js.relatedlist] target not defined"}var k={idProperty:{name:"id"}};var m={id:"relatedlist"};var l=$.extend({},k,h.displayOptions);var j=$.extend({},m,h.tableOptions);var i=km.js.table.create(n,h.jcr,l,j);i.render(h.target)}};
km.js.objectdetails={create:function(e){var f={delayCallbacks:false,layout:null,customizable:false};var d={options:$.extend({},f,e),afterRenderCallbacks:[],renderStage:"not-started",renderedForm:null,updatedRecord:null,render:function(N){this.renderStage="started";this.afterRenderCallbacks=[];var P=$.extend({},this.options,N);this.actualOptions=P;var G=$("<div></div>").addClass("km-rd-table km-grid-section km-grid-group");if(P.customizable){if(!e.customization){throw"Customization context not defined"}G.addClass("km-rd-table-customizable")}var b=P.jsti;if(!b){throw"JSTI not provided to rm.objectdetails"}var O=P.record;if(!O){throw"Record not passed to rm.objectdetails"}this.updatedRecord=$.extend({},O);var j=P.mode;var Q=P.fieldsPerRow;if(!Q){Q=2}if(!j){throw"Form mode (edit/view) not defined"}var M=null;var a=0;if(!P.fields&&!P.layout){throw"Neither fields for display nor layout are specified"}if(P.fields&&P.layout){throw"Both fields and layout cannot be set in options of rm.objectdetails"}if(P.fields){P.layout=this.getDefaultLayout(P,Q)}for(var I=0;I<P.layout.sections.length;I++){var K=P.layout.sections[I];var D=$("<div></div>").addClass("km-rd-body km-property-section km-grid-col km-grid-span-2-of-2");if(K.title){var F=$('<div class="km-rd-row km-section-title"><div class="km-rd-cell">'+K.title+"</div></div>");D.append(F)}if(!K.rows){throw"Layout section does not contain any rows"}var H=0;for(;H<K.rows.length;H++){var M=K.rows[H];var T=$("<div></div>").addClass("km-rd-row km-grid-section km-grid-group");for(var i=0;i<M.fields.length;i++){var S=M.fields[i];if(S.isPlaceholder){T.append(this.placeholder(I,H,i,P.customizable,P));a++;continue}var c=null;if(S.isGeneric===true){var L=km.js.utils.propVal(O,S.name);if(!L&&S.value){L=S.value}var c=this.propertyCell(S,S.name,L,j,null)}else{var J=S.id;var k=null;var E=null;if(!J){if(!P.type){throw"Type not specified in options"}if(!S.name){throw"Neither field name nor ID specified: "+JSON.stringify(S)}E=S.name;k=this.getFieldFromJSTI(P.type,S.name,b)}else{k=b.fields[S.id]}if(!k){throw"Field "+JSON.stringify(S)+" not found in JSTI"}if(k.apiName&&!k.name){k.name=k.apiName}var L=O[k.id];if(S.label){k.label=S.label}var c=this.propertyCell(k,E,L,j,b)}if(!c){continue}if(P.customizable){c.draggable({helper:function(){return $(this).clone().addClass("km-rd-prop-drag-helper")},start:(function(h,n,g,m,l){return function(o,p){h.draggedProperty={field:n,sectionIndex:g,rowIndex:m,fieldIndex:l}}})(this,S,I,H,i),stop:(function(g){return function(h,l){g.draggedProperty=null}})(this)})}T.append(c);a++}while((a%Q)!==0){T.append(this.placeholder(I,H,i,P.customizable,P));a++}if(typeof(M.render)==="function"){T.empty().append(M.render(M,T,G))}D.append(T)}var T=$("<div></div>").addClass("km-rd-row km-grid-section km-grid-group");a=0;while(a<Q){T.append(this.placeholder(I,H,a,P.customizable,P));a++}D.append(T);T=null;if(P.customizable){D.draggable({helper:function(){return $(this).clone().addClass("km-rd-prop-drag-helper")},start:(function(h,g){return function(l,m){h.draggedSection={sectionIndex:g}}})(this,I),stop:(function(g){return function(h,l){g.draggedSection=null}})(this)});D.droppable({drop:(function(h,g,l){return function(){if(!h.draggedSection){return}var m=P.layout;var n=m.sections[g];m.sections[g]=m.sections[h.draggedSection.sectionIndex];m.sections[h.draggedSection.sectionIndex]=n;h.draggedSection=null;console.log("Repainting layout: "+JSON.stringify(m));h.render(h.actualOptions);if(!l.customization){throw"Customization context not defined"}h.saveCustomization(l.type.name,l.customization.context,l.customization.contextValue,m)}})(this,I,P)})}G.append(D)}this.renderedForm=G;var R=G;if(P.customization){R=$("<div></div>").append(this.customizationPanel(P)).append(G)}if(typeof(P.target)==="function"){P.target(R,this)}else{if(P.target instanceof jQuery){P.target.empty().append(R)}}this.renderStage="finished";this.callAfterRenderCallbacks()},customizationPanel:function(m){var a=this.getTypeFromJSTI(m.type,m.jsti);if(!a){throw"Type not found while rendering customization panel"}var o=$("<div></div>");var c=$("<div></div>").addClass("km-field-list");for(var l in m.jsti.fields){var p=m.jsti.fields[l];if(p.typeId!==a.id){continue}var b=$("<div></div>").addClass("km-cust-field");var n=$("<div></div>").text(p.label);b.append(n);var l=$("<div></div>").text(p.name);b.append(l);b.draggable({helper:function(){return $(this).clone().css("display","block").addClass("km-field-drag-helper")},start:(function(h,g){return function(i,j){h.draggedProperty={field:g,sectionIndex:null,rowIndex:null,fieldIndex:null,isNew:true}}})(this,p),stop:(function(g){return function(h,i){g.draggedProperty=null}})(this)});c.append(b)}o.append(c);return o},placeholder:function(c,r,p,m,n){var a=$("<div></div>").addClass("km-rd-property km-grid-col km-grid-span-1-of-2");var b=$("<div></div>").addClass("label km-rd-cell");var o=$("<div></div>").addClass("value km-rd-cell");if(m){b.append($("<div>new field</div>").addClass("km-drop-label-filler"));var q=$('<input type="text"></input>').attr("disabled",true);o.append($("<div></div>").append(q).addClass("km-drop-val-filler"));a.droppable({drop:(function(j,i,h,k,g){return function(){if(!j.draggedProperty.field){throw"Dropped null field"}console.log("Dropped "+JSON.stringify(j.draggedProperty));var v=n.layout;var l=v.sections[i];if(h>=l.rows.length){l.rows.push({fields:[]})}var w=l.rows[h];if(k>=w.fields.length){for(var x=w.fields.length;x<k;x++){w.fields.push({isPlaceholder:true})}}w.fields.push(j.draggedProperty.field);if(j.draggedProperty.isNew!==true){v.sections[j.draggedProperty.sectionIndex].rows[j.draggedProperty.rowIndex].fields[j.draggedProperty.fieldIndex]={isPlaceholder:true}}j.draggedProperty=null;console.log("Repainting layout: "+JSON.stringify(v));j.render(j.actualOptions);if(!g.customization){throw"Customization context not defined"}j.saveCustomization(g.type.name,g.customization.context,g.customization.contextValue,v)}})(this,c,r,p,n)})}return a.append(b).append(o)},saveCustomization:function(b,a,c,h){$.post(km.js.config.contextPath+"/km/objectdetails/customize",{typeName:b,context:a,contextValue:c,layout:JSON.stringify(h)},function(g){})},propertyDrop:function(){var a=$("<div></div>").addClass("km-rd-property km-prop-drop");var b=$("<div></div>").addClass("label km-rd-cell km-drop-cell").text("a");a.append(b);return a},getDefaultLayout:function(n,a){var b={sections:[]};var c={title:null,rows:[]};var m=null;var i=0;for(var o=0;o<n.fields.length;o++){if(!m){m={fields:[]}}var p=n.fields[o];m.fields.push(p);i++;if((i%a)===0){c.rows.push(m);m=null}}if(m){c.rows.push(m)}b.sections.push(c);return b},callAfterRenderCallbacks:function(){for(var a=0;a<this.afterRenderCallbacks.length;a++){this.afterRenderCallbacks[a]()}},addAfterRenderCallback:function(a){if(this.renderStage==="finished"&&!this.options.delayCallbacks){a()}else{this.afterRenderCallbacks.push(a)}},getTypeFromJSTI:function(b,c){if(!b.id&&!b.name){throw"Neither type name nor ID set: "+JSON.stringify(b)}var a=null;for(var i in c.types){var j=c.types[i];if((b.id&&b.id===j.id)||(b.name&&b.name===j.qualifiedName)){return j}}return null},getFieldFromJSTI:function(t,a,q){var b=this.getTypeFromJSTI(t,q);if(!b){throw"Type not found: "+JSON.stringify(t)}var s=a.indexOf(".")>=0;var p=[];if(s){p=a.split(".");a=p[0]}for(var n in q.fields){var c=q.fields[n];if(c.apiName===a&&c.typeId===b.id){if(!s){return c}else{if(c.dataType.id!==km.js.datatypes.object_reference.id){throw"Expected nested field "+a+" to be a type reference, but its data type is "+c.dataType.id}if(!c.dataType.typeId){throw"Referenced type ID not set on field "+a+" in JSTI"}p.shift();var r=p.join(".");var o=q.types[c.dataType.typeId];if(!o){throw"Nested type "+c.dataType.typeId+" not found in JSTI"}return this.getFieldFromJSTI(o,r,q)}}}return null},propertyCell:function(r,o,q,n,p){var a=$("<div></div>").addClass("km-rd-property km-grid-col km-grid-span-1-of-2");var c=$("<div></div>").addClass("label km-rd-cell").text(r.label);var m=this.renderField(r,o,q,n,p);if(!m){return null}var b=$("<div></div>").addClass("value km-rd-cell").append(m);a.append(c).append(b);return a},showErrors:function(c){var b=function(j,g){j.addClass("km-field-err-style")};for(var a=0;a<c.length;a++){var h=c[a];b(this.renderedForm.find(".km-field-"+h.fieldId),h.message)}},renderField:function(u,z,t,y,a){var c=function(g){g.addClass("km-output");g.attr("disabled","true").attr("readonly","true");return g};var i=u.dataType;if(i.id===km.js.datatypes.text.id||i.id===km.js.datatypes.email.id||i.id===km.js.datatypes.number.id||(i.id===km.js.datatypes.enumeration.id&&y==="view")){var A=$("<input></input>").val(t).attr("type","text");A.addClass("km-field-"+u.id);if(u.placeholder){A.attr("placeholder",u.placeholder)}A.change((function(h,g){return function(){h.updatedRecord[g.id]=$(this).val();km.js.utils.setPropVal(h.updatedRecord,z,$(this).val())}})(this,u));if(y==="view"){A=c(A)}return A}else{if(i.id===km.js.datatypes.date.id||i.id===km.js.datatypes.datetime.id){var A=$("<input></input>").val(t).attr("type","text");A.addClass("km-field-"+u.id);A.datepicker({dateFormat:"yy-mm-dd"});A.change((function(h,g){return function(){h.updatedRecord[g.id]=$(this).val();km.js.utils.setPropVal(h.updatedRecord,z,$(this).val())}})(this,u));if(y==="view"){A=c(A)}return A}else{if(i.id===km.js.datatypes.object_reference.id){var b="item-"+km.js.utils.random(1000000);var A=$("<input></input>").val(t).attr("type","text").attr("km-hash",b);A.addClass("km-field-"+u.id);var w=a.types[i.typeId];if(!w){throw"Referenced type with ID "+i.typeId+" for field "+u.apiName+" not found"}var v=a.fields[w.defaultFieldId];var x={baseTypeName:w.qualifiedName,properties:[{name:"id"},{name:v.apiName}]};var D={display:{properties:[{name:v.apiName,label:v.label,linkStyle:true}],idProperty:{name:"id"}}};var B=km.js.ref.create({selectedRecordDisplayField:{name:v.apiName},jcr:x,availableItemsDialogOptions:{},availableItemsOptions:D,inputName:u.apiName,mode:y,selectedRecordId:t?t[w.idFieldId]:null,afterSelect:(function(g,j,h){return function(l){var k={};k[h]=l;g.updatedRecord[j.id]=k;km.js.utils.setPropVal(g.updatedRecord,z,k)}})(this,u,w.idFieldId)});B.render((function(g){return function(h){g.addAfterRenderCallback(function(){$("input[km-hash='"+b+"']").replaceWith(h)})}})(this));return A}else{if(i.id===km.js.datatypes.bool.id){var A=null;if(this.actualOptions.boolDisplay==="dropdown"){var A=$("<select></select>");A.addClass("km-field-"+u.id);A.append($("<option></option>").text("Yes").attr("value","true"));A.append($("<option></option>").text("No").attr("value","false"));A.val(t===true?"Yes":"No");A.change((function(h,g){return function(){h.updatedRecord[g.id]=($(this).val()==="true");km.js.utils.setPropVal(h.updatedRecord,z,$(this).val()==="true")}})(this,u))}else{var A=$("<input></input>").attr("value","true").attr("type","checkbox");A.addClass("km-field-"+u.id);if(t===true){A.attr("checked",true)}A.change((function(h,g){return function(){h.updatedRecord[g.id]=$(this).is(":checked");km.js.utils.setPropVal(h.updatedRecord,z,$(this).is(":checked"))}})(this,u))}if(y==="view"){A=c(A)}return A}else{if(i.id===km.js.datatypes.enumeration.id&&y==="edit"){var A=$("<select></select>");A.addClass("km-field-"+u.id);for(var C=0;C<i.enumValues.length;C++){A.append($("<option></option>").text(i.enumValues[C]).attr("value",i.enumValues[C]))}A.val(t);A.change((function(h,g){return function(){h.updatedRecord[g.id]=$(this).val();km.js.utils.setPropVal(h.updatedRecord,z,$(this).val())}})(this,u));return A}else{if(i.id===km.js.datatypes.inverse_collection.id||i.id===km.js.datatypes.association.id||i.id===km.js.datatypes.rid.id||i.id===km.js.datatypes.formula.id){return null}else{throw"Unsupported field data type "+JSON.stringify(i)}}}}}}return null},};return d},renderRecord:function(b){km.js.db.query(b.query,(function(a){return function(k,j,h){var l=k.length?k[0]:{};var i=km.js.objectdetails.create({mode:a.mode?a.mode:"edit",jsti:h,target:function(e){a.target.empty();var c=$("<div></div>");if(a.title){var d=$("<div></div>").addClass("km-title").text(a.title);c.append(d)}if(a.buttonPanel){a.buttonPanel.render(function(f){c.append(f)})}c.append(e);a.target.append(c)},layout:a.layout,type:{name:a.typeName},record:l,customizable:false});i.render({})}})(b))}};
km.js.tasks={renderStage:"not-started",afterRenderCallbacks:[],options:null,show:function(d){this.renderStage="started";this.afterRenderCallbacks=[];var e={query:"select id, title, priority, status, content, dueDate, assignedUser.id, assignedUser.userName, assignedGroup.id, assignedGroup.name from Task",fields:[{name:"id"},{name:"title"},{name:"content"},{name:"dueDate"},{name:"priority"},{name:"assignedUser"},{name:"assignedGroup"}],mode:"view",title:km.js.config.i18n["tasks.list.title"],display:"boxes",dalFilters:{orderBy:"dueDate asc",dateCondition:null,ownerCondition:null},btnFilters:{dueDate:"all",owner:"all",orderBy:"dueDate asc"},taskId:null,recordId:null,isEmbedded:false,contentInRow:false};this.options=$.extend({},e,d);var f=this.buildQuery(this.options);this.options.taskId=null;km.js.db.query(f,(function(b,a){return function(y,x,v){var E=[{name:"userName"},{name:"id"},{name:"profile"},{name:"isActive"},{name:"createdDate"},{name:"locale"}];var c=$("<div></div>").addClass("km-tasks");if(a.isEmbedded){c.addClass("km-tasks-embedded")}if(!a.contentInRow){c.addClass("km-tasks-no-content")}var G=$("<div></div>");c.append(b.header(a,G));y=km.js.utils.addPropertyNamesToJSRC(y,v);c.append(G);var w=function(g){var h=new Date(g.getTime());h.setHours(0,0,0,0);return h};var B=function(g,h){if(!g||!h){return false}return w(g).getTime()===w(h).getTime()};var H=null;if(y.length){var z=$("<div></div>").addClass("km-task-list-items");for(var C=0;C<y.length;C++){var F=y[C];var D=F.dueDate?km.js.utils.parseDate(F.dueDate):null;if((C===0||(!B(H,D)&&H))){var i=$("<div></div>").addClass("km-tasks-dayheader");if(D){i.text(km.js.config.i18n["dayofweek."+D.getDay()]+", "+D.getDate()+" "+km.js.config.i18n["month.decl."+(D.getMonth()+1)])}else{i.text(km.js.config.i18n["tasks.noduedate.header"])}z.append(i)}if(a.display==="objectdetails"){z.append(b.renderTaskAsObjectDetails(F,a,v,b))}else{if(a.display==="boxes"){z.append(b.renderTaskAsBox(F,a,v,b))}else{throw"Unsupported display mode '"+a.display+"' for task list"}}H=D}c.append(z)}else{var A=$("<div></div>").text(km.js.config.i18n["tasks.notaskstodisplay"]).addClass("km-no-tasks-msg");c.append(A)}if(a.target instanceof jQuery){a.target.empty().append(c)}else{if(typeof(a.target)==="function"){a.target(c)}}c.find(".km-task").hide().fadeIn(500);this.renderStage="finished";for(var C=0;C<b.afterRenderCallbacks.length;C++){b.afterRenderCallbacks[C]()}}})(this,this.options))},buildQuery:function(h){var f=h.query;var e=[];if(h.recordId){e.push("recordId = '"+h.recordId+"'")}if(h.dalFilters||h.taskId){if(h.dalFilters.dateCondition){e.push(h.dalFilters.dateCondition)}if(h.dalFilters.ownerCondition){e.push(h.dalFilters.ownerCondition)}if(e.length||h.taskId){var g=[];if(e.length){g.push(e.join(" AND "))}if(h.taskId){g.push("id = '"+h.taskId+"'")}f+=" WHERE "+g.join(" OR ")}if(h.dalFilters.orderBy){f+=" ORDER BY "+h.dalFilters.orderBy}}return f},getTaskForm:function(){var M=$("<div></div>").addClass("km-newtask-form");var H=$("<div></div>").addClass("km-title").text(km.js.config.i18n["tasks.newtask.title"]);M.append(H);M.append($("<div></div>").attr("id","km-task-err-wrapper").hide());var I=$("<input></input>").attr("type","hidden");M.append(I);var C=$("<input></input>").attr("type","text").attr("id","new-task-title").addClass("km-input");C.attr("placeholder",km.js.config.i18n["tasks.form.title.placeholder"]);M.append(C);var y=$("<textarea></textarea>").attr("id","new-task-content").addClass("km-input");y.attr("placeholder",km.js.config.i18n["tasks.form.content.placeholder"]);M.append($("<div></div>").append(y).addClass("km-task-content-wrapper"));var L=$("<div></div>").addClass("km-newtask-options");var z=$("<div></div>");var i=$("<div></div>").addClass("km-task-option-wrapper");i.append($("<div></div>").text(km.js.config.i18n["tasks.duedate"]).addClass("label"));var N=$("<input></input>").attr("id","due-date").datetimepicker({dateFormat:"yy-mm-dd",addSliderAccess:true,sliderAccessArgs:{touchonly:false}}).addClass("km-input");i.append($("<div></div>").append(N));L.append(z.append(i));var w=$("<div></div>");var D=$("<div></div>").addClass("km-task-option-wrapper");D.append($("<div></div>").text(km.js.config.i18n["tasks.priority"]).addClass("label"));var v=$("<select></select>").attr("id","priority").addClass("km-input");for(var x=0;x<5;x++){var B=$("<option></option>").attr("value",x).text(km.js.config.i18n["tasks.priority."+x]);v.append(B)}v.val(3);D.append($("<div></div>").append(v));w.append(D);L.append(w);var J=$("<div></div>");var A=$("<div></div>").addClass("km-task-option-wrapper");A.append($("<div></div>").text(km.js.config.i18n["tasks.assigneduser"]).addClass("label"));var F=$("<div></div>").attr("id","assigned-user-container");A.append($("<div></div>").append(F));J.append(A);L.append(J);M.append(L);var E=$("<div></div>").addClass("km-newtask-form-btns");var G=$("<a></a>").attr("href","javascript:;").addClass("sbtn").text(km.js.config.i18n["btn.save"]);G.click((function(b,d,c,e,f,a){return function(){var h=$(this);$(this).text(km.js.config.i18n["btn.saving"]);var g={title:c.val(),content:e.val(),dueDate:f.val()?(new Date(f.val())).getTime():null,priority:a.val(),assignedUserId:$(".km-task-assigned-user").val(),recordId:b.options.recordId};$.post(km.js.config.contextPath+"/km/tasklist/save",g,(function(j){return function(k){$(".km-task-err-wrapper").fadeOut(400);h.text(km.js.config.i18n["btn.save"]);if(k.success){km.js.ui.statusbar.show(km.js.config.i18n["tasks.successfully.created"],5000);b.show(b.options);km.js.ui.dialog.closeAllDialogs()}else{km.js.ui.error(k.messages,$(".km-task-err-wrapper"));$(".km-task-err-wrapper").fadeIn(400)}}})(d),"json")}})(this,M,C,y,N,v));E.append(G);var K=$("<a></a>").attr("href","javascript:;").addClass("sbtn").text(km.js.config.i18n["btn.cancel"]);K.click((function(a){return function(){km.js.ui.dialog.closeAllDialogs()}})(M));E.append(K);M.append(E);km.js.utils.userLookup({target:function(a){M.find("#assigned-user-container").empty().append(a)},inputId:"km-task-assigned-user",inputName:"km-task-assigned-user",visibleInput:{cssClass:"km-input"}});return M},header:function(O,ag){var ah=$("<div></div>").addClass("km-tasks-header");var S=$("<div></div>").addClass("km-tasks-titlebar");var J=$("<div></div>").text(O.title).addClass("km-tasklist-title");S.append(J);var U=$("<div></div>").addClass("km-tasklist-icons");var Y=$("<img></img>").attr("src",km.js.config.imagePath+"/newicon.png");Y.click((function(a){return function(){km.js.ui.dialog.create({id:"task-dialog",size:{width:"75%",height:"600px"}}).show(a.getTaskForm())}})(this,ag));U.append(Y);S.append(U);ah.append(S);var M=function(e,c,a,b,d){return function(){e.options.dalFilters[c]=a;e.options.btnFilters[b]=d;e.show(e.options)}};var ak=$("<div></div>").addClass("km-btn-group");var W=$("<a></a>").text(km.js.config.i18n["tasks.btn.mytasks"]);W.click(M(this,"ownerCondition","assignedUser.id = '"+km.js.config.authData.user.id+"'","owner","me"));if(O.btnFilters.owner==="me"){W.addClass("km-active")}ak.append(W);var aa=$("<a></a>").text(km.js.config.i18n["tasks.btn.mygroup"]);aa.click(M(this,"ownerCondition","assignedGroup.id IN (select parentGroup.id from UserGroupAssignment where childUser.id = '"+km.js.config.authData.user.id+"')","owner","mygroup"));if(O.btnFilters.owner==="mygroup"){aa.addClass("km-active")}ak.append(aa);var ai=$("<a></a>").text(km.js.config.i18n["tasks.btn.alltasks"]);if(O.btnFilters.owner==="all"){ai.addClass("km-active")}ai.click(M(this,"ownerCondition",null,"owner","all"));ak.append(ai);ak.find("a").click(function(){$(this).closest("div.km-btn-group").find("a").removeClass("km-active");$(this).addClass("km-active")});var ac=$("<div></div>").addClass("km-tasks-btns-wrapper");ac.append($("<div></div>").text(km.js.config.i18n["tasks.btn.assignedto"]).addClass("km-task-btns-title"));ac.append(ak);ah.append(ac);var L=$("<div></div>").addClass("km-btn-group");var K=$("<a></a>").text(km.js.config.i18n["tasks.btn.duetoday"]);var G=new Date();G.setHours(0,0,0,0);var I=new Date();I.setHours(23,59,59,999);var V=new Date();V.setDate(V.getDate()+7);V.setHours(23,59,59,999);var Q=new Date();Q.setDate(Q.getDate()+3);Q.setHours(23,59,59,999);K.click(M(this,"dateCondition","dueDate >= "+G.getTime()+" and dueDate <= "+I.getTime(),"dueDate","today"));if(O.btnFilters.dueDate==="today"){K.addClass("km-active")}L.append(K);var ae=$("<a></a>").text(km.js.config.i18n["tasks.btn.threedays"]);ae.click(M(this,"dateCondition","dueDate >= "+G.getTime()+" and dueDate <= "+Q.getTime(),"dueDate","3days"));if(O.btnFilters.dueDate==="3days"){ae.addClass("km-active")}L.append(ae);var H=$("<a></a>").text(km.js.config.i18n["tasks.btn.duethisweek"]);H.click(M(this,"dateCondition","dueDate >= "+G.getTime()+" and dueDate <= "+V.getTime(),"dueDate","week"));if(O.btnFilters.dueDate==="week"){H.addClass("km-active")}L.append(H);var P=$("<a></a>").text(km.js.config.i18n["tasks.btn.duepast"]);P.click(M(this,"dateCondition","dueDate < "+(new Date()).getTime(),"dueDate","past"));if(O.btnFilters.dueDate==="past"){P.addClass("km-active")}L.append(P);var T=$("<a></a>").text(km.js.config.i18n["tasks.btn.dueall"]);T.click(M(this,"dateCondition",null,"dueDate","all"));if(O.btnFilters.dueDate==="all"){T.addClass("km-active")}L.append(T);var af=$("<img></img>").attr("src",km.js.config.imagePath+"/calendar-white.png");var ad=$("<div></div>").addClass("cal-wrapper");var al=km.js.utils.dateTimePicker({target:ad,value:this.options.btnFilters.dueDate instanceof Date?this.options.btnFilters.dueDate:null,dateOnly:true,mode:"edit",onSelect:(function(a){return function(c){var b=new Date(c);var d=new Date(b);d.setHours(0,0,0,0);var e=new Date(b);e.setHours(23,59,59,0);M(a,"dateCondition","dueDate <= "+e.getTime()+" and dueDate >= "+d.getTime(),"dueDate",b)()}})(this)});var Z=$("<div></div>").append(ad).append($("<span></span>").append(af)).addClass("btn cal-btn");if(O.btnFilters.dueDate instanceof Date){Z.addClass("km-active")}L.append(Z);L.find("a").click(function(){$(this).closest("div.km-btn-group").find("a").removeClass("km-active");$(this).addClass("km-active")});var ab=$("<div></div>").addClass("km-tasks-btns-wrapper");ab.append($("<div></div>").text(km.js.config.i18n["tasks.btn.duetitle"]).addClass("km-task-btns-title"));ab.append(L);ah.append(ab);var R=$("<div></div>").addClass("km-btn-group");var aj=$("<a></a>").text(km.js.config.i18n["tasks.btn.sortby.duedate.asc"]);aj.click(M(this,"orderBy","dueDate asc","orderBy","dueDate asc"));if(O.btnFilters.orderBy==="dueDate asc"){aj.addClass("km-active")}R.append(aj);var X=$("<a></a>").text(km.js.config.i18n["tasks.btn.sortby.duedate.desc"]);X.click(M(this,"orderBy","dueDate desc","orderBy","dueDate desc"));if(O.btnFilters.orderBy==="dueDate desc"){X.addClass("km-active")}R.append(X);var N=$("<div></div>").addClass("km-tasks-btns-wrapper");N.append($("<div></div>").text(km.js.config.i18n["tasks.btn.sortby.title"]).addClass("km-task-btns-title"));N.append(R);ah.append(N);return ah},addAfterRenderCallback:function(b){if(this.renderStage==="finished"){b()}else{this.afterRenderCallbacks.push(b)}},renderTaskAsBox:function(ac,am,ay,aq){var an=$("<div></div>").addClass("km-task").addClass("km-task-display-row");an.attr("id","km-task-"+ac.id);var aw=$("<div></div>").addClass("km-task-tc");var S=function(a){km.js.ui.statusbar.err(a.message?a.message:a.messages)};var ad=function(a){var b=$("<img></img>").attr("src",km.js.config.imagePath+"/check.gif").css("position","absolute").css("right","5em").css("top","2em");a.css("position","relative");a.append(b);b.hide().fadeIn(700);setTimeout((function(){return function(){b.fadeOut(700)}})(b),3000)};var ae=function(e,a,c){var d=$("<img></img>").attr("src",km.js.config.imagePath+"/trashicon.png").addClass("task-icon");var b=$("<div></div>").addClass("km-task-delete-wrapper");b.append(d);a.append(b);km.js.ui.confirm({target:d,callback:(function(g,f){return function(){km.js.db.deleteRecord(g,(function(h){return function(){h.fadeOut(400)}})(f))}})(c,e)})};var ah=function(b,a){if(!b){km.js.ui.statusbar.err(a.message?a.message:a.messages)}else{}};var aA=function(b,c,a){b.blur((function(e,d){return function(){var f={id:e};f[d]=$(this).val()?$(this).val():null;km.js.db.update(f,ah,S)}})(ac.id,c))};var i=function(c,b,a){c.addClass("km-task-display-form");c.removeClass("km-status-resolved-row");c.removeClass("km-task-display-row");km.js.ui.dialog.create({id:"existing-task-dialog",size:{width:"75%",height:"600px"},afterClose:(function(d){return function(){d.show(d.options)}})(a)}).show(c)};var aj=$("<div></div>").addClass("km-task-status-wrapper");var aC=$("<img></img>").attr("src",km.js.config.imagePath+"/"+(ac.status==="Resolved"?"check.gif":"greycheck.png"));aC.addClass("task-icon");if(ac.status==="Resolved"){aC.addClass("km-status-resolved");an.addClass("km-status-resolved-row")}aj.append(aC);aC.click((function(b,a){return function(){var c=null;if($(this).hasClass("km-status-resolved")){$(this).removeClass("km-status-resolved");a.removeClass("km-status-resolved-row");$(this).attr("src",km.js.config.imagePath+"/greycheck.png");c="Open"}else{$(this).addClass("km-status-resolved");a.addClass("km-status-resolved-row");$(this).attr("src",km.js.config.imagePath+"/check.gif");c="Resolved"}var d={id:b};d.status=c;km.js.db.update(d,ah,S)}})(ac.id,an));aw.append(aj);var ao=$("<div></div>").addClass("km-task-title");var Q=$("<input></input>").attr("type","text").val(ac.title).addClass("km-task-edit");aA(Q,"title",ac.id);var W=ac.content?ac.content:"";var X=$("<textarea></textarea>").val(W).addClass("km-task-edit");if(km.js.utils.isMobile()){Q.focus((function(c,b,a){return function(){i(c,b,a)}})(an,X,this))}ao.append(Q);var ag=$("<div></div>").addClass("km-task-content-wrapper").append(X);aA(X,"content",ac.id);aw.append(ao).append(ag);var aB=$("<div></div>").addClass("km-task-assignee-wrapper");var ax=$("<div></div>").addClass("km-task-option-wrapper");var at=$("<img></img>").attr("src",km.js.config.imagePath+"/personicon.png").addClass("task-icon");var au=$("<span></span>").append(at).addClass("task-icon-wrapper");ax.append(au);var aa="ua-"+km.js.utils.random(1000000);var aD=$("<div></div>").attr("id",aa);var ap=$("<div></div>").text(ac.assignedUser?ac.assignedUser.userName:"");ax.append($("<div></div>").append(aD).append(ap));aB.append(ax);var ai=function(b,a,d,c){d.hide();km.js.utils.userLookup({target:((function(e){return function(f){$("#"+e).empty().append(f)}})(c)),inputName:"km-task-assignee",visibleInput:{cssClass:"km-input"},mode:"view",editable:true,recordId:a,afterSelect:function(e){var f={id:b};f.assignedUser=e?{id:e}:null;km.js.db.update(f,null,S)}})};this.addAfterRenderCallback(function(){var a=ai(ac.id,ac.assignedUser?ac.assignedUser.id:null,ap,aa);ap.click(a);au.click(a)});aw.append(aB);var ak=$("<div></div>").addClass("km-tasks-priority-cell");var V=$("<div></div>").addClass("km-task-option-wrapper");var U=$("<img></img>").attr("src",km.js.config.imagePath+"/impicon.png").addClass("task-icon");var aE=$("<span></span>").append(U).addClass("task-icon-wrapper");V.append(aE);var ar=$("<select></select>").attr("id","priority").addClass("km-task-edit");for(var Y=0;Y<5;Y++){var af=$("<option></option>").attr("value",Y).text(km.js.config.i18n["tasks.priority."+Y]);ar.append(af)}ar.val(ac.priority);aA(ar,"priority",ac.id);V.append($("<div></div>").append(ar));ak.append(V);aw.append(ak);var ab=$("<div></div>").addClass("km-task-duedate-wrapper");var av=$("<div></div>").addClass("km-task-option-wrapper");var az=$("<img></img>").attr("src",km.js.config.imagePath+"/alarmclock.png").addClass("task-icon");var R=$("<span></span>").append(az).addClass("task-icon-wrapper");av.append(R);var T=$("<span></span>").text(ac.dueDate?ac.dueDate:"");aA(T,"dueDate",ac.id);var al=km.js.utils.dateTimePicker({target:T,value:ac.dueDate,mode:"view",onSelect:(function(a){return function(c){var b={id:a,dueDate:c?(new Date(c)).getTime():null};km.js.db.update(b,ah,S)}})(ac.id)});R.click((function(a){return function(){a.enable()}})(al));av.append(T);ab.append(av);aw.append(ab);var Z=$("<img></img>").attr("src",km.js.config.imagePath+"/uncollapse.png").addClass("km-task-open-icon task-icon");Z.click((function(b,c,a,d){return function(){if(b.hasClass("km-task-display-form")){b.removeClass("km-task-display-form");b.addClass("km-status-resolved-row");b.addClass("km-task-display-row");km.js.ui.dialog.closeAllDialogs()}else{d(b,c,a)}}})(an,X,this,i));aw.append($("<div></div>").append(Z).addClass("km-task-open-wrapper"));an.append(aw);ae(an,aw,ac.id);return an},renderTaskAsObjectDetails:function(j,i,k,h){var l="hash-"+km.js.utils.random(10);var m=$("<div></div>").addClass("ibox").attr("km-hash",l);var n=km.js.objectdetails.create({mode:i.mode,jsti:k,delayCallbacks:true,target:(function(c,a){var b=function(d,e){h.addAfterRenderCallback(function(){$("div[km-hash='"+c+"']").empty().append(d);e.callAfterRenderCallbacks()})};return b})(l,h),fields:i.fields,fieldsPerRow:2,type:{name:"kommet.basic.Task"}});n.render({record:j});return m}};
km.js.filelookup={show:function(d){var e={chooseSystemFiles:true,uploadedFileName:"uploadedFile",immediate:false};var f=$.extend({},e,d);km.js.db.query("select id, name from File where id = '"+(f.fileId?f.fileId:"00h0000000000")+"'",(function(a){return function(A,b,v){A=km.js.utils.addPropertyNamesToJSRC(A,v);var x=$("<img></img>").attr("src",km.js.config.imagePath+"/attachicon.png");var s=$("<div></div>").addClass("km-file-icon").append(x);var r=$("<div></div>").append(s).addClass("km-file-lookup");var B="km-file-"+km.js.utils.random(1000000);if(a.inputName){var z=$("<input></input>").attr("type","hidden").val(a.fileId).attr("name",a.inputName);r.append(z)}var c=$("<input></input>").attr("type","file").attr("name",a.uploadedFileName).hide();var y=km.js.filelookup.getFileForm(c,B);r.append(y);if(A.length){var u=A[0];var t=$("<div></div>").text(u.name).addClass("km-filename");r.append(t);var w=$("<img></img>").attr("src",km.js.config.imagePath+"/ex.png");w.click((function(g,h){return function(){g.val(null);h.empty();$(this).remove()}})(z,t));r.append($("<div></div>").append(w).addClass("km-remove"))}x.click((function(h,g,i,h){return function(){var j=km.js.ui.dialog.create({id:"km-fileupload-"+km.js.utils.random(1000000),size:{width:"800px",height:"600px"},afterClose:null});j.show(km.js.filelookup.getFileDialog(g,i,r,h,j))}})(a,c,y,a));a.target.empty().append(r)}})(f))},getFileForm:function(d,f){var e=$("<form></form>").attr("enctype","multipart/form-data").attr("method","post");e.append($("<input></input>").attr("type","hidden").attr("name","fileName"));e.append($("<input></input>").attr("type","hidden").attr("name","revisionId"));e.append($("<input></input>").attr("type","hidden").attr("name","nativeUpload").val("true"));e.append($("<input></input>").attr("type","hidden").attr("name","fileParam").val(f));e.append(d);e.css("display","none");return e},getFileDialog:function(q,o,s,u,w){var v=$("<div></div>").addClass("km-file-upload-wrapper");var A=$("<div></div>").addClass("km-file-drag");A.append($("<div></div>").text(km.js.config.i18n["files.drag.file"]));var B=$("<a></a>").addClass("sbtn").attr("href","javascript:;").text(km.js.config.i18n["files.browse"]);B.click((function(a){return function(){a.click()}})(q));A.append($("<div></div>").append(B).addClass("km-file-browse"));if(u.chooseSystemFiles){var r=$("<a></a>").addClass("sbtn").attr("href","javascript:;").text(km.js.config.i18n["files.choose.existing"]);r.click((function(a,b){return function(){km.js.filelookup.fileList(a,b,u)}})(v,w,u));A.append($("<div></div>").append(r).addClass("km-file-choose"))}var y=$("<div></div>").addClass("km-file-panel").hide();var p=$("<input></input>").attr("type","text").attr("id","filename").addClass("km-input");var t=function(g,a,d,b,c){if(g.success){a.hide();var e=$("<div></div>").text(km.js.config.i18n["files.upload.complete"]).addClass("km-upload-success");d.empty().append(e);b.close();if(typeof(c.afterSave)==="function"){if(!g.fileId||!g.fileRevisionId){throw"File ID or file revision ID not returned after file upload"}c.afterSave(g.fileId,g.fileRevisionId,g.fileName,c)}}else{var f=km.js.config.i18n["files.upload.failed"];if(g.messages&&g.messages.length){f+=": "+g.messages[0]}var e=$("<div></div>").text(f).addClass("km-upload-failed");d.empty().append(e)}};var x=(function(b,a,e,d,c){return function(){if(d.isDropUpload){if(d.dropCallbacks){for(var h=0;h<d.dropCallbacks.length;h++){console.log("Processing upload");d.dropCallbacks[h]()}}}else{var f="km-iframe-"+km.js.utils.random(1000000);var g=$('<iframe style="display: none" />').attr("id",f).attr("name",f);$("body").append(g);e.find("input[name=fileName]").val(a.val());e.attr("target",f);e.attr("action",km.js.config.contextPath+"/km/files/nativeupload");e.submit();var i=km.js.ui.buttonWait({button:$(this),text:"Saving"});g.load((function(l,k,j){return function(){km.js.ui.buttonWaitStop(l);iframeContents=$(this)[0].contentWindow.document.body.innerHTML;var m=JSON.parse(iframeContents);t(m,A,k,c,j)}})(i,y,d))}}})(q,p,o,u,w);if(typeof(A.dropzone)==="function"){A.dropzone({url:km.js.config.contextPath+"/km/files/nativeupload",createImageThumbnails:false,paramName:u.uploadedFileName,success:(function(c,b,a){return function(e,f){var d=JSON.parse(f);t(d,A,b,c,a)}})(w,y,u),previewTemplate:'<div class="dz-details">\n<div class="dz-size"><span data-dz-size></span></div>\n    <div class="dz-filename"><span data-dz-name></span></div>',accept:(function(b,c,a){return function(e,f){var d=e.name.split("\\").pop().split("/").pop();b.find("#filename").val(d);b.show();c.isDropUpload=true;if(!c.dropCallbacks){c.dropCallbacks=[]}c.dropCallbacks.push(f);if(c.immediate){a()}}})(y,u,x)})}v.append(A);y.append(p);var z=$("<a></a>").attr("href","javascript:;").text(km.js.config.i18n["btn.save"]).addClass("sbtn");z.click(x);y.append(z);v.append(y);q.on("change",(function(b,c,a){return function(){console.log("File: "+$(this).val());var d=$(this).val().split("\\").pop().split("/").pop();b.find("#filename").val(d);b.show();if(a.immediate){c()}}})(y,x,u));return v},fileList:function(n,p,i){var o=km.js.datasource.create({type:"database"});var j={baseTypeName:"kommet.basic.File",properties:[{name:"id"},{name:"createdDate"},{name:"name"}]};var m={properties:[{name:"name",label:"File name",linkStyle:true,onClick:(function(a,b){return function(c){if(typeof(b.afterSave)==="function"){b.afterSave(c,null,null,b)}a.close()}})(p,i)},{name:"createdDate",label:"Created date",linkStyle:true}],idProperty:{name:"id"}};var k={id:"km-files",pagination:{active:true,pageSize:15}};var l=km.js.table.create(o,j,m,k);l.render(j,n)}};
km.js.grid={create:function(d){var c={options:d,show:function(a){if(a){this.options.target=a}if(!this.options.fields){throw"Fields not set in grid"}if(!this.options.records){throw"Records not passed to grid"}var b=this.getGridCode(this.options,this.options.records);if(this.options.target instanceof jQuery){this.options.target.empty().append(b)}else{if(typeof(this.options.target)==="function"){this.options.target(b)}else{throw"Unsupported target data type while rendering grid"}}},getGridCode:function(l,a){var j=$("<div></div>").addClass("km-grid");j.append(this.getHeader(l));var b=0;for(var k=0;k<a.length;k++){var i=a[k];j.append(this.getRow(l,i,++b))}if(l.emptyRowCount){for(var k=0;k<l.emptyRowCount;k++){j.append(this.getEmptyRow(l,++b))}}return j},getHeader:function(i){var a=$("<div></div>").addClass("km-grid-row km-grid-header");this.columnCount=0;for(var h=0;h<i.fields.length;h++){var b=i.fields[h];if(!b.dataType){throw"Field data type not set for field "+b.name}if(!this.isValidDataTypeForGrid(b.dataType,b)){continue}this.columnCount++;var j=this.getHeaderCell(b,i);a.append(j)}if(i.emptyColumnCount){for(var h=0;h<i.emptyColumnCount;h++){this.columnCount++;var j=this.getEmptyHeaderCell(i);a.append(j)}}return a},isValidDataTypeForGrid:function(b,a){if(a.name==="accessType"){return false}if(km.js.datatypes.text.id===b.id){return true}if(km.js.datatypes.number.id===b.id){return true}if(km.js.datatypes.enumeration.id===b.id){return true}if(km.js.datatypes.email.id===b.id){return true}return false},getEmptyRow:function(l,j){var b=$("<div></div>").addClass("km-grid-row").attr("km-record-id","null").attr("km-row-no",j);for(var a=0;a<l.fields.length;a++){var k=l.fields[a];if(!k.dataType){throw"Field data type not set for field "+k.name}if(!this.isValidDataTypeForGrid(k.dataType,k)){continue}var i=this.getEmptyCell(l,k,null);i.attr("km-record-id","null");b.append(i)}if(l.emptyColumnCount){for(var a=0;a<l.emptyColumnCount;a++){var i=this.getEmptyCell(l,null,null);i.attr("km-record-id","null");b.append(i)}}return b},getRow:function(m,a,i){var n=$("<div></div>").addClass("km-grid-row").attr("km-record-id",a.id).attr("km-row-no",i);for(var k=0;k<m.fields.length;k++){var b=m.fields[k];if(!b.dataType){throw"Field data type not set for field "+b.name}if(!this.isValidDataTypeForGrid(b.dataType,b)){continue}var l=this.getCell(a,b,m);l.attr("km-record-id",a.id);n.append(l)}if(m.emptyColumnCount){for(var k=0;k<m.emptyColumnCount;k++){var l=this.getEmptyCell(m,null,a.id);l.attr("km-record-id",a.id);n.append(l)}}return n},getCell:function(l,b,j){var i=$("<div></div>").addClass("km-grid-cell");var k=l[b.name];var a=$("<input></input>").attr("type","text").val(k).addClass("km-grid-input");a.blur((function(g,e,f){return function(){var h={id:g.id};h[e]=f.val();km.js.db.update(h,null,null)}})(l,b.name,a));i.append(a);return i},getEmptyCell:function(h,a,b){var j=$("<div></div>").addClass("km-grid-cell").attr("km-record-id",b);var i=$("<input></input>").attr("type","text").addClass("km-grid-input");if(a){i.blur((function(f,e,l,g){if(!g.typeName){throw"Type name not defined in km.js.grid - cannot insert new record"}return function(){var n={id:f};var k={typeName:g.typeName};n[e]=l.val();km.js.db.update(n,null,null,k)}})(b,a.name,i,h))}j.append(i);return j},getHeaderCell:function(b,j){var i=$("<div></div>").addClass("km-grid-cell km-grid-header-cell").attr("km-field",b.id);var l=b.label?b.label:b.name;var k=l;var a=$("<input></input>").attr("type","text").val(k).addClass("km-grid-input");i.append(a);return i},getEmptyHeaderCell:function(f){var b=$("<div></div>").addClass("km-grid-cell km-grid-header-cell").attr("km-field","null");var a=$("<input></input>").attr("type","text").addClass("km-grid-input");a.blur((function(i,j,e){return function(){if(!i.val()){return}if(j.attr("km-field")!=="null"){return}if(!e.typeName){throw"Type name not defined in km.js.grid - cannot create new field"}var g=function(k){return k.replace(/\w\S*/g,function(l){return l.charAt(0).toUpperCase()+l.substr(1).toLowerCase()})};var m=g(i.val());var n=m.replace(/\s+/g,"");n=n.charAt(0).toLowerCase()+n.substr(1).toLowerCase();var h={type:e.typeName,apiName:n,label:m};$.post(km.js.config.contextPath+"/km/rest/field/create",h,(function(k){return function(l){if(l.success){k.attr("km-field",l.data.fieldId)}}})(j),"json")}})(a,b,f));b.append(a);return b}};return c}};
km.js.cookies={create:function(j,i,h){var g="";if(h){var f=new Date();f.setTime(f.getTime()+(h*24*60*60*1000));g="; expires="+f.toUTCString()}document.cookie=j+"="+i+g+"; path=/"},read:function(c){var i=c+"=";var g=document.cookie.split(";");for(var j=0;j<g.length;j++){var h=g[j];while(h.charAt(0)==" "){h=h.substring(1,h.length)}if(h.indexOf(i)==0){return h.substring(i.length,h.length)}}return null},erase:function(b){create(b,"",-1)}};
km.js.marketplace={cachedData:null,render:function(d){this.cachedData={availableLibs:[],installedLibs:[],notifier:km.js.notifier.get()};var f={allowInstall:true,detailsLink:"rm/lib/marketplaceimport?id="};options=$.extend({},f,d);this.cachedData.notifier.wait("availableLibs");if(options.allowInstall){this.cachedData.notifier.wait("installedLibs")}this.cachedData.notifier.onComplete=(function(a){return function(){var E=a.availableLibs;var b=$("<div></div>").addClass("km-mrkt");for(var A=0;A<E.length;A++){var B=E[A];var D=$("<div></div>").addClass("km-lib");D.click((function(g){return function(){location.href=km.js.config.contextPath+"/"+g.detailsLink+B.id}})(options));var G=$("<img></img>").attr("src","https://kommet.io/km/download/"+B.logo.id).addClass("km-lib-logo");D.append(G);var i=$("<div></div>").addClass("km-lib-label").text(B.label);var w=$("<div></div>").addClass("km-lib-name").text(B.name);if(B.background){i.css("background",B.background);w.css("background",B.background)}D.append(i);D.append(w);var c=$("<div></div>").addClass("km-lib-desc").text(B.description);D.append(c);var H=$("<div></div>").addClass("km-lib-btns");if(options.allowInstall){var C=function(g,h){for(var j=0;j<h.length;j++){if(h[j].name===g.name&&h[j].version===g.version){console.log(JSON.stringify(h[j]));if(h[j].isEnabled===true){return"installed"}else{return"installed/disabled"}}}return"not installed"};var v=$("<i></i>").addClass("fa fa-download");var y=C(B,a.installedLibs);if(y==="installed"){var x=$("<a></a>").addClass("sbtn sbtn-inactive").append(v).append("Installed").attr("href","javascript:;");H.append(x)}else{if(y==="installed/disabled"){var x=$("<a></a>").addClass("sbtn sbtn-inactive").append(v).append("Downloaded").attr("href","javascript:;");H.append(x)}else{var x=$("<a></a>").addClass("sbtn").append(v).append("Install").attr("href",km.js.config.contextPath+"/"+options.detailsLink+B.id);H.append(x)}}}var F=$("<i></i>").addClass("fa fa-commenting-o");var z=$("<a></a>").addClass("sbtn").append(F).append("Details").attr("href",km.js.config.contextPath+"/"+options.detailsLink+B.id);H.append(z);D.append(H);b.append(D)}options.target.empty().append(b)}})(this.cachedData);if(options.allowInstall){km.js.db.query("select id, name, source, version, isEnabled from Library where source = 'External (library repository)'",(function(a){return function(h,b,c){lib=km.js.utils.addPropertyNamesToJSRC(h,c);a.installedLibs=h;a.notifier.reach("installedLibs")}})(this.cachedData))}var e={limit:options.limit,keyword:options.keyword};$.get("https://kommet.io/rest/marketplace/libs",e,(function(b,a){return function(c){a.availableLibs=c;a.notifier.reach("availableLibs")}})(options,this.cachedData))}};
