km.js.utils={isEmpty:function(a){return a==null||a==""||typeof(a)=="undefined"},random:function(a){return Math.floor((Math.random()*a)+1)},isMobile:function(){return window.matchMedia("only screen and (min-device-width : 320px) and (max-device-width : 480px)").matches},getItemLink:function(b){var a=b.substring(0,3);switch(a){case"002":return"km/type/"+b;case"003":return"km/field/"+b;case"006":return"km/profile/"+b;case"009":return"km/actions/"+b;case"00a":return"km/views/"+b;case"00b":return"km/classes/"+b;case"00e":return"km/uniquechecks/"+b;case"00f":return"km/layouts/"+b;case"014":return"km/webresources/"+b;case"015":return"km/viewresources/"+b;default:return null}},customizableObjectDetails:function(a){km.js.db.query("select id from "+a.typeName,(function(b){return function(c,d,f){var e=km.js.objectdetails.create({mode:"edit",jsti:f,target:b.target,layout:b.layout,type:{name:b.typeName},record:{},customizable:true,customization:{context:"environment"}});e.render({})}})(a))},renderProfile:function(){var a=$("<div></div>").addClass("km-profile-img");a.css("background","url("+km.js.config.imagePath+"/mountains.jpg)");$(".km-profile-box > .km-profile-pic").append(a);$(".km-profile-box > .km-profile-name").text(km.js.config.authData.user.userName)},cloneArr:function(a){var b=[];for(var c=0;c<a.length;c++){b.push($.extend({},a[c]))}return b},bind:function(d,c,a,b){if(!(d instanceof jQuery)){throw"km.js.utils.bind source should be a jQuery object"}if(!(c instanceof jQuery)){throw"km.js.utils.bind dest should be a jQuery object"}d.keyup((function(e,f,g){return function(){if(e.hasClass("km-bind-manually-edited")){return}var h=f;if($(this).val()!=""){h=$(this).val()}e.text(h);if(typeof(g)==="function"){e.val(g(h))}else{e.val(h)}}})(c,a,b));c.keyup(function(){c.addClass("km-bind-manually-edited")})},capitalize:function(a){return a?a.charAt(0).toUpperCase()+a.slice(1):a},uncapitalize:function(a){return a?a.charAt(0).toLowerCase()+a.slice(1):a},getTypeFromQuery:function(a,b){$.get(km.js.config.contextPath+"/km/typefromquery",{query:a},(function(c){return function(d){c(d.data.type,d.data.isValidQuery)}})(b),"json")},addPropertyNamesToJSRC:function(b,e){var d=[];for(var f=0;f<b.length;f++){var c=b[f];for(var g in c){var j=e.fields[g];if(!j){throw"Field with KID "+g+" not found in JSTI on record "+JSON.stringify(c)}var a=c[g];if($.isArray(a)){a=this.addPropertyNamesToJSRC(a,e)}else{if(this.isObject(a)){var h=[];h.push(a);a=this.addPropertyNamesToJSRC(h,e)[0]}}c[j.apiName]=a}d.push(c)}return d},padLeft:function(b,d,e){if(!b){b=""}if(b.length===d){return b}for(var a=0;a<(d-b.length);a++){b=e+b}return b},isObject:function(a){return a!==null&&typeof a==="object"},propVal:function(c,a){if(c==null){return null}else{if(a.indexOf(".")>=0){var b=a.split(".");return this.propVal(c[b[0]],a.substring(a.indexOf(".")+1))}else{return km.js.utils.isEmpty(c)?null:c[a]}}},coalesce:function(b,a){return b?b:a},getScriptInclude:function(a){return'<script type="text/javascript" src="'+km.js.config.contextPath+"/"+a+'"><\/script>'},getCssInclude:function(a){return'<link href="'+km.js.config.contextPath+"/"+a+'" rel="stylesheet" type="text/css" />'},normalizeId:function(a){return a?a.replace(/\./g,"-"):a},parseDate:function(i,d){if(!d){d="GMT"}var j=i.split(" ");var l=j[0];var f=j[1];var m=l.split("-");var g=parseInt(m[0]);var e=parseInt(m[1])-1;var h=parseInt(m[2]);var a=0;var b=0;var c=0;if(f){var k=f.split(":");var a=parseInt(k[0]);var b=parseInt(k[1]);var c=parseInt(k[2])}return new Date(g,e,h,a,b,c)},forEachProp:function(c,b){for(var a in c){if(c.hasOwnProperty(property)){b(a,c[a])}}},nl2br:function(a){return a!=null?a.replace(/(?:\r\n|\r|\n)/g,"<br />"):null},setPropVal:function(b,c,d){if(c.indexOf(".")==-1){b[c]=d}else{var a=c.split(".");var e=b[a[0]];if(!e){e={}}this.setPropVal(e,c.substring(c.indexOf(".")+1),d);b[a[0]]=e}},lastProperty:function(b){if(b==null||b.indexOf(".")<0){return b}var a=b.split(/\./);return a[a.length-1]},insert:function(a,c,b){c.splice(a,0,b)},remove:function(b,a){a.splice(b,1)},openURL:function(a){location.href=a},formatDate:function(c,b){var a=function(d){return d.toString().length<2?"0"+d:d};return c.getFullYear()+"-"+a(c.getMonth()+1)+"-"+a(c.getDate())},size:function(b){var a=0;for(var c in b){if(b.hasOwnProperty(c)){a++}}return a},populateIdsOnProperties:function(c,d,e){if(!d){throw"Cannot populate IDs on table display options because the passed base type is null"}for(var b=0;b<c.length;b++){var a=c[b];if(a.id){continue}if(!a.name){throw"Neither property name nor its ID specified in table display options"}a.id=km.js.utils.nestedPropertyToPir(a.name,d,e);if(!a.id){throw"Could not resolve property ID for property name "+a.name+" on type "+d.qualifiedName+" (type ID "+d.id+")"}}},nestedPropertyToPir:function(d,e,c){var f=d.split(".");var g=e.qualifiedName;var i=c.pirs[g+"."+f[0]];if(f.length===1){return i}else{var h=c.fields[i];var a=h.dataType.id;var b=null;if(a===km.js.datatypes.object_reference.id){b=c.types[h.dataType.typeId]}else{if(a===km.js.datatypes.inverse_collection.id){b=c.types[h.dataType.inverseTypeId]}else{if(a===km.js.datatypes.association.id){b=c.types[h.dataType.associatedTypeId]}else{throw"Field "+h.name+" is not an object reference, collection or association, but is used with nested properties"}}}if(!b){throw"New base type not retrieved"}return i+"."+this.nestedPropertyToPir(d.substring(d.indexOf(".")+1),b,c)}},isSimpleRestriction:function(a){return a.operator.toLowerCase()!=="or"&&a.operator.toLowerCase()!=="and"&&a.operator.toLowerCase()!=="not"},getTypeFromJSTI:function(a,b){if(a.baseTypeId){type=b.types[a.baseTypeId];if(type==null){throw"Type with ID "+a.baseTypeId+" not found"}}else{if(a.baseTypeName){type=this.getTypeFromJSTIByName(a.baseTypeName,b);if(type==null){throw"Type with name "+a.baseTypeName+" not found"}}else{throw"Neither base type name nor ID specified in JCR"}}return type},getTypeFromJSTIByName:function(a,d){for(var c in d.types){var b=d.types[c];if(b.qualifiedName===a){return b}}return null},openMenuItem:function(a){var b=$("div#content td.left-menu a").filter((function(c){return function(){return $(this).text()==c}})(a)).closest("li").addClass("km-menu-highlighted");b.parent().closest("li").find("ul").show()},openCurrentMenuItem:function(){var c=window.location.href.indexOf(km.js.config.contextPath)+km.js.config.contextPath.length;var b=window.location.href.substring(c);var a=$("div#content div#left-menu a[href$='"+b+"']").closest("li").addClass("km-menu-highlighted");a.parent().closest("li").find("ul").show()},forEachRestriction:function(e,a){var b=[];if($.isArray(e)){b=[].concat(e)}else{b.push(e)}for(var c=0;c<b.length;c++){var d=b[c];a(d);if(d.operator.toLowerCase()==="or"||d.operator.toLowerCase()==="and"||d.operator.toLowerCase()==="not"){this.forEachRestriction(d.args,a)}}},adjustIframeSize:function(f,e,d,b,c){var a=document.getElementById(f);var h=a.contentWindow.document.body.scrollHeight+30;var g=a.contentWindow.document.body.scrollWidth+30;if(d&&h>d){h=d}if(e&&h<e){h=e}if(c&&g>c){g=c}if(b&&g<b){g=b}a.height=(h)+"px";a.width=(g)+"px";console.log("Adjusting size: "+h+" / "+g)},customTypes:function(){var b=[];for(var a in km.js.config.types){var c=km.js.config.types[a];if(c.isBasic===false){b.push(c)}}return b},userLookup:function(b){var a={baseTypeName:"kommet.basic.User",properties:[{name:"id"},{name:"userName"}]};var d={display:{properties:[{name:"userName",label:km.js.config.i18n["user.username"],linkStyle:true}],idProperty:{name:"id"}},title:km.js.config.i18n["tasks.users"],tableSearchOptions:{properties:[{name:"userName",operator:"ilike"}]}};var c=km.js.ref.create({selectedRecordDisplayField:{name:"userName"},jcr:a,availableItemsDialogOptions:{},availableItemsOptions:d,inputName:b.inputName,inputId:b.inputId,selectedRecordId:b.recordId,visibleInput:b.visibleInput,afterSelect:b.afterSelect,mode:b.mode,editable:b.editable});c.render(b.target);return c},isInteger:function(a){return parseInt(a,10)},dateToGMT:function(b){if(b){if(km.js.utils.isInteger(b)){b=new Date(b)}var a=new Date(b.getTime());a.setHours(b.getHours()-1*km.js.config.authData.timeZoneOffset);return a}else{return null}},dateTimePicker:function(b){var c=$("<input></input>").datetimepicker({dateFormat:"yy-mm-dd",addSliderAccess:true,showHour:!b.dateOnly,showMinute:!b.dateOnly,showTime:!b.dateOnly,sliderAccessArgs:{touchonly:false},onSelect:(function(d){return function(e){$(this).removeClass("km-output");if(typeof(d)==="function"){d(e)}}})(b.onSelect)});c.addClass("km-input");c.datepicker("setDate",b.value);if(!b.mode){b.mode="edit"}if(b.mode==="view"){c.addClass("km-output")}c.click(function(){$(this).removeClass("km-output")});c.blur(function(){$(this).addClass("km-output")});if(b.target instanceof jQuery){b.target.empty().append(c)}else{if(typeof(b.target)==="function"){b.target(c)}}var a={input:c,enable:function(){this.input.removeClass("km-output")}};return a},userGroupLookup:function(b){var a={baseTypeName:"kommet.basic.UserGroup",properties:[{name:"id"},{name:"name"}]};var d={display:{properties:[{name:"name",label:km.js.config.i18n["usergroups.groupname"],linkStyle:true}],idProperty:{name:"id"}},title:km.js.config.i18n["usergroups.list.title"],tableSearchOptions:{properties:[{name:"name",operator:"ilike"}]}};var c=km.js.ref.create({selectedRecordDisplayField:{name:"name"},jcr:a,availableItemsDialogOptions:{},availableItemsOptions:d,inputName:b.inputName,inputId:b.inputId,selectedRecordId:b.recordId,visibleInput:b.visibleInput,mode:b.mode,afterSelect:b.afterSelect,editable:b.editable});c.render(b.target);return c}};
km.js.data={associate:function(b,a,e,f,d){var c=function(h,g){return function(i){if(i.success===true){if(km.js.utils.isEmpty(i.id)){throw"Association successful, but ID of linking record not returned"}if(typeof(h)==="function"){h(i.id)}}else{if(typeof(g)==="function"){g(i)}}}};$.post(km.js.config.sysContextPath+"/rest/associate",{relationFieldId:b,parentId:a,childId:e},c(f,d),"json")},unassociate:function(a,e,c,d){var b=function(f){return function(g){if(typeof(f)==="function"){f(g.id)}}};$.post(km.js.config.sysContextPath+"/rest/unassociate",{relationFieldId:a,parentId:e,childId:c},b(d),"json")}};
km.js.datatypes={number:{id:0},text:{id:1},bool:{id:2},datetime:{id:3},rid:{id:4},email:{id:5},object_reference:{id:6},enumeration:{id:7},inverse_collection:{id:8},association:{id:10},formula:{id:11},date:{id:12},autonumber:{id:14}};
km.js.jsti={forTypes:function(c,b,d){var a={};if($.isArray(c)){a.typePrefixes=typePrefix.join(",")}if($.isArray(b)){a.typeNames=b.join(",")}$.post(km.js.config.sysContextPath+"/rest/jsti",a,d,"json")},get:function(a,c){var b={fields:{},types:{},fieldInfo:function(f){var g=this.fields[f];return km.js.utils.isEmpty(g)?null:g},typeInfo:function(f){var g=this.types[f];return km.js.utils.isEmpty(g)?null:g}};if(km.js.utils.isEmpty(c)){c=[]}if(km.js.utils.isEmpty(a)){a=[]}for(var e=0;e<c.length;e++){var d=km.js.utils.lastProperty(c[e]);b.types[d]={}}return b},fieldData:function(a,b){var c=b.indexOf(".")>-1?b.substring(b.indexOf(".")+1):b;return a.fields[c]}};
if(typeof(km.js.scope)==="undefined"){km.js.scope={dialogs:{},refs:{},rels:{},resizeEvent:{listeners:[],listen:function(a){if(typeof(a)!=="function"){throw"Cannot register listener as it is not a function: "+a}this.listeners.push(a)},notify:function(){for(var a=0;a<this.listeners.length;a++){var b=this.listeners[a];if(typeof(b)==="function"){b(window)}}}}}};
km.js.ui={boolButton:function(d){var c=typeof(d.onSetTrue)==="function"&&typeof(d.onSetFalse)==="function";if(!c){if(!(d.target instanceof jQuery)){throw"Target of a boolButton call has to be a jQuery object"}if(!d.recordId){throw"Record ID not defined in boolButton call"}if(!d.field){throw"Field not defined in boolButton call"}if(!d.type){throw"Type not defined in boolButton call"}}var a=d.value;var b=function(e){console.log("Initializing boolButton with options: "+JSON.stringify(e));var f=$('<i class="fa km-bool"></i>').addClass(e.value?"fa-check km-bool-checked":"fa-close km-bool-unchecked").addClass("km-bool-button-icon");e.target.find("i.km-bool").remove();e.target.prepend(f);if(!e.refreshMode){e.target.click((function(g){return function(){console.log("Button clicked");var k=$(this).find("i.km-bool");var j=!k.hasClass("km-bool-checked");var h=(function(m,n){return function(){console.log("Record updated");m.value=j;m.refreshMode=true;b(m)}})(g,k);if(j&&typeof(g.onSetTrue)==="function"){g.onSetTrue(l,g,h)}else{if(!j&&typeof(g.onSetFalse)==="function"){g.onSetFalse(l,g,h)}else{var l={id:g.recordId};l[g.field]=j;console.log("Updating record");km.js.db.update(l,h,null)}}}})(e))}};if(a!==true&&a!==false){if(c){throw"Initial value not set in boolButton called with manual callbacks"}console.log("Fetching initial value");km.js.db.query("select "+d.field+" from "+d.type+" where id = '"+d.recordId+"' limit 1",(function(f,e){return function(h,g,j){console.log("Initial value: "+JSON.stringify(h));h=km.js.utils.addPropertyNamesToJSRC(h,j);if(!h.length){throw"Record '"+e.recordId+"' of type "+e.type+" not found in km.js.ui.boolButton function"}e.value=h[0][e.field];f(e)}})(b,d))}else{b(d)}},buttonWait:function(a){if(a.isRestore==null){a.isRestore=true}if(!(a.button instanceof jQuery)){throw"Button passed to km.ui.buttonWait method is not a jQuery object"}var d=$('<div class="km-spinner"></div>');for(var b=0;b<=5;b++){d.append($("<div></div>").addClass("km-spinner-"+b))}var c=a.button.text()?a.button.text():a.button.val();a.button.empty().append(d).append($("<div></div>").text(a.text?a.text:"").addClass("km-waitbtn-text"));return{options:a,text:c,isRestore:a.isRestore,startTime:(new Date()).getTime()}},buttonWaitStop:function(b){var a=function(){var d=b.options.button;if(typeof(d.val)==="function"){d.empty().val(b.text)}if(typeof(d.text)==="function"){d.empty().text(b.text)}};if(b.isRestore){var c=(new Date()).getTime();if((c-b.startTime)>1000){a()}else{setTimeout(a,1000)}}},header:function(c,a,d){var b=$('<div class="km-ui-header km-title">'+c+"</div>");if(a){b.addClass(a)}if(d){b.attr("style",d)}return b},ripple:function(a){if(!a){a=$(document.body)}a.click(function(c){var b=$("<div></div>").addClass("km-ripple");b.css("top",(c.pageY)+"px").css("left",(c.pageX)+"px");b.css("background-color","#ccc");$(document.body).append(b);b.animate({opacity:0.3,width:"+=40px",height:"+=40px",left:"-=20px",top:"-=20px"},300,function(){$(this).hide()})})},appendMenuImages:function(){if(!$(".km-menu").hasClass("has-menu-icons")){$(".km-menu").addClass("has-menu-icons");$(".km-menu > ul > li > a").each(function(){var a=$("<img></img>").attr("src",km.js.config.imagePath+"/menuarrow.png");$(this).prepend($("<span></span>").append(a).addClass("km-menu-icon"))})}},tooltip:function(a){var b=$("<img></img>").attr("src",km.js.config.imagePath+"/tooltip.png").addClass("km-tooltip-icon");b.click((function(d){return function(h){var f=$("<div></div>").css("position","relative").text(d.text);var g=$("<div></div>").addClass("km-tooltip-text").append(f);var e="tooltip-"+Math.floor(Math.random()*(10000000));g.attr("id",e);$("div.km-tooltip-text").remove();$(document).find("body").append(g);g.css("top",h.pageY-g.outerHeight()/2).css("left",h.pageX+20);$(document).find("body").click(function(){$("div.km-tooltip-text").remove()});h.stopPropagation()}})(a));var c=$("<span></span>").append(b).addClass("km-tooltip-wrapper");if(a.afterTarget instanceof jQuery){a.afterTarget.after(c)}},formatApiName:function(a){if(!a){return}a=km.js.utils.capitalize(a);a=a.replace(/\s/g,"_");return a},formatFieldName:function(a){if(!a){return}a=km.js.utils.uncapitalize(a);a=a.replace(/\s/g,"_");return a},autoFormatName:function(b){if(!(b.target instanceof jQuery)){throw"Target of the autoformatApiName function must be a jQuery object"}var a=function(){var d=$(this).val();if(!d){return}var c="";var f="";if(d.indexOf(".")>=0){c=d.substring(0,d.lastIndexOf("."));f=d.substring(d.lastIndexOf(".")+1,d.length)}else{f=d}var e=(c?c.toLowerCase()+".":"")+km.js.ui.formatApiName(f);if(e!==d){$(this).val(e);$(this).addClass("km-auto-format-highlight")}else{$(this).removeClass("km-auto-format-highlight")}};b.target.focusout(a);if(b.onKeyUp){b.target.keyup(a)}},autoFormatFieldName:function(b){if(!(b.target instanceof jQuery)){throw"Target of the autoformatApiName function must be a jQuery object"}var a=function(){var c=$(this).val();if(!c){return}var d=km.js.ui.formatFieldName(c);if(d!==c){$(this).val(d);$(this).addClass("km-auto-format-highlight")}else{$(this).removeClass("km-auto-format-highlight")}};b.target.focusout(a);if(b.onKeyUp){b.target.keyup(a)}},editable:function(d){var a={};var c=$.extend({},a,d);var b=$("<input></input>").attr("type","text");if(c.inputName){b.attr("name",c.inputName)}b.keyup(function(e){if(e.keyCode==13){$(this).focusout()}});if(c.inputId){b.attr("id",c.inputId)}if(c.cssClass){b.addClass(c.cssClass)}if(!(c.target instanceof jQuery)){throw"Target should be a jQuery object"}b.focusout((function(f,e){return function(){if(typeof(e)==="function"){e($(this).val())}if($(this).val()===""){$(this).val("<empty>")}f.text($(this).val());$(this).hide();f.show()}})(c.target,c.onAccept));c.target.click((function(e,f){return function(){if(typeof(f)==="function"){f()}e.insertAfter($(this));$(this).hide();e.val($(this).text());e.show();e.select()}})(b,c.onActivate))},confirm:function(a){if(!(a.target instanceof jQuery)){throw"Target must be a jQuery object"}a.target.click((function(b){return function(){if(!b.target.is(":visible")){return}b.target.hide();var c=$('<div class="km-ui-confirm"><span class="km-ui-confirm-q">'+(b.question?b.question:km.js.config.i18n["msg.delete.warning"])+"</span></div>");var e=$('<a href="javascript:;">'+(b.yesLabel?b.yesLabel:km.js.config.i18n["btn.yes"])+"</a>");e.click(b.callback);var d=$('<a href="javascript:;">'+(b.noLabel?b.noLabel:km.js.config.i18n["btn.no"])+"</a>");d.click(function(){$(this).closest(".km-ui-confirm").remove();b.target.show()});c.append(e).append(d);b.target.after(c)}})(a))},error:function(c,b,a,d){return this.message(c,b,"error",a,d)},info:function(c,b,a,d){return this.message(c,b,"info",a,d)},message:function(c,e,g,a,j){var l="msg-tag";var d='<img src="'+km.js.config.imagePath+"/";if(g==="error"){l+=" action-errors";d+="erricon.png"}else{if(g==="info"){l+=" action-msgs";d+="infoicon.png"}}d+='" />';if(a!=null){l+=" "+a}var h="";if(c instanceof Array){h="<ul>";for(i=0;i<c.length;i++){h+="<li>"+c[i]+"</li>"}h+="</ul>"}else{h="<ul><li>"+c+"</li></ul>"}var f=$("<tr></tr>").append($("<td></td>").append($(d))).append($("<td></td>").html(h));var k=$("<table></table>").append($("<tbody></tbody>").append(f));var b=$('<div class="'+l+'" style="'+j+'"></div>').append(k);if(typeof(e)==="function"){e(b)}else{if(e instanceof jQuery){e.empty().append(b).show()}}},applyTabs:function(b){if(!(b instanceof jQuery)){throw"Argument of function km.ui.applyTabs must be a jQuery object, instead got "+typeof(b)}var a=function(d,e){e.find("div.km-tabs-panels > div.km-tabs-panel").removeClass("km-tabs-panel-active").hide();e.find("div.km-tabs-panels > div.km-tabs-panel-"+d).addClass("km-tabs-panel-active").show();e.find("ul.km-tabs-head > li.km-tabs-head-active").removeClass("km-tabs-head-active");e.find("ul.km-tabs-head > li.km-tabs-head-"+d).addClass("km-tabs-head-active");location.hash="km.tab."+d};b.find("ul.km-tabs-head > li").click((function(d,e){return function(){e($(this).index(),d)}})(b,a));var c=0;if(location.hash&&location.hash.indexOf("#km.tab.")===0){c=parseInt(location.hash.substring("#km.tab.".length))}a(c,b)},statusbar:{timer:null,stdCssClass:null,container:null,render:function(d,c,f){if(this.timer){clearTimeout(this.timer)}var b=null;if($("div."+this.cssClass).length===0){barWrapper=$("<div></div>").addClass("km-status-bar").addClass(f);b=$("<div></div>").addClass("content").appendTo(barWrapper);b.append(km.js.ui.closeBtn(function(){barWrapper.remove()}));$(document.body).append(barWrapper)}else{b=$("div."+this.cssClass+" div.content");b.find("ul.km-status-msgs").remove()}this.container=barWrapper;var e=$("<ul></ul>").addClass("km-status-msgs");if(!$.isArray(d)){var h=[];h.push(d)}else{h=d}for(var a=0;a<h.length;a++){var g=$("<li></li>").text(h[a]);e.append(g)}b.append(e);if(c){this.timer=setTimeout(function(){km.js.ui.statusbar.hide()},c)}},show:function(b,a){var c="km-status-bar-std km-status-bar-std-info";this.render(b,a,c)},err:function(b,a){this.render(b,a,"km-status-bar-std km-status-bar-std-err")},hide:function(){$(".km-status-bar").remove()}},closeBtn:function(b){var a=$("<img>").attr("src",km.js.config.imagePath+"/ex.png").addClass("km-close");a.click(function(){b()});return a},bool:function(a){a.each(function(){val=$(this).text();if(val){val=val.trim()}var b=$("<img></img>").attr("src",km.js.config.imagePath+"/"+(val=="true"?"check.gif":"uncheck.png"));$(this).empty().append(b)})},typeLookup:function(c){if(!c.types){c.types=km.js.utils.customTypes()}var d=km.js.datasource.create({type:"json",data:c.types});var b={properties:[{name:"qualifiedName"},{name:"id"},{name:"label"}]};if(""===c.selectedRecordId){selectedRecordId=null}var a={options:{id:"type-lookup-search"},display:{properties:[{name:"label",label:"Label",linkStyle:true},{name:"qualifiedName",label:"API Name",linkStyle:true}],idProperty:{name:"id"},defaultProperty:{name:"label"}},title:"Types"};var e=km.js.ref.create({datasource:d,selectedRecordDisplayField:{name:"label"},jcr:b,availableItemsDialogOptions:{afterClose:c.dialogAfterClose},availableItemsOptions:a,inputName:c.inputName,selectedRecordId:c.selectedRecordId,afterSelect:c.afterSelect,visibleInput:c.visibleInput});e.render(c.target);return e},dialog:{create:function(c){var b={size:{width:Math.floor(window.document.body.clientWidth*0.7),height:Math.floor(window.document.body.clientHeight*0.8),maxWidth:Math.floor(window.document.body.clientWidth*0.7),maxHeight:Math.floor(window.document.body.clientHeight*0.8)}};var a=$.extend(true,{},b,c);if(!a.id){a.id="km-dialog-"+km.js.utils.random(1000000)}if(a.size.fitToContent===true){a.size.width=a.size.height=null}var d={id:a.id,imagePath:km.js.config.imagePath+"/",options:a,addOpenDialog:function(e){km.js.scope.dialogs[km.js.utils.normalizeId(e.id)]=e},removeOpenDialog:function(e){delete km.js.scope.dialogs[km.js.utils.normalizeId(e)]},show:function(k){var o='<div class="km-dialog-overlay';if(!km.js.utils.isEmpty(this.options.cssClass)){o+=" "+this.options.cssClass}if(km.js.utils.isMobile()){o+=" km-dialog-mobile"}o+='" id="'+this.id+'">';o+='<div class="km-dialog"';var m="";if(!km.js.utils.isMobile()){if(a.size.width){m+="width: "+a.size.width}if(a.size.height){m+=";height: "+a.size.height}}else{m+="height: "+$(window).height()+"px"}o+='style="'+m+'">';o+='<div class="topbar">';if(!km.js.utils.isEmpty(a.title)){o+=a.title}o+='<img src="'+this.imagePath+'ex.png" class="close-btn"></div>';o+='<div class="km-dialog-content"';if(!km.js.utils.isEmpty(a.style)){o+=' style="'+a.style+'"'}o+=">";o+="</div></div></div>";var q=$(o);if(km.js.utils.isMobile()){q.find(".km-dialog-content").css("height",$(window).height()+"px")}var e=function(s){return function(){s.close()}};q.find(".close-btn").click(e(this)).mouseover(function(){$(this).attr("src",km.js.config.imagePath+"/exh.png")}).mouseout(function(){$(this).attr("src",km.js.config.imagePath+"/ex.png")});q.click(e(this));q.find(".km-dialog").click(function(s){s.stopPropagation()});if(document.getElementById(this.id)!=null){this.self().replaceWith(q)}else{$("body").append(q)}if(!km.js.utils.isEmpty(a.url)){q.find(".km-dialog-content").append('<iframe src="'+a.url+'" style="height: '+a.size.height+'"></iframe>')}else{if(a.iframe){var p=$("<html></html>");var h=$("<head></head>");if(a.iframe.addDefaultStyles===true){h.append($(km.js.utils.getCssInclude("resources/km/css/km.all.min.css")));h.append($(km.js.utils.getCssInclude("resources/layout.css")));h.append($(km.js.utils.getCssInclude("resources/tag-styles.css")));h.append($(km.js.utils.getCssInclude("resources/header.css")));h.append($(km.js.utils.getCssInclude("resources/themes/std/styles.css")));h.append($(km.js.utils.getScriptInclude("resources/km/js/km.core.js")));h.append($(km.js.utils.getScriptInclude("js/km.config.js")));h.append($(km.js.utils.getScriptInclude("resources/km/js/km.all.min.js")));h.append($(km.js.utils.getScriptInclude("resources/km/js/km.ui.js")))}if(window.kommet&&$.isArray(window.kommet.styles)){for(var f=0;f<window.kommet.styles.length;f++){h.append($('<link href="'+window.kommet.styles[f]+'" rel="stylesheet" type="text/css" />'))}}p.append(h);var g=$("<body></body>");if(a.iframe.bodyCssClass){g.addClass(a.iframe.bodyCssClass)}if(a.iframe.bodyCssStyle){g.attr("style",a.iframe.bodyCssStyle)}p.append(g.append(k));var l=this.id+"-iframe";var r=$("<iframe></iframe>").attr("id",l);if(a.iframe.cssClass){r.addClass(a.iframe.cssClass)}r.hide();q.find(".km-dialog-content").empty().append(r);var j=$("<img></img>").attr("src",km.js.config.imagePath+"/ellipsis.gif");q.find(".km-dialog-content").append(j);var n=q.find(".km-dialog-content > iframe").contents().find("body");n.addClass("km-font-scale").append(p);if(a.iframe.cssBodyClass){n.addClass(a.iframe.cssBodyClass)}q.find(".km-dialog-content > iframe").contents().find("body").replaceWith(n);r.ready((function(s,u,t){return function(){u.hide();t.show();s.adjustSize();km.js.scope.resizeEvent.listen((function(){return function(v){console.log("Adjusting iframe to changed content");s.adjustSize()}})())}})(this,j,r))}else{q.find(".km-dialog-content").append(k)}}if(typeof(this.options.beforeShow)==="function"){this.options.beforeShow(this)}$("body").css("overflow","hidden");$("html").css("overflow","hidden");this.addOpenDialog(this);return this},adjustSize:function(){var o=null,f=null;var k=30;var j=this.options.size.width;var h=this.options.size.height;var e=false;if(this.options.size.fitToContent===true){if(this.self().find("iframe").size()>0){e=true;var m=this.self().find("iframe");var g=m.attr("id");o=m.contents().find("body").height()+20;f=m.contents().find("body").width()+100;m.css("width",f+"px");m.css("height",o+"px");h=o;j=f}}j+=(2*k)+100;h+=(2*k)+40;if(this.options.size.maxHeight&&h>this.options.size.maxHeight){h=this.options.size.maxHeight}if(this.options.size.minHeight&&h<this.options.size.minHeight){h=this.options.size.minHeight}if(this.options.size.maxWidth&&j>this.options.size.maxWidth){j=this.options.size.maxWidth}if(this.options.size.minWidth&&j<this.options.size.minWidth){j=this.options.size.minWidth}console.log("Allow body scale: "+this.options.iframe.allowAdjustBodyWidth);if(e&&this.options.iframe.allowAdjustBodyWidth){m.contents().find("body").css("width",Math.floor(j*0.9))}var n=this.self().find(".km-dialog");if(!km.js.utils.isMobile()){console.log("not mobile");n.css("width",j+"px");n.css("height",h+"px");var l=n.find(".km-dialog-content");l.css("width",j+"px");l.css("height",h+"px")}else{console.log("mobile");n.css("width","100%");n.css("height",$(window).height())}this.self().find(".km-dialog-content").css("padding",k+"px")},self:function(){return $("div[id='"+this.id+"']")},close:function(){this.self().remove();$("body").css("overflow","initial");$("html").css("overflow","auto");if(typeof(this.options.afterClose)==="function"){this.options.afterClose()}this.removeOpenDialog(this.id)},hide:function(){this.self().hide();$("body").css("overflow","auto");$("html").css("overflow","auto");this.removeOpenDialog(this.id)},content:function(e){this.self().find(".km-dialog-content").html(e)},fullscreen:function(){this.self().find(".km-dialog").css("width","100%").css("height","100vh").addClass("km-dialog-fullscreen");return this}};return d},closeAllDialogs:function(){for(var a in km.js.scope.dialogs){km.js.scope.dialogs[a].close()}}}};
km.js.notifier={get:function(){var a={waits:{},onComplete:null,isComplete:false,wait:function(b){this.waits[b]=false;this.isComplete=false},reach:function(c){this.waits[c]=true;var b=true;for(wait in this.waits){if(this.waits[wait]!==true){b=false;break}}if(b===true){this.isComplete=true;this.onComplete(this)}}};return a}};
km.js.datasource={create:function(c){var b={contextPath:km.js.config.contextPath,sysContextPath:km.js.config.sysContextPath};var a=$.extend({},b,c);var d={type:a.type,data:a.data,jsti:a.jsti,jcr:null,contextPath:a.contextPath,sysContextPath:a.sysContextPath,dataLength:km.js.utils.isEmpty(a.data)?null:a.data.length,getDefaultCompare:function(f,e){return function(j,h){var i=km.js.utils.propVal(j,f);var g=km.js.utils.propVal(h,f);if(i<g){return e?1:-1}if(i>g){return e?-1:1}return 0}},query:function(j,i,e){var h=null;var g=null;if(j&&typeof(j)==="object"){h=j}else{g=j}if(this.type==="collection"){if(h){this.populateJCRIds(h,this.jsti)}return this.queryLocalCollection(h,i)}else{if(this.type==="database"){var f=function(l,k){return function(n,o,m){if(h){k.populateJCRIds(h,m)}l(n,o,m)}};return this.queryDatabase(h?h:g,f(i,this),e)}else{if(this.type==="json"){return this.queryJSONCollection(h,i)}else{console.error("Unsupported data source type "+this.type)}}}},queryDatabase:function(i,h,k){var g=null;var f=null;var e=null;if(typeof(i)==="object"){g=i;this.jcr=g;e={jcr:JSON.stringify(g),mode:"datasource"}}else{f=i;this.jcr=null;e={query:f,mode:"datasource"}}if(typeof(this.contextPath)==="undefined"){throw"Context path not set"}var j=function(m,n,l){return function(o){m.jsti=o.jsrc.jsti;m.dataLength=o.recordCount;if(typeof(n)==="function"){n(o.jsrc.records,o.recordCount,o.jsrc.jsti)}}};$.post(this.sysContextPath+"/rest/jsds/query",e,j(this,h),"json").fail(k)},queryJSONCollection:function(e,h){this.jcr=e;this.dataLength=this.data.length;var g=this.filterData();var f=g.length;g=this.sortItems(g);g=this.pageItems(g,this.jcr.limit,this.jcr.offset);if(typeof(h)==="function"){h(g,f,this.jsti)}return g},queryLocalCollection:function(q,m){this.jcr=q;this.dataLength=this.data.length;var u=this.filterData();var f=[];if(q.groupings!=null&&q.groupings.length>0){var p={};var n=q.groupings[0].property_id;for(var y=0;y<u.length;y++){var s=u[y];var r=km.js.utils.propVal(s,n);if(km.js.utils.isEmpty(r)){r=""}if($.inArray(r,f)<0){f.push(r)}var h=null;if(!km.js.utils.isEmpty(p[r])){h=p[r]}else{h={group_value:r,items:[],aggr_results:{}}}h.items.push(s);p[r]=h}var l=[];for(var w=0;w<f.length;w++){var A=f[w];var t=p[A];km.js.utils.setPropVal(t,n,A);for(var y=0;y<q.properties.length;y++){if(q.properties[y].id!=n){t[q.properties[y].id]=t.items.length}}l.push(t)}for(var y=0;y<l.length;y++){var t=l[y];for(var x=0;x<t.items.length;x++){var s=t.items[x];for(var w=0;w<q.properties.length;w++){var g=q.properties[w];if(km.js.utils.isEmpty(t.aggr_results[g.id])){t.aggr_results[g.id]={sum:0,count:0,min:null,max:null,avg:null}}var v=t.aggr_results[g.id];if(g.id!=n){var e=g.aggr;var o=g.id;if(e==="avg"){var r=km.js.utils.propVal(s,o);v.sum+=(r!=null?r:0);v.count=t.items.length}else{if(e==="sum"){var r=km.js.utils.propVal(s,o);v.sum+=(r!=null?r:0)}else{if(e==="count"){v.count=t.items.length}else{if(e==="min"){var r=km.js.utils.propVal(s,o);if(v.min==null||r<v.min){v.min=r}}else{if(e==="max"){var r=km.js.utils.propVal(s,o);if(v.max==null||r>v.max){v.max=r}}}}}}}v.avg=(v.sum/v.count).toFixed(2)}}for(var w=0;w<q.properties.length;w++){var e=q.properties[w].aggr;if(!km.js.utils.isEmpty(e)){t[q.properties[w].id]=t.aggr_results[q.properties[w].id][e]}}}u=l}var z=u.length;u=this.sortItems(u);u=this.pageItems(u,this.jcr.limit,this.jcr.offset);if(typeof(m)==="function"){m(u,z,this.jsti)}return u},filterData:function(){var f=[];if(km.js.utils.isEmpty(this.jcr)){return[].concat(this.data)}if(this.jcr.restrictions!=null&&this.jcr.restrictions.length>0){for(var j=0;j<this.data.length;j++){var h=this.data[j];var g=true;for(var l=0;l<this.jcr.restrictions.length&&g;l++){var e=this.jcr.restrictions[l];if(!this.isMeetCriteria(e,h)){g=false}}if(g){f.push(h)}}}else{f=[].concat(this.data)}return f},pageItems:function(e,i,h){var g=km.js.utils.isEmpty(h)?0:h;var f=km.js.utils.isEmpty(i)?(e.length-g):i;return e.splice(g,f)},sortItems:function(e){if(km.js.utils.isEmpty(this.jcr.orderings)||this.jcr.orderings.length==0){return e}sortProperty=this.jcr.orderings[0].property_id;sortOrder=this.jcr.orderings[0].direction;return e.sort(this.getDefaultCompare(sortProperty,sortOrder==="desc"))},populateJCRIds:function(g,f){var m=km.js.utils.getTypeFromJSTI(g,f);var l=m.qualifiedName;if(!l){throw"Type qualified name not found in JSTI. Type ID is "+g.baseTypeId}if(g.properties){for(var e=0;e<g.properties.length;e++){var k=g.properties[e];if(!k.id){k.id=km.js.utils.nestedPropertyToPir(k.name,m,f)}}}if(g.groupings){for(var e=0;e<g.groupings.length;e++){var j=g.grouping[e];if(!j.property_id){j.property_id=nestedPropertyToPir(j.property_name,m,f)}}}if(g.orderings){for(var e=0;e<g.orderings.length;e++){var h=g.orderings[e];if(!h.property_id){h.property_id=nestedPropertyToPir(h.property_name,m,f)}}}if(g.restrictions){km.js.utils.forEachRestriction(g.restrictions,(function(n,i){return function(o){if(km.js.utils.isSimpleRestriction(o)&&!o.property_id){var p=km.js.utils.getTypeFromJSTI(i,n);o.property_id=km.js.utils.nestedPropertyToPir(o.property_name,p,n)}}})(f,g))}},isMeetCriteria:function(e,k){if(e.operator.toLowerCase()==="eq"){return km.js.utils.propVal(k,e.property_id)===e.args[0]}else{if(e.operator.toLowerCase()==="ne"){return km.js.utils.propVal(k,e.property_id)!==e.args[0]}else{if(e.operator.toLowerCase()==="gt"){return km.js.utils.propVal(k,e.property_id)>e.args[0]}else{if(e.operator.toLowerCase()==="ge"){return km.js.utils.propVal(k,e.property_id)>=e.args[0]}else{if(e.operator.toLowerCase()==="lt"){return km.js.utils.propVal(k,e.property_id)<e.args[0]}else{if(e.operator.toLowerCase()==="le"){return km.js.utils.propVal(k,e.property_id)<=e.args[0]}else{if(e.operator.toLowerCase()==="ilike"){var j=km.js.utils.propVal(k,e.property_id);if(km.js.utils.isEmpty(j)){return false}else{var g=new RegExp(e.args[0].replace(/%/g,".*"),"gi");return(j+"").toLowerCase().match(g)!==null}}else{if(e.operator.toLowerCase()==="not"){if(e.args===null||e.args.length===0){throw"Empty argument list for a NOT restriction"}else{if(e.args.length>1){throw"More than one argument not allowed in a NOT restriction"}}var h=e.args[0];if(typeof h==="object"&&h!==null){return !this.isMeetCriteria(h,k)}else{throw"Argument of a NOT restriction is not an object. Its value is "+h}}else{if(e.operator.toLowerCase()==="or"||e.operator.toLowerCase()==="and"){if(e.args===null||e.args.length===0){throw"Empty argument list for a "+e.operator+" restriction"}if(e.operator.toLowerCase()==="and"){for(var f=0;f<e.args.length;f++){var h=e.args[f];if(typeof h==="object"&&h!==null){if(!this.isMeetCriteria(h,k)){return false}}else{throw"Argument of an AND restriction is not an object. Its value is "+h}}return true}else{if(e.operator.toLowerCase()==="or"){for(var f=0;f<e.args.length;f++){var h=e.args[f];if(typeof h==="object"&&h!==null){if(this.isMeetCriteria(h,k)){return true}}else{throw"Argument of an AND restriction is not an object. Its value is "+h}}return false}}}else{console.log("Criteria not supported: "+e.operator);return false}}}}}}}}}}};return d}};
km.js.buttonpanel={create:function(b){var a={buttons:[],id:b.id,cssClass:b.cssClass,options:b,addButton:function(c){this.buttons.push(c)},render:function(e){var d=$('<div class="km-btn-panel" id="'+this.id+'"></div>');if(this.cssClass){d.addClass(this.cssClass)}if(b.title){var f=$("<div></div>").text(b.title.text);if(b.title.cssClass){f.addClass(b.title.cssClass)}d.append(f)}var c=$("<div></div>").addClass("km-btn-panel-buttons");for(var g=0;g<this.buttons.length;g++){c.append(this.getButtonCode(this.buttons[g]))}d.append(c);if(typeof(e)==="function"){e(d)}else{e.html(d)}return d},getButtonCode:function(d){var e='<a href="'+(d.url?d.url:"javascript:;")+'" ';e+='class="sbtn">'+d.label+"</a>";var c=$(e);if(d.id){c.attr("id",d.id)}if(typeof(d.onClick)==="function"){c.click(d.onClick)}return c}};return a}};
km.js.table={create:function(f,b,g,e){var d={cssClass:"km-table-std",wrapperCssClass:null,contextPath:km.js.config.contextPath,dragRowCount:10,pageSize:20,afterRender:null,afterRemoveColumn:null,exportFormats:[],buttonPanel:null,pagination:{active:false,currentPage:0,pageCount:null}};var c=$.extend({},d,e);if(!g.idProperty){g.idProperty={name:"id"}}if(c.title){if(c.title.placement==="buttons-left"){if(c.buttonPanel){c.buttonPanel.title=c.title}}}var a={datasource:null,jcr:null,title:c.title,data:null,generatedCode:null,display:null,settings:null,activeDragColumnIndex:null,sortPropertyId:null,sortOrder:null,unpagedDataCount:null,id:c.id,buttonPanel:c.buttonPanel,baseType:null,pagination:c.pagination,render:function(j,i){var h=function(m,l){return function(q,o,p){var n=m.datasource.type==="json";if(!p&&!n){throw"JSTI not passed to datasource.query callback"}if(!n){m.baseType=km.js.utils.getTypeFromJSTI(l,p);m.populateIdsOnTableOptions(p,m.baseType)}m.getCode(q,o);m.rerenderFooter();m.initHeaderFilters();m.draggableColumns();m.updateHeaders();m.updateButtonPanel();if(typeof(i)==="function"){i(m.generatedCode,m)}else{i.html(m.generatedCode)}if(typeof(m.settings.afterRender)==="function"){m.settings.afterRender(m)}if(km.js.scope.resizeEvent){km.js.scope.resizeEvent.notify()}m.data=[].concat(q);m.unpagedDataCount=o}};var k=km.js.utils.isEmpty(j)?this.jcr:j;if(km.js.utils.isEmpty(k)){console.error("JCR is empty")}this.datasource.query(k,h(this,k))},rerenderRows:function(h,i,j){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call rerenderRows when no table code has been generated"}this.generatedCode.find("div.kmjstb").html(this.renderRows(h,i));if(j&&typeof(j.onComplete)==="function"){j.onComplete(this)}},populateIdsOnTableOptions:function(i,h){if(!this.display){return}if(this.display.properties&&this.display.properties.length>0){km.js.utils.populateIdsOnProperties(this.display.properties,h,i)}if(this.display.idProperty){if(!this.display.idProperty.id){if(this.display.idProperty.name){this.display.idProperty.id=km.js.utils.nestedPropertyToPir(this.display.idProperty.name,h,i)}else{throw"Neither ID property name nor its ID defined in table options"}}}else{throw"ID property not defined in km.js.table options"}},updateButtonPanel:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call updateHeaders when no table code has been generated"}if(!this.buttonPanel||!this.buttonPanel.buttons||this.buttonPanel.buttons.length===0){return}if(typeof(this.buttonPanel.render)!=="function"){throw"Button panel defined on rm.table does not have function render(). It may not have been created using rm.buttonpanel.create()"}this.buttonPanel.render(this.generatedCode.find(".km-btn-panel-container"))},updateHeaders:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call updateHeaders when no table code has been generated"}if(!km.js.utils.isEmpty(b.groupings)){for(var m=0;m<b.groupings.length;m++){var j=b.groupings[m].property_id;this.generatedCode.find("#"+this.settings.id+"-group-btn-"+j.replace(/\./g,"-")).attr("src",this.imagePath+"linkh.png")}}for(var m=0;m<b.properties.length;m++){var i=b.properties[m];var o=this.generatedCode.find("#"+this.settings.id+" .kmjsth select#aggr-"+i.id.replace(/\./g,"-"));var h=null;if(this.datasource.type!=="json"){h=this.datasource.jsti.fields[km.js.utils.lastProperty(i.id)].dataType.id}else{h=km.js.datatypes.text.id}var k=this.aggrFunctionsForDataType(h);var n="";for(var l=0;l<k.length;l++){n+='<option value="'+k[l].name+'">'+k[l].label+"</option>"}o.html(n);if(!km.js.utils.isEmpty(i.aggr)){o.val(i.aggr).show()}}},container:function(){return $("#km-table-container-"+this.settings.id)},getCode:function(j,l){var h=$('<div id="km-table-container-'+this.settings.id+'"></div>').addClass("km-table-container");if(this.title&&this.title.placement==="top"){var k=$("<div></div>").text(this.title.text).addClass("km-record-table-title");if(this.title.cssClass){k.addClass(this.title.cssClass)}h.append(k)}h.append($('<div class="km-btn-panel-container"></div>'));var i=$('<div id="km-table-wrapper-'+this.settings.id+'" class="km-table-wrapper"></div>');if(this.settings.wrapperCssClass){i.addClass(this.settings.wrapperCssClass)}h.append(i);var m=$('<div class="kmjstable '+this.settings.cssClass+'" id="'+this.settings.id+'"></div>');m.append(this.renderHeaders());m.append($('<div class="kmjstb"></div>'));h.append(m);h.append($('<div class="kmjstf"></div>'));this.generatedCode=h;this.generatedCode.find(".kmjstb").html(this.renderRows(j,l));return this.generatedCode},rerenderFooter:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call rerenderFooter when no table code has been generated"}this.generatedCode.find(".kmjstf").replaceWith(this.renderFooter())},renderFooter:function(){var m=$('<div class="kmjstf"></div>');var q=$('<div class="kmjstr"></div>');var j=this.pagination.pageCount>15?15:this.pagination.pageCount;if(this.pagination.active){var u=$('<div id="pagination-'+this.settings.id+'" class="km-pagination"></div>');u.append($('<a href="javascript:;" class="km-first km-page-no"></a>').html("&lt;&lt;"));u.append($('<a href="javascript:;" class="km-prev km-page-no"></a>').html("&lt;"));var h=$('<div class="km-page-no-no-ellipsis"></div>');for(var o=0;o<j;o++){h.append($('<a href="javascript:;" class="km-page-no km-page-'+o+'">'+(o+1)+"</a>"))}u.append(h);if(this.pagination.pageCount>j){var t=$('<div class="km-page-no-ellipsis"></div>');for(var o=j;o<(this.pagination.pageCount-1);o++){t.append($('<a href="javascript:;" class="km-page-no km-page-'+o+'">'+(o+1)+"</a>"))}u.append(t)}var s=$('<div class="km-page-no-no-ellipsis">');if(this.pagination.pageCount>j){s.append($('<a href="javascript:;" class="km-page-no km-page-'+(this.pagination.pageCount-1)+'">'+this.pagination.pageCount+"</a>"))}u.append(s);u.append($('<a href="javascript:;" class="km-next km-page-no"></a>').html("&gt;"))}q.append(u);var r=false;var n=false;if(!km.js.utils.isEmpty(this.settings.exportFormats)&&this.settings.exportFormats.length>0){var v=$('<div class="kmjstr"></div>');var l=$('<div class="km-export-btns"></div>');for(var o=0;o<this.settings.exportFormats.length;o++){if(this.settings.exportFormats[o]==="csv"){r=true;l.append($('<input type="button" class="sbtn km-export-csv" id="'+this.id+'-csv" value="CSV">'));l.append($('<form id="'+this.settings.id+'-csv-form" method="post" style="display:none"><input type="hidden" name="jcr"></form>'))}else{if(this.settings.exportFormats[o]==="xlsx"){n=true;l.append($('<input type="button" class="sbtn km-export-xlsx" id="'+this.id+'-xlsx" value="Excel">'));l.append($('<form id="'+this.settings.id+'-xlsx-form" method="post" style="display:none"><input type="hidden" name="jcr"></form>'))}else{throw"Unsupported export format "+this.options.exportFormats[o]}}}v.append(l);q.append(l)}m.append(q);var p=function(w){return function(){w.prevPage()}};var i=function(w){return function(){w.nextPage()}};var k=function(x,w){return function(){x.goToPage(w)}};if(r===true){m.find(".km-export-csv").click((function(w){return function(){w.exportToCsv()}})(this))}if(n===true){m.find(".km-export-xlsx").click((function(w){return function(){w.exportToXlsx()}})(this))}m.find(".km-prev").click(p(this));m.find(".km-next").click(i(this));m.find(".km-first").click(k(this,0));m.find(".km-last").click(k(this,this.pagination.pageCount-1));for(var o=0;o<j;o++){m.find(".km-page-"+o).click(k(this,o))}if(this.pagination.pageCount>j){m.find(".km-page-"+(this.pagination.pageCount-1)).click(k(this,(this.pagination.pageCount-1)))}return m},renderHeaders:function(){var i='<div class="kmjsth">';i+='<div class="kmjstr">';for(var h=0;h<this.display.properties.length;h++){i+='<div class="kmjstd th-'+this.display.properties[h].id.replace(/\./g,"-")+'">'+this.display.properties[h].label+"</div>"}i+="</div></div>";return $(i)},aggrFunctionsForDataType:function(h){var i=[{name:"count",label:"zliczanie"}];if(h===0){i.push({name:"sum",label:"suma"});i.push({name:"avg",label:"srednia"});i.push({name:"min",label:"minimum"});i.push({name:"max",label:"maksimum"})}return i},defaultRestrictionOperatorForType:function(h){if(h===km.js.datatypes.bool.id||h===km.js.datatypes.number.id){return"eq"}else{return"ilike"}},waitModeOn:function(){$("#"+this.settings.id+" > .kmjstb").css({filter:"alpha(opacity=40)",zoom:"1",opacity:"0.4"})},waitModeOff:function(){$("#"+this.settings.id+" > .kmjstb").css({filter:"alpha(opacity=100)",zoom:"1",opacity:"1.0"})},renderRows:function(r,x){if(!r){return""}if(this.pagination.active){this.pagination.pageCount=Math.ceil(x/this.pagination.pageSize)}var v=function(C,B,A){return C.replace(/{(.*?)}/g,function(D,E){if(E==="id"){return B}else{return km.js.utils.propVal(A,E)}})};var n=[];var t=false;if(!this.datasource.type==="database"){if(this.datasource.jsti){r=km.js.utils.addPropertyNamesToJSRC(r,this.datasource.jsti);t=true}else{throw"JSTI not defined on database datasource"}}var s=false;for(var w=0;w<this.display.properties.length;w++){var k=this.display.properties[w];if(k.url&&/{(.*?)}/.test(k.url)&&!t){if(this.datasource.type==="database"&&this.datasource.jsti){r=km.js.utils.addPropertyNamesToJSRC(r,this.datasource.jsti);t=true}else{console.warn("Requested initializing properties on record set, but it was impossible due to missing JSTI")}}}if(r.length){for(var w=0;w<r.length;w++){var m=r[w];var p='<div class="kmjstr"';var z=null;if(!km.js.utils.isEmpty(this.display.idProperty.id)){z=m[this.display.idProperty.id];if(!z){throw"ID property "+this.display.idProperty.id+" not retrieved in query"}p+=' id="'+z+'"'}p+="></div>";var y=$(p);for(var u=0;u<this.display.properties.length;u++){var k=this.display.properties[u];var q=k.id?km.js.utils.propVal(m,k.id):m;if(typeof(k.format)==="function"){q=k.format(q,m)}if(q==null){q=""}cellCode='<div class="kmjstd kmjstd-'+k.id.replace(/\./g,"-")+"";if(k.linkStyle===true){cellCode+=" kmjstda"}cellCode+='"></div>';var i=$(cellCode);var o=$("<div></div>").addClass("km-prop-mobile-label").text(k.label);i.append(o);var j=null;if(!km.js.utils.isEmpty(k.url)){j=$('<a href="'+v(k.url,m[this.display.idProperty.id],m)+'">'+q+"</a>")}else{if(q instanceof jQuery){j=q}else{j=q}}i.append(j);if(k.content&&typeof(k.content)==="function"){k.content(m,z,i)}y.append(i)}n.push(y)}}else{var l=$("<div></div>").addClass("kmjstr km-table-no-results");var i=$("<div></div>").addClass("kmjstd").text(km.js.config.i18n["msg.noresults"]);l.append(i);for(var u=1;u<this.display.properties.length;u++){l.append($("<div></div>").addClass("kmjstd"))}n.push(l)}for(var w=0;w<this.display.properties.length;w++){var k=this.display.properties[w];if(typeof(k.onClick)==="function"){var h=function(A){return function(){var B=$(this).closest(".kmjstr").attr("id");A(B)}};for(var u=0;u<n.length;u++){n[u].find(".kmjstd-"+k.id.replace(/\./g,"-")).click(h(k.onClick))}}}return n},goToPage:function(h){this.pagination.currentPage=h;this.jcr.offset=this.pagination.pageSize*h;this.update()},prevPage:function(){if(this.pagination.currentPage>0){this.goToPage(this.pagination.currentPage-1)}},nextPage:function(){if(this.pagination.currentPage<(this.pagination.pageCount-1)){this.goToPage(this.pagination.currentPage+1)}},update:function(h){var j=[].concat(this.data);var i=function(k,l){return function(n,m){k.rerenderRows(n,m);k.rerenderFooter();k.updatePaginationDisplay();k.data=[].concat(n);k.unpagedDataCount=m;if(typeof(l)==="function"){l(k)}}};if(!km.js.utils.isEmpty(b)){this.datasource.query(b,i(this,h))}else{(i(this))(j,this.unpagedDataCount)}},updatePaginationDisplay:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call updatePaginationDisplay when no table code has been generated"}this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-no").removeClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-"+this.pagination.currentPage).addClass("km-page-no-hl");if(this.pagination.currentPage==0){this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-0").addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-prev").addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-first").addClass("km-page-no-hl")}if(this.pagination.currentPage==(this.pagination.pageCount-1)){this.generatedCode.find("#pagination-"+this.settings.id+" .km-page-"+this.pagination.currentPage).addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-next").addClass("km-page-no-hl");this.generatedCode.find("#pagination-"+this.settings.id+" .km-last").addClass("km-page-no-hl")}},setPageSize:function(h){this.pagination.pageSize=h;this.jcr.offset=this.pagination.pageSize*pageIndex;this.update();this.rerenderFooter()},moveColumn:function(i,j){if(i===j){return}$("#"+this.settings.id+" .kmjstr").each(function(){var l=$(this).children().eq(i);var k=$(this).children().eq(j);if(j>i){k.after(l)}else{k.before(l)}});var h=this.display.properties[i];km.js.utils.remove(i,this.display.properties);km.js.utils.insert(j,this.display.properties,h)},draggableColumns:function(){if(km.js.utils.isEmpty(this.generatedCode)){throw"Cannot call draggableColumns when no table code has been generated"}var h=function(i){for(var m=0;m<i.display.properties.length;m++){var k=i.display.properties[m];if(k.draggable!==true){continue}var l=k.id.replace(/\./g,"-");var j=i.generatedCode.find(".kmjsth > .kmjstr > .th-"+l);j.draggable({helper:"clone",start:function(q,r){var o=$(this).index();i.activeDragColumnIndex=o;var n=$('<div id="drag-col-'+i.settings.id+'"></div>');var p=0;i.generatedCode.find(".kmjstr .kmjstd:nth-child("+(o+1)+")").each(function(){if(p<i.settings.dragRowCount){n.append($(this).clone());p++}else{return false}});$(r.helper).html(n);$(r.helper).css("border","1px dotted #666");$(r.helper).css("background-color","#eee").css("color","#555").css("opacity","0.9")},cursor:"move",stop:function(){var n=$("#drag-col-"+i.settings.id);n.remove()}})}i.generatedCode.find(".kmjsth > .kmjstr > .kmjstd").droppable({drop:function(o,n){if($(n.draggable).hasClass("kmjstd")){i.moveColumn(i.activeDragColumnIndex,$(this).index());i.activeDragColumnIndex=null}},tolerance:"pointer"})};return h(this)},exportToXlsx:function(){var k=this;$("#"+k.settings.id+"-xlsx-form").attr("action",km.js.config.sysContextPath+"/rest/jsds/query?format=xlsx&exportFileName="+(k.settings.exportFileName?k.settings.exportFileName:""));var h=$.extend({},k.jcr);h.offset=null;h.limit=null;h.properties=[];for(var j=0;j<k.display.properties.length;j++){var l=null;for(var i=0;j<k.jcr.properties.length;i++){if(k.jcr.properties[i].id===k.display.properties[j].id){l=k.jcr.properties[i];break}}if(l){h.properties.push(l)}}$("#"+k.settings.id+"-xlsx-form > input[name='jcr']").val(JSON.stringify(h));$("#"+k.settings.id+"-xlsx-form").submit()},exportToCsv:function(){var k=this;$("#"+k.settings.id+"-csv-form").attr("action",km.js.config.sysContextPath+"/rest/jsds/query?format=csv&exportFileName="+(k.settings.exportFileName?k.settings.exportFileName:""));var j=$.extend({},k.jcr);j.offset=null;j.limit=null;j.properties=[];for(var i=0;i<k.display.properties.length;i++){var l=null;for(var h=0;h<k.jcr.properties.length;h++){if(k.jcr.properties[h].id===k.display.properties[i].id){l=k.jcr.properties[h];break}}if(l){j.properties.push(l)}}$("#"+k.settings.id+"-csv-form > input[name='jcr']").val(JSON.stringify(j));$("#"+k.settings.id+"-csv-form").submit()},sort:function(k){var h=k.replace(/\./,"-");var i=this.container().find(".th-"+h);this.waitModeOn();var j=this.sortOrder==="asc"?"desc":"asc";i.closest(".kmjsth").find(".kmjstd .sort-btn").attr("src",this.imagePath+"sort.png");i.find(".sort-btn").attr("src",this.imagePath+"sort"+j+".png");this.sortOrder=j;this.jcr.orderings=[{property_id:k,direction:j}];var l=function(m){return function(o,n){m.rerenderRows(o,n,{onComplete:function(p){p.waitModeOff()}});m.data=[].concat(o);m.unpagedDataCount=n}};this.datasource.query(b,l(this))},initHeaderFilters:function(){var h=function(l){if(km.js.utils.isEmpty(l.generatedCode)){throw"Cannot call initHeaderFilters when no table code has been generated"}for(var q=0;q<l.display.properties.length;q++){var n=l.display.properties[q];var k=n.id.replace(/\./g,"-");var j=null;if(l.datasource.type==="database"){j=l.datasource.jsti.fields[km.js.utils.lastProperty(n.id)].dataType.id;if(!j&&j!==0){throw"Data type not retrieved for property "+JSON.stringify(n)}}var p=l.generatedCode.find(".kmjsth > .kmjstr > .th-"+k);var i=n.label;var o=n.id;var m='<span class="km-th-label">'+i+"</span>";if(n.filterable===true){m+='<div class="filter-val"></div>'}m+='<div class="km-label-btns">';if(n.groupable===true){m+='<div class="km-header-btn"><img class="group-btn" id="'+l.settings.id+"-group-btn-"+k+'" src="'+l.imagePath+'link.png"></div>'}if(n.filterable===true){m+='<div class="km-header-btn"><img class="filter-btn" id="'+l.settings.id+"-filter-btn-"+k+'" src="'+l.imagePath+'filter.png"></div>'}if(n.sortable===true){if(l.datasource.type==="database"&&j===km.js.datatypes.formula.id){console.warn("Sorting by formula field "+n.id+" skipped");n.sortable=false}else{m+='<div class="km-header-btn"><img class="sort-btn" id="'+l.settings.id+"-sort-btn-"+k+'" src="'+l.imagePath+'sort.png"></div>'}}if(n.removable===true){m+='<div class="km-header-btn"><img class="del-btn" id="'+l.settings.id+"-del-btn-"+k+'" src="'+l.imagePath+'exb.png"></div>'}m+='<select class="aggr-select" id="aggr-'+k+'">';m+='<option value="count">zliczanie</option>';m+='<option value="sum">suma</option>';m+='<option value="avg">srednia</option>';m+='<option value="min">minimum</option>';m+='<option value="max">maksimum</option>';m+="</select>";m+="</div>";if(n.filterable===true){m+='<div><input class="km-js-th-input th-input-'+k+'" type="text" placeholder="filtr"></div>'}p.html(m);if(n.filterable===true){p.find("img.filter-btn").each(function(){$(this).click(function(){var r=$(this).closest(".kmjstd").find("input.km-js-th-input");if(r.is(":visible")){r.hide()}else{$(this).closest(".kmjstr").find(".kmjstd input.km-js-th-input").hide();$(this).closest(".kmjstd").find(".filter-val").hide();r.show()}})})}if(n.sortable===true){p.find(".km-th-label").click((function(s,r){return function(){s.sort(r.id)}})(l,n));p.find("img.sort-btn").each(function(){$(this).click(function(){l.waitModeOn();var r=$(this).attr("id").substring((l.settings.id+"-sort-btn-").length);r=r.replace(/\-/g,".");var s=l.sortOrder==="asc"?"desc":"asc";$(this).closest(".kmjsth").find(".kmjstd .sort-btn").attr("src",l.imagePath+"sort.png");$(this).attr("src",l.imagePath+"sort"+s+".png");l.sortOrder=s;l.jcr.orderings=[{property_id:r,direction:s}];var t=function(u){return function(v,w){u.rerenderRows(v,w,{onComplete:function(x){x.waitModeOff()}});u.data=[].concat(v);u.unpagedDataCount=w}};l.datasource.query(l.jcr,t(l))})})}if(n.removable===true){p.find("img.del-btn").each(function(){$(this).click(function(){var s=$(this).attr("id").substring((l.settings.id+"-del-btn-").length);var r=l.isGrouped(l.datasource.jcr,s);s=s.replace(/\-/g,".");l.removeColumn(s,true);if(r){l.update()}})})}p.find(".aggr-select").each(function(){$(this).change(function(){var r=$(this).attr("id").substring("aggr-".length);l.setAggr(b,r,$("#aggr-"+r).val());l.update()})});if(n.groupable===true){p.find(".group-btn").each(function(){$(this).click(function(){var s=$(this).attr("id").substring($(this).attr("id").indexOf("-group-btn")+"-group-btn".length+1);s=s.replace(/\-/g,".");if(l.isGrouped(b,s)){$(this).attr("src",l.imagePath+"link.png");l.setGrouping(l.jcr,null);var r=$(this).closest(".kmjstr");r.find("select.aggr-select").hide()}else{var r=$(this).closest(".kmjstr");r.find("img.group-btn").attr("src",l.imagePath+"link.png");$(this).attr("src",l.imagePath+"linkh.png");l.setGrouping(l.jcr,s);r.find("select.aggr-select").show();r.find("select#aggr-"+s).hide()}l.update()})})}if(n.filterable===true){p.find("input.km-js-th-input").each(function(){$(this).focusout(function(){$(this).hide()});$(this).keyup(function(u){var t=$(this).attr("class").split(/\s+/);var r=null;for(var s=0;s<t.length;s++){if(t[s].indexOf("th-input-")==0){r=t[s].substring("th-input-".length)}}r=r.replace(/\-/g,".");if(km.js.utils.isEmpty($(this).val())){l.removeRestrictions(l.jcr,r);$(this).closest(".kmjstd").find(".filter-btn").attr("src",l.imagePath+"filter.png")}else{l.addRestriction(l.jcr,r,$(this).val());l.goToPage(0);$(this).closest(".kmjstd").find(".filter-btn").attr("src",l.imagePath+"filterh.png")}l.update()})})}}};return h(this)},setAggr:function(l,h,j){for(var i=0;i<l.properties.length;i++){var k=l.properties[i];if(k.id==h){k.aggr=j;return}}},isGrouped:function(i,j){if(i.groupings==null||i.groupings.length==0){return false}for(var h=0;h<i.groupings.length;h++){if(i.groupings[h].property_id==j){return true}}return false},setGrouping:function(l,h){l.groupings=[];if(h!=null){l.groupings.push({property_id:h});for(var i=0;i<l.properties.length;i++){var k=l.properties[i];var j=k.aggr;k.aggr=k.id===h?null:(km.js.utils.isEmpty(j)?"count":j)}}else{for(var i=0;i<l.properties.length;i++){l.properties[i].aggr=null}}},removeRestrictions:function(i,j){var h=[];for(var k=0;k<i.restrictions.length;k++){if(i.restrictions[k].property_id!=j){h.push(i.restrictions[k])}}i.restrictions=h},parseRestriction:function(h){var i={operator:null,args:[]};if(km.js.utils.isEmpty(h)){return i}h=h.trim();var k=h.split(/\s+/);if(k.length==1){i.args.push(h);return i}getRestrictionName=function(l){if(l==">"){return"gt"}else{if(l==">="){return"ge"}else{if(l=="<"){return"lt"}else{if(l=="<="){return"le"}else{if(l=="="){return"eq"}else{return null}}}}}};var j=getRestrictionName(k[0]);if(j!=null){i.operator=j;i.args.push(h.substring(k[0].length))}else{i.args.push(h)}return i},removeColumn:function(m,i){this.removeColumnFromView(m);if(!i){return}for(var h=0;h<this.display.properties.length;h++){if(this.display.properties[h].id===m){this.display.properties.splice(h,1);break}}var j=this.jcr.groupings;var l=false;if(!km.js.utils.isEmpty(j)){for(var h=0;h<j.length;h++){if(j[h].property_id===m){j.splice(h,1);l=true;break}}}var k=this.jcr.properties;for(var h=0;h<k.length;h++){if(k[h].id===m){k.splice(h,1);break}else{if(l){k[h].aggr=null;console.log("rem for "+k[h].id)}}}if(typeof(this.settings.afterRemoveColumn)==="function"){this.settings.afterRemoveColumn(m)}},everyCell:function(h,k){var m=h.replace(/\./g,"-");var i=$("#"+this.settings.id+" .th-"+m);var l=i.index();if(l<0){return}var j=function(n,o){$("#"+n.settings.id+" .kmjstr").each(function(){o($(this).children().eq(l))})};j(this,k)},removeColumnFromView:function(h){this.everyCell(h,function(i){i.remove()})},hideColumn:function(h){this.everyCell(h,function(i){i.fadeOut(400)})},showColumn:function(h){this.everyCell(h,function(i){i.fadeIn(400)})},setButtonPanel:function(h){this.buttonPanel=h;this.buttonPanel.options.title=this.title},addRestriction:function(k,l,p){var h=null;var r=false;if(!km.js.utils.isEmpty(k.restrictions)){for(var i=0;i<k.restrictions.length;i++){if(k.restrictions[i].property_id==l){h=k.restrictions[i];r=true}}}else{k.restrictions=[]}if(h==null){h={property_id:l}}var j=this.parseRestriction(p);var n=j.operator;var q=km.js.jsti.fieldData(this.settings.jsti,km.js.utils.lastProperty(l));if(km.js.utils.isEmpty(q)){throw"JSTI does not contain information about field "+l}if(n==null){n=this.defaultRestrictionOperatorForType(q.dataType.id);if(n.toLowerCase()==="like"||n.toLowerCase()==="ilike"){var o=[];for(var i=0;i<j.args.length;i++){o.push("%"+j.args[i]+"%")}}j.args=o;console.log("Using default operator "+n+" for dt "+q.dataType.id)}h.operator=n;h.args=j.args;if(q.dataType.id===km.js.datatypes.number.id){var m=[];for(var i=0;i<h.args.length;i++){m.push(parseFloat(h.args[i]))}h.args=m}else{if(q.dataType.id===km.js.datatypes.bool.id){var m=[];for(var i=0;i<h.args.length;i++){m.push(h.args[i]==="true")}h.args=m}}if(!r){k.restrictions.push(h)}}};a.datasource=f;a.jcr=b;a.data=f.data;a.display=g;a.settings=c;a.pagination.pageSize=km.js.utils.isEmpty(e.pageSize)?a.pagination.pageSize:e.pageSize;if(a.settings.paginationActive===true||a.settings.paginationActive===false){a.pagination.active=a.settings.paginationActive}if(a.datasource.type==="json"){a=this.adjustJSONDatasource(a)}if(a.pagination.active===true){a.jcr.offset=0;a.jcr.limit=a.pagination.pageSize}a.imagePath=a.settings.contextPath+"/resources/images/";return a},adjustJSONDatasource:function(b){var e=[];for(var d=0;d<b.jcr.properties.length;d++){var a=b.jcr.properties[d];a.id=a.name;e.push(a)}b.jcr.properties=e;var f=[];for(var d=0;d<b.display.properties.length;d++){var a=b.display.properties[d];a.id=a.name;f.push(a)}b.display.properties=f;if(b.jcr.groupings){var c=[];for(var d=0;d<b.jcr.groupings.length;d++){var a=b.jcr.groupings[d];a.id=a.name;c.push(a)}b.jcr.groupings=c}if(b.selectedRecordDisplayField){b.selectedRecordDisplayField.id=b.selectedRecordDisplayField.name}if(b.display.idProperty){b.display.idProperty.id=b.display.idProperty.name}if(!b.display.defaultProperty||!b.display.defaultProperty.name){throw'Option display.defaultProperty.name needs to be specified when using datasource of type "json"'}return b}};
km.js.itemlist={create:function(a){var b={addBtnImage:"attachment.png",contextPath:km.js.config.contextPath};var c={getSelectedValues:a.getSelectedValues,options:$.extend({},b,a),items:[],jsti:{},imagePath:null,render:function(d){var f='<div id="'+this.options.id+'-container">'+this.getInnerCode()+"</div>";var e=$(f);if(typeof(d)==="function"){d(e,this)}else{throw"Callback not specified while calling itemlist.render()"}},getInnerCode:function(){var h='<div class="rmcp apc"><ul>';if(this.options.addBtn===true){h+='<li class="rmcpi rmcpadd">';if(!km.js.utils.isEmpty(this.options.addBtnImage)){h+='<img src="'+this.imagePath+this.options.addBtnImage+'">'}h+="</li>"}for(var d=0;d<this.items.length;d++){h+=this.getItemCode(this.items[d])}h+="</ul></div>";var f=$(h);if(typeof(this.options.onItemClick)==="function"){var g=function(i){return function(){var l=$(this).closest("li").attr("id").substring(i.options.id.length+"-i-".length);for(var k=0;k<i.items.length;k++){if(i.items[k][i.options.idField]===l){i.options.onItemClick(i.items[k])}}}};f.find("li.kmcpi > div.kmcptxt").click(g(this))}if(this.options.removeBtn===true){var e=function(i){return function(){var l=$(this).closest("li").attr("id").substring(i.options.id.length+"-i-".length);$(this).closest("li").remove();if(typeof(i.options.afterItemDelete)==="function"){for(var k=0;k<i.items.length;k++){if(i.items[k][i.options.idField]===l){i.options.afterItemDelete(i.items[k],l)}}}}};f.find("li.kmcpi img.del").click(e(this))}if(this.options.addBtn===true&&typeof(this.options.addBtnClick)==="function"){var j=function(i){return function(){i.options.addBtnClick(i)}};f.find("li.kmcpadd").click(j(this))}return f},getItemCode:function(d){var f='<li class="rmcpi" id="'+this.options.id+"-i-"+d[this.options.idField]+'"><div class="rmcptxt">';for(var e=0;e<this.options.properties.length;e++){f+=("<span>"+d[this.options.properties[e].id]+"</span>")}f+="</div>";if(this.options.removeBtn===true){f+='<img src="'+this.imagePath+'ex.png" class="del">'}f+="</li>";return f},update:function(d){var e=function(f,g){return function(h){f.items=h.records;f.jsti=h.jsti;$("#"+f.options.id+"-container").html(f.getInnerCode());if(typeof(g)==="function"){g(f)}}};this.items=this.getSelectedValues(e(this,d))}};c.imagePath=c.options.contextPath+"/resources/images/";return c}};
km.js.tablesearch={create:function(d){var c={columns:2,searchLabel:"Search"};var b=$.extend({},c,d);var a={table:b.table,columns:b.columns,cssClass:b.cssClass,properties:b.properties,searchPropertyValues:{},searchLabel:b.searchLabel,jsti:b.jsti,originalRestrictionCount:null,render:function(p){if(!this.properties||this.properties.length==0){throw"No properties specified in the table search panel"}if(!this.table){throw"No table associated with the table search panel"}if(!this.table.jcr){throw"Table object associated with the search panel has no JCR"}if(!this.table.datasource){throw"Data source not set on the associated table"}if(!this.jsti){throw"JSTI not set on table search"}var e=$("<div></div>").addClass("km-table-search").attr("id","table-search-"+this.table.id);if(this.cssClass){e.addClass(this.cssClass)}var o=$("<div></div>").addClass("km-table-search-table");var l=this.table.baseType;if(!l){if(!this.jsti){throw"Base type on table not set and it cannot be retrieved because JSTI on table search is not set"}else{l=this.jsti.types[this.table.jcr.baseTypeId]}}km.js.utils.populateIdsOnProperties(this.properties,l,this.jsti);var r=null;for(var h=0;h<this.properties.length;h++){if(h%this.columns==0){o.append(r);r=$("<div></div>").addClass("km-table-search-row")}var n=this.properties[h];var m=this.jsti.fields[km.js.utils.lastProperty(n.id)];var k=n.label?n.label:m.label;r.append($('<div class="km-table-search-cell km-table-search-label">'+k+"</div>"));var f=$("<div></div>").addClass("km-table-search-cell");f.append(this.getSearchInput(n,m.dataType));r.append(f)}var q=this.properties.length%this.columns;if(q!==0){for(var h=0;h<q;h++){r.append($('<div class="km-table-search-cell km-table-search-label"></div>'));var f=$("<div></div>").addClass("km-table-search-cell");r.append(f)}}o.append(r);var g=this.table.buttonPanel;if(!g){g=km.js.buttonpanel.create({id:this.table.id+"-btn-panel"})}var j={label:this.searchLabel,onClick:(function(i){return function(){i.search()}})(this)};g.addButton(j);this.table.setButtonPanel(g);e.append(o);e.keypress((function(i){return function(s){if(s.keyCode==13){i.search();return false}}})(this));if(typeof(p)==="function"){p(e)}else{this.table.container().prepend(e)}return e},search:function(){var k=this.table.jcr;if(!k){throw"Associated table has null JCR"}if(this.table.jcr.restrictions){for(var g=0;g<this.table.jcr.restrictions.length;g++){if(this.table.jcr.restrictions[g].table_search_restriction===true){km.js.utils.remove(g,this.table.jcr.restrictions)}}}for(var g=0;g<this.properties.length;g++){var j=this.properties[g];var f=this.searchPropertyValues[j.id];if(f){var h=f;if(j.operator==="ilike"||j.operator==="like"){h="%"+h+"%"}var e={property_id:j.id,operator:j.operator,args:[h],table_search_restriction:true};if(!this.table.jcr.restrictions){this.table.jcr.restrictions=[]}this.table.jcr.restrictions.push(e)}}this.table.goToPage(0);this.table.update()},getSearchInput:function(e,g){var f=$("<input></input>");f.keydown((function(h,i){return function(){h[i]=$(this).val()}})(this.searchPropertyValues,e.id));if(!g){throw"Data type for property"+e.id+" not found in JSTI"}if(g.id===km.js.datatypes.number.id||g.id===km.js.datatypes.text.id||g.id===km.js.datatypes.enumeration.id||g.id===km.js.datatypes.autonumber.id){f.attr("type","text").attr("id","search-"+e.id.replace(/\./,"-"));return f}else{if(g.id===km.js.datatypes.bool.id){f.attr("type","checkbox").attr("id","search-"+e.id.replace(/\./,"-"));return f}else{if(g.id===km.js.datatypes.rid.id){f.attr("type","text").attr("id","search-"+e.id.replace(/\./,"-"));return f}else{throw"Unsupported data type ID "+g.id+" while rendering input field"}}}}};return a}};
km.js.rel={create:function(a){var e={removeBtn:true,addBtn:true};var m=$.extend({},e,a);var b=m.jsti.fields[m.fieldId];var g=null;var j=null;var h=m.jsti.types[m.typeId];if(b.dataType.id===km.js.datatypes.inverse_collection.id){if(km.js.utils.isEmpty(b.dataType.inverseTypeId)){throw"Inverse type ID not specifed"}g=m.jsti.types[b.dataType.inverseTypeId]}else{if(b.dataType.id===km.js.datatypes.association.id){if(km.js.utils.isEmpty(b.dataType.associatedTypeId)){throw"Associated type ID not specifed"}g=m.jsti.types[b.dataType.associatedTypeId]}}if(!g){throw"Associated type not defined for relation field "+JSON.stringify(b)}var d=[];for(var c=0;c<m.selectedItemProperties.length;c++){d.push({id:b.id+"."+m.selectedItemProperties[c].id})}j=function(i){var p=km.js.datasource.create({type:"database"});var o={baseTypeId:m.typeId,properties:d,restrictions:[{property_id:h.idFieldId,operator:"eq",args:[m.recordId]}]};var n=function(q){return function(r){r.records=r.length>0?r[0][b.id]:[];q(r)}};p.query(o,n(i))};d.push({id:b.id+"."+g.idFieldId});if(km.js.utils.isEmpty(m.availableItemsOptions)){m.availableItemsOptions={}}if(km.js.utils.isEmpty(m.availableItemsOptions.properties)){var f=m.jsti.fields[g.defaultFieldId];if(km.js.utils.isEmpty(f)){throw"Default field with ID "+g.defaultFieldId+" not found"}m.availableItemsOptions.properties=[{id:f.id,label:f.label}]}var l=m.getAssignableItems;if(typeof(l)!=="function"){l=function(o){var n=km.js.datasource.create({type:"database"});var p={baseTypeId:g.id,properties:[]};p.properties.push({id:g.idFieldId});for(var i=0;i<m.availableItemsOptions.properties.length;i++){p.properties.push({id:m.availableItemsOptions.properties[i].id})}n.query(p,o)}}var k={baseType:h,relationField:b,associatedType:g,id:m.id,itemList:null,getSelectedValues:j,availableItemsDialog:null,availableItemsOptions:{properties:null,title:null,tableSearchOptions:null},options:m,update:function(){var i=function(n){return function(o){$("#"+n.id).replaceWith(o)}};this.render(i(this))},render:function(n){var i=function(r){return function(t){var s=function(){return function(u,w,v){console.log("Fetched assignable data");r.openSelectDialog(u,v)}};l(s(this))}};var q=function(r){return function(s,t){console.log("Deleting "+t);km.js.data.unassociate(r.relationField.id,r.options.recordId,t)}};var p={id:"item-list-"+this.id,properties:m.selectedItemProperties,idField:g.idFieldId,onItemClick:function(r){km.js.utils.openURL(km.js.config.contextPath+"/"+r[g.idFieldId])},afterItemDelete:q(this),removeBtn:m.removeBtn,addBtn:m.addBtn,addBtnClick:i(this),getSelectedValues:j};var o=function(r){return function(s){this.itemList=km.js.itemlist.create(p);this.itemList.render((function(t){return function(v,u){itemListElem=v;if(typeof(t)==="function"){t(v)}u.update()}})(r))}};this.getSelectedValues(o(n))},openSelectDialog:function(q,i){var o={id:"av-dialog-"+this.id,width:"800px",height:"500px",cssClass:"km-rel-av-dialog",iframe:{addDefaultStyles:true,cssClass:"km-std-iframe",cssBodyClass:"km-std-iframe-body",allowAdjustBodyWidth:true}};if(this.availableItemsDialog==null){this.availableItemsDialog=km.js.ui.dialog.create(o)}var p=function(r,s){return function(u,v){var t=$('<div style="margin: 0 auto;"></div>');if(m.availableItemsOptions.title){t.append(km.js.ui.header(m.availableItemsOptions.title,null,"margin-bottom: 20px"))}t.append(u);r.show(t)}};var n=this.getAvailableItemTable(q,i,p(this.availableItemsDialog,this.title))},getAvailableItemTable:function(t,s,q){var i=km.js.datasource.create({type:"collection",data:t,jsti:s});if(km.js.utils.isEmpty(m.availableItemsOptions.properties)){throw"Properties for available items not defined"}var x={baseTypeId:this.associatedType.id,properties:[].concat(this.options.availableItemsOptions.properties)};x.properties.push({id:this.associatedType.idFieldId});var n={properties:[],idProperty:{id:this.associatedType.idFieldId}};for(var u=0;u<this.options.availableItemsOptions.properties.length;u++){n.properties.push({id:this.options.availableItemsOptions.properties[u].id,label:this.options.availableItemsOptions.properties[u].label,sortable:this.options.availableItemsOptions.properties[u].sortable,linkStyle:true,onClick:(function(z){return function(A){z.onItemSelect(A)}})(this)})}var p=km.js.table.create(i,x,n,{id:"available-items-"+this.id,jsti:s,pageSize:10,paginationActive:true,cssClass:"km-table-std km-rel-av-items",wrapperCssClass:"km-rel-av-items-wrapper",buttonPanel:this.options.availableItemsOptions.buttonPanel});var w=null;if(!km.js.utils.isEmpty(m.availableItemsOptions.tableSearchOptions)){var r={properties:[{id:this.associatedType.defaultFieldId,operator:"ilike"}],cssClass:"km-table-search-std"};var v={table:p,jsti:s};var o=$.extend({},r,m.availableItemsOptions.tableSearchOptions,v);w=km.js.tablesearch.create(o)}var y=function(A,z){return function(D,C){if(A){D=A.render().add(D)}z(D,C)}};p.render(null,y(w,q))},onItemSelect:function(n){this.availableItemsDialog.hide();var i=function(p){return function(q){p.update()}};var o=function(p){km.js.ui.statusbar.err(p.message?p.message:p.messages,10000)};km.js.data.associate(this.relationField.id,this.options.recordId,n,i(this),o)}};km.js.scope.rels[km.js.utils.normalizeId(k.id)]=k;return k}};
km.js.tabs={create:function(c){var b={originalContentHandling:"hide",cssClass:"km-tabs-std"};var c=$.extend({},b,c);var a={id:c.id,tabs:c.tabs,cssClass:c.cssClass,originalContentHandling:c.originalContentHandling,afterRender:c.afterRender,renderCount:0,render:function(m){this.renderCount++;var f=$('<ul class="km-tabs-head"></ul>');var l=$('<div class="km-tabs-panels"></div>');for(var h=0;h<this.tabs.length;h++){var g=this.tabs[h];var j=$('<li class="km-tabs-head-'+h+'">'+g.label+"</li>");j.click((function(n,i){return function(){n.open(i)}})(this,h));f.append(j);var d=$('<div class="km-tabs-panel km-tabs-panel-'+h+'"></div>');if(!(g.content instanceof jQuery)){throw"Tab content for tab "+h+" ("+g.label+") is not a jQuery object, its type is "+typeof(g.content)}if(g.content){d.html(g.content.clone());if(this.originalContentHandling==="remove"){g.content.remove()}else{g.content.hide()}}else{throw"Content not defined for tab with ID "+h+" and label "+g.label}l.append(d)}var k='<div class="km-tabs-container';if(this.cssClass){k+=" "+a.cssClass}k+='" id="'+this.id+'"></div>';var e=$(k);e.append($("<div></div>").append(f).addClass("km-tab-names-container"));e.append(l);if(typeof(m)==="function"){m(e)}else{m.html(e)}this.callAfterRender()},container:function(){return $("#"+this.id)},openActiveTab:function(){var d=0;if(location.hash&&location.hash.indexOf("#rm.tab.")===0){d=parseInt(location.hash.substring("#rm.tab.".length))}this.open(d)},open:function(d){if(typeof(this.tabs[d].beforeOpen)==="function"){this.tabs[d].beforeOpen()}this.container().find("div.km-tabs-panels > div.km-tabs-panel-active").removeClass("km-tabs-panel-active").hide();this.container().find("div.km-tabs-panels > div.km-tabs-panel-"+d).addClass("km-tabs-panel-active").show();this.container().find("ul.km-tabs-head > li.km-tabs-head-active").removeClass("km-tabs-head-active");this.container().find("ul.km-tabs-head > li.km-tabs-head-"+d).addClass("km-tabs-head-active");location.hash="rm.tab."+d},appendAfterRender:function(d){if(!this.afterRender){this.afterRender=d}else{if($.isArray(this.afterRender)){this.afterRender.push(d)}}this.callAfterRender(this.afterRender)},callAfterRender:function(){if(this.renderCount<1){return}if(typeof(this.afterRender)==="function"){this.afterRender(this)}else{if($.isArray(this.afterRender)){for(var d=0;d<this.afterRender.length;d++){var e=this.afterRender[d];if(typeof(e)==="function"){e(this)}else{throw"After render callback is not a function"}}}}}};return a}};
km.js.comments={create:function(b){var a={cssClass:"km-cmt-std",addLabel:km.js.config.i18n["comments.save"],deleteLabel:km.js.config.i18n["comments.delete"],respondLabel:km.js.config.i18n["comments.reply"],responsesLabel:km.js.config.i18n["comments.replies"],responseTitleLabel:km.js.config.i18n["comments.response.title"],noAnswersLabel:km.js.config.i18n["comments.no.replies"],title:km.js.config.i18n["comments.list.title"],commentTypePrefix:"00l",sortMode:"desc",maxResponseIndentLevel:4,maxResponseAddLevel:null,addComments:false};b=$.extend({},a,b);if(!b.id){throw"No ID passed in configuration options to the comments object"}return{id:b.id,comments:b.comments,recordId:b.recordId,title:b.title,cssClass:b.cssClass,addLabel:b.addLabel,deleteLabel:b.deleteLabel,respondLabel:b.respondLabel,responsesLabel:b.responsesLabel,responseTitleLabel:b.responseTitleLabel,noAnswersLabel:b.noAnswersLabel,recentInvocationParams:{},commentTypePrefix:b.commentTypePrefix,maxResponseIndentLevel:b.maxResponseIndentLevel,maxResponseAddLevel:b.maxResponseAddLevel,addComments:b.addComments,options:b,sortMode:b.sortMode,render:function(e){this.recentInvocationParams.renderArg=e;var d=function(f,g){return function(o){var l=o.data;var n=$('<div id="'+f.id+'" class="km-cmt '+f.cssClass+'"></div>');n.append('<div class="km-cmt-title km-title">'+f.title+"</div>");if(f.recordId&&f.addComments===true){var p=$('<div class="km-cmt-new"></div>');p.append('<div class="km-cmt-add-error"></div>');p.append('<textarea id="newcomment"></textarea>');var m=$('<a href="javascript:;" class="sbtn">'+f.addLabel+"</a>");m.click((function(i){return function(){var s=$(this).closest(".km-cmt-new").find("textarea#newcomment").first().val();var q=i.container().find("textarea#newcomment");q.prop("disabled",true);var r={content:s,recordId:i.recordId};$.post(km.js.config.sysContextPath+"/comments/save",r,(function(u,t){return function(v){if(v.success===true){u.refresh()}else{t.prop("disabled",false);km.js.ui.error(v.message,u.container().find(".km-cmt-new .km-cmt-add-error"),null)}}})(f,q),"json")}})(f));p.append(m);n.append(p)}var j=function(){var q=$('<ul class="km-cmt-list-btns"></ul>');var i=$('<li><img class="km-cmt-sort-'+f.sortMode+'" src="'+km.js.config.imagePath+"/sort"+f.sortMode+'.png" /></li>');i.find("img").click((function(r){return function(){if($(this).hasClass("km-cmt-sort-desc")){r.sort("asc")}else{r.sort("desc")}}})(f));q.append(i);return q};n.append(j());var k=$('<div class="km-cmt-list"></div>');for(var h=0;h<l.length;h++){k.append(f.commentCode(l[h],0,f.options))}n.append(k);if(typeof(g)==="function"){g(n)}else{if(g instanceof jQuery){g.empty().append(n)}else{throw"Unsupported type "+typeof(g)+" of parameter target in call to km.js.comments.render()"}}}};if(this.comments&&this.recordId){throw"Both comments list and record ID cannot be set"}if(this.recordId){var c={sort:this.sortMode,subcommentLevels:-1,additionalFields:this.options.queriedFields};$.get(km.js.config.sysContextPath+"/rest/recordcomments/"+this.recordId,c,d(this,e),"json")}else{(d(this,e))({comments:this.comments})}return this},refresh:function(){this.render(this.recentInvocationParams.renderArg)},container:function(){return $("#"+this.id)},commentCode:function(i,c,n){if(!i.id){throw"Comment has no ID"}if(!i.content){throw"Comment has no text"}var d=$('<div class="km-cmt-item km-cmt-item-'+i.id+'"></div>');var m=$('<div class="km-cmt-box"></div>');var h=$('<div class="km-cmt-head"></div>');var g=i.createdBy?i.createdBy.userName:"";h.append($('<span class="km-cmt-author">'+g+"</span>"));h.append($('<span class="km-cmt-date">'+i.createdDate+"</span>"));m.append(h);var j=$('<div class="km-cmt-content"></div>').text(km.js.utils.nl2br(i.content));m.append(j);var k=$('<div class="km-cmt-btns"></div>');if(i.canDelete===true){k.append($('<a class="km-cmt-del btn" href="javascript:;">'+this.deleteLabel+"</a>"))}if(this.addComments===true){k.append($('<a class="km-cmt-resp btn" href="javascript:;">'+this.respondLabel+"</a>"))}var e=i.comments?i.comments.length:0;k.append($('<a class="km-cmt-show-replies" href="javascript:;">'+this.responsesLabel+" ("+e+")</a>"));if(typeof(n.buttonsPostprocessor)==="function"){n.buttonsPostprocessor(i,k,n)}m.append(k);d.append(m);d.append(this.answerList(i,c,n));d.find("a.km-cmt-show-replies").click((function(o){return function(){$(this).closest(".km-cmt-item").find(".km-cmt-answer-list-"+o).toggle()}})(i.id));if(i.canDelete===true){d.find("a.km-cmt-del").each((function(p,o){return function(){var q=function(){p.container().find("textarea#newcomment").attr("disabled","disabled");$.post(km.js.config.sysContextPath+"/comments/delete",{commentId:o},function(r){p.refresh()},"json")};km.js.ui.confirm({callback:q,question:km.js.config.i18n["comments.delete.warning"],target:$(this)})}})(this,i.id))}if(this.addComments===true){d.find("a.km-cmt-resp").click((function(p,o){return function(){$(this).closest(".km-cmt-item").find(".km-cmt-resp-form-"+o).toggle();$(this).closest(".km-cmt-item").find(".km-cmt-resp-form-"+o+" > textarea").attr("id","km-cmt-resp-text-"+o)}})(this,i.id));if(!this.maxResponseAddLevel||c<=this.maxResponseAddLevel){var f=$('<div class="km-cmt-resp-form km-cmt-resp-form-'+i.id+'"><div class="km-cmt-resp-title">'+this.responseTitleLabel+"</div><textarea></textarea></div>");if(c<=this.maxResponseIndentLevel){f.css("padding-left","5%")}var l=$('<a href="javascript:;" class="sbtn">'+this.addLabel+"</a>");l.click((function(o){return function(){var p=$(this).closest(".km-cmt-resp-form").find("textarea");var r=p.first().val();p.attr("disabled","disabled");$(this).attr("disabled","disabled");var s=p.attr("id").substring("km-cmt-resp-text-".length);var q={content:r,parentId:s,recordId:o.recordId};$.post(km.js.config.sysContextPath+"/comments/save",q,"json").done(function(t){console.log("S: "+JSON.stringify(t));o.refresh()}).fail(function(t){console.log("E: "+JSON.stringify(t));o.refresh()})}})(this));f.append(l);d.append(f)}}return d},sort:function(c){if(c!=="asc"&&c!=="desc"){throw'Unsupported sort direction "'+direction+'"'}this.sortMode=c;this.refresh()},answerList:function(f,e,g){var d=$('<div class="km-cmt-answer-list km-cmt-answer-list-'+f.id+'"></div>');if(e<=this.maxResponseIndentLevel){d.css("padding-left","5%")}if(f.comments&&f.comments.length>0){for(var c=0;c<f.comments.length;c++){d.append(this.commentCode(f.comments[c],e+1,g))}}else{d.append('<div class="km-cmt-no-replies">'+this.noAnswersLabel+"</div>")}return d}}}};
km.js.ref={create:function(c){var a=function(d){if(!d.datasource){d.datasource=km.js.datasource.create({type:"database"})}if(!d.id){d.id="km-ref-"+km.js.utils.random(1000000)}if(d.datasource.type==="json"){if(d.availableItemsOptions&&d.availableItemsOptions.display&&d.availableItemsOptions.display.idProperty&&!d.availableItemsOptions.display.idProperty.id){d.availableItemsOptions.display.idProperty.id=d.availableItemsOptions.display.idProperty.name}}return d};c=a(c);var b={recentRenderParams:null,inputName:c.inputName,inputId:c.inputId,visibleInput:c.visibleInput,selectedRecordId:c.selectedRecordId,selectedRecordDisplayName:c.selectedRecordDisplayName,selectedRecordDisplayField:c.selectedRecordDisplayField,availableItemsOptions:c.availableItemsOptions,datasource:c.datasource,jcr:c.jcr,dialog:null,id:c.id,dialogOptions:c.availableItemsDialogOptions,afterSelect:c.afterSelect,afterClear:c.afterClear,mode:c.mode?c.mode:"edit",editable:c.editable,render:function(e){if(this.selectedRecordId&&!this.selectedRecordDisplayName){if(!this.selectedRecordDisplayField){throw"Display field not defined. Specify option selectedRecordDisplayField in configuration of the rm.ref component."}else{if(!this.selectedRecordDisplayField.id&&!this.selectedRecordDisplayField.name){throw"Neither selectedRecordDisplayField ID nor its name specified"}}var i={baseTypeId:this.jcr.baseTypeId,baseTypeName:this.jcr.baseTypeName,properties:[{id:this.selectedRecordDisplayField.id,name:this.selectedRecordDisplayField.name}],restrictions:[{operator:"eq",property_id:this.availableItemsOptions.display.idProperty.id,property_name:this.availableItemsOptions.display.idProperty.name,args:[this.selectedRecordId]}]};this.datasource.query(i,(function(l){return function(o,p,n){if(!l.selectedRecordDisplayField.id){if(l.datasource.type!=="json"){var m=km.js.utils.getTypeFromJSTI(l.jcr,n);if(!m){throw"Base type not retrieved"}l.selectedRecordDisplayField.id=km.js.utils.nestedPropertyToPir(l.selectedRecordDisplayField.name,m,n);if(!l.selectedRecordDisplayField.id){throw"Could not get ID for select record display field with name '"+l.selectedRecordDisplayField.name+"' on type "+m.qualifiedName}}else{if(!l.availableItemsOptions.display.defaultProperty.name){throw'Option display.defaultProperty.name name not defined on km.js.table using datasource of type "json"'}l.selectedRecordDisplayField.id=l.availableItemsOptions.display.defaultProperty.name}}if(o.length===0){throw"Selected record with ID "+l.selectedRecordId+" not found"}else{l.setDisplayValue(o[0][l.selectedRecordDisplayField.id])}}})(this))}this.recentRenderParams=e;if(!this.id){throw"Object reference ID is not defined"}if(!this.dialog){var g={size:{fitToContent:true},iframe:{addDefaultStyles:true,cssClass:"km-std-iframe",cssBodyClass:"km-std-iframe-body",allowAdjustBodyWidth:true},id:this.id+"-items-dialog",style:"background-color: #fff"};var d=$.extend({},g,this.dialogOptions);this.dialog=km.js.ui.dialog.create(d)}var k=$('<div class="km-lookup" id="km-lookup-'+this.id+'"></div>');if(!this.inputName){throw"Reference input name must not be empty. Specify inputName option in lookup configuration"}if(this.mode==="view"){k.addClass("km-readonly-lookup");if(this.editable===true){k.click((function(l){return function(m){l.makeEditable()}})(this))}}var h=$('<input type="hidden" class="km-lookup-val" name="'+this.inputName+'"></input>');if(this.selectedRecordId){h.val(this.selectedRecordId)}if(this.inputId){h.attr("id",this.inputId)}k.append(h);var j=$('<input class="km-lookup-display-name" type="text" readonly="true"></input>');if(this.visibleInput&&this.visibleInput.cssClass){j.addClass(this.visibleInput.cssClass)}j.click((function(l){return function(){if(l.isEditable()){console.log("Opening available items");l.openAvailableItems()}}})(this));k.append(j);if(this.mode==="view"&&this.editable===true){j.blur((function(l){return function(){l.makeIneditable()}})(this))}var f=$('<img class="km-lookup-del" src="'+km.js.config.imagePath+'/ex.png">');f.click((function(l){return function(){l.clear()}})(this));k.append(f);if(e){if(typeof(e)==="function"){e(k,this)}else{if(e instanceof jQuery){console.log("Target "+e.size()+", target desc: "+e+" ("+JSON.stringify(e)+")");e.replaceWith(k)}else{throw"Unsupported argument type "+typeof(e)+" while calling ref.render()"}}if(this.selectedRecordDisplayName){this.setDisplayValue(this.selectedRecordDisplayName)}}return k},isEditable:function(){return !this.container().hasClass("km-readonly-lookup")},makeEditable:function(){this.container().removeClass("km-readonly-lookup")},makeIneditable:function(){this.container().addClass("km-readonly-lookup")},clear:function(){this.setDisplayValue(null);this.container().find("input.km-lookup-val").val(null);if(typeof(this.afterClear)==="function"){this.afterClear(this.selectedRecordId)}this.selectedRecordId=null},refresh:function(){this.render(this.recentRenderParams)},openAvailableItems:function(){var g={id:this.id+"-ait",options:{pageSize:10,paginationActive:true}};var h={};for(var e=0;e<this.availableItemsOptions.display.properties.length;e++){var f=this.availableItemsOptions.display.properties[e];f.onClick=(function(i){return function(l){i.select(l)}})(this)}var k=$.extend({},g,this.availableItemsOptions,h);var d=km.js.table.create(this.datasource,this.jcr,k.display,k.options);var j=function(i){return function(s,o){var q=null;var r=o.datasource.type==="json";if(!o.datasource.jsti&&!r){throw"JSTI not available on datasource related to available items table"}var t=null;if(!r){t=km.js.utils.getTypeFromJSTI(i.jcr,o.datasource.jsti);if(!t){throw"Type information not found in JSTI for type KID "+i.jcr.baseTypeId}}if(!km.js.utils.isEmpty(i.availableItemsOptions.tableSearchOptions)){console.log("Adding table search for type "+JSON.stringify(t));var m={properties:[{id:t.defaultFieldId,operator:"ilike"}],cssClass:"km-table-search-std"};var n={table:o,jsti:o.datasource.jsti};var l=$.extend({},m,i.availableItemsOptions.tableSearchOptions,n);if(!r){km.js.utils.populateIdsOnProperties(l.properties,t,o.datasource.jsti)}q=km.js.tablesearch.create(l)}var p=$("<div></div>");var u=i.availableItemsOptions.title?i.availableItemsOptions.title:t.pluralLabel;p.append(km.js.ui.header(u,null,"margin-bottom: 20px"));if(q){s=q.render().add(s)}p.append(s);i.dialog.show(p)}};d.render(null,j(this))},container:function(){var d=$("div[id='km-lookup-"+this.id+"']");if(d.length>1){throw"Ambiguous container, found "+d.length+" such elements instead of one"}return d},select:function(d){this.dialog.hide();this.selectedRecordId=d;this.selectedRecordDisplayName=null;if(this.mode==="view"&&this.editable===true){this.container().addClass("km-readonly-lookup")}if(typeof(this.recentRenderParams)==="function"){this.render(this.recentRenderParams);if(typeof(this.afterSelect)==="function"){this.afterSelect(this.selectedRecordId)}}else{if(this.recentRenderParams instanceof jQuery){this.render(this.container());if(typeof(this.afterSelect)==="function"){this.afterSelect(this.selectedRecordId)}}else{throw"Unsupported recent invocation param type: "+typeof(this.recentRenderParams)}}},setDisplayValue:function(d){this.container().find("input.km-lookup-display-name").val(d);this.selectedRecordDisplayName=d}};km.js.scope.refs[km.js.utils.normalizeId(b.id)]=b;return b}};
km.js.validation={init:function(a){if(!a){a=$(document)}else{if(!(a instanceof jQuery)){throw"Target of validation.init must be a jQuery object"}}a.find("input[km-validate=number]").each((function(b){return function(){$(this).change(function(c){b.validateNumber($(this),c)});$(this).blur(function(c){b.validateNumber($(this),c)})}})(this))},isValidNumber:function(a){return(new RegExp(km.js.config.localeNumberFormat)).test(a)},validateNumber:function(c,a){var b=c.val();if(b&&!this.isValidNumber(c.val())){c.addClass(this.errorClass);c.focus()}else{c.removeClass(this.errorClass)}},errorClass:"km-validate-err"};
km.js.fileupload={create:function(d){var c={id:"file-upload",parentDialog:null};var a=$.extend({},c,d);var b=km.js.ui.dialog.create({id:a.id,size:{width:"800px",height:"600px"},url:km.js.config.sysContextPath+"/files/new?"+(a.parentDialog?"parentDialog="+a.parentDialog:"")+(a.recordId?"&recordId="+a.recordId:""),afterClose:a.afterClose});return b}};
km.js.userlookup={create:function(f){var e={id:"user-lookup"};var d=$.extend({},e,f);var c={baseTypeName:"kommet.basic.User",properties:[{name:"userName"},{name:"id"}]};var a={options:{id:"user-search"},display:{properties:[{name:"userName",label:"User Name",linkStyle:true}],idProperty:{name:"id"}},title:"Users",tableSearchOptions:{properties:[{name:"userName",operator:"ilike"}]}};var b=km.js.ref.create({selectedRecordDisplayField:{name:"userName"},jcr:c,availableItemsDialogOptions:{},availableItemsOptions:a,inputName:d.inputName,inputId:d.inputId,visibleInput:d.visibleInput,selectedRecordId:d.selectedRecordId});return b}};
km.js.devitems={create:function(c){var b={items:null,group:"package",checkboxes:false,checkboxCallback:null};var d=$.extend({},b,c);var a={options:d,container:null,render:function(E,H){var y=H?$.extend({},this.options,H):this.options;this.container=$("<div></div>").addClass("km-dev-items-container");this.container.append(this.getBtnPanel(y));if(!y.items){throw"Item collection has not been provided"}if(y.group==="type"){var l=$("<ul></ul>").addClass("km-devitems-tree");var f=y.types;var h=0;if(f&&$.isArray(f)){var z=$("<ul></ul>");var D={};for(var G=0;G<f.length;G++){var A=f[G];var m=A.qualifiedName.split(".");var F=y.selectedItemIds&&km.js.utils.isObject(y.selectedItemIds[A.id]);if(F||y.ignoreSelection){h++}D=this.addItemToTree(D,m,m,A.id,F);for(var C=0;C<A.fields.length;C++){var p=A.fields[C];if(p.isSystem){continue}var x=y.selectedItemIds&&y.selectedItemIds[p.id];if(x||y.ignoreSelection){h++}var r=(A.qualifiedName+"._"+p.apiName).split(".");D=this.addItemToTree(D,r,r,p.id,x,{field:p})}}z=this.appendItemTree(z,D,this,1,y,false);var t=$("<a></a>").text("Types and fields ("+h+")").addClass("km-devitems-type");t.click(function(){$(this).closest("div.km-devitems-typegroup-name").siblings("ul").children("li").toggle()});var j=$("<div></div>").addClass("km-devitems-typegroup-name");var g=$("<span></span>").addClass("km-devitems-typegroup-icon").append($("<i></i>").addClass("fa fa-folder km-devitem-icon"));j.append(g).append(t);var u=$("<li></li>").append(j).append(z);l.append(u)}for(typeId in y.items){var v=km.js.config.componentTypes[typeId];if(!v){throw"Component type with ID "+typeId+" not found"}var z=$("<ul></ul>");var q=y.items[typeId];if(q){if($.isArray(q)){var D={};for(var G=0;G<q.length;G++){var w=q[G];var B=[];var e=null;for(var s in w){if(s.indexOf("003")!==0){continue}var p=y.jsti.fields[s];if(p.apiName==="id"){e=w[s]}else{var n=w[s];B.push(n)}}var m=B.join(".").split(".");var F=y.selectedItemIds&&y.selectedItemIds[e];D=this.addItemToTree(D,m,m,e,F)}z=this.appendItemTree(z,D,this,1,y,false)}else{throw"Items for component type ID "+typeId+" are not represented in an array"}}var o=v.name.toLowerCase().replace(/\_/g," ");var t=$("<a></a>").text(o+" ("+q.length+")").addClass("km-devitems-type");t.click(function(){$(this).closest("div.km-devitems-typegroup-name").siblings("ul").children("li").toggle()});var j=$("<div></div>").addClass("km-devitems-typegroup-name");var g=$("<span></span>").addClass("km-devitems-typegroup-icon").append($("<i></i>").addClass("fa fa-folder km-devitem-icon"));j.append(g).append(t);var u=$("<li></li>").append(j).append(z);l.append(u)}this.container.append(l)}else{if(y.group==="package"){throw"Grouping by package not supported"}else{throw"Unsupported dev item grouping '"+y.group+"'"}}this.container.append(l);if(typeof(E)==="function"){E(this.container,this)}else{if(E instanceof jQuery){E.empty().append(this.container)}}this.collapse()},collapse:function(){this.container.find("li.km-devitems-enditem-li").hide();this.container.find("li.km-devitems-package-li").hide()},addItemToTree:function(f,i,h,g,e,k){if(i.length>1){var j=f[i[0]];if(!j){f[i[0]]={};j=f[i[0]]}i.splice(0,1);j=this.addItemToTree(j,i,h,g,e,k)}else{if(f[i[0]]){throw"The same item "+i[0]+" added twice"}f[i[0]]={name:i[0],qualifiedName:h.join("."),id:g,isSelected:e,options:k}}return f},appendItemTree:function(t,k,q,e,s,f){for(var o in k){var u=k[o];if(f&&!km.js.utils.isObject(u)){continue}var n=f?o.substring(1):o;var r=$("<li></li>");var j=$("<span></span>").text(n).addClass("km-devitems-item-name");var p=$("<div></div>").css("padding-left",(2*e)+"em");var g=$("<a></a>").append(j);if(u.id){g.addClass("km-devitems-enditem");r.addClass("km-devitems-enditem-li").attr("id","km-devitems-enditem-li-"+u.id);r.append($("<input></input>").val(u.qualifiedName).attr("name","qualifiedName").attr("type","hidden"));if(typeof(q.options.itemClick)==="function"){g.click((function(z,y){return function(){z(y)}}(q.options.itemClick,u)))}if(s.checkboxes===true){var i=$("<input></input>").attr("type","checkbox").attr("id","record_"+u.id);if(u.isSelected){i.attr("checked","checked")}if(typeof(s.onCheck)==="function"){i.click((function(y){return function(){s.onCheck(y)}})(u))}p.append($("<div></div>").addClass("km-devitems-checkbox-wrapper").append(i))}if(typeof(s.onClick)==="function"){g.click((function(z,y){return function(){s.onClick(z);y.toggleClass("km-devitems-selected")}})(u,r))}var m=$("<div></div>").addClass("km-devitems-icon-wrapper");var h=$("<i></i>").addClass("fa fa-file km-devitem-icon");m.append(h);p.append(m);p.append(g);if(f){var v=u.options.field;if(!v){throw"Field definition not set"}var x=$("<div></div>").addClass("km-field-info");x.text("("+v.datatype.name+")");p.append(x)}r.append(p);if(u.isSelected){r.addClass("km-devitems-selected")}else{if(s.unselectedItemCssClass){r.addClass(s.unselectedItemCssClass)}}if(u.id.indexOf("002")===0){r.addClass("km-devitems-type-li");g.click((function(){return function(){$(this).closest(".km-devitems-type-li").children("ul").children("li").toggle()}}()));var w=$("<ul></ul>");this.appendItemTree(w,u,q,e+1,s,true);r.append(w)}}else{g.addClass("km-devitems-package");r.addClass("km-devitems-package-li");r.append(g);g.click((function(){return function(){$(this).closest(".km-devitems-package-li").children("ul").children("li").toggle()}}()));var l=$("<i></i>").addClass("fa fa-list km-devitem-icon");l.click((function(){return function(){$(this).closest(".km-devitems-package-li").children("ul").children("li").toggle()}}()));p.append($("<div></div>").addClass("km-devitems-icon-wrapper").append(l));p.append(g);r.append(p);var w=$("<ul></ul>");this.appendItemTree(w,u,q,e+1,s,false);r.append(w)}t.append(r)}return t},getBtnPanel:function(f){var e=$("<div></div>").addClass("km-devitems-btns");return e}};return a}};
km.js.calendar={create:function(b){var a={range:"week",daysPerRow:7,cssClass:"km-cal-std",hourStart:7,hourEnd:18,eventUrl:"events/{id}",hours:true,formatDate:function(c){return c!==null?this.stdDateFormat(c,"-"):""}};b=$.extend({},a,b);return{range:b.range,startDate:b.startDate,endDate:b.endDate,hourStart:b.hourStart,hourEnd:b.hourEnd,hours:b.hours,formatDate:b.formatDate,daysPerRow:b.daysPerRow,cssClass:b.cssClass,defaultEventDuration:3600000,eventUrl:b.eventUrl,id:b.id?b.id:"cal-"+(Math.floor(Math.random()*1000)+1),addEvents:function(d){for(var c=0;c<d.length;c++){this.addEvent(d[c])}},showRange:function(c,e){if(c<this.startDate){c=this.startDate}if(e>this.endDate){e=this.endDate}this.container().find(".km-cal-day").hide();for(var f=new Date(c);f<=e;f.setDate(f.getDate()+1)){var d=this.stdDateFormat(f,"");this.container().find(".km-cal-day-"+d).show()}},addEvent:function(g){var o=this.hourStart;var k=g.duration?g.duration:this.defaultEventDuration;var c=new Date(g.startDate);var j=new Date(g.startDate+k);if(c.getHours()<this.hourStart){if(j.getHours()<this.hourStart){console.log("Ignoring event "+g.name);return}}else{o=c.getHours()}var i=$('<div class="km-cal-event"></div>');i.append('<div class="km-cal-event-inner"><a class="km-cal-event-link" href="'+this.eventUrl.replace(/{id}/g,g.id)+'">'+g.name+"</a></div>");var l=this.stdDateFormat(c,"")+o;var m=this.container().find("div.km-cal-hour-"+l+" > div.km-cal-event-content").first();var n=this.container().find("div.km-cal-hour-"+this.stdDateFormat(c,"")+(j.getHours()+(j.getMinutes()>0?1:0))+" > div.km-cal-event-content").first();var f=n.position().top;var d=null;if(j.getHours()>c.getHours()){d=this.container().find("div.km-cal-hour-"+(this.stdDateFormat(c,"")+(j.getHours()-1))+" > div.km-cal-event-content").first()}else{d=m}var h=d.position().top;console.log("Event: "+g.name+", MIN: "+j.getMinutes());console.log("NEXT: "+f+", BUT: "+h);var p=m.position().top;var e=j.getMinutes()>0?(h+(j.getMinutes()*(f-h))/60):f;i.css("height",e-p);m.append(i)},container:function(){return $("#"+this.id)},render:function(f){var h='<div class="km-cal-container '+this.cssClass+'" id="'+this.id+'">';var g=$('<div class="km-cal-days"></div>');var c=0;for(var e=new Date(b.startDate);e<=b.endDate;e.setDate(e.getDate()+1)){if(c%this.daysPerRow===0){g.append('<div class="km-cal-day-row"></div>')}g.append(this.renderDay(e));c++;if(c%this.daysPerRow===0){g.append("</div>")}}h+="</div>";var d=$(h);d.append(g);if(typeof(f)==="function"){f(d)}else{f.append(d)}},stdDateFormat:function(d,c){var e=function(f){var g=f+"";return g.length==1?"0"+g:g};return d.getFullYear()+c+e(d.getMonth()+1)+c+e(d.getDate())},renderDay:function(d){var c=this.stdDateFormat(d,"");var e=$('<div class="km-cal-day km-cal-day-'+c+'"></div>');e.append('<div class="km-cal-date-label">'+this.formatDate(d)+"</div>");if(this.hours===true){e.append(this.renderHours(d))}return e},renderHours:function(e){var c='<div class="km-cal-hours">';for(var d=this.hourStart;d<=this.hourEnd;d++){c+='<div class="km-cal-hour km-cal-hour-'+this.stdDateFormat(e,"")+d+'"><div class="km-cal-hour-num">';c+=d+".00";c+='</div><div class="km-cal-event-content"></div></div>'}c+="</div>";return $(c)},}}};
km.js.rightpanel={create:function(b){var a={recentItems:{show:true,count:5},notifications:{show:true,count:5},icon:null};var d=$.extend({},a,b);var c={options:d,container:null,render:function(e){this.container=$("<div></div>").addClass("km-rp-container");this.container.append(this.userInfo());if(typeof(e)==="function"){e(this.container,this)}else{if(e instanceof jQuery){e.empty().append(this.container)}}this.initNotifications(this.container);this.initTasks(this.container);this.initEvents(this.container)},initNotifications:function(g){var e=km.js.datasource.create({type:"database"});var f={baseTypeName:"kommet.basic.Notification",properties:[{name:"id"},{name:"text"},{name:"title"},{name:"viewedDate"},],restrictions:[{property_name:"assignee.id",operator:"eq",args:[km.js.config.authData.user.id]},{property_name:"viewedDate",operator:"isnull",args:[]}]};e.query(f,(function(h,j,i){return function(k,m,n){k=km.js.utils.addPropertyNamesToJSRC(k,n);var r=$("<div></div>").addClass("km-rp-list-wrapper");var s=$("<ul></ul>").addClass("km-rp-list");var u=$("<div></div>").addClass("km-rp-list-title").text(km.js.config.i18n["notif.notification.title"]+" ("+k.length+")");r.append(u);var p=0;if(k.length>0){for(var o=0;o<k.length;o++){var l=k[o];var v=$("<li></li>");var u=$("<div></div>").addClass("km-rp-list-item-title").text(l.title);var t=$("<img></img>").attr("src",km.js.config.imagePath+"/ex.png").addClass("km-rp-list-close");t.click((function(z,y){return function(){console.log("Deleting notification "+z);$.post(km.js.config.contextPath+"/km/notifications/setviewed",{id:z},function(A){if(A.status==="success"){v.remove()}else{km.js.ui.statusbar.show("Could not set notification as viewed",10000)}},"json")}})(l.id,v));u.append(t);var w=$("<div></div>").addClass("km-rp-list-item-text").text(l.text);v.append(u).append(w);if(!l.viewedDate){p++;v.addClass("km-unread")}v.click((function(y){return function(){var z={id:y,viewedDate:(new Date()).getTime()};km.js.db.update(z,(function(A){return function(){A.removeClass("km-unread");A.fadeOut(500)}})($(this)))}})(l.id));s.append(v)}var q=$("<div></div>").append(s).addClass("km-rp-item-wrapper");if(k.length>5){q.addClass("km-rp-scroll")}r.append(q);if(p&&(j instanceof jQuery)){var x=$("<div></div>").addClass("km-alert-numbers");x.text(p);x.click((function(y){return function(){y()}})(i));j.append(x)}}else{r.append($("<div></div>").addClass("km-rp-list-noitems").text(km.js.config.i18n["rightpanel.list.noitems"]))}h.append(r)}})(g,this.options.icon,this.options.openCallback))},initTasks:function(g){var e=km.js.datasource.create({type:"database"});var f={baseTypeName:"kommet.basic.Task",properties:[{name:"id"},{name:"content"},{name:"title"}],restrictions:[{property_name:"assignedUser.id",operator:"eq",args:[km.js.config.authData.user.id]}]};e.query(f,(function(h){return function(o,r,s){o=km.js.utils.addPropertyNamesToJSRC(o,s);var j=$("<div></div>").addClass("km-rp-list-wrapper");var k=$("<ul></ul>").addClass("km-rp-list");var q=$("<div></div>").addClass("km-rp-list-title km-rp-list-title-clickable").text(km.js.config.i18n["rightpanel.tasks.title"]+" ("+o.length+")");q.click(function(){km.js.utils.openURL(km.js.config.contextPath+"/km/tasks/userlist")});j.append(q);if(o.length>0){for(var t=0;t<o.length;t++){var p=o[t];var l=$("<li></li>").addClass("km-rp-list-item-link");var q=$("<div></div>").addClass("km-rp-list-item-title").text(p.title);l.click((function(i,u){return function(){km.js.utils.openURL(km.js.config.contextPath+"/km/tasks/userlist?id="+i)}})(p.id,l));var m=$("<div></div>").addClass("km-rp-list-item-text").text(p.content);l.append(q).append(m);k.append(l)}var n=$("<div></div>").append(k).addClass("km-rp-item-wrapper");if(o.length>5){n.addClass("km-rp-scroll")}j.append(n)}else{j.append($("<div></div>").addClass("km-rp-list-noitems").text(km.js.config.i18n["rightpanel.list.noitems"]))}h.append(j)}})(g))},initEvents:function(f){var g=new Date();g.setHours(0);g.setMinutes(0);g.setSeconds(0);var e=new Date(g);e.setDate(e.getDate()+6);e.setHours(23);e.setMinutes(59);e.setSeconds(59);$.get(km.js.config.contextPath+"/km/rest/events",{startDate:g.getTime(),endDate:e.getTime(),userId:km.js.config.authData.user.id},(function(h){return function(o){var k=o.data.events;var r=$("<div></div>").addClass("km-rp-list-wrapper");var s=$("<ul></ul>").addClass("km-rp-list");var l=$("<div></div>").addClass("km-rp-list-title").text(km.js.config.i18n["rightpanel.events.title"]+" ("+k.length+")");r.append(l);if(k.length>0){for(var p=0;p<k.length;p++){var m=k[p];var j=$("<li></li>").addClass("km-rp-list-item-link");var l=$("<div></div>").addClass("km-rp-list-item-title").text(m.name);j.click((function(i,t){return function(){km.js.utils.openURL(km.js.config.contextPath+"/km/events/"+i)}})(m.id,j));var n=$("<div></div>").addClass("km-rp-list-item-text").text(m.description?m.description.substring(0,40):"");j.append(l).append(n);s.append(j)}var q=$("<div></div>").append(s).addClass("km-rp-item-wrapper");if(records.length>5){q.addClass("km-rp-scroll")}r.append(q)}else{r.append($("<div></div>").addClass("km-rp-list-noitems").text(km.js.config.i18n["rightpanel.list.noitems"]))}h.append(r)}})(f))},userInfo:function(){var e=$("<div></div>").addClass("km-rp-username-wrapper");e.append($("<div></div>").addClass("km-rp-username-title").text(km.js.config.i18n["rightpanel.loggedin.as"]));e.append($("<div></div>").addClass("km-rp-username").text(km.js.config.authData.user.userName));return e}};return c}};
km.js.ide={getJavaHints:function(f,b,e,d,c,a){$.post(km.js.config.contextPath+"/km/livejavahints",{code:f,varName:b,methodName:e,line:d,position:c},(function(g){return function(i){var h=[];for(var k=0;k<i.data.methods.length;k++){var j=i.data.methods[k].name;h.push({text:(e?"":".")+j+"()",displayText:j})}g(h)}})(a),"json")},getControllerTemplate:function(a){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"controller",templateFileName:"kommet.example.MyController"},function(c){if(c.success===true){var b={name:"MyController",content:c.data.source,mode:"text/x-java",type:"class",fileData:c.data.fileData};console.log("Calling callback");a(b)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getClassTemplate:function(a){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"class",templateFileName:"kommet.example.MyClass"},function(c){if(c.success===true){var b={name:"MyClass",content:c.data.source,mode:"text/x-java",type:"class",fileData:c.data.fileData};a(b)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getTriggerTemplate:function(b,a){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"trigger",templateFileName:"kommet.example.SampleTrigger",typeName:a?a.type:null},function(c){if(c.success===true){var d={name:"SampleTrigger",content:c.data.source,mode:"text/x-java",type:"class",fileData:c.data.fileData};b(d)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getBusinessActionTemplate:function(a){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"businessAction",templateFileName:"kommet.example.MyBusinessAction"},function(c){if(c.success===true){var b={name:"MyBusinessAction",content:c.data.source,mode:"text/x-java",type:"class",fileData:c.data.fileData};a(b)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getViewTemplate:function(a){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"view",templateFileName:"kommet.views.MyView"},function(c){if(c.success===true){var b={name:"MyView",content:c.data.source,mode:"xml",type:"view"};a(b)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")},getLayoutTemplate:function(a){$.get(km.js.config.contextPath+"/km/codetemplate",{type:"layout",templateFileName:"kommet.views.MyLayout"},function(c){if(c.success===true){var b={name:"MyLayout",content:c.data.source,mode:"xml",type:"layout"};a(b)}else{km.js.ui.statusbar.err("Could not load template",10000)}},"json")}};
km.js.db={query:function(c,d,a){var b=km.js.datasource.create({type:"database"});b.query(c,d,a)},update:function(c,a,b,d){var e=c.id;delete c.id;var f={id:e,record:JSON.stringify(c),};if(d){if(d.typeName){f.typeName=d.typeName}}$.post(km.js.config.contextPath+"/km/rest/record/save",f,function(g){if(typeof(a)==="function"){a(g.success,g)}},"json").fail(function(g){if(typeof(b)==="function"){b(JSON.parse(g.responseText))}})},deleteRecord:function(c,a,b){$.post(km.js.config.contextPath+"/km/rest/record/delete",{id:c},function(d){if(typeof(a)==="function"){a(d.success,d)}},"json").fail(function(d){if(typeof(b)==="function"){b(JSON.parse(d.responseText))}})}};
km.js.rest={call:function(a,b){if(a.indexOf("/")==0){a=a.substring(1)}$.get(km.js.config.contextPath+"/"+a,b,"json")}};
km.js.relatedlist={create:function(d){var e=km.js.datasource.create({type:"database"});if(!d.jcr){throw"[km.js.relatedlist] jcr is null"}if(!d.target){throw"[km.js.relatedlist] target not defined"}var a={idProperty:{name:"id"}};var f={id:"relatedlist"};var g=$.extend({},a,d.displayOptions);var b=$.extend({},f,d.tableOptions);var c=km.js.table.create(e,d.jcr,g,b);c.render(d.target)}};
km.js.objectdetails={create:function(a){var c={delayCallbacks:false,layout:null,customizable:false};var b={options:$.extend({},c,a),afterRenderCallbacks:[],renderStage:"not-started",renderedForm:null,updatedRecord:null,render:function(m){this.renderStage="started";this.afterRenderCallbacks=[];var h=$.extend({},this.options,m);this.actualOptions=h;var v=$("<div></div>").addClass("km-rd-table km-grid-section km-grid-group");if(h.customizable){if(!a.customization){throw"Customization context not defined"}v.addClass("km-rd-table-customizable")}var B=h.jsti;if(!B){throw"JSTI not provided to rm.objectdetails"}var l=h.record;if(!l){throw"Record not passed to rm.objectdetails"}this.updatedRecord=$.extend({},l);var y=h.mode;var g=h.fieldsPerRow;if(!g){g=2}if(!y){throw"Form mode (edit/view) not defined"}var n=null;var r=0;if(!h.fields&&!h.layout){throw"Neither fields for display nor layout are specified"}if(h.fields&&h.layout){throw"Both fields and layout cannot be set in options of rm.objectdetails"}if(h.fields){h.layout=this.getDefaultLayout(h,g)}for(var u=0;u<h.layout.sections.length;u++){var p=h.layout.sections[u];var A=$("<div></div>").addClass("km-rd-body km-property-section km-grid-col km-grid-span-2-of-2");if(p.title){var t=$('<div class="km-rd-row km-section-title"><div class="km-rd-cell">'+p.title+"</div></div>");A.append(t)}if(!p.rows){throw"Layout section does not contain any rows"}var s=0;for(;s<p.rows.length;s++){var n=p.rows[s];var d=$("<div></div>").addClass("km-rd-row km-grid-section km-grid-group");for(var q=0;q<n.fields.length;q++){var e=n.fields[q];if(e.isPlaceholder){d.append(this.placeholder(u,s,q,h.customizable,h));r++;continue}var z=null;if(e.isGeneric===true){var o=km.js.utils.propVal(l,e.name);if(!o&&e.value){o=e.value}var z=this.propertyCell(e,e.name,o,y,null)}else{var C=e.id;var w=null;var x=null;if(!C){if(!h.type){throw"Type not specified in options"}if(!e.name){throw"Neither field name nor ID specified: "+JSON.stringify(e)}x=e.name;w=this.getFieldFromJSTI(h.type,e.name,B)}else{w=B.fields[e.id]}if(!w){throw"Field "+JSON.stringify(e)+" not found in JSTI"}if(w.apiName&&!w.name){w.name=w.apiName}var o=l[w.id];if(e.label){w.label=e.label}var z=this.propertyCell(w,x,o,y,B)}if(!z){continue}if(h.customizable){z.draggable({helper:function(){return $(this).clone().addClass("km-rd-prop-drag-helper")},start:(function(D,i,E,j,k){return function(G,F){D.draggedProperty={field:i,sectionIndex:E,rowIndex:j,fieldIndex:k}}})(this,e,u,s,q),stop:(function(i){return function(k,j){i.draggedProperty=null}})(this)})}d.append(z);r++}while((r%g)!==0){d.append(this.placeholder(u,s,q,h.customizable,h));r++}if(typeof(n.render)==="function"){d.empty().append(n.render(n,d,v))}A.append(d)}var d=$("<div></div>").addClass("km-rd-row km-grid-section km-grid-group");r=0;while(r<g){d.append(this.placeholder(u,s,r,h.customizable,h));r++}A.append(d);d=null;if(h.customizable){A.draggable({helper:function(){return $(this).clone().addClass("km-rd-prop-drag-helper")},start:(function(i,j){return function(D,k){i.draggedSection={sectionIndex:j}}})(this,u),stop:(function(i){return function(k,j){i.draggedSection=null}})(this)});A.droppable({drop:(function(j,k,i){return function(){if(!j.draggedSection){return}var D=h.layout;var E=D.sections[k];D.sections[k]=D.sections[j.draggedSection.sectionIndex];D.sections[j.draggedSection.sectionIndex]=E;j.draggedSection=null;console.log("Repainting layout: "+JSON.stringify(D));j.render(j.actualOptions);if(!i.customization){throw"Customization context not defined"}j.saveCustomization(i.type.name,i.customization.context,i.customization.contextValue,D)}})(this,u,h)})}v.append(A)}this.renderedForm=v;var f=v;if(h.customization){f=$("<div></div>").append(this.customizationPanel(h)).append(v)}if(typeof(h.target)==="function"){h.target(f,this)}else{if(h.target instanceof jQuery){h.target.empty().append(f)}}this.renderStage="finished";this.callAfterRenderCallbacks()},customizationPanel:function(e){var g=this.getTypeFromJSTI(e.type,e.jsti);if(!g){throw"Type not found while rendering customization panel"}var f=$("<div></div>");var i=$("<div></div>").addClass("km-field-list");for(var k in e.jsti.fields){var h=e.jsti.fields[k];if(h.typeId!==g.id){continue}var d=$("<div></div>").addClass("km-cust-field");var j=$("<div></div>").text(h.label);d.append(j);var k=$("<div></div>").text(h.name);d.append(k);d.draggable({helper:function(){return $(this).clone().css("display","block").addClass("km-field-drag-helper")},start:(function(l,m){return function(o,n){l.draggedProperty={field:m,sectionIndex:null,rowIndex:null,fieldIndex:null,isNew:true}}})(this,h),stop:(function(l){return function(n,m){l.draggedProperty=null}})(this)});i.append(d)}f.append(i);return f},placeholder:function(j,d,f,i,h){var l=$("<div></div>").addClass("km-rd-property km-grid-col km-grid-span-1-of-2");var k=$("<div></div>").addClass("label km-rd-cell");var g=$("<div></div>").addClass("value km-rd-cell");if(i){k.append($("<div>new field</div>").addClass("km-drop-label-filler"));var e=$('<input type="text"></input>').attr("disabled",true);g.append($("<div></div>").append(e).addClass("km-drop-val-filler"));l.droppable({drop:(function(m,n,o,q,p){return function(){if(!m.draggedProperty.field){throw"Dropped null field"}console.log("Dropped "+JSON.stringify(m.draggedProperty));var u=h.layout;var t=u.sections[n];if(o>=t.rows.length){t.rows.push({fields:[]})}var s=t.rows[o];if(q>=s.fields.length){for(var r=s.fields.length;r<q;r++){s.fields.push({isPlaceholder:true})}}s.fields.push(m.draggedProperty.field);if(m.draggedProperty.isNew!==true){u.sections[m.draggedProperty.sectionIndex].rows[m.draggedProperty.rowIndex].fields[m.draggedProperty.fieldIndex]={isPlaceholder:true}}m.draggedProperty=null;console.log("Repainting layout: "+JSON.stringify(u));m.render(m.actualOptions);if(!p.customization){throw"Customization context not defined"}m.saveCustomization(p.type.name,p.customization.context,p.customization.contextValue,u)}})(this,j,d,f,h)})}return l.append(k).append(g)},saveCustomization:function(d,e,g,f){$.post(km.js.config.contextPath+"/km/objectdetails/customize",{typeName:d,context:e,contextValue:g,layout:JSON.stringify(f)},function(h){})},propertyDrop:function(){var e=$("<div></div>").addClass("km-rd-property km-prop-drop");var d=$("<div></div>").addClass("label km-rd-cell km-drop-cell").text("a");e.append(d);return e},getDefaultLayout:function(l,g){var j={sections:[]};var f={title:null,rows:[]};var k=null;var h=0;for(var e=0;e<l.fields.length;e++){if(!k){k={fields:[]}}var d=l.fields[e];k.fields.push(d);h++;if((h%g)===0){f.rows.push(k);k=null}}if(k){f.rows.push(k)}j.sections.push(f);return j},callAfterRenderCallbacks:function(){for(var d=0;d<this.afterRenderCallbacks.length;d++){this.afterRenderCallbacks[d]()}},addAfterRenderCallback:function(d){if(this.renderStage==="finished"&&!this.options.delayCallbacks){d()}else{this.afterRenderCallbacks.push(d)}},getTypeFromJSTI:function(f,e){if(!f.id&&!f.name){throw"Neither type name nor ID set: "+JSON.stringify(f)}var g=null;for(var d in e.types){var h=e.types[d];if((f.id&&f.id===h.id)||(f.name&&f.name===h.qualifiedName)){return h}}return null},getFieldFromJSTI:function(j,i,m){var h=this.getTypeFromJSTI(j,m);if(!h){throw"Type not found: "+JSON.stringify(j)}var k=i.indexOf(".")>=0;var d=[];if(k){d=i.split(".");i=d[0]}for(var f in m.fields){var g=m.fields[f];if(g.apiName===i&&g.typeId===h.id){if(!k){return g}else{if(g.dataType.id!==km.js.datatypes.object_reference.id){throw"Expected nested field "+i+" to be a type reference, but its data type is "+g.dataType.id}if(!g.dataType.typeId){throw"Referenced type ID not set on field "+i+" in JSTI"}d.shift();var l=d.join(".");var e=m.types[g.dataType.typeId];if(!e){throw"Nested type "+g.dataType.typeId+" not found in JSTI"}return this.getFieldFromJSTI(e,l,m)}}}return null},propertyCell:function(d,g,e,h,f){var l=$("<div></div>").addClass("km-rd-property km-grid-col km-grid-span-1-of-2");var j=$("<div></div>").addClass("label km-rd-cell").text(d.label);var i=this.renderField(d,g,e,h,f);if(!i){return null}var k=$("<div></div>").addClass("value km-rd-cell").append(i);l.append(j).append(k);return l},showErrors:function(g){var d=function(h,i){h.addClass("km-field-err-style")};for(var e=0;e<g.length;e++){var f=g[e];d(this.renderedForm.find(".km-field-"+f.fieldId),f.message)}},renderField:function(r,d,h,m,o){var f=function(i){i.addClass("km-output");i.attr("disabled","true").attr("readonly","true");return i};var k=r.dataType;if(k.id===km.js.datatypes.text.id||k.id===km.js.datatypes.email.id||k.id===km.js.datatypes.number.id||(k.id===km.js.datatypes.enumeration.id&&m==="view")){var s=$("<input></input>").val(h).attr("type","text");s.addClass("km-field-"+r.id);if(r.placeholder){s.attr("placeholder",r.placeholder)}s.change((function(i,t){return function(){i.updatedRecord[t.id]=$(this).val();km.js.utils.setPropVal(i.updatedRecord,d,$(this).val())}})(this,r));if(m==="view"){s=f(s)}return s}else{if(k.id===km.js.datatypes.date.id||k.id===km.js.datatypes.datetime.id){var s=$("<input></input>").val(h).attr("type","text");s.addClass("km-field-"+r.id);s.datepicker({dateFormat:"yy-mm-dd"});s.change((function(i,t){return function(){i.updatedRecord[t.id]=$(this).val();km.js.utils.setPropVal(i.updatedRecord,d,$(this).val())}})(this,r));if(m==="view"){s=f(s)}return s}else{if(k.id===km.js.datatypes.object_reference.id){var l="item-"+km.js.utils.random(1000000);var s=$("<input></input>").val(h).attr("type","text").attr("km-hash",l);s.addClass("km-field-"+r.id);var e=o.types[k.typeId];if(!e){throw"Referenced type with ID "+k.typeId+" for field "+r.apiName+" not found"}var q=o.fields[e.defaultFieldId];var p={baseTypeName:e.qualifiedName,properties:[{name:"id"},{name:q.apiName}]};var g={display:{properties:[{name:q.apiName,label:q.label,linkStyle:true}],idProperty:{name:"id"}}};var n=km.js.ref.create({selectedRecordDisplayField:{name:q.apiName},jcr:p,availableItemsDialogOptions:{},availableItemsOptions:g,inputName:r.apiName,mode:m,selectedRecordId:h?h[e.idFieldId]:null,afterSelect:(function(u,i,t){return function(v){var w={};w[t]=v;u.updatedRecord[i.id]=w;km.js.utils.setPropVal(u.updatedRecord,d,w)}})(this,r,e.idFieldId)});n.render((function(i){return function(t){i.addAfterRenderCallback(function(){$("input[km-hash='"+l+"']").replaceWith(t)})}})(this));return s}else{if(k.id===km.js.datatypes.bool.id){var s=null;if(this.actualOptions.boolDisplay==="dropdown"){var s=$("<select></select>");s.addClass("km-field-"+r.id);s.append($("<option></option>").text("Yes").attr("value","true"));s.append($("<option></option>").text("No").attr("value","false"));s.val(h===true?"Yes":"No");s.change((function(i,t){return function(){i.updatedRecord[t.id]=($(this).val()==="true");km.js.utils.setPropVal(i.updatedRecord,d,$(this).val()==="true")}})(this,r))}else{var s=$("<input></input>").attr("value","true").attr("type","checkbox");s.addClass("km-field-"+r.id);if(h===true){s.attr("checked",true)}s.change((function(i,t){return function(){i.updatedRecord[t.id]=$(this).is(":checked");km.js.utils.setPropVal(i.updatedRecord,d,$(this).is(":checked"))}})(this,r))}if(m==="view"){s=f(s)}return s}else{if(k.id===km.js.datatypes.enumeration.id&&m==="edit"){var s=$("<select></select>");s.addClass("km-field-"+r.id);for(var j=0;j<k.enumValues.length;j++){s.append($("<option></option>").text(k.enumValues[j]).attr("value",k.enumValues[j]))}s.val(h);s.change((function(i,t){return function(){i.updatedRecord[t.id]=$(this).val();km.js.utils.setPropVal(i.updatedRecord,d,$(this).val())}})(this,r));return s}else{if(k.id===km.js.datatypes.inverse_collection.id||k.id===km.js.datatypes.association.id||k.id===km.js.datatypes.rid.id||k.id===km.js.datatypes.formula.id){return null}else{throw"Unsupported field data type "+JSON.stringify(k)}}}}}}return null},};return b},renderRecord:function(a){km.js.db.query(a.query,(function(b){return function(d,e,g){var c=d.length?d[0]:{};var f=km.js.objectdetails.create({mode:b.mode?b.mode:"edit",jsti:g,target:function(h){b.target.empty();var j=$("<div></div>");if(b.title){var i=$("<div></div>").addClass("km-title").text(b.title);j.append(i)}if(b.buttonPanel){b.buttonPanel.render(function(k){j.append(k)})}j.append(h);b.target.append(j)},layout:b.layout,type:{name:b.typeName},record:c,customizable:false});f.render({})}})(a))}};
km.js.tasks={renderStage:"not-started",afterRenderCallbacks:[],options:null,show:function(b){this.renderStage="started";this.afterRenderCallbacks=[];var a={query:"select id, title, priority, status, content, dueDate, assignedUser.id, assignedUser.userName, assignedGroup.id, assignedGroup.name from Task",fields:[{name:"id"},{name:"title"},{name:"content"},{name:"dueDate"},{name:"priority"},{name:"assignedUser"},{name:"assignedGroup"}],mode:"view",title:km.js.config.i18n["tasks.list.title"],display:"boxes",dalFilters:{orderBy:"dueDate asc",dateCondition:null,ownerCondition:null},btnFilters:{dueDate:"all",owner:"all",orderBy:"dueDate asc"},taskId:null,recordId:null,isEmbedded:false,contentInRow:false};this.options=$.extend({},a,b);var c=this.buildQuery(this.options);this.options.taskId=null;km.js.db.query(c,(function(d,e){return function(o,p,m){var j=[{name:"userName"},{name:"id"},{name:"profile"},{name:"isActive"},{name:"createdDate"},{name:"locale"}];var n=$("<div></div>").addClass("km-tasks");if(e.isEmbedded){n.addClass("km-tasks-embedded")}if(!e.contentInRow){n.addClass("km-tasks-no-content")}var g=$("<div></div>");n.append(d.header(e,g));o=km.js.utils.addPropertyNamesToJSRC(o,m);n.append(g);var r=function(v){var i=new Date(v.getTime());i.setHours(0,0,0,0);return i};var s=function(v,i){if(!v||!i){return false}return r(v).getTime()===r(i).getTime()};var f=null;if(o.length){var l=$("<div></div>").addClass("km-task-list-items");for(var q=0;q<o.length;q++){var h=o[q];var k=h.dueDate?km.js.utils.parseDate(h.dueDate):null;if((q===0||(!s(f,k)&&f))){var u=$("<div></div>").addClass("km-tasks-dayheader");if(k){u.text(km.js.config.i18n["dayofweek."+k.getDay()]+", "+k.getDate()+" "+km.js.config.i18n["month.decl."+(k.getMonth()+1)])}else{u.text(km.js.config.i18n["tasks.noduedate.header"])}l.append(u)}if(e.display==="objectdetails"){l.append(d.renderTaskAsObjectDetails(h,e,m,d))}else{if(e.display==="boxes"){l.append(d.renderTaskAsBox(h,e,m,d))}else{throw"Unsupported display mode '"+e.display+"' for task list"}}f=k}n.append(l)}else{var t=$("<div></div>").text(km.js.config.i18n["tasks.notaskstodisplay"]).addClass("km-no-tasks-msg");n.append(t)}if(e.target instanceof jQuery){e.target.empty().append(n)}else{if(typeof(e.target)==="function"){e.target(n)}}n.find(".km-task").hide().fadeIn(500);this.renderStage="finished";for(var q=0;q<d.afterRenderCallbacks.length;q++){d.afterRenderCallbacks[q]()}}})(this,this.options))},buildQuery:function(a){var c=a.query;var d=[];if(a.recordId){d.push("recordId = '"+a.recordId+"'")}if(a.dalFilters||a.taskId){if(a.dalFilters.dateCondition){d.push(a.dalFilters.dateCondition)}if(a.dalFilters.ownerCondition){d.push(a.dalFilters.ownerCondition)}if(d.length||a.taskId){var b=[];if(d.length){b.push(d.join(" AND "))}if(a.taskId){b.push("id = '"+a.taskId+"'")}c+=" WHERE "+b.join(" OR ")}if(a.dalFilters.orderBy){c+=" ORDER BY "+a.dalFilters.orderBy}}return c},getTaskForm:function(){var b=$("<div></div>").addClass("km-newtask-form");var s=$("<div></div>").addClass("km-title").text(km.js.config.i18n["tasks.newtask.title"]);b.append(s);b.append($("<div></div>").attr("id","km-task-err-wrapper").hide());var d=$("<input></input>").attr("type","hidden");b.append(d);var e=$("<input></input>").attr("type","text").attr("id","new-task-title").addClass("km-input");e.attr("placeholder",km.js.config.i18n["tasks.form.title.placeholder"]);b.append(e);var n=$("<textarea></textarea>").attr("id","new-task-content").addClass("km-input");n.attr("placeholder",km.js.config.i18n["tasks.form.content.placeholder"]);b.append($("<div></div>").append(n).addClass("km-task-content-wrapper"));var c=$("<div></div>").addClass("km-newtask-options");var q=$("<div></div>");var u=$("<div></div>").addClass("km-task-option-wrapper");u.append($("<div></div>").text(km.js.config.i18n["tasks.duedate"]).addClass("label"));var a=$("<input></input>").attr("id","due-date").datetimepicker({dateFormat:"yy-mm-dd",addSliderAccess:true,sliderAccessArgs:{touchonly:false}}).addClass("km-input");u.append($("<div></div>").append(a));c.append(q.append(u));var o=$("<div></div>");var l=$("<div></div>").addClass("km-task-option-wrapper");l.append($("<div></div>").text(km.js.config.i18n["tasks.priority"]).addClass("label"));var r=$("<select></select>").attr("id","priority").addClass("km-input");for(var f=0;f<5;f++){var j=$("<option></option>").attr("value",f).text(km.js.config.i18n["tasks.priority."+f]);r.append(j)}r.val(3);l.append($("<div></div>").append(r));o.append(l);c.append(o);var g=$("<div></div>");var m=$("<div></div>").addClass("km-task-option-wrapper");m.append($("<div></div>").text(km.js.config.i18n["tasks.assigneduser"]).addClass("label"));var p=$("<div></div>").attr("id","assigned-user-container");m.append($("<div></div>").append(p));g.append(m);c.append(g);b.append(c);var h=$("<div></div>").addClass("km-newtask-form-btns");var t=$("<a></a>").attr("href","javascript:;").addClass("sbtn").text(km.js.config.i18n["btn.save"]);t.click((function(w,i,v,z,y,x){return function(){var A=$(this);$(this).text(km.js.config.i18n["btn.saving"]);var B={title:v.val(),content:z.val(),dueDate:y.val()?(new Date(y.val())).getTime():null,priority:x.val(),assignedUserId:$(".km-task-assigned-user").val(),recordId:w.options.recordId};$.post(km.js.config.contextPath+"/km/tasklist/save",B,(function(C){return function(D){$(".km-task-err-wrapper").fadeOut(400);A.text(km.js.config.i18n["btn.save"]);if(D.success){km.js.ui.statusbar.show(km.js.config.i18n["tasks.successfully.created"],5000);w.show(w.options);km.js.ui.dialog.closeAllDialogs()}else{km.js.ui.error(D.messages,$(".km-task-err-wrapper"));$(".km-task-err-wrapper").fadeIn(400)}}})(i),"json")}})(this,b,e,n,a,r));h.append(t);var k=$("<a></a>").attr("href","javascript:;").addClass("sbtn").text(km.js.config.i18n["btn.cancel"]);k.click((function(i){return function(){km.js.ui.dialog.closeAllDialogs()}})(b));h.append(k);b.append(h);km.js.utils.userLookup({target:function(i){b.find("#assigned-user-container").empty().append(i)},inputId:"km-task-assigned-user",inputName:"km-task-assigned-user",visibleInput:{cssClass:"km-input"}});return b},header:function(q,r){var B=$("<div></div>").addClass("km-tasks-header");var p=$("<div></div>").addClass("km-tasks-titlebar");var F=$("<div></div>").text(q.title).addClass("km-tasklist-title");p.append(F);var x=$("<div></div>").addClass("km-tasklist-icons");var t=$("<img></img>").attr("src",km.js.config.imagePath+"/newicon.png");t.click((function(G){return function(){km.js.ui.dialog.create({id:"task-dialog",size:{width:"75%",height:"600px"}}).show(G.getTaskForm())}})(this,r));x.append(t);p.append(x);B.append(p);var E=function(K,H,J,I,G){return function(){K.options.dalFilters[H]=J;K.options.btnFilters[I]=G;K.show(K.options)}};var l=$("<div></div>").addClass("km-btn-group");var h=$("<a></a>").text(km.js.config.i18n["tasks.btn.mytasks"]);h.click(E(this,"ownerCondition","assignedUser.id = '"+km.js.config.authData.user.id+"'","owner","me"));if(q.btnFilters.owner==="me"){h.addClass("km-active")}l.append(h);var f=$("<a></a>").text(km.js.config.i18n["tasks.btn.mygroup"]);f.click(E(this,"ownerCondition","assignedGroup.id IN (select parentGroup.id from UserGroupAssignment where childUser.id = '"+km.js.config.authData.user.id+"')","owner","mygroup"));if(q.btnFilters.owner==="mygroup"){f.addClass("km-active")}l.append(f);var b=$("<a></a>").text(km.js.config.i18n["tasks.btn.alltasks"]);if(q.btnFilters.owner==="all"){b.addClass("km-active")}b.click(E(this,"ownerCondition",null,"owner","all"));l.append(b);l.find("a").click(function(){$(this).closest("div.km-btn-group").find("a").removeClass("km-active");$(this).addClass("km-active")});var D=$("<div></div>").addClass("km-tasks-btns-wrapper");D.append($("<div></div>").text(km.js.config.i18n["tasks.btn.assignedto"]).addClass("km-task-btns-title"));D.append(l);B.append(D);var z=$("<div></div>").addClass("km-btn-group");var u=$("<a></a>").text(km.js.config.i18n["tasks.btn.duetoday"]);var w=new Date();w.setHours(0,0,0,0);var v=new Date();v.setHours(23,59,59,999);var n=new Date();n.setDate(n.getDate()+7);n.setHours(23,59,59,999);var j=new Date();j.setDate(j.getDate()+3);j.setHours(23,59,59,999);u.click(E(this,"dateCondition","dueDate >= "+w.getTime()+" and dueDate <= "+v.getTime(),"dueDate","today"));if(q.btnFilters.dueDate==="today"){u.addClass("km-active")}z.append(u);var C=$("<a></a>").text(km.js.config.i18n["tasks.btn.threedays"]);C.click(E(this,"dateCondition","dueDate >= "+w.getTime()+" and dueDate <= "+j.getTime(),"dueDate","3days"));if(q.btnFilters.dueDate==="3days"){C.addClass("km-active")}z.append(C);var g=$("<a></a>").text(km.js.config.i18n["tasks.btn.duethisweek"]);g.click(E(this,"dateCondition","dueDate >= "+w.getTime()+" and dueDate <= "+n.getTime(),"dueDate","week"));if(q.btnFilters.dueDate==="week"){g.addClass("km-active")}z.append(g);var A=$("<a></a>").text(km.js.config.i18n["tasks.btn.duepast"]);A.click(E(this,"dateCondition","dueDate < "+(new Date()).getTime(),"dueDate","past"));if(q.btnFilters.dueDate==="past"){A.addClass("km-active")}z.append(A);var o=$("<a></a>").text(km.js.config.i18n["tasks.btn.dueall"]);o.click(E(this,"dateCondition",null,"dueDate","all"));if(q.btnFilters.dueDate==="all"){o.addClass("km-active")}z.append(o);var c=$("<img></img>").attr("src",km.js.config.imagePath+"/calendar-white.png");var d=$("<div></div>").addClass("cal-wrapper");var k=km.js.utils.dateTimePicker({target:d,value:this.options.btnFilters.dueDate instanceof Date?this.options.btnFilters.dueDate:null,dateOnly:true,mode:"edit",onSelect:(function(G){return function(K){var H=new Date(K);var J=new Date(H);J.setHours(0,0,0,0);var I=new Date(H);I.setHours(23,59,59,0);E(G,"dateCondition","dueDate <= "+I.getTime()+" and dueDate >= "+J.getTime(),"dueDate",H)()}})(this)});var s=$("<div></div>").append(d).append($("<span></span>").append(c)).addClass("btn cal-btn");if(q.btnFilters.dueDate instanceof Date){s.addClass("km-active")}z.append(s);z.find("a").click(function(){$(this).closest("div.km-btn-group").find("a").removeClass("km-active");$(this).addClass("km-active")});var e=$("<div></div>").addClass("km-tasks-btns-wrapper");e.append($("<div></div>").text(km.js.config.i18n["tasks.btn.duetitle"]).addClass("km-task-btns-title"));e.append(z);B.append(e);var i=$("<div></div>").addClass("km-btn-group");var a=$("<a></a>").text(km.js.config.i18n["tasks.btn.sortby.duedate.asc"]);a.click(E(this,"orderBy","dueDate asc","orderBy","dueDate asc"));if(q.btnFilters.orderBy==="dueDate asc"){a.addClass("km-active")}i.append(a);var m=$("<a></a>").text(km.js.config.i18n["tasks.btn.sortby.duedate.desc"]);m.click(E(this,"orderBy","dueDate desc","orderBy","dueDate desc"));if(q.btnFilters.orderBy==="dueDate desc"){m.addClass("km-active")}i.append(m);var y=$("<div></div>").addClass("km-tasks-btns-wrapper");y.append($("<div></div>").text(km.js.config.i18n["tasks.btn.sortby.title"]).addClass("km-task-btns-title"));y.append(i);B.append(y);return B},addAfterRenderCallback:function(a){if(this.renderStage==="finished"){a()}else{this.afterRenderCallbacks.push(a)}},renderTaskAsBox:function(O,H,y,K){var b=$("<div></div>").addClass("km-task").addClass("km-task-display-row");b.attr("id","km-task-"+O.id);var z=$("<div></div>").addClass("km-task-tc");var B=function(i){km.js.ui.statusbar.err(i.message?i.message:i.messages)};var n=function(Q){var i=$("<img></img>").attr("src",km.js.config.imagePath+"/check.gif").css("position","absolute").css("right","5em").css("top","2em");Q.css("position","relative");Q.append(i);i.hide().fadeIn(700);setTimeout((function(){return function(){i.fadeOut(700)}})(i),3000)};var N=function(R,Q,T){var S=$("<img></img>").attr("src",km.js.config.imagePath+"/trashicon.png").addClass("task-icon");var i=$("<div></div>").addClass("km-task-delete-wrapper");i.append(S);Q.append(i);km.js.ui.confirm({target:S,callback:(function(U,V){return function(){km.js.db.deleteRecord(U,(function(W){return function(){W.fadeOut(400)}})(V))}})(T,R)})};var e=function(i,Q){if(!i){km.js.ui.statusbar.err(Q.message?Q.message:Q.messages)}else{}};var x=function(R,Q,i){R.blur((function(S,T){return function(){var U={id:S};U[T]=$(this).val()?$(this).val():null;km.js.db.update(U,e,B)}})(O.id,Q))};var P=function(Q,R,i){Q.addClass("km-task-display-form");Q.removeClass("km-status-resolved-row");Q.removeClass("km-task-display-row");km.js.ui.dialog.create({id:"existing-task-dialog",size:{width:"75%",height:"600px"},afterClose:(function(S){return function(){S.show(S.options)}})(i)}).show(Q)};var d=$("<div></div>").addClass("km-task-status-wrapper");var w=$("<img></img>").attr("src",km.js.config.imagePath+"/"+(O.status==="Resolved"?"check.gif":"greycheck.png"));w.addClass("task-icon");if(O.status==="Resolved"){w.addClass("km-status-resolved");b.addClass("km-status-resolved-row")}d.append(w);w.click((function(i,Q){return function(){var S=null;if($(this).hasClass("km-status-resolved")){$(this).removeClass("km-status-resolved");Q.removeClass("km-status-resolved-row");$(this).attr("src",km.js.config.imagePath+"/greycheck.png");S="Open"}else{$(this).addClass("km-status-resolved");Q.addClass("km-status-resolved-row");$(this).attr("src",km.js.config.imagePath+"/check.gif");S="Resolved"}var R={id:i};R.status=S;km.js.db.update(R,e,B)}})(O.id,b));z.append(d);var g=$("<div></div>").addClass("km-task-title");var C=$("<input></input>").attr("type","text").val(O.title).addClass("km-task-edit");x(C,"title",O.id);var t=O.content?O.content:"";var s=$("<textarea></textarea>").val(t).addClass("km-task-edit");if(km.js.utils.isMobile()){C.focus((function(Q,R,i){return function(){P(Q,R,i)}})(b,s,this))}g.append(C);var m=$("<div></div>").addClass("km-task-content-wrapper").append(s);x(s,"content",O.id);z.append(g).append(m);var D=$("<div></div>").addClass("km-task-assignee-wrapper");var J=$("<div></div>").addClass("km-task-option-wrapper");var a=$("<img></img>").attr("src",km.js.config.imagePath+"/personicon.png").addClass("task-icon");var F=$("<span></span>").append(a).addClass("task-icon-wrapper");J.append(F);var p="ua-"+km.js.utils.random(1000000);var j=$("<div></div>").attr("id",p);var G=$("<div></div>").text(O.assignedUser?O.assignedUser.userName:"");J.append($("<div></div>").append(j).append(G));D.append(J);var l=function(i,S,Q,R){Q.hide();km.js.utils.userLookup({target:((function(T){return function(U){$("#"+T).empty().append(U)}})(R)),inputName:"km-task-assignee",visibleInput:{cssClass:"km-input"},mode:"view",editable:true,recordId:S,afterSelect:function(U){var T={id:i};T.assignedUser=U?{id:U}:null;km.js.db.update(T,null,B)}})};this.addAfterRenderCallback(function(){var i=l(O.id,O.assignedUser?O.assignedUser.id:null,G,p);G.click(i);F.click(i)});z.append(D);var c=$("<div></div>").addClass("km-tasks-priority-cell");var u=$("<div></div>").addClass("km-task-option-wrapper");var A=$("<img></img>").attr("src",km.js.config.imagePath+"/impicon.png").addClass("task-icon");var v=$("<span></span>").append(A).addClass("task-icon-wrapper");u.append(v);var f=$("<select></select>").attr("id","priority").addClass("km-task-edit");for(var r=0;r<5;r++){var M=$("<option></option>").attr("value",r).text(km.js.config.i18n["tasks.priority."+r]);f.append(M)}f.val(O.priority);x(f,"priority",O.id);u.append($("<div></div>").append(f));c.append(u);z.append(c);var o=$("<div></div>").addClass("km-task-duedate-wrapper");var k=$("<div></div>").addClass("km-task-option-wrapper");var E=$("<img></img>").attr("src",km.js.config.imagePath+"/alarmclock.png").addClass("task-icon");var I=$("<span></span>").append(E).addClass("task-icon-wrapper");k.append(I);var h=$("<span></span>").text(O.dueDate?O.dueDate:"");x(h,"dueDate",O.id);var L=km.js.utils.dateTimePicker({target:h,value:O.dueDate,mode:"view",onSelect:(function(i){return function(R){var Q={id:i,dueDate:R?(new Date(R)).getTime():null};km.js.db.update(Q,e,B)}})(O.id)});I.click((function(i){return function(){i.enable()}})(L));k.append(h);o.append(k);z.append(o);var q=$("<img></img>").attr("src",km.js.config.imagePath+"/uncollapse.png").addClass("km-task-open-icon task-icon");q.click((function(i,R,S,Q){return function(){if(i.hasClass("km-task-display-form")){i.removeClass("km-task-display-form");i.addClass("km-status-resolved-row");i.addClass("km-task-display-row");km.js.ui.dialog.closeAllDialogs()}else{Q(i,R,S)}}})(b,s,this,P));z.append($("<div></div>").append(q).addClass("km-task-open-wrapper"));b.append(z);N(b,z,O.id);return b},renderTaskAsObjectDetails:function(b,c,a,d){var g="hash-"+km.js.utils.random(10);var f=$("<div></div>").addClass("ibox").attr("km-hash",g);var e=km.js.objectdetails.create({mode:c.mode,jsti:a,delayCallbacks:true,target:(function(h,j){var i=function(l,k){d.addAfterRenderCallback(function(){$("div[km-hash='"+h+"']").empty().append(l);k.callAfterRenderCallbacks()})};return i})(g,d),fields:c.fields,fieldsPerRow:2,type:{name:"kommet.basic.Task"}});e.render({record:b});return f}};
km.js.filelookup={show:function(b){var a={chooseSystemFiles:true,uploadedFileName:"uploadedFile",immediate:false};var c=$.extend({},a,b);km.js.db.query("select id, name from File where id = '"+(c.fileId?c.fileId:"00h0000000000")+"'",(function(d){return function(l,q,k){l=km.js.utils.addPropertyNamesToJSRC(l,k);var j=$("<img></img>").attr("src",km.js.config.imagePath+"/attachicon.png");var n=$("<div></div>").addClass("km-file-icon").append(j);var g=$("<div></div>").append(n).addClass("km-file-lookup");var i="km-file-"+km.js.utils.random(1000000);if(d.inputName){var o=$("<input></input>").attr("type","hidden").val(d.fileId).attr("name",d.inputName);g.append(o)}var h=$("<input></input>").attr("type","file").attr("name",d.uploadedFileName).hide();var e=km.js.filelookup.getFileForm(h,i);g.append(e);if(l.length){var f=l[0];var p=$("<div></div>").text(f.name).addClass("km-filename");g.append(p);var m=$("<img></img>").attr("src",km.js.config.imagePath+"/ex.png");m.click((function(s,r){return function(){s.val(null);r.empty();$(this).remove()}})(o,p));g.append($("<div></div>").append(m).addClass("km-remove"))}j.click((function(s,t,r,s){return function(){var u=km.js.ui.dialog.create({id:"km-fileupload-"+km.js.utils.random(1000000),size:{width:"800px",height:"600px"},afterClose:null});u.show(km.js.filelookup.getFileDialog(t,r,g,s,u))}})(d,h,e,d));d.target.empty().append(g)}})(c))},getFileForm:function(b,c){var a=$("<form></form>").attr("enctype","multipart/form-data").attr("method","post");a.append($("<input></input>").attr("type","hidden").attr("name","fileName"));a.append($("<input></input>").attr("type","hidden").attr("name","revisionId"));a.append($("<input></input>").attr("type","hidden").attr("name","nativeUpload").val("true"));a.append($("<input></input>").attr("type","hidden").attr("name","fileParam").val(c));a.append(b);a.css("display","none");return a},getFileDialog:function(a,b,j,i,h){var k=$("<div></div>").addClass("km-file-upload-wrapper");var d=$("<div></div>").addClass("km-file-drag");d.append($("<div></div>").text(km.js.config.i18n["files.drag.file"]));var c=$("<a></a>").addClass("sbtn").attr("href","javascript:;").text(km.js.config.i18n["files.browse"]);c.click((function(o){return function(){o.click()}})(a));d.append($("<div></div>").append(c).addClass("km-file-browse"));if(i.chooseSystemFiles){var m=$("<a></a>").addClass("sbtn").attr("href","javascript:;").text(km.js.config.i18n["files.choose.existing"]);m.click((function(p,o){return function(){km.js.filelookup.fileList(p,o,i)}})(k,h,i));d.append($("<div></div>").append(m).addClass("km-file-choose"))}var g=$("<div></div>").addClass("km-file-panel").hide();var n=$("<input></input>").attr("type","text").attr("id","filename").addClass("km-input");var l=function(p,o,s,u,t){if(p.success){o.hide();var r=$("<div></div>").text(km.js.config.i18n["files.upload.complete"]).addClass("km-upload-success");s.empty().append(r);u.close();if(typeof(t.afterSave)==="function"){if(!p.fileId||!p.fileRevisionId){throw"File ID or file revision ID not returned after file upload"}t.afterSave(p.fileId,p.fileRevisionId,p.fileName,t)}}else{var q=km.js.config.i18n["files.upload.failed"];if(p.messages&&p.messages.length){q+=": "+p.messages[0]}var r=$("<div></div>").text(q).addClass("km-upload-failed");s.empty().append(r)}};var f=(function(q,r,s,o,p){return function(){if(o.isDropUpload){if(o.dropCallbacks){for(var u=0;u<o.dropCallbacks.length;u++){console.log("Processing upload");o.dropCallbacks[u]()}}}else{var w="km-iframe-"+km.js.utils.random(1000000);var v=$('<iframe style="display: none" />').attr("id",w).attr("name",w);$("body").append(v);s.find("input[name=fileName]").val(r.val());s.attr("target",w);s.attr("action",km.js.config.contextPath+"/km/files/nativeupload");s.submit();var t=km.js.ui.buttonWait({button:$(this),text:"Saving"});v.load((function(y,z,x){return function(){km.js.ui.buttonWaitStop(y);iframeContents=$(this)[0].contentWindow.document.body.innerHTML;var A=JSON.parse(iframeContents);l(A,d,z,p,x)}})(t,g,o))}}})(a,n,b,i,h);if(typeof(d.dropzone)==="function"){d.dropzone({url:km.js.config.contextPath+"/km/files/nativeupload",createImageThumbnails:false,paramName:i.uploadedFileName,success:(function(o,p,q){return function(s,r){var t=JSON.parse(r);l(t,d,p,o,q)}})(h,g,i),previewTemplate:'<div class="dz-details">\n<div class="dz-size"><span data-dz-size></span></div>\n    <div class="dz-filename"><span data-dz-name></span></div>',accept:(function(p,o,q){return function(s,r){var t=s.name.split("\\").pop().split("/").pop();p.find("#filename").val(t);p.show();o.isDropUpload=true;if(!o.dropCallbacks){o.dropCallbacks=[]}o.dropCallbacks.push(r);if(o.immediate){q()}}})(g,i,f)})}k.append(d);g.append(n);var e=$("<a></a>").attr("href","javascript:;").text(km.js.config.i18n["btn.save"]).addClass("sbtn");e.click(f);g.append(e);k.append(g);a.on("change",(function(p,o,q){return function(){console.log("File: "+$(this).val());var r=$(this).val().split("\\").pop().split("/").pop();p.find("#filename").val(r);p.show();if(q.immediate){o()}}})(g,f,i));return k},fileList:function(d,b,a){var c=km.js.datasource.create({type:"database"});var h={baseTypeName:"kommet.basic.File",properties:[{name:"id"},{name:"createdDate"},{name:"name"}]};var e={properties:[{name:"name",label:"File name",linkStyle:true,onClick:(function(j,i){return function(k){if(typeof(i.afterSave)==="function"){i.afterSave(k,null,null,i)}j.close()}})(b,a)},{name:"createdDate",label:"Created date",linkStyle:true}],idProperty:{name:"id"}};var g={id:"km-files",pagination:{active:true,pageSize:15}};var f=km.js.table.create(c,h,e,g);f.render(h,d)}};
km.js.grid={create:function(a){var b={options:a,show:function(d){if(d){this.options.target=d}if(!this.options.fields){throw"Fields not set in grid"}if(!this.options.records){throw"Records not passed to grid"}var c=this.getGridCode(this.options,this.options.records);if(this.options.target instanceof jQuery){this.options.target.empty().append(c)}else{if(typeof(this.options.target)==="function"){this.options.target(c)}else{throw"Unsupported target data type while rendering grid"}}},getGridCode:function(c,h){var e=$("<div></div>").addClass("km-grid");e.append(this.getHeader(c));var g=0;for(var d=0;d<h.length;d++){var f=h[d];e.append(this.getRow(c,f,++g))}if(c.emptyRowCount){for(var d=0;d<c.emptyRowCount;d++){e.append(this.getEmptyRow(c,++g))}}return e},getHeader:function(c){var f=$("<div></div>").addClass("km-grid-row km-grid-header");this.columnCount=0;for(var d=0;d<c.fields.length;d++){var e=c.fields[d];if(!e.dataType){throw"Field data type not set for field "+e.name}if(!this.isValidDataTypeForGrid(e.dataType,e)){continue}this.columnCount++;var g=this.getHeaderCell(e,c);f.append(g)}if(c.emptyColumnCount){for(var d=0;d<c.emptyColumnCount;d++){this.columnCount++;var g=this.getEmptyHeaderCell(c);f.append(g)}}return f},isValidDataTypeForGrid:function(c,d){if(d.name==="accessType"){return false}if(km.js.datatypes.text.id===c.id){return true}if(km.js.datatypes.number.id===c.id){return true}if(km.js.datatypes.enumeration.id===c.id){return true}if(km.js.datatypes.email.id===c.id){return true}return false},getEmptyRow:function(h,e){var g=$("<div></div>").addClass("km-grid-row").attr("km-record-id","null").attr("km-row-no",e);for(var c=0;c<h.fields.length;c++){var d=h.fields[c];if(!d.dataType){throw"Field data type not set for field "+d.name}if(!this.isValidDataTypeForGrid(d.dataType,d)){continue}var f=this.getEmptyCell(h,d,null);f.attr("km-record-id","null");g.append(f)}if(h.emptyColumnCount){for(var c=0;c<h.emptyColumnCount;c++){var f=this.getEmptyCell(h,null,null);f.attr("km-record-id","null");g.append(f)}}return g},getRow:function(g,d,c){var f=$("<div></div>").addClass("km-grid-row").attr("km-record-id",d.id).attr("km-row-no",c);for(var h=0;h<g.fields.length;h++){var j=g.fields[h];if(!j.dataType){throw"Field data type not set for field "+j.name}if(!this.isValidDataTypeForGrid(j.dataType,j)){continue}var e=this.getCell(d,j,g);e.attr("km-record-id",d.id);f.append(e)}if(g.emptyColumnCount){for(var h=0;h<g.emptyColumnCount;h++){var e=this.getEmptyCell(g,null,d.id);e.attr("km-record-id",d.id);f.append(e)}}return f},getCell:function(h,g,e){var f=$("<div></div>").addClass("km-grid-cell");var d=h[g.name];var c=$("<input></input>").attr("type","text").val(d).addClass("km-grid-input");c.blur((function(i,k,j){return function(){var l={id:i.id};l[k]=j.val();km.js.db.update(l,null,null)}})(h,g.name,c));f.append(c);return f},getEmptyCell:function(d,f,e){var g=$("<div></div>").addClass("km-grid-cell").attr("km-record-id",e);var c=$("<input></input>").attr("type","text").addClass("km-grid-input");if(f){c.blur((function(j,k,h,i){if(!i.typeName){throw"Type name not defined in km.js.grid - cannot insert new record"}return function(){var m={id:j};var l={typeName:i.typeName};m[k]=h.val();km.js.db.update(m,null,null,l)}})(e,f.name,c,d))}g.append(c);return g},getHeaderCell:function(g,e){var f=$("<div></div>").addClass("km-grid-cell km-grid-header-cell").attr("km-field",g.id);var c=g.label?g.label:g.name;var d=c;var h=$("<input></input>").attr("type","text").val(d).addClass("km-grid-input");f.append(h);return f},getEmptyHeaderCell:function(c){var d=$("<div></div>").addClass("km-grid-cell km-grid-header-cell").attr("km-field","null");var e=$("<input></input>").attr("type","text").addClass("km-grid-input");e.blur((function(g,f,h){return function(){if(!g.val()){return}if(f.attr("km-field")!=="null"){return}if(!h.typeName){throw"Type name not defined in km.js.grid - cannot create new field"}var k=function(m){return m.replace(/\w\S*/g,function(n){return n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()})};var i=k(g.val());var l=i.replace(/\s+/g,"");l=l.charAt(0).toLowerCase()+l.substr(1).toLowerCase();var j={type:h.typeName,apiName:l,label:i};$.post(km.js.config.contextPath+"/km/rest/field/create",j,(function(m){return function(n){if(n.success){m.attr("km-field",n.data.fieldId)}}})(f),"json")}})(e,d,c));d.append(e);return d}};return b}};
km.js.cookies={create:function(d,e,a){var b="";if(a){var c=new Date();c.setTime(c.getTime()+(a*24*60*60*1000));b="; expires="+c.toUTCString()}document.cookie=d+"="+e+b+"; path=/"},read:function(d){var f=d+"=";var b=document.cookie.split(";");for(var e=0;e<b.length;e++){var a=b[e];while(a.charAt(0)==" "){a=a.substring(1,a.length)}if(a.indexOf(f)==0){return a.substring(f.length,a.length)}}return null},erase:function(a){create(a,"",-1)}};
km.js.marketplace={cachedData:null,render:function(b){this.cachedData={availableLibs:[],installedLibs:[],notifier:km.js.notifier.get()};var c={allowInstall:true,detailsLink:"rm/lib/marketplaceimport?id="};options=$.extend({},c,b);this.cachedData.notifier.wait("availableLibs");if(options.allowInstall){this.cachedData.notifier.wait("installedLibs")}this.cachedData.notifier.onComplete=(function(d){return function(){var h=d.availableLibs;var u=$("<div></div>").addClass("km-mrkt");for(var r=0;r<h.length;r++){var n=h[r];var j=$("<div></div>").addClass("km-lib");j.click((function(i){return function(){location.href=km.js.config.contextPath+"/"+i.detailsLink+n.id}})(options));var f=$("<img></img>").attr("src","https://kommet.io/km/download/"+n.logo.id).addClass("km-lib-logo");j.append(f);var q=$("<div></div>").addClass("km-lib-label").text(n.label);var t=$("<div></div>").addClass("km-lib-name").text(n.name);if(n.background){q.css("background",n.background);t.css("background",n.background)}j.append(q);j.append(t);var l=$("<div></div>").addClass("km-lib-desc").text(n.description);j.append(l);var e=$("<div></div>").addClass("km-lib-btns");if(options.allowInstall){var p=function(w,v){for(var i=0;i<v.length;i++){if(v[i].name===w.name&&v[i].version===w.version){console.log(JSON.stringify(v[i]));if(v[i].isEnabled===true){return"installed"}else{return"installed/disabled"}}}return"not installed"};var s=$("<i></i>").addClass("fa fa-download");var m=p(n,d.installedLibs);if(m==="installed"){var o=$("<a></a>").addClass("sbtn sbtn-inactive").append(s).append("Installed").attr("href","javascript:;");e.append(o)}else{if(m==="installed/disabled"){var o=$("<a></a>").addClass("sbtn sbtn-inactive").append(s).append("Downloaded").attr("href","javascript:;");e.append(o)}else{var o=$("<a></a>").addClass("sbtn").append(s).append("Install").attr("href",km.js.config.contextPath+"/"+options.detailsLink+n.id);e.append(o)}}}var g=$("<i></i>").addClass("fa fa-commenting-o");var k=$("<a></a>").addClass("sbtn").append(g).append("Details").attr("href",km.js.config.contextPath+"/"+options.detailsLink+n.id);e.append(k);j.append(e);u.append(j)}options.target.empty().append(u)}})(this.cachedData);if(options.allowInstall){km.js.db.query("select id, name, source, version, isEnabled from Library where source = 'External (library repository)'",(function(d){return function(e,g,f){lib=km.js.utils.addPropertyNamesToJSRC(e,f);d.installedLibs=e;d.notifier.reach("installedLibs")}})(this.cachedData))}var a={limit:options.limit,keyword:options.keyword};$.get("https://kommet.io/rest/marketplace/libs",a,(function(d,e){return function(f){e.availableLibs=f;e.notifier.reach("availableLibs")}})(options,this.cachedData))}};
